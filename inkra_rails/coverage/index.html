<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Inkra rails</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.13.1/application.js' type='text/javascript'></script>
    <link href='./assets/0.13.1/application.css' media='screen, projection, print' rel='stylesheet' type='text/css' />
    <link rel="icon" type="image/png" href="./assets/0.13.1/favicon_red.png" />
  </head>

  <body>
    <div id="loading">
      <img src="./assets/0.13.1/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" class="hide">
      <div class="timestamp">Generated <abbr class="timeago" title="2025-08-31T20:10:04-07:00">2025-08-31T20:10:04-07:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent">
      <span class="red">
  2.32%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.04
       </span>
    </span> hits/line
    )
  </h2>

  <a name="AllFiles"></a>

  <div>
    <b>82</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>8657</b> relevant lines,
    <span class="green"><b>201</b> lines covered</span> and
    <span class="red"><b>8456</b> lines missed. </span>
    (<span class="red">
  2.32%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cd62a2b2f4b0fe6f0d3e5c7bbaad34fa7821789f" class="src_link" title="app/controllers/api/audio_segments_controller.rb">app/controllers/api/audio_segments_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">162</td>
            <td class="cell--number">136</td>
            <td class="cell--number">0</td>
            <td class="cell--number">136</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e08663247523cdd1b9df30cbec9958c7669e8d9a" class="src_link" title="app/controllers/api/auth_controller.rb">app/controllers/api/auth_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">188</td>
            <td class="cell--number">147</td>
            <td class="cell--number">0</td>
            <td class="cell--number">147</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c253432a39914f607841e1a12b739ddd7b97d57e" class="src_link" title="app/controllers/api/base_controller.rb">app/controllers/api/base_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">81</td>
            <td class="cell--number">63</td>
            <td class="cell--number">0</td>
            <td class="cell--number">63</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e35574fdced837f3c7d2e5893136906f9e837103" class="src_link" title="app/controllers/api/device_logs_controller.rb">app/controllers/api/device_logs_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">97</td>
            <td class="cell--number">76</td>
            <td class="cell--number">0</td>
            <td class="cell--number">76</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4a9ba860a4fb4621cf5cdbb7a310463238ab6938" class="src_link" title="app/controllers/api/exports_controller.rb">app/controllers/api/exports_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">708</td>
            <td class="cell--number">567</td>
            <td class="cell--number">0</td>
            <td class="cell--number">567</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#97440ec6d82bbb8df7ed1d8764cd6278f8913745" class="src_link" title="app/controllers/api/feedbacks_controller.rb">app/controllers/api/feedbacks_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">43</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c21b1cf41cb6de9333e942cad2ad63875b4314d0" class="src_link" title="app/controllers/api/interview_presets_controller.rb">app/controllers/api/interview_presets_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.83 %</td>
            <td class="cell--number">175</td>
            <td class="cell--number">46</td>
            <td class="cell--number">45</td>
            <td class="cell--number">1</td>
            <td class="cell--number">2.48</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7138b8c39fe25524fd86be3269c1074de0c7a04f" class="src_link" title="app/controllers/api/interview_questions_controller.rb">app/controllers/api/interview_questions_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">283</td>
            <td class="cell--number">239</td>
            <td class="cell--number">0</td>
            <td class="cell--number">239</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#799a72f817064bc8c90378359994f3641734f0f1" class="src_link" title="app/controllers/api/polly_audio_controller.rb">app/controllers/api/polly_audio_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">273</td>
            <td class="cell--number">226</td>
            <td class="cell--number">0</td>
            <td class="cell--number">226</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#829b4a7b63f662dea3f96d1032335bcc209dac19" class="src_link" title="app/controllers/api/polly_voices_controller.rb">app/controllers/api/polly_voices_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">72</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#59cee80abccc3752b521c76ca2950b67af08d897" class="src_link" title="app/controllers/api/projects_controller.rb">app/controllers/api/projects_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">1294</td>
            <td class="cell--number">1018</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1018</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#16c56625a1e423cf964d471898d295abedd28079" class="src_link" title="app/controllers/api/questions_controller.rb">app/controllers/api/questions_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">55</td>
            <td class="cell--number">44</td>
            <td class="cell--number">0</td>
            <td class="cell--number">44</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#0ea0ae91b2145fe10a51f27bad3276fe0eb9ca15" class="src_link" title="app/controllers/api/quote_extraction_controller.rb">app/controllers/api/quote_extraction_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">56</td>
            <td class="cell--number">42</td>
            <td class="cell--number">0</td>
            <td class="cell--number">42</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#aadb2e0467bab888be74444a30bedfc965bb4d0e" class="src_link" title="app/controllers/api/runware_controller.rb">app/controllers/api/runware_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">190</td>
            <td class="cell--number">112</td>
            <td class="cell--number">0</td>
            <td class="cell--number">112</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4ec753d4986f7f7507552b352962c6092bd3cfff" class="src_link" title="app/controllers/api/speakers_controller.rb">app/controllers/api/speakers_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">47</td>
            <td class="cell--number">38</td>
            <td class="cell--number">0</td>
            <td class="cell--number">38</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5022726e042598eeb917dbbb8dcb7e2303a148e7" class="src_link" title="app/controllers/api/transcriptions_controller.rb">app/controllers/api/transcriptions_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">68</td>
            <td class="cell--number">50</td>
            <td class="cell--number">0</td>
            <td class="cell--number">50</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b02107164c489eea8dc360bfac316449b48eecaf" class="src_link" title="app/controllers/api/user_lifecycle_controller.rb">app/controllers/api/user_lifecycle_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">205</td>
            <td class="cell--number">165</td>
            <td class="cell--number">0</td>
            <td class="cell--number">165</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#38aa29bc0c756a5af30e60b349be18431115111f" class="src_link" title="app/controllers/api/user_preferences_controller.rb">app/controllers/api/user_preferences_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">19</td>
            <td class="cell--number">16</td>
            <td class="cell--number">0</td>
            <td class="cell--number">16</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#798126cf9012de24d7c84b3fc9fa478f8ca51a7a" class="src_link" title="app/controllers/api/users_controller.rb">app/controllers/api/users_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a4d8afc78503228385bc85c6bc8cf23d54a807d6" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">17.78 %</td>
            <td class="cell--number">89</td>
            <td class="cell--number">45</td>
            <td class="cell--number">8</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.18</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d96f81800b601534e3736afbaba4451e32277ca2" class="src_link" title="app/controllers/concerns/admin_authentication.rb">app/controllers/concerns/admin_authentication.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">32</td>
            <td class="cell--number">26</td>
            <td class="cell--number">0</td>
            <td class="cell--number">26</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#490d9805133c46ea3a35ee0bf98a4c4599652dae" class="src_link" title="app/controllers/concerns/error_responder.rb">app/controllers/concerns/error_responder.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">128</td>
            <td class="cell--number">108</td>
            <td class="cell--number">0</td>
            <td class="cell--number">108</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d87cc620927caa91974b5709c8f6ccd25430ac50" class="src_link" title="app/controllers/home_controller.rb">app/controllers/home_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b8fb142668553b6a021f6fc9850bde3db4b541ef" class="src_link" title="app/controllers/projects_controller.rb">app/controllers/projects_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">97</td>
            <td class="cell--number">82</td>
            <td class="cell--number">0</td>
            <td class="cell--number">82</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a82e1062c20702ef73b545af678e28c7710a9f14" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c56ceeb6623cb3382123fe535cf2b455dfb363c1" class="src_link" title="app/helpers/home_helper.rb">app/helpers/home_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8345edd5d7292b23889c6295df4c13ff0354c1b1" class="src_link" title="app/helpers/projects_helper.rb">app/helpers/projects_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9f82b619045a78e7bbeee0182b9fff9474fe4398" class="src_link" title="app/jobs/account_deletion_job.rb">app/jobs/account_deletion_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">115</td>
            <td class="cell--number">75</td>
            <td class="cell--number">0</td>
            <td class="cell--number">75</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e4652e9b218159a214fe070c5a632d37a1ab95dc" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4800f671a117151388a3c5074722729efe7fd117" class="src_link" title="app/jobs/data_export_job.rb">app/jobs/data_export_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">27</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#715ec0adf7f1dcb6bdcc3298eac52b0017d6876c" class="src_link" title="app/jobs/finalize_transcript_job.rb">app/jobs/finalize_transcript_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ac61f2f2aaf97948529349de13ecdc5c43352677" class="src_link" title="app/jobs/generate_followup_questions_job.rb">app/jobs/generate_followup_questions_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">85</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5fd907f3e81b3df467999a3067ace00b8cff71bb" class="src_link" title="app/jobs/outline_generation_job.rb">app/jobs/outline_generation_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">140</td>
            <td class="cell--number">107</td>
            <td class="cell--number">0</td>
            <td class="cell--number">107</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e22cf7e5fd9f99f556ae2fc7c1dd1b8e710b1947" class="src_link" title="app/jobs/podcast_export_job.rb">app/jobs/podcast_export_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">247</td>
            <td class="cell--number">171</td>
            <td class="cell--number">0</td>
            <td class="cell--number">171</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#fa1e4ee9efb68f030cd4b3f778151418ed6fdc56" class="src_link" title="app/jobs/polly_generation_job.rb">app/jobs/polly_generation_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">74</td>
            <td class="cell--number">55</td>
            <td class="cell--number">0</td>
            <td class="cell--number">55</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b738af0cd87d5b357043abaa948fb5f768ed4c77" class="src_link" title="app/jobs/transcript_editing_job.rb">app/jobs/transcript_editing_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">170</td>
            <td class="cell--number">128</td>
            <td class="cell--number">0</td>
            <td class="cell--number">128</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8bd487ded651604d20ff74ce3c0b58357db0869f" class="src_link" title="app/jobs/transcription_job.rb">app/jobs/transcription_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">46</td>
            <td class="cell--number">33</td>
            <td class="cell--number">0</td>
            <td class="cell--number">33</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#31c42e5d466bf1717cff43de862f964a6926ae67" class="src_link" title="app/jobs/unlimited_questions_generation_job.rb">app/jobs/unlimited_questions_generation_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">110</td>
            <td class="cell--number">81</td>
            <td class="cell--number">0</td>
            <td class="cell--number">81</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#70b8d8d2c8b2a84838e3af3cb42c907f15cc5c96" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d12c787353378b943b7e269761173a69cdc72397" class="src_link" title="app/mailers/user_data_export_mailer.rb">app/mailers/user_data_export_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">45</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8f3ac697ee8cefb79a78091f613e006bf1450769" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f543aa0d245038880df13149988fad7c4a67f5e0" class="src_link" title="app/models/audio_segment.rb">app/models/audio_segment.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">37</td>
            <td class="cell--number">29</td>
            <td class="cell--number">0</td>
            <td class="cell--number">29</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4e54a370a0ea54e5956ca03fd77c30381351083b" class="src_link" title="app/models/chapter.rb">app/models/chapter.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">12</td>
            <td class="cell--number">9</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3a042261cb48d0d5c1b55dfddf96fa76cda7e072" class="src_link" title="app/models/device_log.rb">app/models/device_log.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">48</td>
            <td class="cell--number">39</td>
            <td class="cell--number">0</td>
            <td class="cell--number">39</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3e4ac5f4ffd531b9fd6a12566d2be5fad25a8d9f" class="src_link" title="app/models/feedback.rb">app/models/feedback.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">20</td>
            <td class="cell--number">16</td>
            <td class="cell--number">0</td>
            <td class="cell--number">16</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#91a7c071cbd13538d3dc6243d5fe70e3e383b24f" class="src_link" title="app/models/interview_preset.rb">app/models/interview_preset.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.15 %</td>
            <td class="cell--number">42</td>
            <td class="cell--number">26</td>
            <td class="cell--number">25</td>
            <td class="cell--number">1</td>
            <td class="cell--number">2.65</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#0e12cfe302f944e7f55573407476c3f564fba364" class="src_link" title="app/models/log_entry.rb">app/models/log_entry.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">12</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9d3912ed872eb1a86c3b4d6600e18d4a2b3b2f55" class="src_link" title="app/models/polly_audio_clip.rb">app/models/polly_audio_clip.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">72</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d89136bc34ca3ff92d9084407437bd7014058d15" class="src_link" title="app/models/preset_question.rb">app/models/preset_question.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">86.67 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">15</td>
            <td class="cell--number">13</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.87</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b3b41a590beb21599f12007ee1bd1031a10a9895" class="src_link" title="app/models/project.rb">app/models/project.rb</a></td>
            <td class="red strong cell--number t-file__coverage">51.32 %</td>
            <td class="cell--number">175</td>
            <td class="cell--number">76</td>
            <td class="cell--number">39</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.54</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#95e543916cde9baab2ea01501520dc3ce55f1029" class="src_link" title="app/models/question.rb">app/models/question.rb</a></td>
            <td class="red strong cell--number t-file__coverage">61.76 %</td>
            <td class="cell--number">67</td>
            <td class="cell--number">34</td>
            <td class="cell--number">21</td>
            <td class="cell--number">13</td>
            <td class="cell--number">0.65</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#98d17d0be697f6832c86685d1105e1d9a5a83d4b" class="src_link" title="app/models/section.rb">app/models/section.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">11</td>
            <td class="cell--number">8</td>
            <td class="cell--number">8</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#583304283d71814ac1525e6e37af45cce5df9625" class="src_link" title="app/models/speaker.rb">app/models/speaker.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">18</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2cba90c5cdd93dd2019b1bb1e9d111c45d585a19" class="src_link" title="app/models/tracker.rb">app/models/tracker.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">14</td>
            <td class="cell--number">11</td>
            <td class="cell--number">0</td>
            <td class="cell--number">11</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c1a3cdc67b29de58400297074b37a1cd33892c94" class="src_link" title="app/models/transcript.rb">app/models/transcript.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">44</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#58a4fe0f991a4557f7f37c575984c49a35c1e45b" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">90.00 %</td>
            <td class="cell--number">38</td>
            <td class="cell--number">20</td>
            <td class="cell--number">18</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2.35</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9d532dfe99f3e60b04269ef9ddbb6557b55ab7f9" class="src_link" title="app/models/user_data_export.rb">app/models/user_data_export.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">83</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#97772cf93c152900e49fafcf0458e40a050846ce" class="src_link" title="app/models/user_shown_interview_preset.rb">app/models/user_shown_interview_preset.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">83.33 %</td>
            <td class="cell--number">19</td>
            <td class="cell--number">12</td>
            <td class="cell--number">10</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.83</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#1fa2f6a7629760f0729ef866f95dd6eef8f37026" class="src_link" title="app/services/aws/polly_service.rb">app/services/aws/polly_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">368</td>
            <td class="cell--number">269</td>
            <td class="cell--number">0</td>
            <td class="cell--number">269</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#6a46c71b198818c0b81689711792a17b778fe071" class="src_link" title="app/services/gemini_content_analysis_service.rb">app/services/gemini_content_analysis_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">511</td>
            <td class="cell--number">351</td>
            <td class="cell--number">0</td>
            <td class="cell--number">351</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#681d02ba100dff236efac2340176b090351645db" class="src_link" title="app/services/gemini_quote_extraction_service.rb">app/services/gemini_quote_extraction_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">148</td>
            <td class="cell--number">115</td>
            <td class="cell--number">0</td>
            <td class="cell--number">115</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8c640ccaa38b16c1d4a4d0c6522e4b8ef7a6292a" class="src_link" title="app/services/gemini_service.rb">app/services/gemini_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">79</td>
            <td class="cell--number">62</td>
            <td class="cell--number">0</td>
            <td class="cell--number">62</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#99d9dc4d25b1ed71a85ebdd8e49dfe8a6c16c1ad" class="src_link" title="app/services/gemini_text_polishing_service.rb">app/services/gemini_text_polishing_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">189</td>
            <td class="cell--number">145</td>
            <td class="cell--number">0</td>
            <td class="cell--number">145</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f4b936095d50fbcf430b064ebba077696334dc61" class="src_link" title="app/services/image_apis/base_image_client.rb">app/services/image_apis/base_image_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">37</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b37cad1ebfd987f7632d2cc77acc514bd62b55ef" class="src_link" title="app/services/image_apis/image_service_bus.rb">app/services/image_apis/image_service_bus.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">266</td>
            <td class="cell--number">186</td>
            <td class="cell--number">0</td>
            <td class="cell--number">186</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#98638beb2d8023e188703138b45e1afc72d52ea3" class="src_link" title="app/services/image_apis/lorem_picsum_client.rb">app/services/image_apis/lorem_picsum_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">34</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#47e70a90b34a8cb4f111c1d6740f069605fc5a3d" class="src_link" title="app/services/image_apis/openverse_client.rb">app/services/image_apis/openverse_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">39</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a5bef94f5c17b4a8f5fe6a6510bedf5a12a680fa" class="src_link" title="app/services/image_apis/pexels_client.rb">app/services/image_apis/pexels_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">52</td>
            <td class="cell--number">42</td>
            <td class="cell--number">0</td>
            <td class="cell--number">42</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2a430e8ab6e04f5ac1f649d79327d1cdda571446" class="src_link" title="app/services/image_apis/pixabay_client.rb">app/services/image_apis/pixabay_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">84</td>
            <td class="cell--number">62</td>
            <td class="cell--number">0</td>
            <td class="cell--number">62</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#777f3b0e8dc11a0f5c3864f57300766e6530a78a" class="src_link" title="app/services/image_apis/unsplash_client.rb">app/services/image_apis/unsplash_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">85</td>
            <td class="cell--number">61</td>
            <td class="cell--number">0</td>
            <td class="cell--number">61</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2cf847907eba6cf8250176fe73a059a51b67dd6a" class="src_link" title="app/services/image_apis/wikimedia_client.rb">app/services/image_apis/wikimedia_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">193</td>
            <td class="cell--number">155</td>
            <td class="cell--number">0</td>
            <td class="cell--number">155</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#40b254911a3e28d5457e88a551f95d7c22cfcdab" class="src_link" title="app/services/interview_flow_service.rb">app/services/interview_flow_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">180</td>
            <td class="cell--number">123</td>
            <td class="cell--number">0</td>
            <td class="cell--number">123</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8567ce1cc767c0a0d3242b757144b6a1006f2697" class="src_link" title="app/services/interview_question_service.rb">app/services/interview_question_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">533</td>
            <td class="cell--number">410</td>
            <td class="cell--number">0</td>
            <td class="cell--number">410</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#6aaf8bb6e19fb8ec450f6da2e5e60435f8bd476e" class="src_link" title="app/services/jwt_service.rb">app/services/jwt_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">46</td>
            <td class="cell--number">38</td>
            <td class="cell--number">0</td>
            <td class="cell--number">38</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ef02a77a6146c164c330122481c2e1ae738baf18" class="src_link" title="app/services/performance_tracker.rb">app/services/performance_tracker.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">281</td>
            <td class="cell--number">221</td>
            <td class="cell--number">0</td>
            <td class="cell--number">221</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ef3b4db87c402afe406f59555207dc469386fc2e" class="src_link" title="app/services/preset_questions_importer.rb">app/services/preset_questions_importer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">167</td>
            <td class="cell--number">133</td>
            <td class="cell--number">0</td>
            <td class="cell--number">133</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cb0b6816d0350dd2cc7ed699bb2e62b87391b3f9" class="src_link" title="app/services/runware_service.rb">app/services/runware_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">238</td>
            <td class="cell--number">130</td>
            <td class="cell--number">0</td>
            <td class="cell--number">130</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#dcdbafec3c5b1946fff32e7431827c0194d0ecb4" class="src_link" title="app/services/s3_service.rb">app/services/s3_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">492</td>
            <td class="cell--number">406</td>
            <td class="cell--number">0</td>
            <td class="cell--number">406</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#490a4684f17592695cbfe8e1e732d57f3a2c4a10" class="src_link" title="app/services/transcript_content_assembler_service.rb">app/services/transcript_content_assembler_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">273</td>
            <td class="cell--number">195</td>
            <td class="cell--number">0</td>
            <td class="cell--number">195</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a15d656496ad5c44b661239217ce5ead18a9ecdb" class="src_link" title="app/services/transcription_service.rb">app/services/transcription_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">456</td>
            <td class="cell--number">354</td>
            <td class="cell--number">0</td>
            <td class="cell--number">354</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#52882c73ad5556576f9ed7b831d0c6e8e0c9e69a" class="src_link" title="app/services/user_data_export_service.rb">app/services/user_data_export_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">512</td>
            <td class="cell--number">418</td>
            <td class="cell--number">0</td>
            <td class="cell--number">418</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cf583b717d2b7683b80f90ce524ba73524a5eb72" class="src_link" title="app/services/voice_demo_generator.rb">app/services/voice_demo_generator.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">71</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent">
      <span class="red">
  1.58%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.04
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Controllers"></a>

  <div>
    <b>24</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>3362</b> relevant lines,
    <span class="green"><b>53</b> lines covered</span> and
    <span class="red"><b>3309</b> lines missed. </span>
    (<span class="red">
  1.58%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cd62a2b2f4b0fe6f0d3e5c7bbaad34fa7821789f" class="src_link" title="app/controllers/api/audio_segments_controller.rb">app/controllers/api/audio_segments_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">162</td>
            <td class="cell--number">136</td>
            <td class="cell--number">0</td>
            <td class="cell--number">136</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e08663247523cdd1b9df30cbec9958c7669e8d9a" class="src_link" title="app/controllers/api/auth_controller.rb">app/controllers/api/auth_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">188</td>
            <td class="cell--number">147</td>
            <td class="cell--number">0</td>
            <td class="cell--number">147</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c253432a39914f607841e1a12b739ddd7b97d57e" class="src_link" title="app/controllers/api/base_controller.rb">app/controllers/api/base_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">81</td>
            <td class="cell--number">63</td>
            <td class="cell--number">0</td>
            <td class="cell--number">63</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e35574fdced837f3c7d2e5893136906f9e837103" class="src_link" title="app/controllers/api/device_logs_controller.rb">app/controllers/api/device_logs_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">97</td>
            <td class="cell--number">76</td>
            <td class="cell--number">0</td>
            <td class="cell--number">76</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4a9ba860a4fb4621cf5cdbb7a310463238ab6938" class="src_link" title="app/controllers/api/exports_controller.rb">app/controllers/api/exports_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">708</td>
            <td class="cell--number">567</td>
            <td class="cell--number">0</td>
            <td class="cell--number">567</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#97440ec6d82bbb8df7ed1d8764cd6278f8913745" class="src_link" title="app/controllers/api/feedbacks_controller.rb">app/controllers/api/feedbacks_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">43</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c21b1cf41cb6de9333e942cad2ad63875b4314d0" class="src_link" title="app/controllers/api/interview_presets_controller.rb">app/controllers/api/interview_presets_controller.rb</a></td>
            <td class="green strong cell--number t-file__coverage">97.83 %</td>
            <td class="cell--number">175</td>
            <td class="cell--number">46</td>
            <td class="cell--number">45</td>
            <td class="cell--number">1</td>
            <td class="cell--number">2.48</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7138b8c39fe25524fd86be3269c1074de0c7a04f" class="src_link" title="app/controllers/api/interview_questions_controller.rb">app/controllers/api/interview_questions_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">283</td>
            <td class="cell--number">239</td>
            <td class="cell--number">0</td>
            <td class="cell--number">239</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#799a72f817064bc8c90378359994f3641734f0f1" class="src_link" title="app/controllers/api/polly_audio_controller.rb">app/controllers/api/polly_audio_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">273</td>
            <td class="cell--number">226</td>
            <td class="cell--number">0</td>
            <td class="cell--number">226</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#829b4a7b63f662dea3f96d1032335bcc209dac19" class="src_link" title="app/controllers/api/polly_voices_controller.rb">app/controllers/api/polly_voices_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">72</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#59cee80abccc3752b521c76ca2950b67af08d897" class="src_link" title="app/controllers/api/projects_controller.rb">app/controllers/api/projects_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">1294</td>
            <td class="cell--number">1018</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1018</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#16c56625a1e423cf964d471898d295abedd28079" class="src_link" title="app/controllers/api/questions_controller.rb">app/controllers/api/questions_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">55</td>
            <td class="cell--number">44</td>
            <td class="cell--number">0</td>
            <td class="cell--number">44</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#0ea0ae91b2145fe10a51f27bad3276fe0eb9ca15" class="src_link" title="app/controllers/api/quote_extraction_controller.rb">app/controllers/api/quote_extraction_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">56</td>
            <td class="cell--number">42</td>
            <td class="cell--number">0</td>
            <td class="cell--number">42</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#aadb2e0467bab888be74444a30bedfc965bb4d0e" class="src_link" title="app/controllers/api/runware_controller.rb">app/controllers/api/runware_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">190</td>
            <td class="cell--number">112</td>
            <td class="cell--number">0</td>
            <td class="cell--number">112</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4ec753d4986f7f7507552b352962c6092bd3cfff" class="src_link" title="app/controllers/api/speakers_controller.rb">app/controllers/api/speakers_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">47</td>
            <td class="cell--number">38</td>
            <td class="cell--number">0</td>
            <td class="cell--number">38</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5022726e042598eeb917dbbb8dcb7e2303a148e7" class="src_link" title="app/controllers/api/transcriptions_controller.rb">app/controllers/api/transcriptions_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">68</td>
            <td class="cell--number">50</td>
            <td class="cell--number">0</td>
            <td class="cell--number">50</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b02107164c489eea8dc360bfac316449b48eecaf" class="src_link" title="app/controllers/api/user_lifecycle_controller.rb">app/controllers/api/user_lifecycle_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">205</td>
            <td class="cell--number">165</td>
            <td class="cell--number">0</td>
            <td class="cell--number">165</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#38aa29bc0c756a5af30e60b349be18431115111f" class="src_link" title="app/controllers/api/user_preferences_controller.rb">app/controllers/api/user_preferences_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">19</td>
            <td class="cell--number">16</td>
            <td class="cell--number">0</td>
            <td class="cell--number">16</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#798126cf9012de24d7c84b3fc9fa478f8ca51a7a" class="src_link" title="app/controllers/api/users_controller.rb">app/controllers/api/users_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a4d8afc78503228385bc85c6bc8cf23d54a807d6" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">17.78 %</td>
            <td class="cell--number">89</td>
            <td class="cell--number">45</td>
            <td class="cell--number">8</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.18</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d96f81800b601534e3736afbaba4451e32277ca2" class="src_link" title="app/controllers/concerns/admin_authentication.rb">app/controllers/concerns/admin_authentication.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">32</td>
            <td class="cell--number">26</td>
            <td class="cell--number">0</td>
            <td class="cell--number">26</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#490d9805133c46ea3a35ee0bf98a4c4599652dae" class="src_link" title="app/controllers/concerns/error_responder.rb">app/controllers/concerns/error_responder.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">128</td>
            <td class="cell--number">108</td>
            <td class="cell--number">0</td>
            <td class="cell--number">108</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d87cc620927caa91974b5709c8f6ccd25430ac50" class="src_link" title="app/controllers/home_controller.rb">app/controllers/home_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b8fb142668553b6a021f6fc9850bde3db4b541ef" class="src_link" title="app/controllers/projects_controller.rb">app/controllers/projects_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">97</td>
            <td class="cell--number">82</td>
            <td class="cell--number">0</td>
            <td class="cell--number">82</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Channels">
  <h2>
    <span class="group_name">Channels</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Channels"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent">
      <span class="red">
  30.92%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.47
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Models"></a>

  <div>
    <b>18</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>469</b> relevant lines,
    <span class="green"><b>145</b> lines covered</span> and
    <span class="red"><b>324</b> lines missed. </span>
    (<span class="red">
  30.92%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8f3ac697ee8cefb79a78091f613e006bf1450769" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f543aa0d245038880df13149988fad7c4a67f5e0" class="src_link" title="app/models/audio_segment.rb">app/models/audio_segment.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">37</td>
            <td class="cell--number">29</td>
            <td class="cell--number">0</td>
            <td class="cell--number">29</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4e54a370a0ea54e5956ca03fd77c30381351083b" class="src_link" title="app/models/chapter.rb">app/models/chapter.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">12</td>
            <td class="cell--number">9</td>
            <td class="cell--number">9</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3a042261cb48d0d5c1b55dfddf96fa76cda7e072" class="src_link" title="app/models/device_log.rb">app/models/device_log.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">48</td>
            <td class="cell--number">39</td>
            <td class="cell--number">0</td>
            <td class="cell--number">39</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#3e4ac5f4ffd531b9fd6a12566d2be5fad25a8d9f" class="src_link" title="app/models/feedback.rb">app/models/feedback.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">20</td>
            <td class="cell--number">16</td>
            <td class="cell--number">0</td>
            <td class="cell--number">16</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#91a7c071cbd13538d3dc6243d5fe70e3e383b24f" class="src_link" title="app/models/interview_preset.rb">app/models/interview_preset.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.15 %</td>
            <td class="cell--number">42</td>
            <td class="cell--number">26</td>
            <td class="cell--number">25</td>
            <td class="cell--number">1</td>
            <td class="cell--number">2.65</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#0e12cfe302f944e7f55573407476c3f564fba364" class="src_link" title="app/models/log_entry.rb">app/models/log_entry.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">12</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9d3912ed872eb1a86c3b4d6600e18d4a2b3b2f55" class="src_link" title="app/models/polly_audio_clip.rb">app/models/polly_audio_clip.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">72</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0</td>
            <td class="cell--number">57</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d89136bc34ca3ff92d9084407437bd7014058d15" class="src_link" title="app/models/preset_question.rb">app/models/preset_question.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">86.67 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">15</td>
            <td class="cell--number">13</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.87</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b3b41a590beb21599f12007ee1bd1031a10a9895" class="src_link" title="app/models/project.rb">app/models/project.rb</a></td>
            <td class="red strong cell--number t-file__coverage">51.32 %</td>
            <td class="cell--number">175</td>
            <td class="cell--number">76</td>
            <td class="cell--number">39</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.54</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#95e543916cde9baab2ea01501520dc3ce55f1029" class="src_link" title="app/models/question.rb">app/models/question.rb</a></td>
            <td class="red strong cell--number t-file__coverage">61.76 %</td>
            <td class="cell--number">67</td>
            <td class="cell--number">34</td>
            <td class="cell--number">21</td>
            <td class="cell--number">13</td>
            <td class="cell--number">0.65</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#98d17d0be697f6832c86685d1105e1d9a5a83d4b" class="src_link" title="app/models/section.rb">app/models/section.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">11</td>
            <td class="cell--number">8</td>
            <td class="cell--number">8</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#583304283d71814ac1525e6e37af45cce5df9625" class="src_link" title="app/models/speaker.rb">app/models/speaker.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">18</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2cba90c5cdd93dd2019b1bb1e9d111c45d585a19" class="src_link" title="app/models/tracker.rb">app/models/tracker.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">14</td>
            <td class="cell--number">11</td>
            <td class="cell--number">0</td>
            <td class="cell--number">11</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c1a3cdc67b29de58400297074b37a1cd33892c94" class="src_link" title="app/models/transcript.rb">app/models/transcript.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">44</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#58a4fe0f991a4557f7f37c575984c49a35c1e45b" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">90.00 %</td>
            <td class="cell--number">38</td>
            <td class="cell--number">20</td>
            <td class="cell--number">18</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2.35</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9d532dfe99f3e60b04269ef9ddbb6557b55ab7f9" class="src_link" title="app/models/user_data_export.rb">app/models/user_data_export.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">83</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#97772cf93c152900e49fafcf0458e40a050846ce" class="src_link" title="app/models/user_shown_interview_preset.rb">app/models/user_shown_interview_preset.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">83.33 %</td>
            <td class="cell--number">19</td>
            <td class="cell--number">12</td>
            <td class="cell--number">10</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.83</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Mailers"></a>

  <div>
    <b>2</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>41</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>41</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#70b8d8d2c8b2a84838e3af3cb42c907f15cc5c96" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#d12c787353378b943b7e269761173a69cdc72397" class="src_link" title="app/mailers/user_data_export_mailer.rb">app/mailers/user_data_export_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">45</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="yellow">
         1.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Helpers"></a>

  <div>
    <b>3</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>3</b> relevant lines,
    <span class="green"><b>3</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a82e1062c20702ef73b545af678e28c7710a9f14" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#c56ceeb6623cb3382123fe535cf2b455dfb363c1" class="src_link" title="app/helpers/home_helper.rb">app/helpers/home_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8345edd5d7292b23889c6295df4c13ff0354c1b1" class="src_link" title="app/helpers/projects_helper.rb">app/helpers/projects_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Jobs"></a>

  <div>
    <b>11</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>746</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>746</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9f82b619045a78e7bbeee0182b9fff9474fe4398" class="src_link" title="app/jobs/account_deletion_job.rb">app/jobs/account_deletion_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">115</td>
            <td class="cell--number">75</td>
            <td class="cell--number">0</td>
            <td class="cell--number">75</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e4652e9b218159a214fe070c5a632d37a1ab95dc" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4800f671a117151388a3c5074722729efe7fd117" class="src_link" title="app/jobs/data_export_job.rb">app/jobs/data_export_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">27</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0</td>
            <td class="cell--number">18</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#715ec0adf7f1dcb6bdcc3298eac52b0017d6876c" class="src_link" title="app/jobs/finalize_transcript_job.rb">app/jobs/finalize_transcript_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">22</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ac61f2f2aaf97948529349de13ecdc5c43352677" class="src_link" title="app/jobs/generate_followup_questions_job.rb">app/jobs/generate_followup_questions_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">85</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5fd907f3e81b3df467999a3067ace00b8cff71bb" class="src_link" title="app/jobs/outline_generation_job.rb">app/jobs/outline_generation_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">140</td>
            <td class="cell--number">107</td>
            <td class="cell--number">0</td>
            <td class="cell--number">107</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e22cf7e5fd9f99f556ae2fc7c1dd1b8e710b1947" class="src_link" title="app/jobs/podcast_export_job.rb">app/jobs/podcast_export_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">247</td>
            <td class="cell--number">171</td>
            <td class="cell--number">0</td>
            <td class="cell--number">171</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#fa1e4ee9efb68f030cd4b3f778151418ed6fdc56" class="src_link" title="app/jobs/polly_generation_job.rb">app/jobs/polly_generation_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">74</td>
            <td class="cell--number">55</td>
            <td class="cell--number">0</td>
            <td class="cell--number">55</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b738af0cd87d5b357043abaa948fb5f768ed4c77" class="src_link" title="app/jobs/transcript_editing_job.rb">app/jobs/transcript_editing_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">170</td>
            <td class="cell--number">128</td>
            <td class="cell--number">0</td>
            <td class="cell--number">128</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8bd487ded651604d20ff74ce3c0b58357db0869f" class="src_link" title="app/jobs/transcription_job.rb">app/jobs/transcription_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">46</td>
            <td class="cell--number">33</td>
            <td class="cell--number">0</td>
            <td class="cell--number">33</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#31c42e5d466bf1717cff43de862f964a6926ae67" class="src_link" title="app/jobs/unlimited_questions_generation_job.rb">app/jobs/unlimited_questions_generation_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">110</td>
            <td class="cell--number">81</td>
            <td class="cell--number">0</td>
            <td class="cell--number">81</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Libraries"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Services">
  <h2>
    <span class="group_name">Services</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Services"></a>

  <div>
    <b>24</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>4036</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>4036</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#1fa2f6a7629760f0729ef866f95dd6eef8f37026" class="src_link" title="app/services/aws/polly_service.rb">app/services/aws/polly_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">368</td>
            <td class="cell--number">269</td>
            <td class="cell--number">0</td>
            <td class="cell--number">269</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#6a46c71b198818c0b81689711792a17b778fe071" class="src_link" title="app/services/gemini_content_analysis_service.rb">app/services/gemini_content_analysis_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">511</td>
            <td class="cell--number">351</td>
            <td class="cell--number">0</td>
            <td class="cell--number">351</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#681d02ba100dff236efac2340176b090351645db" class="src_link" title="app/services/gemini_quote_extraction_service.rb">app/services/gemini_quote_extraction_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">148</td>
            <td class="cell--number">115</td>
            <td class="cell--number">0</td>
            <td class="cell--number">115</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8c640ccaa38b16c1d4a4d0c6522e4b8ef7a6292a" class="src_link" title="app/services/gemini_service.rb">app/services/gemini_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">79</td>
            <td class="cell--number">62</td>
            <td class="cell--number">0</td>
            <td class="cell--number">62</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#99d9dc4d25b1ed71a85ebdd8e49dfe8a6c16c1ad" class="src_link" title="app/services/gemini_text_polishing_service.rb">app/services/gemini_text_polishing_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">189</td>
            <td class="cell--number">145</td>
            <td class="cell--number">0</td>
            <td class="cell--number">145</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f4b936095d50fbcf430b064ebba077696334dc61" class="src_link" title="app/services/image_apis/base_image_client.rb">app/services/image_apis/base_image_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">37</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b37cad1ebfd987f7632d2cc77acc514bd62b55ef" class="src_link" title="app/services/image_apis/image_service_bus.rb">app/services/image_apis/image_service_bus.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">266</td>
            <td class="cell--number">186</td>
            <td class="cell--number">0</td>
            <td class="cell--number">186</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#98638beb2d8023e188703138b45e1afc72d52ea3" class="src_link" title="app/services/image_apis/lorem_picsum_client.rb">app/services/image_apis/lorem_picsum_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">34</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0</td>
            <td class="cell--number">32</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#47e70a90b34a8cb4f111c1d6740f069605fc5a3d" class="src_link" title="app/services/image_apis/openverse_client.rb">app/services/image_apis/openverse_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">39</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0</td>
            <td class="cell--number">37</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a5bef94f5c17b4a8f5fe6a6510bedf5a12a680fa" class="src_link" title="app/services/image_apis/pexels_client.rb">app/services/image_apis/pexels_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">52</td>
            <td class="cell--number">42</td>
            <td class="cell--number">0</td>
            <td class="cell--number">42</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2a430e8ab6e04f5ac1f649d79327d1cdda571446" class="src_link" title="app/services/image_apis/pixabay_client.rb">app/services/image_apis/pixabay_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">84</td>
            <td class="cell--number">62</td>
            <td class="cell--number">0</td>
            <td class="cell--number">62</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#777f3b0e8dc11a0f5c3864f57300766e6530a78a" class="src_link" title="app/services/image_apis/unsplash_client.rb">app/services/image_apis/unsplash_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">85</td>
            <td class="cell--number">61</td>
            <td class="cell--number">0</td>
            <td class="cell--number">61</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2cf847907eba6cf8250176fe73a059a51b67dd6a" class="src_link" title="app/services/image_apis/wikimedia_client.rb">app/services/image_apis/wikimedia_client.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">193</td>
            <td class="cell--number">155</td>
            <td class="cell--number">0</td>
            <td class="cell--number">155</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#40b254911a3e28d5457e88a551f95d7c22cfcdab" class="src_link" title="app/services/interview_flow_service.rb">app/services/interview_flow_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">180</td>
            <td class="cell--number">123</td>
            <td class="cell--number">0</td>
            <td class="cell--number">123</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8567ce1cc767c0a0d3242b757144b6a1006f2697" class="src_link" title="app/services/interview_question_service.rb">app/services/interview_question_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">533</td>
            <td class="cell--number">410</td>
            <td class="cell--number">0</td>
            <td class="cell--number">410</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#6aaf8bb6e19fb8ec450f6da2e5e60435f8bd476e" class="src_link" title="app/services/jwt_service.rb">app/services/jwt_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">46</td>
            <td class="cell--number">38</td>
            <td class="cell--number">0</td>
            <td class="cell--number">38</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ef02a77a6146c164c330122481c2e1ae738baf18" class="src_link" title="app/services/performance_tracker.rb">app/services/performance_tracker.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">281</td>
            <td class="cell--number">221</td>
            <td class="cell--number">0</td>
            <td class="cell--number">221</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ef3b4db87c402afe406f59555207dc469386fc2e" class="src_link" title="app/services/preset_questions_importer.rb">app/services/preset_questions_importer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">167</td>
            <td class="cell--number">133</td>
            <td class="cell--number">0</td>
            <td class="cell--number">133</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cb0b6816d0350dd2cc7ed699bb2e62b87391b3f9" class="src_link" title="app/services/runware_service.rb">app/services/runware_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">238</td>
            <td class="cell--number">130</td>
            <td class="cell--number">0</td>
            <td class="cell--number">130</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#dcdbafec3c5b1946fff32e7431827c0194d0ecb4" class="src_link" title="app/services/s3_service.rb">app/services/s3_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">492</td>
            <td class="cell--number">406</td>
            <td class="cell--number">0</td>
            <td class="cell--number">406</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#490a4684f17592695cbfe8e1e732d57f3a2c4a10" class="src_link" title="app/services/transcript_content_assembler_service.rb">app/services/transcript_content_assembler_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">273</td>
            <td class="cell--number">195</td>
            <td class="cell--number">0</td>
            <td class="cell--number">195</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a15d656496ad5c44b661239217ce5ead18a9ecdb" class="src_link" title="app/services/transcription_service.rb">app/services/transcription_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">456</td>
            <td class="cell--number">354</td>
            <td class="cell--number">0</td>
            <td class="cell--number">354</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#52882c73ad5556576f9ed7b831d0c6e8e0c9e69a" class="src_link" title="app/services/user_data_export_service.rb">app/services/user_data_export_service.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">512</td>
            <td class="cell--number">418</td>
            <td class="cell--number">0</td>
            <td class="cell--number">418</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#cf583b717d2b7683b80f90ce524ba73524a5eb72" class="src_link" title="app/services/voice_demo_generator.rb">app/services/voice_demo_generator.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">71</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0</td>
            <td class="cell--number">59</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Views">
  <h2>
    <span class="group_name">Views</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Views"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
      </div>

      <div id="footer">
        Generated by <a href="https://github.com/simplecov-ruby/simplecov">simplecov</a> v0.21.2
        and simplecov-html v0.13.1<br/>
        using RSpec
      </div>

      <div class="source_files">
      
        <div class="source_table" id="cd62a2b2f4b0fe6f0d3e5c7bbaad34fa7821789f">
  <div class="header">
    <h3>app/controllers/api/audio_segments_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>136</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>136</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::AudioSegmentsController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  include ErrorResponder</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  before_action :set_project</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Test Harness Status:  Comprehensive test coverage with happy/sad paths</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  def upload_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    audio_segment = @project.audio_segments.build(audio_segment_params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    audio_segment.upload_status = &#39;pending&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    if audio_segment.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      # Generate S3 pre-signed URL using centralized service</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      s3_service = S3Service.new(current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      s3_result = s3_service.generate_upload_url(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">        record_id: audio_segment.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">        record_type: &#39;audio_segment&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">        filename: audio_segment.file_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">        content_type: audio_segment.mime_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">        expires_in: 3600</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">        audio_segment_id: audio_segment.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        upload_url: s3_result[:url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">        expires_at: 1.hour.from_now.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">        audio_segment.errors.full_messages.join(&quot;, &quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">        &quot;VALIDATION_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        :bad_request,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">        { field_errors: audio_segment.errors.as_json }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">  def upload_complete</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      audio_segment = @project.audio_segments.find(params[:audio_segment_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">        &quot;Audio segment not found&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">        &quot;SEGMENT_NOT_FOUND&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    if params[:upload_status] == &#39;success&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      audio_segment.update!(upload_status: &#39;success&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      # Trigger transcription processing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      TranscriptionService.trigger_transcription_job(audio_segment.id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        message: &#39;Audio segment processing initiated&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        status: &#39;processing_started&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      audio_segment.update!(upload_status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">        params[:error_message] || &#39;Upload failed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">        &quot;UPLOAD_FAILED&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">        :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">  def playback_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      audio_segment = @project.audio_segments.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        &quot;Audio segment not found&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">        &quot;SEGMENT_NOT_FOUND&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">        :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    # Only allow playback for successfully uploaded segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    unless audio_segment.upload_status == &#39;success&#39; || audio_segment.upload_status == &#39;transcribed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">      return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">        &#39;Audio segment not available for playback&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">        &quot;SEGMENT_NOT_AVAILABLE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">        :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">      s3_service = S3Service.new(current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      playback_url = s3_service.generate_playback_url(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">        record_id: audio_segment.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">        record_type: &#39;audio_segment&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">        filename: audio_segment.file_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">        content_type: audio_segment.mime_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">        expires_in: 3600</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">        playback_url: playback_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">        expires_at: 1.hour.from_now.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">        duration: audio_segment.duration_seconds,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">        file_name: audio_segment.file_name</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">      Rails.logger.error &quot;Failed to generate playback URL: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">        &#39;Unable to generate playback URL&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">        &quot;PLAYBACK_URL_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">        :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">  def transcription_details</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">      audio_segment = @project.audio_segments.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">    rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">        &quot;Audio segment not found&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">        &quot;SEGMENT_NOT_FOUND&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">        :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">    unless audio_segment.transcribed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">        &quot;Transcription not available for this audio segment&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">        &quot;TRANSCRIPTION_NOT_AVAILABLE&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">        :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">    # Return the detailed transcription data with word-level timestamps</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">    transcription_data = audio_segment.transcription_data || {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">      words: transcription_data[&#39;words&#39;] || [],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      duration: audio_segment.duration_seconds,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">      full_text: audio_segment.transcription_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">      status: &#39;success&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">  def set_project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    unless current_user.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">      return render json: { error: &#39;Authentication required to access project data.&#39; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    @project = current_user.projects.find(params[:project_id] || params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">    render json: { error: &#39;Project not found or you do not have access to it.&#39; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">  def audio_segment_params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">    params.permit(:file_name, :mime_type, :recorded_duration_seconds, :question_id).tap do |permitted|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">      permitted[:duration_seconds] = permitted.delete(:recorded_duration_seconds) if permitted[:recorded_duration_seconds]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e08663247523cdd1b9df30cbec9958c7669e8d9a">
  <div class="header">
    <h3>app/controllers/api/auth_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>147</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>147</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::AuthController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  skip_before_action :authenticate_api_request!, only: [:register, :login, :refresh]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # Test Harness Status:  Comprehensive test coverage with happy/sad paths</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  def register</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] Registration attempt for email: #{params[:user][:email] rescue &#39;unknown&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] User params received: #{user_params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    user = User.new(user_params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] User object created, valid: #{user.valid?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    if user.valid?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] User validation passed, attempting save...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      Rails.logger.warn &quot; [RAILS_AUTH] User validation failed: #{user.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    if user.save</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] User saved successfully with ID: #{user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Generating token pair...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      tokens = JwtService.generate_token_pair(user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Tokens generated - AccessToken length: #{tokens[:access_token].length}, RefreshToken length: #{tokens[:refresh_token].length}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Updating user with refresh token digest...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      user.update!(refresh_token_digest: BCrypt::Password.create(tokens[:refresh_token]))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Refresh token digest stored successfully&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      pp tokens</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      response_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        user: user_response(user),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">        access_token: tokens[:access_token],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        refresh_token: tokens[:refresh_token]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      pp response_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Registration response prepared - User ID: #{response_data[:user][:id]}, Email: #{response_data[:user][:email]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Response includes access_token: #{response_data[:access_token].present?}, refresh_token: #{response_data[:refresh_token].present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      render json: response_data, status: :created</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      Rails.logger.warn &quot; [RAILS_AUTH] User save failed: #{user.errors.full_messages}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      pp user.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      render json: { errors: user.errors.full_messages }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    Rails.logger.error &quot; [RAILS_AUTH] Registration exception: #{e.class.name} - #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    Rails.logger.error &quot; [RAILS_AUTH] Backtrace: #{e.backtrace.first(5).join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    render json: { error: &#39;Registration failed&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">  # Test Harness Status:  Comprehensive test coverage with happy/sad paths</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">  def login</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    email = params[:email]&amp;.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] Login attempt for email: #{email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] Password provided: #{params[:password].present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    user = User.find_by(email: email)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] User found: #{user.present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    if user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] User exists (ID: #{user.id}), attempting authentication...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      auth_result = user.authenticate(params[:password])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Authentication result: #{auth_result.present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      Rails.logger.warn &quot; [RAILS_AUTH] No user found with email: #{email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    if user&amp;.authenticate(params[:password])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Authentication successful, generating tokens...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      tokens = JwtService.generate_token_pair(user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Tokens generated - AccessToken length: #{tokens[:access_token].length}, RefreshToken length: #{tokens[:refresh_token].length}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Updating user with refresh token digest...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      user.update!(refresh_token_digest: BCrypt::Password.create(tokens[:refresh_token]))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Refresh token digest stored successfully&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">      response_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">        user: user_response(user),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">        access_token: tokens[:access_token],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">        refresh_token: tokens[:refresh_token]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Login response prepared - User ID: #{response_data[:user][:id]}, Email: #{response_data[:user][:email]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Response includes access_token: #{response_data[:access_token].present?}, refresh_token: #{response_data[:refresh_token].present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">      render json: response_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">      Rails.logger.warn &quot; [RAILS_AUTH] Login failed - invalid credentials for email: #{email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      render json: { error: &#39;Invalid email or password&#39; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    Rails.logger.error &quot; [RAILS_AUTH] Login exception: #{e.class.name} - #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">    Rails.logger.error &quot; [RAILS_AUTH] Backtrace: #{e.backtrace.first(5).join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    render json: { error: &#39;Login failed&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">  # Test Harness Status:  Comprehensive test coverage with happy/sad paths</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">  def refresh</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] Token refresh attempt&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] Refresh token provided: #{params[:refresh_token].present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Decoding refresh token...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">      refresh_payload = JwtService.decode_token(params[:refresh_token])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Token decoded successfully, type: #{refresh_payload[&#39;type&#39;]}, user_id: #{refresh_payload[&#39;user_id&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">      unless refresh_payload[&#39;type&#39;] == &#39;refresh&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">        Rails.logger.warn &quot; [RAILS_AUTH] Invalid token type: #{refresh_payload[&#39;type&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">        return render json: { error: &#39;Invalid token type&#39; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Finding user with ID: #{refresh_payload[&#39;user_id&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      user = User.find(refresh_payload[&#39;user_id&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] User found: #{user.email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">      # Verify the refresh token matches what we have stored</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Verifying refresh token against stored digest...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">      token_valid = user.refresh_token_digest &amp;&amp; BCrypt::Password.new(user.refresh_token_digest) == params[:refresh_token]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Token verification result: #{token_valid}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      unless token_valid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">        Rails.logger.warn &quot; [RAILS_AUTH] Refresh token verification failed for user: #{user.email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">        return render json: { error: &#39;Invalid refresh token&#39; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Generating new token pair...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      tokens = JwtService.generate_token_pair(user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] New tokens generated - AccessToken length: #{tokens[:access_token].length}, RefreshToken length: #{tokens[:refresh_token].length}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Updating refresh token digest...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">      user.update!(refresh_token_digest: BCrypt::Password.create(tokens[:refresh_token]))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Refresh token digest updated successfully&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">      response_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">        access_token: tokens[:access_token],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">        refresh_token: tokens[:refresh_token]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Refresh response prepared - includes access_token: #{response_data[:access_token].present?}, refresh_token: #{response_data[:refresh_token].present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">      render json: response_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">      Rails.logger.error &quot; [RAILS_AUTH] Token refresh exception: #{e.class.name} - #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">      Rails.logger.error &quot; [RAILS_AUTH] Backtrace: #{e.backtrace.first(5).join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">      render json: { error: &#39;Token refresh failed&#39; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">  # Test Harness Status:  Comprehensive test coverage with happy/sad paths</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">  def logout</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] Logout attempt&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] Current user present: #{current_user.present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">    if current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Logging out user: #{current_user.email} (ID: #{current_user.id})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Clearing refresh token digest...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">      current_user.update!(refresh_token_digest: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">      Rails.logger.info &quot; [RAILS_AUTH] Refresh token digest cleared successfully&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">      render json: { message: &#39;Logged out successfully&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      Rails.logger.warn &quot; [RAILS_AUTH] Logout attempt without authenticated user&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">      render json: { error: &#39;Not logged in&#39; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">  def user_params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">    params.require(:user).permit(:email, :password, :password_confirmation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">  def user_response(user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] Building user response for ID: #{user.id}, Email: #{user.email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] User created_at: #{user.created_at}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">    response = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">      id: user.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">      email: user.email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">      created_at: user.created_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">      interests: user.interests || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">    Rails.logger.info &quot; [RAILS_AUTH] User response built: #{response.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">    response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c253432a39914f607841e1a12b739ddd7b97d57e">
  <div class="header">
    <h3>app/controllers/api/base_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>63</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>63</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::BaseController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  skip_before_action :verify_authenticity_token</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  skip_before_action :authenticate_user!, raise: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  before_action :authenticate_api_request!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  # Authentication for all API endpoints</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def authenticate_api_request!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== API AUTHENTICATION DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Request path: #{request.path}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Request method: #{request.method}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Authorization header: #{request.headers[&#39;Authorization&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    Rails.logger.debug &quot;All headers: #{request.headers.to_h.select { |k,v| k.downcase.include?(&#39;auth&#39;) }}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    # Skip authentication in development/test if bypass flag is set</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    if (Rails.env.development? || Rails.env.test?) &amp;&amp; ENV[&#39;DEV_SKIP_AUTH&#39;] == &#39;true&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Skipping auth due to DEV_SKIP_AUTH flag&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      # Set a default user for tests - use the first user or create one</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      @current_user = User.first || User.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">        email: &#39;test@example.com&#39;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">        password: &#39;password123&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">        admin: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      return </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    token = extract_token_from_header</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Extracted token: #{token ? &#39;[PRESENT]&#39; : &#39;[MISSING]&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    unless token</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      Rails.logger.debug &quot;No token found, rendering unauthorized&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      return render_unauthorized(&#39;Missing authorization token&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      decoded_token = JwtService.decode_token(token)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Decoded token: #{decoded_token.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      unless decoded_token[&#39;type&#39;] == &#39;access&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">        Rails.logger.debug &quot;Invalid token type: #{decoded_token[&#39;type&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">        return render_unauthorized(&#39;Invalid token type&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      user_id = decoded_token[&#39;user_id&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Looking up user with ID: #{user_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">      @current_user = User.find_by(id: user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      unless @current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">        Rails.logger.debug &quot;User not found with ID: #{user_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">        return render_unauthorized(&#39;User not found&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Authentication successful for user: #{@current_user.email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      Rails.logger.error &quot;Authentication failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      render_unauthorized(&#39;Invalid or expired token&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">  def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    @current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">  def render_unauthorized(message = &#39;Unauthorized&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      message: message, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      code: &#39;UNAUTHORIZED&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      details: {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">  def extract_token_from_header</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    authorization_header = request.headers[&#39;Authorization&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    return nil unless authorization_header</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    # Extract token from &quot;Bearer &lt;token&gt;&quot; format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    authorization_header.split(&#39; &#39;).last if authorization_header.start_with?(&#39;Bearer &#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e35574fdced837f3c7d2e5893136906f9e837103">
  <div class="header">
    <h3>app/controllers/api/device_logs_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>76</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>76</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::DeviceLogsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :authenticate_user!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # POST /api/device_logs/presigned_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  def presigned_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    expires_in = params[:expires_in] || 3600</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    content_type = params[:content_type] || &#39;text/plain&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    # Generate unique key for the log file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    timestamp = Time.current.strftime(&#39;%Y%m%d_%H%M%S&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    device_id = params[:device_id] || &#39;unknown&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    log_type = params[:log_type] || &#39;manual&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    key = &quot;device_logs/user_#{current_user.id}/#{device_id}/#{log_type}_#{timestamp}_#{SecureRandom.hex(4)}.log&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    # Generate presigned URL for upload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    s3 = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      region: ENV[&#39;AWS_REGION&#39;] || &#39;us-east-1&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      access_key_id: ENV[&#39;AWS_ACCESS_KEY_ID&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      secret_access_key: ENV[&#39;AWS_SECRET_ACCESS_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    bucket = ENV[&#39;S3_USER_CONTENT_BUCKET&#39;] || &#39;inkra-user-content&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    signer = Aws::S3::Presigner.new(client: s3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    presigned_url = signer.presigned_url(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      :put_object,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      bucket: bucket,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      expires_in: expires_in.to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      content_type: content_type</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    # Create DeviceLog record</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    device_log = current_user.device_logs.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      s3_url: &quot;s3://#{bucket}/#{key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      device_id: device_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      build_version: params[:build_version],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      os_version: params[:os_version],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      log_type: log_type</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      upload_url: presigned_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      log_id: device_log.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      s3_key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      expires_at: Time.current + expires_in.to_i.seconds</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to generate presigned URL: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    render json: { error: &#39;Failed to generate upload URL&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">  # POST /api/device_logs/:id/confirm_upload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">  def confirm_upload</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    device_log = current_user.device_logs.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    device_log.update!(uploaded_at: Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    render json: { success: true, log_id: device_log.id }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    render json: { error: &#39;Log not found&#39; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">  # GET /api/device_logs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    logs = current_user.device_logs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">                       .recent</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">                       .page(params[:page])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">                       .per(params[:per_page] || 20)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    render json: logs.map { |log|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">        id: log.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        device_id: log.device_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">        build_version: log.build_version,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">        os_version: log.os_version,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">        log_type: log.log_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">        uploaded_at: log.uploaded_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">        created_at: log.created_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">  # GET /api/device_logs/:id/download_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">  def download_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    device_log = current_user.device_logs.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    presigned_url = device_log.send(:presigned_url, expires_in: 3600)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    if presigned_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      render json: { download_url: presigned_url, expires_in: 3600 }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">      render json: { error: &#39;Failed to generate download URL&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    render json: { error: &#39;Log not found&#39; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4a9ba860a4fb4621cf5cdbb7a310463238ab6938">
  <div class="header">
    <h3>app/controllers/api/exports_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>567</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>567</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::ExportsController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  include ErrorResponder</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  before_action :set_project</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Export project transcript as PDF</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  def pdf</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    export_data = generate_export_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    pdf_content = generate_pdf(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    send_data pdf_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      filename: generate_project_filename(&#39;pdf&#39;, export_data),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      type: &#39;application/pdf&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      disposition: &#39;attachment&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  # Export project transcript as DOCX</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">  def docx</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    export_data = generate_export_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    docx_content = generate_docx(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    send_data docx_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      filename: generate_project_filename(&#39;docx&#39;, export_data),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      type: &#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      disposition: &#39;attachment&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  # Export project transcript as TXT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">  def txt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    export_data = generate_export_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    txt_content = generate_txt(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    send_data txt_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      filename: generate_project_filename(&#39;txt&#39;, export_data),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      type: &#39;text/plain&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      disposition: &#39;attachment&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  # Export project transcript as CSV</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  def csv</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    export_data = generate_export_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    csv_content = generate_csv(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    send_data csv_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      filename: generate_project_filename(&#39;csv&#39;, export_data),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      type: &#39;text/csv&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      disposition: &#39;attachment&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  # Get export preview data (JSON)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">  def preview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    export_data = generate_export_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      project: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        title: @project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">        topic: @project.topic,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">        created_at: @project.created_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">        status: @project.status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      outline: export_data[:outline],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      transcript: export_data[:transcript],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      raw_text: export_data[:raw_text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      polished_text: export_data[:polished_text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      statistics: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">        total_questions: export_data[:statistics][:total_questions],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">        answered_questions: export_data[:statistics][:answered_questions],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">        total_recording_time: export_data[:statistics][:total_recording_time],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">        total_words: export_data[:statistics][:total_words]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">  # Export podcast audio - start background job to stitch audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">  def podcast</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">    # Check if project has any audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    audio_segments = @project.audio_segments.where.not(audio_file_key: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    if audio_segments.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">        error: &quot;No audio segments available for podcast export&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">        message: &quot;This project doesn&#39;t have any recorded audio to export.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">    # Start background job to create the podcast</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    job_id = PodcastExportJob.perform_async(@project.id, current_user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">      job_id: job_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">      message: &quot;Podcast export started. This may take a few minutes to process.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      total_segments: audio_segments.count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      estimated_duration: format_duration(audio_segments.sum(:duration_seconds))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    Rails.logger.error &quot;Podcast export failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">    Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">    render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">      error: &quot;Failed to start podcast export&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      message: e.message </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">  # Check podcast export status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">  def podcast_status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">    job_id = params[:job_id]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    unless job_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      render json: { error: &quot;Job ID is required&quot; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">    # Check Sidekiq job status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">    if Sidekiq::Status.exists?(job_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      status = Sidekiq::Status.status(job_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      progress = Sidekiq::Status.pct_complete(job_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      case status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">      when &#39;complete&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">        # Get the result from Redis or database</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">        result = Sidekiq::Status.get_all(job_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">          status: &#39;completed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">          progress: 100,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">          download_url: result[&#39;download_url&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">          filename: result[&#39;filename&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">          file_size: result[&#39;file_size&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">          duration: result[&#39;duration&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">      when &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">        error_message = Sidekiq::Status.get_all(job_id)[&#39;error&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">          status: &#39;failed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">          progress: progress,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">          error: error_message || &#39;Unknown error occurred&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">        current_step = Sidekiq::Status.get_all(job_id)[&#39;current_step&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">          status: status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">          progress: progress,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">          current_step: current_step || &#39;Processing audio segments&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">        status: &#39;not_found&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">        error: &#39;Job not found or has expired&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">      }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    Rails.logger.error &quot;Podcast status check failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">    render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">      error: &quot;Failed to check podcast status&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">      message: e.message </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">    }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">  # Generate shareable link for export</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">  def share_link</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">    export_data = generate_export_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">    format = params[:format] || &#39;txt&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">    # Generate content based on format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">    content = case format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">              when &#39;csv&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">                generate_csv(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">              when &#39;pdf&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">                generate_pdf(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">              when &#39;docx&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">                generate_docx(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">              else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">                generate_txt(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">    # Generate filename</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">    filename = generate_project_filename(format, export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">    # Store in S3 and get shareable URL</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">    s3_service = S3Service.new(current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">    s3_result = s3_service.store_export_file(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">      content: content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">      filename: filename,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">      project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">      format: format,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">      expires_in: 7.days</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">      share_url: s3_result[:share_url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">      filename: filename,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">      expires_at: (Time.current + 7.days).iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">      format: format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">    Rails.logger.error &quot;Share link generation failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">    Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">    render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">      error: &quot;Failed to generate share link&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">      message: e.message </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">    }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">  def set_project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">    @project = current_user.projects.find(params[:project_id] || params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">    render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">      &quot;Project not found&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">      &quot;PROJECT_NOT_FOUND&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">      :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">  def generate_export_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby">    # Get transcript version from params (default to &#39;edited&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">    transcript_version = params[:transcript_version] || &#39;edited&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">    include_outline = params[:include_outline] != &#39;false&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">    include_transcript = params[:include_transcript] != &#39;false&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">    include_questions = params[:include_questions] != &#39;false&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            

            <code class="ruby">      # Get basic project data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="230">
            

            

            <code class="ruby">      outline = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">      if include_outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">        chapters = @project.chapters.includes(sections: :questions)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">        outline = chapters.map do |chapter|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">            title: chapter.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">            order: chapter.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">            omitted: chapter.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">            sections: chapter.sections.map do |section|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">                title: section.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">                order: section.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="243">
            

            

            <code class="ruby">                omitted: section.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">                questions: section.questions.map do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">                  {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">                    question_id: question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">                    text: question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">                    order: question.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">                    omitted: question.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">                    audio_segments: question.audio_segments.map do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">                      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">                        id: segment.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">                        transcription_text: segment.transcription_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">                        duration_seconds: segment.duration_seconds</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">                      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="256">
            

            

            <code class="ruby">                    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">                  }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="258">
            

            

            <code class="ruby">                end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="265">
            

            

            <code class="ruby">      # Get transcript data based on version</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">      transcript = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">      raw_text = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">      polished_text = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">      if include_transcript &amp;&amp; @project.transcript</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="271">
            

            

            <code class="ruby">        # Get the complete text versions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">        raw_text = @project.transcript.raw_content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">        polished_text = @project.transcript.polished_content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="274">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            

            <code class="ruby">        # For backward compatibility, also provide structured content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">        if transcript_version == &#39;raw&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">          transcript = @project.transcript.raw_structured_content_json || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="278">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">          transcript = @project.transcript.edited_content_json || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="282">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="283">
            

            

            <code class="ruby">      # Calculate basic statistics</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="284">
            

            

            <code class="ruby">      total_questions = @project.questions.count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="285">
            

            

            <code class="ruby">      total_audio_segments = @project.audio_segments.count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="286">
            

            

            <code class="ruby">      total_recording_time = @project.audio_segments.sum(:duration_seconds) || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="287">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="288">
            

            

            <code class="ruby">      # Calculate word count based on available transcript content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="289">
            

            

            <code class="ruby">      total_words = 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="290">
            

            

            <code class="ruby">      if polished_text.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">        total_words = polished_text.split(/\s+/).length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">      elsif raw_text.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">        total_words = raw_text.split(/\s+/).length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="294">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="295">
            

            

            <code class="ruby">        total_words = estimate_word_count(transcript)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="296">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="298">
            

            

            <code class="ruby">      statistics = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">        total_questions: total_questions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">        answered_questions: total_audio_segments,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="301">
            

            

            <code class="ruby">        total_recording_time: total_recording_time,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="302">
            

            

            <code class="ruby">        total_words: total_words</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="303">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="304">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="305">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="306">
            

            

            <code class="ruby">        outline: outline,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="307">
            

            

            <code class="ruby">        transcript: transcript,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="308">
            

            

            <code class="ruby">        raw_text: raw_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="309">
            

            

            <code class="ruby">        polished_text: polished_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="310">
            

            

            <code class="ruby">        statistics: statistics,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="311">
            

            

            <code class="ruby">        transcript_version: transcript_version,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">        include_questions: include_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="313">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="314">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="315">
            

            

            <code class="ruby">      Rails.logger.error &quot;Export data generation failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="316">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="317">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="318">
            

            

            <code class="ruby">      # Return minimal data structure</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="319">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="320">
            

            

            <code class="ruby">        outline: [],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="321">
            

            

            <code class="ruby">        transcript: [],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="322">
            

            

            <code class="ruby">        raw_text: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="323">
            

            

            <code class="ruby">        polished_text: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="324">
            

            

            <code class="ruby">        statistics: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="325">
            

            

            <code class="ruby">          total_questions: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="326">
            

            

            <code class="ruby">          answered_questions: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="327">
            

            

            <code class="ruby">          total_recording_time: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="328">
            

            

            <code class="ruby">          total_words: 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="329">
            

            

            <code class="ruby">        },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="330">
            

            

            <code class="ruby">        transcript_version: transcript_version,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="331">
            

            

            <code class="ruby">        include_questions: include_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="332">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="333">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="334">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="335">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="336">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="337">
            

            

            <code class="ruby">  def generate_pdf(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="338">
            

            

            <code class="ruby">    # Simple PDF generation using HTML to PDF approach</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            

            <code class="ruby">    # In production, you&#39;d want to use a proper PDF library like Prawn</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="340">
            

            

            <code class="ruby">    html_content = generate_html_content(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="341">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="342">
            

            

            <code class="ruby">    # For now, return a simple text-based PDF placeholder</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            

            <code class="ruby">    # In production, integrate with a PDF generation service</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="344">
            

            

            <code class="ruby">    &quot;PDF Export Placeholder\n\n#{generate_txt(export_data)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="345">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="346">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="347">
            

            

            <code class="ruby">  def generate_docx(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="348">
            

            

            <code class="ruby">    # DOCX generation placeholder</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="349">
            

            

            <code class="ruby">    # In production, use a library like ruby-docx or integrate with an external service</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="350">
            

            

            <code class="ruby">    &quot;DOCX Export Placeholder\n\n#{generate_txt(export_data)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="351">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="352">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">  def generate_txt(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="354">
            

            

            <code class="ruby">    content = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="355">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="356">
            

            

            <code class="ruby">    # Header</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="357">
            

            

            <code class="ruby">    content &lt;&lt; &quot;#{@project.title}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="358">
            

            

            <code class="ruby">    content &lt;&lt; &quot;=&quot; * @project.title.length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="359">
            

            

            <code class="ruby">    content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="360">
            

            

            <code class="ruby">    content &lt;&lt; &quot;Topic: #{@project.topic}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">    content &lt;&lt; &quot;Generated: #{Time.current.strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">    content &lt;&lt; &quot;Status: #{@project.status.humanize}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="363">
            

            

            <code class="ruby">    content &lt;&lt; &quot;Transcript Version: #{export_data[:transcript_version].humanize}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="364">
            

            

            <code class="ruby">    content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="365">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="366">
            

            

            <code class="ruby">    # Statistics</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="367">
            

            

            <code class="ruby">    stats = export_data[:statistics]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="368">
            

            

            <code class="ruby">    content &lt;&lt; &quot;STATISTICS&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="369">
            

            

            <code class="ruby">    content &lt;&lt; &quot;-&quot; * 10</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="370">
            

            

            <code class="ruby">    content &lt;&lt; &quot;Total Questions: #{stats[:total_questions]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="371">
            

            

            <code class="ruby">    content &lt;&lt; &quot;Answered Questions: #{stats[:answered_questions]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="372">
            

            

            <code class="ruby">    content &lt;&lt; &quot;Total Recording Time: #{format_duration(stats[:total_recording_time])}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="373">
            

            

            <code class="ruby">    content &lt;&lt; &quot;Total Words: #{stats[:total_words]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="374">
            

            

            <code class="ruby">    content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="375">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="376">
            

            

            <code class="ruby">    # Transcript Content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="377">
            

            

            <code class="ruby">    transcript_text = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="378">
            

            

            <code class="ruby">    if export_data[:transcript_version] == &#39;raw&#39; &amp;&amp; export_data[:raw_text].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="379">
            

            

            <code class="ruby">      transcript_text = export_data[:raw_text]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="380">
            

            

            <code class="ruby">    elsif export_data[:polished_text].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="381">
            

            

            <code class="ruby">      transcript_text = export_data[:polished_text]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="382">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="383">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="384">
            

            

            <code class="ruby">    if transcript_text.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="385">
            

            

            <code class="ruby">      content &lt;&lt; &quot;INTERVIEW TRANSCRIPT (#{export_data[:transcript_version].upcase})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="386">
            

            

            <code class="ruby">      content &lt;&lt; &quot;=&quot; * 30</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="387">
            

            

            <code class="ruby">      content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="388">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="389">
            

            

            <code class="ruby">      # If include_questions is true and we have outline data, interleave questions with answers</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="390">
            

            

            <code class="ruby">      if export_data[:include_questions] &amp;&amp; export_data[:outline].any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="391">
            

            

            <code class="ruby">        export_data[:outline].each do |chapter|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="392">
            

            

            <code class="ruby">          next if chapter[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="393">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="394">
            

            

            <code class="ruby">          content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="395">
            

            

            <code class="ruby">          content &lt;&lt; &quot;#{chapter[:title]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="396">
            

            

            <code class="ruby">          content &lt;&lt; &quot;=&quot; * chapter[:title].length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="397">
            

            

            <code class="ruby">          content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="398">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="399">
            

            

            <code class="ruby">          chapter[:sections].each do |section|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="400">
            

            

            <code class="ruby">            next if section[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="401">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="402">
            

            

            <code class="ruby">            content &lt;&lt; &quot;#{section[:title]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="403">
            

            

            <code class="ruby">            content &lt;&lt; &quot;-&quot; * section[:title].length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="404">
            

            

            <code class="ruby">            content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="405">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="406">
            

            

            <code class="ruby">            section[:questions].each do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="407">
            

            

            <code class="ruby">              next if question[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="408">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="409">
            

            

            <code class="ruby">              # Include question text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="410">
            

            

            <code class="ruby">              content &lt;&lt; &quot;Q: #{question[:text]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="411">
            

            

            <code class="ruby">              content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="412">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="413">
            

            

            <code class="ruby">              # Include corresponding answer if available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="414">
            

            

            <code class="ruby">              question[:audio_segments].each do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="415">
            

            

            <code class="ruby">                if segment[:transcription_text].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="416">
            

            

            <code class="ruby">                  content &lt;&lt; segment[:transcription_text]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="417">
            

            

            <code class="ruby">                  content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="418">
            

            

            <code class="ruby">                end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="419">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="420">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="421">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="423">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="424">
            

            

            <code class="ruby">        # Just the transcript without questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="425">
            

            

            <code class="ruby">        content &lt;&lt; transcript_text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="426">
            

            

            <code class="ruby">        content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="427">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="428">
            

            

            <code class="ruby">    elsif export_data[:transcript].any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="429">
            

            

            <code class="ruby">      content &lt;&lt; &quot;INTERVIEW TRANSCRIPT (#{export_data[:transcript_version].upcase})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="430">
            

            

            <code class="ruby">      content &lt;&lt; &quot;=&quot; * 30</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="431">
            

            

            <code class="ruby">      content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="432">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="433">
            

            

            <code class="ruby">      current_chapter = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="434">
            

            

            <code class="ruby">      current_section = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="435">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="436">
            

            

            <code class="ruby">      export_data[:transcript].each do |item|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="437">
            

            

            <code class="ruby">        case item[&#39;type&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="438">
            

            

            <code class="ruby">        when &#39;chapter&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="439">
            

            

            <code class="ruby">          current_chapter = item</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="440">
            

            

            <code class="ruby">          content &lt;&lt; &quot;#{item[&#39;title&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="441">
            

            

            <code class="ruby">          content &lt;&lt; &quot;=&quot; * item[&#39;title&#39;].length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="442">
            

            

            <code class="ruby">          content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="443">
            

            

            <code class="ruby">        when &#39;section&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="444">
            

            

            <code class="ruby">          current_section = item</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="445">
            

            

            <code class="ruby">          content &lt;&lt; &quot;#{item[&#39;title&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="446">
            

            

            <code class="ruby">          content &lt;&lt; &quot;-&quot; * item[&#39;title&#39;].length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="447">
            

            

            <code class="ruby">          content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="448">
            

            

            <code class="ruby">        when &#39;paragraph&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="449">
            

            

            <code class="ruby">          if item[&#39;text&#39;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="450">
            

            

            <code class="ruby">            # If include_questions is true and paragraph has question_id, find and display the question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="451">
            

            

            <code class="ruby">            if export_data[:include_questions] &amp;&amp; item[&#39;question_id&#39;].present? &amp;&amp; export_data[:outline].any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="452">
            

            

            <code class="ruby">              question_text = find_question_text(export_data[:outline], item[&#39;question_id&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="453">
            

            

            <code class="ruby">              if question_text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="454">
            

            

            <code class="ruby">                content &lt;&lt; &quot;Q: #{question_text}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="455">
            

            

            <code class="ruby">                content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="456">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="457">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="458">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="459">
            

            

            <code class="ruby">            content &lt;&lt; item[&#39;text&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="460">
            

            

            <code class="ruby">            content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="461">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="462">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="463">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="464">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="465">
            

            

            <code class="ruby">      content &lt;&lt; &quot;No transcript content available.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="466">
            

            

            <code class="ruby">      content &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="467">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="468">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="469">
            

            

            <code class="ruby">    content.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="470">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="471">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="472">
            

            

            <code class="ruby">  def generate_html_content(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="473">
            

            

            <code class="ruby">    # HTML template for PDF conversion</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="474">
            

            

            <code class="ruby">    html = &lt;&lt;~HTML</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="475">
            

            

            <code class="ruby">      &lt;!DOCTYPE html&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="476">
            

            

            <code class="ruby">      &lt;html&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="477">
            

            

            <code class="ruby">      &lt;head&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="478">
            

            

            <code class="ruby">        &lt;meta charset=&quot;UTF-8&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="479">
            

            

            <code class="ruby">        &lt;title&gt;#{@project.title} - Interview Transcript&lt;/title&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="480">
            

            

            <code class="ruby">        &lt;style&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="481">
            

            

            <code class="ruby">          body { font-family: Arial, sans-serif; margin: 40px; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="482">
            

            

            <code class="ruby">          h1 { color: #333; border-bottom: 2px solid #333; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="483">
            

            

            <code class="ruby">          h2 { color: #666; margin-top: 30px; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="484">
            

            

            <code class="ruby">          h3 { color: #888; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="485">
            

            

            <code class="ruby">          .question { margin: 20px 0; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="486">
            

            

            <code class="ruby">          .answer { margin-left: 20px; background: #f5f5f5; padding: 10px; border-radius: 5px; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="487">
            

            

            <code class="ruby">          .metadata { color: #888; font-size: 0.9em; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="488">
            

            

            <code class="ruby">          .stats { background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 20px 0; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="489">
            

            

            <code class="ruby">        &lt;/style&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="490">
            

            

            <code class="ruby">      &lt;/head&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="491">
            

            

            <code class="ruby">      &lt;body&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="492">
            

            

            <code class="ruby">        &lt;h1&gt;#{@project.title}&lt;/h1&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="493">
            

            

            <code class="ruby">        &lt;div class=&quot;metadata&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="494">
            

            

            <code class="ruby">          &lt;p&gt;&lt;strong&gt;Topic:&lt;/strong&gt; #{@project.topic}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="495">
            

            

            <code class="ruby">          &lt;p&gt;&lt;strong&gt;Generated:&lt;/strong&gt; #{Time.current.strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="496">
            

            

            <code class="ruby">          &lt;p&gt;&lt;strong&gt;Status:&lt;/strong&gt; #{@project.status.humanize}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="497">
            

            

            <code class="ruby">        &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="498">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="499">
            

            

            <code class="ruby">        &lt;div class=&quot;stats&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="500">
            

            

            <code class="ruby">          &lt;h2&gt;Statistics&lt;/h2&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="501">
            

            

            <code class="ruby">          &lt;p&gt;&lt;strong&gt;Total Questions:&lt;/strong&gt; #{export_data[:statistics][:total_questions]}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="502">
            

            

            <code class="ruby">          &lt;p&gt;&lt;strong&gt;Answered Questions:&lt;/strong&gt; #{export_data[:statistics][:answered_questions]}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="503">
            

            

            <code class="ruby">          &lt;p&gt;&lt;strong&gt;Total Recording Time:&lt;/strong&gt; #{format_duration(export_data[:statistics][:total_recording_time])}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="504">
            

            

            <code class="ruby">          &lt;p&gt;&lt;strong&gt;Total Words:&lt;/strong&gt; #{export_data[:statistics][:total_words]}&lt;/p&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="505">
            

            

            <code class="ruby">        &lt;/div&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="506">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="507">
            

            

            <code class="ruby">        &lt;h2&gt;Interview Transcript&lt;/h2&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="508">
            

            

            <code class="ruby">        #{generate_html_outline(export_data[:outline])}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="509">
            

            

            <code class="ruby">      &lt;/body&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="510">
            

            

            <code class="ruby">      &lt;/html&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="511">
            

            

            <code class="ruby">    HTML</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="512">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="513">
            

            

            <code class="ruby">    html</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="514">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="515">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="516">
            

            

            <code class="ruby">  def generate_html_outline(outline)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="517">
            

            

            <code class="ruby">    content = &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="518">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="519">
            

            

            <code class="ruby">    outline.each do |chapter|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="520">
            

            

            <code class="ruby">      next if chapter[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="521">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="522">
            

            

            <code class="ruby">      content += &quot;&lt;h2&gt;#{chapter[:order]}. #{chapter[:title]}&lt;/h2&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="523">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="524">
            

            

            <code class="ruby">      chapter[:sections].each do |section|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="525">
            

            

            <code class="ruby">        next if section[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="526">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="527">
            

            

            <code class="ruby">        content += &quot;&lt;h3&gt;#{section[:order]}. #{section[:title]}&lt;/h3&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="528">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="529">
            

            

            <code class="ruby">        section[:questions].each do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="530">
            

            

            <code class="ruby">          next if question[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="531">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="532">
            

            

            <code class="ruby">          content += &quot;&lt;div class=&#39;question&#39;&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="533">
            

            

            <code class="ruby">          content += &quot;&lt;p&gt;&lt;strong&gt;Q:&lt;/strong&gt; #{question[:text]}&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="534">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="535">
            

            

            <code class="ruby">          (question[:audio_segments] || []).each do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="536">
            

            

            <code class="ruby">            if segment[:transcription_text].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="537">
            

            

            <code class="ruby">              content += &quot;&lt;div class=&#39;answer&#39;&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="538">
            

            

            <code class="ruby">              content += &quot;&lt;p&gt;#{segment[:transcription_text]}&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="539">
            

            

            <code class="ruby">              content += &quot;&lt;p class=&#39;metadata&#39;&gt;Duration: #{format_duration(segment[:duration_seconds])}&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="540">
            

            

            <code class="ruby">              content += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="541">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="542">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="543">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="544">
            

            

            <code class="ruby">          if question[:follow_up_questions]&amp;.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="545">
            

            

            <code class="ruby">            content += &quot;&lt;div style=&#39;margin-left: 20px;&#39;&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="546">
            

            

            <code class="ruby">            content += &quot;&lt;p&gt;&lt;strong&gt;Follow-up Questions:&lt;/strong&gt;&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="547">
            

            

            <code class="ruby">            question[:follow_up_questions].each do |followup|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="548">
            

            

            <code class="ruby">              next if followup[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="549">
            

            

            <code class="ruby">              content += &quot;&lt;p&gt; #{followup[:text]}&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="550">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="551">
            

            

            <code class="ruby">              (followup[:audio_segments] || []).each do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="552">
            

            

            <code class="ruby">                if segment[:transcription_text].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="553">
            

            

            <code class="ruby">                  content += &quot;&lt;div class=&#39;answer&#39; style=&#39;margin-left: 20px;&#39;&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="554">
            

            

            <code class="ruby">                  content += &quot;&lt;p&gt;#{segment[:transcription_text]}&lt;/p&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="555">
            

            

            <code class="ruby">                  content += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="556">
            

            

            <code class="ruby">                end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="557">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="558">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="559">
            

            

            <code class="ruby">            content += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="560">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="561">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="562">
            

            

            <code class="ruby">          content += &quot;&lt;/div&gt;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="563">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="564">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="565">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="566">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="567">
            

            

            <code class="ruby">    content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="568">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="569">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="570">
            

            

            <code class="ruby">  def format_duration(seconds)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="571">
            

            

            <code class="ruby">    return &quot;0 seconds&quot; if seconds.nil? || seconds == 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="572">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="573">
            

            

            <code class="ruby">    hours = seconds / 3600</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="574">
            

            

            <code class="ruby">    minutes = (seconds % 3600) / 60</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="575">
            

            

            <code class="ruby">    remaining_seconds = seconds % 60</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="576">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="577">
            

            

            <code class="ruby">    parts = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="578">
            

            

            <code class="ruby">    parts &lt;&lt; &quot;#{hours} hour#{&#39;s&#39; if hours != 1}&quot; if hours &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="579">
            

            

            <code class="ruby">    parts &lt;&lt; &quot;#{minutes} minute#{&#39;s&#39; if minutes != 1}&quot; if minutes &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="580">
            

            

            <code class="ruby">    parts &lt;&lt; &quot;#{remaining_seconds} second#{&#39;s&#39; if remaining_seconds != 1}&quot; if remaining_seconds &gt; 0 || parts.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="581">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="582">
            

            

            <code class="ruby">    parts.join(&quot;, &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="583">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="584">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="585">
            

            

            <code class="ruby">  def estimate_word_count(transcript_content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="586">
            

            

            <code class="ruby">    return 0 unless transcript_content.is_a?(Array)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="587">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="588">
            

            

            <code class="ruby">    word_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="589">
            

            

            <code class="ruby">    transcript_content.each do |item|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="590">
            

            

            <code class="ruby">      if item[&#39;type&#39;] == &#39;paragraph&#39; &amp;&amp; item[&#39;text&#39;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="591">
            

            

            <code class="ruby">        word_count += item[&#39;text&#39;].split(/\s+/).length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="592">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="593">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="594">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="595">
            

            

            <code class="ruby">    word_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="596">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="597">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="598">
            

            

            <code class="ruby">  def generate_csv(export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="599">
            

            

            <code class="ruby">    require &#39;csv&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="600">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="601">
            

            

            <code class="ruby">    CSV.generate(headers: true) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="602">
            

            

            <code class="ruby">      if export_data[:include_questions]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="603">
            

            

            <code class="ruby">        csv &lt;&lt; [&#39;Chapter&#39;, &#39;Section&#39;, &#39;Question&#39;, &#39;Answer&#39;, &#39;Type&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="604">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="605">
            

            

            <code class="ruby">        csv &lt;&lt; [&#39;Chapter&#39;, &#39;Section&#39;, &#39;Content&#39;, &#39;Type&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="606">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="607">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="608">
            

            

            <code class="ruby">      # Use the structured outline data if available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="609">
            

            

            <code class="ruby">      if export_data[:outline].any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="610">
            

            

            <code class="ruby">        export_data[:outline].each do |chapter|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="611">
            

            

            <code class="ruby">          next if chapter[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="612">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="613">
            

            

            <code class="ruby">          chapter[:sections].each do |section|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="614">
            

            

            <code class="ruby">            next if section[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="615">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="616">
            

            

            <code class="ruby">            section[:questions].each do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="617">
            

            

            <code class="ruby">              next if question[:omitted]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="618">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="619">
            

            

            <code class="ruby">              # Combine all audio segments for this question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="620">
            

            

            <code class="ruby">              answer_text = question[:audio_segments]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="621">
            

            

            <code class="ruby">                .select { |seg| seg[:transcription_text].present? }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="622">
            

            

            <code class="ruby">                .map { |seg| seg[:transcription_text] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="623">
            

            

            <code class="ruby">                .join(&#39; &#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="624">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="625">
            

            

            <code class="ruby">              if export_data[:include_questions]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="626">
            

            

            <code class="ruby">                csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="627">
            

            

            <code class="ruby">                  chapter[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="628">
            

            

            <code class="ruby">                  section[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="629">
            

            

            <code class="ruby">                  question[:text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="630">
            

            

            <code class="ruby">                  answer_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="631">
            

            

            <code class="ruby">                  export_data[:transcript_version]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="632">
            

            

            <code class="ruby">                ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="633">
            

            

            <code class="ruby">              else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="634">
            

            

            <code class="ruby">                csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="635">
            

            

            <code class="ruby">                  chapter[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="636">
            

            

            <code class="ruby">                  section[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="637">
            

            

            <code class="ruby">                  answer_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="638">
            

            

            <code class="ruby">                  export_data[:transcript_version]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="639">
            

            

            <code class="ruby">                ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="640">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="641">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="642">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="643">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="644">
            

            

            <code class="ruby">      elsif export_data[:transcript].any?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="645">
            

            

            <code class="ruby">        # Use transcript structure</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="646">
            

            

            <code class="ruby">        current_chapter = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="647">
            

            

            <code class="ruby">        current_section = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="648">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="649">
            

            

            <code class="ruby">        export_data[:transcript].each do |item|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="650">
            

            

            <code class="ruby">          case item[&#39;type&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="651">
            

            

            <code class="ruby">          when &#39;chapter&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="652">
            

            

            <code class="ruby">            current_chapter = item[&#39;title&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="653">
            

            

            <code class="ruby">          when &#39;section&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="654">
            

            

            <code class="ruby">            current_section = item[&#39;title&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="655">
            

            

            <code class="ruby">          when &#39;paragraph&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="656">
            

            

            <code class="ruby">            if item[&#39;text&#39;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="657">
            

            

            <code class="ruby">              if export_data[:include_questions] &amp;&amp; item[&#39;question_id&#39;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="658">
            

            

            <code class="ruby">                question_text = find_question_text(export_data[:outline], item[&#39;question_id&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="659">
            

            

            <code class="ruby">                csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="660">
            

            

            <code class="ruby">                  current_chapter || &#39;&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="661">
            

            

            <code class="ruby">                  current_section || &#39;&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="662">
            

            

            <code class="ruby">                  question_text || &#39;&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="663">
            

            

            <code class="ruby">                  item[&#39;text&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="664">
            

            

            <code class="ruby">                  export_data[:transcript_version]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="665">
            

            

            <code class="ruby">                ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="666">
            

            

            <code class="ruby">              else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="667">
            

            

            <code class="ruby">                csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="668">
            

            

            <code class="ruby">                  current_chapter || &#39;&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="669">
            

            

            <code class="ruby">                  current_section || &#39;&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="670">
            

            

            <code class="ruby">                  item[&#39;text&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="671">
            

            

            <code class="ruby">                  export_data[:transcript_version]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="672">
            

            

            <code class="ruby">                ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="673">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="674">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="675">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="676">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="677">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="678">
            

            

            <code class="ruby">        # Fallback to raw text if available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="679">
            

            

            <code class="ruby">        content = export_data[:transcript_version] == &#39;raw&#39; ? export_data[:raw_text] : export_data[:polished_text]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="680">
            

            

            <code class="ruby">        if content.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="681">
            

            

            <code class="ruby">          csv &lt;&lt; [&#39;&#39;, &#39;&#39;, content, export_data[:transcript_version]]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="682">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="683">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="684">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="685">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="686">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="687">
            

            

            <code class="ruby">  def find_question_text(outline, question_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="688">
            

            

            <code class="ruby">    outline.each do |chapter|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="689">
            

            

            <code class="ruby">      chapter[:sections].each do |section|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="690">
            

            

            <code class="ruby">        section[:questions].each do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="691">
            

            

            <code class="ruby">          return question[:text] if question[:question_id] == question_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="692">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="693">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="694">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="695">
            

            

            <code class="ruby">    nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="696">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="697">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="698">
            

            

            <code class="ruby">  def generate_project_filename(format, export_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="699">
            

            

            <code class="ruby">    # Start with first 15 characters of project title</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="700">
            

            

            <code class="ruby">    title_part = @project.title.parameterize.underscore</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="701">
            

            

            <code class="ruby">    title_part = title_part[0..14] if title_part.length &gt; 15  # Limit to first 15 characters</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="702">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="703">
            

            

            <code class="ruby">    # Add date for uniqueness</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="704">
            

            

            <code class="ruby">    date_part = Time.current.strftime(&#39;%Y%m%d&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="705">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="706">
            

            

            <code class="ruby">    &quot;#{title_part}_#{date_part}.#{format}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="707">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="708">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="97440ec6d82bbb8df7ed1d8764cd6278f8913745">
  <div class="header">
    <h3>app/controllers/api/feedbacks_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>37</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::FeedbacksController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :authenticate_request!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    feedback = current_user.feedbacks.build(feedback_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    if feedback.save</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">        id: feedback.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">        message: &quot;Thank you for your feedback! We truly appreciate you taking the time to help us improve Inkra.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">        feedback_type: feedback.feedback_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">        created_at: feedback.created_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      }, status: :created</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">        error: &quot;Unable to submit feedback&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">        errors: feedback.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    feedbacks = current_user.feedbacks.recent.limit(10)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      feedbacks: feedbacks.map do |feedback|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">          id: feedback.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">          feedback_text: feedback.feedback_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">          feedback_type: feedback.feedback_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">          resolved: feedback.resolved,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">          created_at: feedback.created_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  def feedback_params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    params.require(:feedback).permit(:feedback_text, :feedback_type, :email)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c21b1cf41cb6de9333e942cad2ad63875b4314d0">
  <div class="header">
    <h3>app/controllers/api/interview_presets_controller.rb</h3>
    <h4>
      <span class="green">
  97.83%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>46</b> relevant lines.
      <span class="green"><b>45</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Api::InterviewPresetsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :authenticate_request!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_action :set_interview_preset, only: [:show, :mark_as_shown, :launch]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # GET /api/interview_presets</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    # Get presets that haven&#39;t been shown to this user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="8">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    excluded_ids = @current_user.user_shown_interview_presets.pluck(:interview_preset_id)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="9">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    available_presets = InterviewPreset.active</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">                                     .where.not(id: excluded_ids)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">                                     .ordered</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">                                     .limit(50)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # If we have fewer than 2 available presets, reset the shown list and get fresh ones</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="15">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    if available_presets.count &lt; 2 &amp;&amp; @current_user.user_shown_interview_presets.count &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      @current_user.user_shown_interview_presets.destroy_all</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      available_presets = InterviewPreset.active.ordered.limit(50)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    # Select 2 random presets for the home screen</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="21">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    selected_presets = available_presets.order(Arel.sql(&#39;RANDOM()&#39;)).limit(2)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="23">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      presets: selected_presets.map do |preset|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="26">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">          uuid: preset.uuid,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">          title: preset.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">          description: preset.description,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">          category: preset.category,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">          icon_name: preset.icon_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">          total_questions_count: preset.total_questions_count,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">          is_featured: preset.is_featured</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  # GET /api/interview_presets/:uuid</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">      preset: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">        uuid: @interview_preset.uuid,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">        title: @interview_preset.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">        description: @interview_preset.description,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        category: @interview_preset.category,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        icon_name: @interview_preset.icon_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">        total_questions_count: @interview_preset.total_questions_count,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">        is_featured: @interview_preset.is_featured,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">        questions_by_chapter: @interview_preset.questions_grouped_by_chapter.transform_values do |questions|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="50">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">          questions.map do |q|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="52">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">              id: q.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">              text: q.question_text,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">              chapter_title: q.chapter_title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">              section_title: q.section_title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">              order: [q.chapter_order, q.section_order, q.question_order]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">  # POST /api/interview_presets/:uuid/mark_as_shown</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="65">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def mark_as_shown</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="66">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    @interview_preset.mark_as_shown_to_user(@current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="67">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    render json: { success: true }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">  # POST /api/interview_presets/:uuid/launch</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="71">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def launch</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">    # Mark as shown since user is engaging with it</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="73">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    @interview_preset.mark_as_shown_to_user(@current_user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    # Create a new project based on this preset</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="76">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    project = @current_user.projects.build(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">      title: @interview_preset.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      topic: @interview_preset.description,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">      status: &#39;outline_ready&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">      interview_preset_id: @interview_preset.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">      is_speech_interview: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="84">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    if project.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">      # Create chapters, sections, and questions from the preset</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="86">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      create_project_structure(project)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="88">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">        success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">        project: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">          id: project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">          title: project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">          topic: project.topic,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">          status: project.status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">        success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">        errors: project.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">  # GET /api/interview_presets/categories</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="106">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def categories</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="107">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    categories = InterviewPreset.active</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">                               .distinct</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">                               .pluck(:category)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">                               .compact</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">                               .sort</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="113">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    render json: { categories: categories }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">  # GET /api/interview_presets/featured</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="117">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def featured</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="118">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    featured_presets = InterviewPreset.active.featured.ordered.limit(10)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="120">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">      presets: featured_presets.map do |preset|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="123">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">          uuid: preset.uuid,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">          title: preset.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">          description: preset.description,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">          category: preset.category,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">          icon_name: preset.icon_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">          total_questions_count: preset.total_questions_count,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">          is_featured: preset.is_featured</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="135">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="137">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def set_interview_preset</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="138">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">    @interview_preset = InterviewPreset.find_by!(uuid: params[:uuid])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="140">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    render json: { error: &#39;Interview preset not found&#39; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="143">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create_project_structure(project)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="144">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    questions_by_chapter = @interview_preset.questions_grouped_by_chapter</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="146">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    questions_by_chapter.each do |chapter_title, questions|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="147">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      chapter = project.chapters.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">        title: chapter_title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">        order: questions.first.chapter_order,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">        omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">      # Group questions by section within this chapter</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="154">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      questions_by_section = questions.group_by(&amp;:section_title)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="156">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      questions_by_section.each do |section_title, section_questions|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="157">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        section = chapter.sections.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">          title: section_title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">          order: section_questions.first.section_order,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">          omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">        # Create questions in this section</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="164">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">        section_questions.each do |preset_question|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="165">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">          section.questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">            text: preset_question.question_text,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">            order: preset_question.question_order,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">            omitted: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">            skipped: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7138b8c39fe25524fd86be3269c1074de0c7a04f">
  <div class="header">
    <h3>app/controllers/api/interview_questions_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>239</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>239</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::InterviewQuestionsController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # Generate a complete interview outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def generate_outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_DEBUG] generate_outline called with params: #{params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    topic = params[:topic]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    options = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      num_chapters: params[:num_chapters]&amp;.to_i || 3,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      sections_per_chapter: params[:sections_per_chapter]&amp;.to_i || 2,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      questions_per_section: params[:questions_per_section]&amp;.to_i || 3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_DEBUG] Parsed options: #{options.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    if topic.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      Rails.logger.warn &quot;[INTERVIEW_DEBUG] Topic is blank, returning bad_request&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      render json: { error: &#39;Topic is required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Creating InterviewQuestionService instance&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Calling generate_interview_outline with topic: #{topic}, options: #{options}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      outline = service.generate_interview_outline(topic, options)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Outline generated: #{outline.keys.inspect}, chapters count: #{outline[:chapters]&amp;.size || 0}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      if outline[:error]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">        Rails.logger.error &quot;[INTERVIEW_DEBUG] Outline generation error: #{outline[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">        render json: { error: outline[:error] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        response_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">          outline: outline,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">          generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">        Rails.logger.info &quot;[INTERVIEW_DEBUG] Successful outline generation, returning: #{response_data.keys.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">        render json: response_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      Rails.logger.error &quot;[INTERVIEW_DEBUG] Interview outline generation failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      Rails.logger.error &quot;[INTERVIEW_DEBUG] Backtrace: #{e.backtrace.first(5).join(&#39;\n&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      render json: { error: &#39;Failed to generate interview outline&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  # Generate additional questions for a section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">  def generate_section_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_DEBUG] generate_section_questions called with params: #{params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    section_id = params[:section_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    num_questions = params[:num_questions]&amp;.to_i || 3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_DEBUG] Looking for section_id: #{section_id}, num_questions: #{num_questions}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    section = current_user.projects.joins(:sections).find_by(sections: { id: section_id })&amp;.sections&amp;.find(section_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    unless section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      Rails.logger.warn &quot;[INTERVIEW_DEBUG] Section not found for id: #{section_id}, user: #{current_user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      render json: { error: &#39;Section not found&#39; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_DEBUG] Found section: #{section.title}, chapter: #{section.chapter.title}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      section_context = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">        chapter_title: section.chapter.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">        section_title: section.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">        existing_questions: section.questions.by_order.pluck(:text)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Section context: #{section_context.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Generating #{num_questions} new questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      new_questions = service.generate_section_questions(section_context, num_questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Generated #{new_questions.size} questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      response_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">        section_id: section.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">        new_questions: new_questions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">        generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Returning new questions for section #{section_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">      render json: response_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">      Rails.logger.error &quot;[INTERVIEW_DEBUG] Section questions generation failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">      Rails.logger.error &quot;[INTERVIEW_DEBUG] Backtrace: #{e.backtrace.first(5).join(&#39;\n&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      render json: { error: &#39;Failed to generate section questions&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">  # Refine existing questions based on feedback</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">  def refine_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    question_ids = params[:question_ids] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    feedback = params[:feedback]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    if question_ids.empty? || feedback.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      render json: { error: &#39;Question IDs and feedback are required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    questions = current_user.projects.joins(:questions).where(questions: { id: question_ids }).distinct.flat_map(&amp;:questions).select { |q| question_ids.include?(q.id) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">    if questions.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">      render json: { error: &#39;No questions found&#39; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">      questions_data = questions.map { |q| { text: q.text, id: q.id } }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">      refined_questions = service.refine_questions(questions_data, feedback)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">        original_questions: questions_data,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">        refined_questions: refined_questions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">        feedback_applied: feedback,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">        generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">      Rails.logger.error &quot;Question refinement failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      render json: { error: &#39;Failed to refine questions&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">  # Create project from generated outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">  def create_project_from_outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_DEBUG] create_project_from_outline called&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">    project_title = params[:title]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">    topic = params[:topic]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">    outline_data = params[:outline]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_DEBUG] Project params - title: #{project_title}, topic: #{topic}, outline keys: #{outline_data&amp;.keys&amp;.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    if project_title.blank? || topic.blank? || outline_data.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      Rails.logger.warn &quot;[INTERVIEW_DEBUG] Missing required params - title: #{project_title.present?}, topic: #{topic.present?}, outline: #{outline_data.present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">      render json: { error: &#39;Title, topic, and outline are required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">      ActiveRecord::Base.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">        Rails.logger.info &quot;[INTERVIEW_DEBUG] Starting transaction to create project&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">        # Create the project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">        project = current_user.projects.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">          title: project_title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">          topic: topic,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">          status: &#39;outline_ready&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">        Rails.logger.info &quot;[INTERVIEW_DEBUG] Created project id: #{project.id}, title: #{project.title}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">        # Create chapters, sections, and questions from outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">        chapters_count = outline_data[:chapters]&amp;.size || 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">        Rails.logger.info &quot;[INTERVIEW_DEBUG] Creating #{chapters_count} chapters&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">        outline_data[:chapters]&amp;.each do |chapter_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">          chapter = project.chapters.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">            title: chapter_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">            order: chapter_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">            omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">          Rails.logger.info &quot;[INTERVIEW_DEBUG] Created chapter id: #{chapter.id}, title: #{chapter.title}, order: #{chapter.order}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">          sections_count = chapter_data[:sections]&amp;.size || 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">          Rails.logger.info &quot;[INTERVIEW_DEBUG] Creating #{sections_count} sections for chapter #{chapter.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">          chapter_data[:sections]&amp;.each do |section_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">            section = chapter.sections.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">              title: section_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">              order: section_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">              omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">            )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">            Rails.logger.info &quot;[INTERVIEW_DEBUG] Created section id: #{section.id}, title: #{section.title}, order: #{section.order}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">            questions_count = section_data[:questions]&amp;.size || 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">            Rails.logger.info &quot;[INTERVIEW_DEBUG] Creating #{questions_count} questions for section #{section.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">            section_data[:questions]&amp;.each do |question_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">              question = section.questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">                text: question_data[:text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">                order: question_data[:order]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">              )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">              Rails.logger.info &quot;[INTERVIEW_DEBUG] Created question id: #{question.id}, order: #{question.order}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">        Rails.logger.info &quot;[INTERVIEW_DEBUG] Project creation complete - total questions: #{project.questions.count}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">          project_id: project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">          title: project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">          status: project.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">          created_at: project.created_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">          message: &#39;Project created successfully from generated outline&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">        }, status: :created</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">      Rails.logger.error &quot;[INTERVIEW_DEBUG] Project creation from outline failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">      Rails.logger.error &quot;[INTERVIEW_DEBUG] Error class: #{e.class.name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">      Rails.logger.error &quot;[INTERVIEW_DEBUG] Backtrace: #{e.backtrace.first(5).join(&#39;\n&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">      render json: { error: &#39;Failed to create project from outline&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby">  # Generate interview from tracker data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">  def generate_from_tracker</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_DEBUG] generate_from_tracker called with params: #{params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">    tracker_name = params[:tracker_name]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">    tracker_context = params[:tracker_context]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_DEBUG] Tracker: #{tracker_name}, context keys: #{tracker_context&amp;.keys&amp;.inspect if tracker_context.is_a?(Hash)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">    if tracker_name.blank? || tracker_context.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">      Rails.logger.warn &quot;[INTERVIEW_DEBUG] Missing tracker params - name: #{tracker_name.present?}, context: #{tracker_context.present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">      render json: { error: &#39;Tracker name and context are required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="212">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Creating InterviewQuestionService for tracker generation&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Calling generate_interview_from_tracker&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">      outline = service.generate_interview_from_tracker(tracker_name, tracker_context)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_DEBUG] Tracker outline generated, keys: #{outline.keys.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">      if outline[:error]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">        Rails.logger.error &quot;[INTERVIEW_DEBUG] Tracker generation error: #{outline[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">        render json: { error: outline[:error] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">        response_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">          outline: outline,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">          tracker_name: tracker_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">          generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">        Rails.logger.info &quot;[INTERVIEW_DEBUG] Successful tracker interview generation&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="230">
            

            

            <code class="ruby">        render json: response_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">      Rails.logger.error &quot;[INTERVIEW_DEBUG] Tracker interview generation failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">      Rails.logger.error &quot;[INTERVIEW_DEBUG] Backtrace: #{e.backtrace.first(5).join(&#39;\n&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">      render json: { error: &#39;Failed to generate interview from tracker data&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="238">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            

            <code class="ruby">  # Add generated questions to existing section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">  def add_questions_to_section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">    section_id = params[:section_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">    questions_data = params[:questions] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">    section = current_user.projects.joins(:sections).find_by(sections: { id: section_id })&amp;.sections&amp;.find(section_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">    unless section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">      render json: { error: &#39;Section not found&#39; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="249">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">    if questions_data.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">      render json: { error: &#39;Questions data is required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="254">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="256">
            

            

            <code class="ruby">      ActiveRecord::Base.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">        max_order = section.questions.maximum(:order) || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">        new_questions = questions_data.map.with_index do |question_data, index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">          section.questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">            text: question_data[:text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">            order: max_order + index + 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="265">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">        render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">          section_id: section.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">          added_questions: new_questions.map do |q|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="269">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">              question_id: q.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">              text: q.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">              order: q.order</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">          end,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="275">
            

            

            <code class="ruby">          message: &quot;#{new_questions.count} questions added successfully&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="278">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">      Rails.logger.error &quot;Adding questions to section failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">      render json: { error: &#39;Failed to add questions to section&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="282">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="283">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="799a72f817064bc8c90378359994f3641734f0f1">
  <div class="header">
    <h3>app/controllers/api/polly_audio_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>226</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>226</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::PollyAudioController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :set_project, except: [:generate_questions, :voices]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # Generate Polly audio for all questions in a project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  def generate_all</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    tracker = PerformanceTracker.instance</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    session_id = &quot;api_generate_all_#{@project&amp;.id || &#39;unknown&#39;}_#{Time.current.to_i}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    tracker.start_session(session_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    unless @project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      tracker.track_event(&#39;validation_failed&#39;, { reason: &#39;not_speech_interview&#39; })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">        error: &#39;Project is not configured for speech interviews&#39; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    voice_id = params[:voice_id] || &#39;Matthew&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    speech_rate = params[:speech_rate]&amp;.to_i || 100</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    # Update project with voice settings</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    tracker.track_event(&#39;update_project_settings&#39;, { voice_id: voice_id, speech_rate: speech_rate }) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      @project.update(voice_id: voice_id, speech_rate: speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      result = tracker.track_event(&#39;polly_generation_service&#39;, { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">        project_id: @project.id, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">        voice_id: voice_id, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        speech_rate: speech_rate </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      }) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        service = PollyAudioGenerationService.new(@project, voice_id: voice_id, speech_rate: speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">        service.generate_all_question_audio</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      tracker.end_session</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">        voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">        speech_rate: speech_rate,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">        generation_summary: result,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        generated_at: Time.current.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">        performance_session_id: session_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">      Rails.logger.error &quot;Polly audio generation failed for project #{@project.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      tracker.track_event(&#39;generation_error&#39;, { error: e.message })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">      tracker.end_session</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">        error: &quot;Failed to generate audio: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        performance_session_id: session_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">  # Generate audio for questions that don&#39;t have it yet</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  def generate_missing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    unless @project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">        error: &#39;Project is not configured for speech interviews&#39; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    voice_id = params[:voice_id] || &#39;Matthew&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    speech_rate = params[:speech_rate]&amp;.to_i || 100</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">    # Update project with voice settings</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">    @project.update(voice_id: voice_id, speech_rate: speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      service = PollyAudioGenerationService.new(@project, voice_id: voice_id, speech_rate: speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">      success_count = service.generate_missing_question_audio</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">        voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">        speech_rate: speech_rate,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">        generated_count: success_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">        generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">      Rails.logger.error &quot;Missing Polly audio generation failed for project #{@project.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">        error: &quot;Failed to generate missing audio: #{e.message}&quot; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">      }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">  # Update voice settings and regenerate audio as needed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">  def update_voice_settings</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">    unless @project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">        error: &#39;Project is not configured for speech interviews&#39; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    voice_id = params[:voice_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">    speech_rate = params[:speech_rate]&amp;.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">    if voice_id.blank? || speech_rate.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">        error: &#39;Voice ID and speech rate are required&#39; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">      }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">    # Update project with voice settings</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">    @project.update(voice_id: voice_id, speech_rate: speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">      service = PollyAudioGenerationService.new(@project, voice_id: voice_id, speech_rate: speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      regenerated_count = service.update_voice_settings(voice_id, speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">        voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">        speech_rate: speech_rate,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">        regenerated_count: regenerated_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">        updated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">      Rails.logger.error &quot;Voice settings update failed for project #{@project.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">        error: &quot;Failed to update voice settings: #{e.message}&quot; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">      }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">  # Get generation status for a project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">  def status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    unless @project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">        error: &#39;Project is not configured for speech interviews&#39; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">      }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">      service = PollyAudioGenerationService.new(@project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">      status_info = service.generation_status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">      cost_estimate = service.estimate_cost</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">        status: status_info,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">        cost_estimate: cost_estimate,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">        checked_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">      Rails.logger.error &quot;Status check failed for project #{@project.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">        error: &quot;Failed to get status: #{e.message}&quot; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">      }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">  # Generate audio for specific questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">  def generate_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">    question_ids = params[:question_ids] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">    voice_id = params[:voice_id] || &#39;Matthew&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">    speech_rate = params[:speech_rate]&amp;.to_i || 100</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    if question_ids.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">      render json: { error: &#39;Question IDs are required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">    # Verify user has access to all questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">    user_question_ids = current_user.projects.joins(:questions).where(questions: { id: question_ids }).pluck(&#39;questions.id&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">    if user_question_ids.length != question_ids.length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">      render json: { error: &#39;Some questions not found or access denied&#39; }, status: :forbidden</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">      results = PollyAudioGenerationService.batch_generate(question_ids, voice_id: voice_id, speech_rate: speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">      success_count = results.count { |r| r[:status] == &#39;success&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">      error_count = results.count { |r| r[:status] == &#39;error&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">        voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">        speech_rate: speech_rate,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">        results: results,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">        summary: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">          total: results.length,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">          success: success_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">          errors: error_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">        },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">        generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">      Rails.logger.error &quot;Batch audio generation failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">      render json: { error: &quot;Failed to generate audio: #{e.message}&quot; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="211">
            

            

            <code class="ruby">  # List available Polly voices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">  def voices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">      polly_service = Aws::PollyService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">      voices = polly_service.list_english_voices</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">        voices: voices,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">        default_voice: Aws::PollyService::DEFAULT_VOICE,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">        fetched_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">      Rails.logger.error &quot;Failed to fetch Polly voices: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">      render json: { error: &quot;Failed to fetch voices: #{e.message}&quot; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby">  # Clean up failed audio clips</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">  def cleanup_failed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="230">
            

            

            <code class="ruby">    unless @project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">        error: &#39;Project is not configured for speech interviews&#39; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">      }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">      service = PollyAudioGenerationService.new(@project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">      cleanup_count = service.cleanup_failed_clips</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="241">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="243">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">        cleaned_up_count: cleanup_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">        cleaned_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">      Rails.logger.error &quot;Cleanup failed for project #{@project.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">        error: &quot;Failed to cleanup: #{e.message}&quot; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">      }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="256">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="258">
            

            

            <code class="ruby">  def set_project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">    unless current_user.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">      return render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">        requested_project_id: params[:id],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">        error: &#39;Authentication required to access project data.&#39; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">      }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="265">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">    @project = current_user.projects.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">    render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="269">
            

            

            <code class="ruby">      requested_project_id: params[:id],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">      error: &#39;Project not found or you do not have access to it.&#39; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">    }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="829b4a7b63f662dea3f96d1032335bcc209dac19">
  <div class="header">
    <h3>app/controllers/api/polly_voices_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>57</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>57</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::PollyVoicesController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  include ErrorResponder</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # Make the index action publicly accessible (no authentication required)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  skip_before_action :authenticate_api_request!, only: [:index]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      polly_service = Aws::PollyService.new # No user needed for listing voices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      voices = polly_service.list_english_voices.map do |voice|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">          id: voice[:id],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">          name: voice[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">          gender: voice[:gender],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">          neural: voice[:neural],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">          language_code: voice[:language_code],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">          demo_url: &quot;https://#{ENV[&#39;AWS_S3_BUCKET&#39;]}.s3.us-east-1.amazonaws.com/inkra_voice_welcomes/#{voice[:id].downcase}_inkra_welcome.mp3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">        voices: voices,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">        default_voice_id: Aws::PollyService::DEFAULT_VOICE,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">        supported_speech_rates: [70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200] # Example rates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      Rails.logger.error &quot;Failed to fetch Polly voices for index: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      render_error(&quot;Failed to fetch voices.&quot;, &quot;VOICE_FETCH_FAILED&quot;, :internal_server_error)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  def generate_demo</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    voice_id = params[:id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    service = Aws::PollyService.new # Use the main PollyService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    # Find the voice configuration in ENGLISH_VOICES</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    voice_config = Aws::PollyService::ENGLISH_VOICES.find { |v| v[:id] == voice_id }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    unless voice_config</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      return render_not_found(&quot;Voice with ID &#39;#{voice_id}&#39; not found in English voices list.&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    Rails.logger.info &quot; Generating demo for voice: #{voice_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">      # Use a standard demo phrase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      demo_text = &quot;Hi there! This is a sample of my voice. I can help bring your story to life with natural, expressive narration.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      # Pass the correct engine type (neural or standard)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      engine_type = voice_config[:neural] ? &#39;neural&#39; : &#39;standard&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      result = service.generate_speech(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">        text: demo_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">        voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">        speech_rate: 100, # Default demo rate</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        language_code: voice_config[:language_code], # Use correct language code from config</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        engine: engine_type # Ensure the correct engine is passed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      s3_key = result[:s3_key]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      demo_url = service.get_presigned_url(s3_key) # Generate presigned URL for playback</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      Rails.logger.info &quot; Demo generated for #{voice_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      render json: { demo_url: demo_url }, status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    rescue Aws::Polly::Errors::ServiceError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      Rails.logger.error &quot;Polly service error generating demo for #{voice_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      render_error(&quot;Polly service error: #{e.message}&quot;, &quot;POLLY_SERVICE_ERROR&quot;, :bad_request)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      Rails.logger.error &quot; Failed to generate demo for #{voice_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      render_error(&quot;Failed to generate demo clip. Error: #{e.message}&quot;, &quot;DEMO_GENERATION_FAILED&quot;, :internal_server_error)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="59cee80abccc3752b521c76ca2950b67af08d897">
  <div class="header">
    <h3>app/controllers/api/projects_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1018</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>1018</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::ProjectsController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  include ErrorResponder</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  before_action :set_project, except: [:index, :recent, :create]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Test Harness Status:  Comprehensive test coverage with happy/sad paths</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    # Optimize with eager loading and single query with aggregations (presets removed)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    projects = current_user.projects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">                          .left_joins(:chapters, :sections, :questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">                          .select(&#39;projects.*, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">                                  COUNT(DISTINCT chapters.id) as chapters_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">                                  COUNT(DISTINCT sections.id) as sections_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">                                  COUNT(DISTINCT questions.id) as questions_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">                                  COUNT(DISTINCT CASE WHEN questions.is_follow_up = false THEN questions.id END) as base_questions_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">                                  COUNT(DISTINCT CASE WHEN questions.is_follow_up = true THEN questions.id END) as followup_questions_count&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">                          .group(&#39;projects.id&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">                          .order(&#39;last_accessed_at DESC NULLS LAST, last_modified_at DESC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    # Get answered questions count for all projects in a single query</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    answered_counts = AudioSegment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      .where(project_id: projects.map(&amp;:id))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      .where.not(question_id: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      .group(:project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      .distinct</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      .count(:question_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      projects: projects.map do |project|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">        # Calculate outline status without additional queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        outline_status = case project.status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">                        when &#39;outline_generating&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">                          &#39;generating&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">                        when &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">                          &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">                        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">                          project.chapters_count &gt; 0 ? &#39;ready&#39; : &#39;not_started&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">                        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">          id: project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">          title: project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">          topic: project.topic,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">          created_at: project.created_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">          last_modified_at: project.last_modified_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">          last_accessed_at: project.last_accessed_at&amp;.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">          is_speech_interview: project.is_speech_interview,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">          outline: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">            status: outline_status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">            chapters_count: project.chapters_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">            sections_count: project.sections_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">            questions_count: project.questions_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">            base_questions_count: project.base_questions_count || 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">            followup_questions_count: project.followup_questions_count || 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">            answered_questions_count: answered_counts[project.id] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">  # Test Harness Status:  Batch endpoint for recent projects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">  def recent</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    limit = params[:limit]&amp;.to_i || 5</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    offset = params[:offset]&amp;.to_i || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    # Get recent projects with counts, limited by parameters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    projects = current_user.projects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">                          .left_joins(:chapters, :sections, :questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">                          .select(&#39;projects.*, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">                                  COUNT(DISTINCT chapters.id) as chapters_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">                                  COUNT(DISTINCT sections.id) as sections_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">                                  COUNT(DISTINCT questions.id) as questions_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">                                  COUNT(DISTINCT CASE WHEN questions.is_follow_up = false THEN questions.id END) as base_questions_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">                                  COUNT(DISTINCT CASE WHEN questions.is_follow_up = true THEN questions.id END) as followup_questions_count&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">                          .group(&#39;projects.id&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">                          .order(&#39;last_accessed_at DESC NULLS LAST, last_modified_at DESC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">                          .limit(limit)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">                          .offset(offset)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">    # Get total count for pagination</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    total_count = current_user.projects.count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    has_more = offset + limit &lt; total_count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">    # Get answered questions count for these projects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    answered_counts = AudioSegment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">      .where(project_id: projects.map(&amp;:id))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">      .where.not(question_id: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">      .group(:project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      .distinct</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">      .count(:question_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      projects: projects.map do |project|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">        outline_status = case project.status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">                        when &#39;outline_generating&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">                          &#39;generating&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">                        when &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">                          &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">                        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">                          project.chapters_count &gt; 0 ? &#39;ready&#39; : &#39;not_started&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">                        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">          id: project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">          title: project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">          topic: project.topic,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">          created_at: project.created_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">          last_modified_at: project.last_modified_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">          last_accessed_at: project.last_accessed_at&amp;.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">          is_speech_interview: project.is_speech_interview,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">          outline: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">            status: outline_status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">            chapters_count: project.chapters_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">            sections_count: project.sections_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">            questions_count: project.questions_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">            base_questions_count: project.base_questions_count || 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">            followup_questions_count: project.followup_questions_count || 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">            answered_questions_count: answered_counts[project.id] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      end,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">      pagination: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">        total_count: total_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">        has_more: has_more,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">        current_offset: offset,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">        current_limit: limit</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">  # Test Harness Status:  Comprehensive test coverage with happy/sad paths</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== PROJECT CREATE DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Raw params: #{params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Processed project_params: #{project_params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">    # Implement retry logic with exponential backoff for race conditions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">    max_retries = 3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">    retry_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">      retry_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">      project = current_user.projects.new(project_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">      ActiveRecord::Base.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">        # Check for duplicate projects within the transaction to avoid race conditions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">        topic = project_params[:topic]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">        if topic.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">          # Use advisory lock based on user_id + topic hash to prevent race conditions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">          topic_hash = Digest::SHA256.hexdigest(&quot;#{current_user.id}_#{topic}&quot;).to_i(16) % 2147483647</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">          Rails.logger.debug &quot;Acquiring advisory lock for user #{current_user.id}, topic: &#39;#{topic}&#39; (hash: #{topic_hash})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">          # Get advisory lock - this will block other requests with same user+topic combination</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">          ActiveRecord::Base.connection.execute(&quot;SELECT pg_advisory_xact_lock(#{topic_hash})&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">          # Now check for duplicates after acquiring the lock</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">          recent_duplicate = current_user.projects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">                                        .where(&quot;created_at &gt; ? AND topic = ?&quot;, 10.seconds.ago, topic)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">                                        .first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">          if recent_duplicate</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">            Rails.logger.warn &quot;Duplicate project creation detected for topic &#39;#{topic}&#39; - returning existing project #{recent_duplicate.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">            return render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">              project_id: recent_duplicate.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">              title: recent_duplicate.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">              created_at: recent_duplicate.created_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">              duplicate_prevented: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">            }, status: :created</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">        # Preset functionality disabled - use custom topic only</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">        if project.title.blank? &amp;&amp; project.topic.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">          # If only topic is provided (from initial_topic), use it as both title and topic</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">          project.title = project.topic</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">        elsif project.topic.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">          project.topic = &quot;Custom Interview&quot; # Default fallback</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">          project.title = project.topic if project.title.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">        project.status = &#39;outline_generating&#39; # Initial status before scaffolding</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">        project.save!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">        # CRITICAL FIX: Make outline generation asynchronous to avoid 20+ second API response times</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby">        # Queue a background job to generate the outline instead of doing it synchronously</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">        Rails.logger.debug &quot;Enqueuing async outline generation job for project #{project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">        OutlineGenerationJob.perform_later(project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">      # NOTE: Polly jobs will be enqueued by the OutlineGenerationJob after questions are created</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">        project_id: project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">        title: project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">        created_at: project.created_at.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">      }, status: :created</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">      render_error(e.record.errors.full_messages.join(&quot;, &quot;), &quot;VALIDATION_ERROR&quot;, :unprocessable_entity, { field_errors: e.record.errors.as_json })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">    rescue PG::TRSerializationFailure, ActiveRecord::Deadlocked =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">      if retry_count &lt; max_retries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Transaction conflict on project creation attempt #{retry_count}, retrying... (#{e.class}: #{e.message})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">        sleep(0.1 * retry_count) # Exponential backoff: 0.1s, 0.2s, 0.3s</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">        retry</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">        Rails.logger.error &quot;Failed to create project after #{max_retries} retries due to transaction conflicts&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">        render_error(&quot;Project creation failed due to high concurrency. Please try again.&quot;, &quot;CREATION_CONFLICT&quot;, :service_unavailable)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">      Rails.logger.error &quot;Unexpected error in project creation: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">      render_error(&quot;An unexpected error occurred during project creation&quot;, &quot;INTERNAL_ERROR&quot;, :internal_server_error)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            

            

            <code class="ruby">    # Touch last accessed timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">    @project.touch_accessed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            

            <code class="ruby">    # Use a single optimized query to load all associations including follow_up_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">    project_with_details = current_user.projects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">      .includes(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">        chapters: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">          sections: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">            questions: :follow_up_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">      .where(id: @project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">      .first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">    render json: project_json_representation(project_with_details)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">  def update</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== PROJECT UPDATE DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project ID: #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Update params: #{params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">    if params[:status]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">      valid_statuses = [&#39;outline_ready&#39;, &#39;recording_in_progress&#39;, &#39;transcribing&#39;, &#39;completed&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">      unless valid_statuses.include?(params[:status])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="243">
            

            

            <code class="ruby">        return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">          &quot;Invalid status: #{params[:status]}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">          &quot;INVALID_STATUS&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">          :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="249">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">      @project.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">        status: params[:status],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">        last_modified_at: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby">    # FIX: Eager load associations and render the full project object</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            

            <code class="ruby">    # to match the Swift client&#39;s expectation.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="258">
            

            

            <code class="ruby">    project_with_details = current_user.projects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">      .includes(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">        chapters: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">          sections: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">            questions: :follow_up_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">      .find(@project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="267">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">    render json: project_json_representation(project_with_details)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">    Rails.logger.error &quot;Project update failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">    render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">      &quot;Failed to update project: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">      &quot;UPDATE_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="275">
            

            

            <code class="ruby">      :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="278">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">  def outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">    updates = params[:updates] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="281">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="282">
            

            

            <code class="ruby">    updates.each do |update|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="283">
            

            

            <code class="ruby">      if update[:chapter_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="284">
            

            

            <code class="ruby">        chapter = @project.chapters.find(update[:chapter_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="285">
            

            

            <code class="ruby">        chapter.update(omitted: update[:omitted]) if chapter</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="286">
            

            

            <code class="ruby">      elsif update[:section_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="287">
            

            

            <code class="ruby">        section = @project.sections.find(update[:section_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="288">
            

            

            <code class="ruby">        section.update(omitted: update[:omitted]) if section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="289">
            

            

            <code class="ruby">      elsif update[:question_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="290">
            

            

            <code class="ruby">        question = @project.questions.find(update[:question_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">        question.update(omitted: update[:omitted]) if question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="294">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="295">
            

            

            <code class="ruby">    @project.update(last_modified_at: Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="296">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="297">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="298">
            

            

            <code class="ruby">      message: &#39;Outline updated successfully&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">      project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">      status: @project.status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="301">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="302">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="304">
            

            

            <code class="ruby">  def transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="305">
            

            

            <code class="ruby">    if request.patch?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="306">
            

            

            <code class="ruby">      update_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="307">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="308">
            

            

            <code class="ruby">      show_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="309">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="310">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="311">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="313">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="314">
            

            

            <code class="ruby">  def show_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="315">
            

            

            <code class="ruby">    transcript = @project.transcript</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="316">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="317">
            

            

            <code class="ruby">    # Create a placeholder transcript if it doesn&#39;t exist</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="318">
            

            

            <code class="ruby">    unless transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="319">
            

            

            <code class="ruby">      transcript = @project.build_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="320">
            

            

            <code class="ruby">      transcript.status = &#39;processing_raw&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="321">
            

            

            <code class="ruby">      transcript.save!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="322">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="323">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="324">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="325">
            

            

            <code class="ruby">      id: transcript.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="326">
            

            

            <code class="ruby">      project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="327">
            

            

            <code class="ruby">      status: transcript.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="328">
            

            

            <code class="ruby">      last_updated: transcript.last_updated&amp;.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="329">
            

            

            <code class="ruby">      raw_content: transcript.raw_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="330">
            

            

            <code class="ruby">      polished_content: transcript.polished_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="331">
            

            

            <code class="ruby">      edited_content: transcript.edited_content_json || [],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="332">
            

            

            <code class="ruby">      raw_structured_content: transcript.raw_structured_content_json || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="333">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="334">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="335">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="336">
            

            

            <code class="ruby">  def update_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="337">
            

            

            <code class="ruby">    transcript = @project.transcript</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="338">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="339">
            

            

            <code class="ruby">    unless transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="340">
            

            

            <code class="ruby">      render_error(&quot;Transcript not found&quot;, &quot;TRANSCRIPT_NOT_FOUND&quot;, :not_found)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="341">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="342">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="344">
            

            

            <code class="ruby">    # Extract polished content from request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="345">
            

            

            <code class="ruby">    polished_content = params[:polishedContent]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="346">
            

            

            <code class="ruby">    edited_content = params[:editedContent]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="347">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="348">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="349">
            

            

            <code class="ruby">      # Update transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="350">
            

            

            <code class="ruby">      transcript.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="351">
            

            

            <code class="ruby">        polished_content: polished_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="352">
            

            

            <code class="ruby">        edited_content_json: edited_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">        last_updated: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="354">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="355">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="356">
            

            

            <code class="ruby">      # Update project&#39;s last modified timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="357">
            

            

            <code class="ruby">      @project.update!(last_modified_at: Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="358">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="359">
            

            

            <code class="ruby">      Rails.logger.info &quot;Transcript updated for project #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="360">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">        id: transcript.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="363">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="364">
            

            

            <code class="ruby">        status: transcript.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="365">
            

            

            <code class="ruby">        last_updated: transcript.last_updated.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="366">
            

            

            <code class="ruby">        message: &quot;Transcript updated successfully&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="367">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="368">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="369">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="370">
            

            

            <code class="ruby">      Rails.logger.error &quot;Failed to update transcript for project #{@project.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="371">
            

            

            <code class="ruby">      render_error(&quot;Failed to update transcript&quot;, &quot;UPDATE_FAILED&quot;, :unprocessable_entity)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="372">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="373">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="374">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="375">
            

            

            <code class="ruby">  public</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="376">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="377">
            

            

            <code class="ruby">  def add_more_chapters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="378">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== ADD_MORE_CHAPTERS DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="379">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project ID: #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="380">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project topic: #{@project.topic}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="381">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Current chapters count: #{@project.chapters.count}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="382">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="383">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="384">
            

            

            <code class="ruby">      # Use LLM service to generate additional chapters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="385">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="386">
            

            

            <code class="ruby">      Rails.logger.debug &quot;InterviewQuestionService instantiated&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="387">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="388">
            

            

            <code class="ruby">      additional_outline = service.generate_additional_chapters(@project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="389">
            

            

            <code class="ruby">      Rails.logger.debug &quot;LLM service returned: #{additional_outline.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="390">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="391">
            

            

            <code class="ruby">      if additional_outline[:error]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="392">
            

            

            <code class="ruby">        Rails.logger.error &quot;Additional chapters generation failed: #{additional_outline[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="393">
            

            

            <code class="ruby">        render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="394">
            

            

            <code class="ruby">          &quot;Failed to generate additional chapters: #{additional_outline[:error]}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="395">
            

            

            <code class="ruby">          &quot;GENERATION_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="396">
            

            

            <code class="ruby">          :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="397">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="398">
            

            

            <code class="ruby">        return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="399">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="400">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="401">
            

            

            <code class="ruby">      # Create new chapters, sections, and questions from LLM-generated outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="402">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Creating additional chapters from outline...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="403">
            

            

            <code class="ruby">      Rails.logger.debug &quot;New chapters count: #{additional_outline[:chapters]&amp;.length || 0}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="404">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="405">
            

            

            <code class="ruby">      created_chapters = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="406">
            

            

            <code class="ruby">      new_question_ids = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="407">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="408">
            

            

            <code class="ruby">      ActiveRecord::Base.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="409">
            

            

            <code class="ruby">        additional_outline[:chapters]&amp;.each do |chapter_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="410">
            

            

            <code class="ruby">          Rails.logger.debug &quot;Creating chapter: #{chapter_data[:title]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="411">
            

            

            <code class="ruby">          chapter = @project.chapters.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="412">
            

            

            <code class="ruby">            title: chapter_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="413">
            

            

            <code class="ruby">            order: chapter_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="414">
            

            

            <code class="ruby">            omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="415">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="416">
            

            

            <code class="ruby">          Rails.logger.debug &quot;Chapter created with ID: #{chapter.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="417">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="418">
            

            

            <code class="ruby">          chapter_data[:sections]&amp;.each do |section_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="419">
            

            

            <code class="ruby">            Rails.logger.debug &quot;Creating section: #{section_data[:title]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="420">
            

            

            <code class="ruby">            section = chapter.sections.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="421">
            

            

            <code class="ruby">              title: section_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            

            

            <code class="ruby">              order: section_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="423">
            

            

            <code class="ruby">              omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="424">
            

            

            <code class="ruby">            )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="425">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="426">
            

            

            <code class="ruby">            section_data[:questions]&amp;.each do |question_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="427">
            

            

            <code class="ruby">              question = section.questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="428">
            

            

            <code class="ruby">                text: question_data[:text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="429">
            

            

            <code class="ruby">                order: question_data[:order]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="430">
            

            

            <code class="ruby">              )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="431">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="432">
            

            

            <code class="ruby">              # Collect question IDs for post-transaction job enqueueing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="433">
            

            

            <code class="ruby">              if @project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="434">
            

            

            <code class="ruby">                new_question_ids &lt;&lt; question.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="435">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="436">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="437">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="438">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="439">
            

            

            <code class="ruby">          created_chapters &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="440">
            

            

            <code class="ruby">            chapter_id: chapter.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="441">
            

            

            <code class="ruby">            title: chapter.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="442">
            

            

            <code class="ruby">            order: chapter.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="443">
            

            

            <code class="ruby">            omitted: chapter.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="444">
            

            

            <code class="ruby">            sections: chapter.sections.by_order.map do |section|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="445">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="446">
            

            

            <code class="ruby">                section_id: section.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="447">
            

            

            <code class="ruby">                title: section.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="448">
            

            

            <code class="ruby">                order: section.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="449">
            

            

            <code class="ruby">                omitted: section.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="450">
            

            

            <code class="ruby">                questions: section.questions.base_questions.by_order.map do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="451">
            

            

            <code class="ruby">                  {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="452">
            

            

            <code class="ruby">                    question_id: question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="453">
            

            

            <code class="ruby">                    text: question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="454">
            

            

            <code class="ruby">                    order: question.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="455">
            

            

            <code class="ruby">                    omitted: question.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="456">
            

            

            <code class="ruby">                    is_follow_up: question.is_follow_up</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="457">
            

            

            <code class="ruby">                  }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="458">
            

            

            <code class="ruby">                end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="459">
            

            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="460">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="461">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="462">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="463">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="464">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="465">
            

            

            <code class="ruby">      # Enqueue Polly jobs after transaction commits to ensure questions exist</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="466">
            

            

            <code class="ruby">      if @project.is_speech_interview &amp;&amp; new_question_ids.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="467">
            

            

            <code class="ruby">        Rails.logger.debug &quot;Enqueueing Polly jobs for #{new_question_ids.length} questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="468">
            

            

            <code class="ruby">        new_question_ids.each do |question_id|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="469">
            

            

            <code class="ruby">          PollyGenerationJob.perform_later(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="470">
            

            

            <code class="ruby">            question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="471">
            

            

            <code class="ruby">            voice_id: @project.voice_id || &#39;Joanna&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="472">
            

            

            <code class="ruby">            speech_rate: @project.speech_rate || 100</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="473">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="474">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="475">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="476">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="477">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Updating project last_modified_at&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="478">
            

            

            <code class="ruby">      @project.update!(last_modified_at: Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="479">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Additional chapters generation completed successfully&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="480">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="481">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="482">
            

            

            <code class="ruby">        message: &#39;Additional chapters generated successfully&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="483">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="484">
            

            

            <code class="ruby">        new_chapters: created_chapters,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="485">
            

            

            <code class="ruby">        total_chapters_count: @project.chapters.count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="486">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="487">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="488">
            

            

            <code class="ruby">      Rails.logger.error &quot;Additional chapters generation failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="489">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="490">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="491">
            

            

            <code class="ruby">        &quot;Failed to generate additional chapters: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="492">
            

            

            <code class="ruby">        &quot;GENERATION_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="493">
            

            

            <code class="ruby">        :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="494">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="495">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="496">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="497">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="498">
            

            

            <code class="ruby">  def complete_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="499">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== COMPLETE_INTERVIEW DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="500">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project ID: #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="501">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Current status: #{@project.status}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="502">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="503">
            

            

            <code class="ruby">    # Validate that the project is in the right state to be completed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="504">
            

            

            <code class="ruby">    unless [&#39;outline_ready&#39;, &#39;recording_in_progress&#39;].include?(@project.status)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="505">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="506">
            

            

            <code class="ruby">        &quot;Cannot complete interview for project with status: #{@project.status}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="507">
            

            

            <code class="ruby">        &quot;INVALID_STATUS&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="508">
            

            

            <code class="ruby">        :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="509">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="510">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="511">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="512">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="513">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="514">
            

            

            <code class="ruby">      # Update project status to transcribing (will later become completed when transcript is ready)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="515">
            

            

            <code class="ruby">      @project.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="516">
            

            

            <code class="ruby">        status: &#39;transcribing&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="517">
            

            

            <code class="ruby">        last_modified_at: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="518">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="519">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="520">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Project status updated to transcribing&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="521">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="522">
            

            

            <code class="ruby">      # Check if there are any audio segments to process</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="523">
            

            

            <code class="ruby">      audio_segments_count = @project.audio_segments.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="524">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="525">
            

            

            <code class="ruby">      # If no audio segments, mark as completed immediately</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="526">
            

            

            <code class="ruby">      if audio_segments_count == 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="527">
            

            

            <code class="ruby">        @project.update!(status: &#39;completed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="528">
            

            

            <code class="ruby">        Rails.logger.debug &quot;No audio segments found, marking as completed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="529">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="530">
            

            

            <code class="ruby">        # Generate complete transcript for the entire interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="531">
            

            

            <code class="ruby">        Rails.logger.debug &quot;Generating complete transcript for #{audio_segments_count} audio segments&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="532">
            

            

            <code class="ruby">        TranscriptContentAssemblerService.generate_complete_transcript(@project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="533">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="534">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="535">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="536">
            

            

            <code class="ruby">        message: &#39;Interview completed successfully&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="537">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="538">
            

            

            <code class="ruby">        status: @project.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="539">
            

            

            <code class="ruby">        next_step: audio_segments_count &gt; 0 ? &#39;transcribing&#39; : &#39;view_transcript&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="540">
            

            

            <code class="ruby">        completed_at: Time.current.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="541">
            

            

            <code class="ruby">        audio_segments_count: audio_segments_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="542">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="543">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="544">
            

            

            <code class="ruby">      Rails.logger.error &quot;Interview completion failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="545">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="546">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="547">
            

            

            <code class="ruby">        &quot;Failed to complete interview: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="548">
            

            

            <code class="ruby">        &quot;COMPLETION_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="549">
            

            

            <code class="ruby">        :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="550">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="551">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="552">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="553">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="554">
            

            

            <code class="ruby">  # Get available questions for interview including existing followup questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="555">
            

            

            <code class="ruby">  def available_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="556">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== AVAILABLE_QUESTIONS DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="557">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project ID: #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="558">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Current status: #{@project.status}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="559">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="560">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="561">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="562">
            

            

            <code class="ruby">      # Use InterviewFlowService to generate the proper question queue</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="563">
            

            

            <code class="ruby">      # This includes both base questions and any existing followup questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="564">
            

            

            <code class="ruby">      service = InterviewFlowService.new(@project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="565">
            

            

            <code class="ruby">      question_queue = service.generate_question_queue</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="566">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="567">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Generated question queue with #{question_queue.length} questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="568">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="569">
            

            

            <code class="ruby">      # CRITICAL FIX: Filter questions based on audio readiness for speech interviews</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="570">
            

            

            <code class="ruby">      # For speech interviews: Only include questions that have audio ready</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="571">
            

            

            <code class="ruby">      # For reading interviews: Include all questions immediately</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="572">
            

            

            <code class="ruby">      initial_count = question_queue.length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="573">
            

            

            <code class="ruby">      question_queue = question_queue.select do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="574">
            

            

            <code class="ruby">        question.available_for_project_type?(@project.is_speech_interview)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="575">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="576">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="577">
            

            

            <code class="ruby">      if @project.is_speech_interview &amp;&amp; question_queue.length &lt; initial_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="578">
            

            

            <code class="ruby">        filtered_count = initial_count - question_queue.length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="579">
            

            

            <code class="ruby">        Rails.logger.debug &quot;Speech interview: Filtered out #{filtered_count} questions without completed audio&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="580">
            

            

            <code class="ruby">        Rails.logger.debug &quot;Remaining questions: #{question_queue.length}/#{initial_count}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="581">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="582">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="583">
            

            

            <code class="ruby">      # Serialize the questions in the format expected by the iOS client</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="584">
            

            

            <code class="ruby">      Rails.logger.debug &quot;\n AUDIO URL MAPPING DEBUG - available_questions endpoint&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="585">
            

            

            <code class="ruby">      Rails.logger.debug &quot;&quot; * 50</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="586">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="587">
            

            

            <code class="ruby">      serialized_questions = question_queue.map do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="588">
            

            

            <code class="ruby">        question_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="589">
            

            

            <code class="ruby">          question_id: question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="590">
            

            

            <code class="ruby">          text: question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="591">
            

            

            <code class="ruby">          order: question.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="592">
            

            

            <code class="ruby">          omitted: question.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="593">
            

            

            <code class="ruby">          skipped: question.skipped,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="594">
            

            

            <code class="ruby">          parent_question_id: question.parent_question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="595">
            

            

            <code class="ruby">          is_follow_up: question.is_follow_up,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="596">
            

            

            <code class="ruby">          section_id: question.section_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="597">
            

            

            <code class="ruby">          section_title: question.section.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="598">
            

            

            <code class="ruby">          chapter_id: question.section.chapter_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="599">
            

            

            <code class="ruby">          chapter_title: question.section.chapter.title</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="600">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="601">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="602">
            

            

            <code class="ruby">        # Include polly_audio_url if this is a speech interview</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="603">
            

            

            <code class="ruby">        # Since we already filtered for audio-ready questions, all speech interview questions should have audio</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="604">
            

            

            <code class="ruby">        if @project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="605">
            

            

            <code class="ruby">          if question.polly_audio_clip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="606">
            

            

            <code class="ruby">            audio_url = question.polly_audio_clip.s3_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="607">
            

            

            <code class="ruby">            question_data[:polly_audio_url] = audio_url</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="608">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="609">
            

            

            <code class="ruby">            # DEBUG: Log the audio mapping</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="610">
            

            

            <code class="ruby">            Rails.logger.debug &quot; Question #{question.id}: \&quot;#{question.text[0..50]}...\&quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="611">
            

            

            <code class="ruby">            Rails.logger.debug &quot;    S3 Key: #{question.polly_audio_clip.s3_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="612">
            

            

            <code class="ruby">            Rails.logger.debug &quot;    Voice: #{question.polly_audio_clip.voice_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="613">
            

            

            <code class="ruby">            Rails.logger.debug &quot;    Rate: #{question.polly_audio_clip.speech_rate}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="614">
            

            

            <code class="ruby">            Rails.logger.debug &quot;    Status: #{question.polly_audio_clip.status}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="615">
            

            

            <code class="ruby">            Rails.logger.debug &quot;    URL: #{audio_url[0..100]}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="616">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="617">
            

            

            <code class="ruby">            Rails.logger.warn &quot; Question #{question.id} has NO polly_audio_clip!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="618">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="619">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="620">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="621">
            

            

            <code class="ruby">        question_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="622">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="623">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="624">
            

            

            <code class="ruby">      Rails.logger.debug &quot; Total questions with audio: #{serialized_questions.count { |q| q[:polly_audio_url].present? }}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="625">
            

            

            <code class="ruby">      Rails.logger.debug &quot;&quot; * 50</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="626">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="627">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="628">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="629">
            

            

            <code class="ruby">        status: @project.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="630">
            

            

            <code class="ruby">        questions: serialized_questions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="631">
            

            

            <code class="ruby">        total_questions: question_queue.length,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="632">
            

            

            <code class="ruby">        generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="633">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="634">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="635">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="636">
            

            

            <code class="ruby">      Rails.logger.error &quot;Available questions request failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="637">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="638">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="639">
            

            

            <code class="ruby">        &quot;Failed to get available questions: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="640">
            

            

            <code class="ruby">        &quot;QUESTIONS_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="641">
            

            

            <code class="ruby">        :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="642">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="643">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="644">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="645">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="646">
            

            

            <code class="ruby">  def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="647">
            

            

            <code class="ruby">    project_id = @project.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="648">
            

            

            <code class="ruby">    title = @project.title</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="649">
            

            

            <code class="ruby">    @project.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="650">
            

            

            <code class="ruby">    render json: { message: &quot;Project &#39;#{title}&#39; deleted successfully.&quot;, project_id: project_id }, status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="651">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="652">
            

            

            <code class="ruby">    render_error(&quot;Failed to delete project: #{e.message}&quot;, &quot;DELETE_ERROR&quot;, :internal_server_error)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="653">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="654">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="655">
            

            

            <code class="ruby">  # Get follow-up questions created after a specific timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="656">
            

            

            <code class="ruby">  def follow_up_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="657">
            

            

            <code class="ruby">    timestamp_param = params[:since]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="658">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="659">
            

            

            <code class="ruby">    if timestamp_param.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="660">
            

            

            <code class="ruby">      render_error(&quot;Missing &#39;since&#39; timestamp parameter&quot;, &quot;MISSING_TIMESTAMP&quot;, :bad_request)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="661">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="662">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="663">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="664">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="665">
            

            

            <code class="ruby">      since_timestamp = Time.parse(timestamp_param)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="666">
            

            

            <code class="ruby">    rescue ArgumentError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="667">
            

            

            <code class="ruby">      render_error(&quot;Invalid timestamp format&quot;, &quot;INVALID_TIMESTAMP&quot;, :bad_request)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="668">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="669">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="670">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="671">
            

            

            <code class="ruby">    # Get all questions in this project created after the timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="672">
            

            

            <code class="ruby">    new_questions = @project.questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="673">
            

            

            <code class="ruby">                           .where(&quot;questions.created_at &gt; ?&quot;, since_timestamp)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="674">
            

            

            <code class="ruby">                           .includes(:section =&gt; {:chapter =&gt; {}})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="675">
            

            

            <code class="ruby">                           .order(&quot;questions.created_at&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="676">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="677">
            

            

            <code class="ruby">    # Serialize the questions in the format expected by the iOS client</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="678">
            

            

            <code class="ruby">    serialized_questions = new_questions.map do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="679">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="680">
            

            

            <code class="ruby">        question_id: question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="681">
            

            

            <code class="ruby">        text: question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="682">
            

            

            <code class="ruby">        order: question.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="683">
            

            

            <code class="ruby">        omitted: question.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="684">
            

            

            <code class="ruby">        parent_question_id: question.parent_question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="685">
            

            

            <code class="ruby">        is_follow_up: question.is_follow_up,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="686">
            

            

            <code class="ruby">        section_id: question.section_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="687">
            

            

            <code class="ruby">        section_title: question.section.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="688">
            

            

            <code class="ruby">        chapter_id: question.section.chapter_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="689">
            

            

            <code class="ruby">        chapter_title: question.section.chapter.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="690">
            

            

            <code class="ruby">        created_at: question.created_at.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="691">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="692">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="693">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="694">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="695">
            

            

            <code class="ruby">      project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="696">
            

            

            <code class="ruby">      since: since_timestamp.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="697">
            

            

            <code class="ruby">      new_questions: serialized_questions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="698">
            

            

            <code class="ruby">      count: new_questions.count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="699">
            

            

            <code class="ruby">      generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="700">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="701">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="702">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="703">
            

            

            <code class="ruby">    Rails.logger.error &quot;Follow-up questions request failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="704">
            

            

            <code class="ruby">    Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="705">
            

            

            <code class="ruby">    render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="706">
            

            

            <code class="ruby">      &quot;Failed to get follow-up questions: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="707">
            

            

            <code class="ruby">      &quot;FOLLOWUP_QUESTIONS_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="708">
            

            

            <code class="ruby">      :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="709">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="710">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="711">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="712">
            

            

            <code class="ruby">  # Get questions with their actual interview responses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="713">
            

            

            <code class="ruby">  def questions_with_responses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="714">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== QUESTIONS_WITH_RESPONSES DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="715">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project ID: #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="716">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Current status: #{@project.status}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="717">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="718">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="719">
            

            

            <code class="ruby">      # Get all questions with their associated audio segments (responses)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="720">
            

            

            <code class="ruby">      questions_with_audio = @project.questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="721">
            

            

            <code class="ruby">                                    .includes(:section =&gt; {:chapter =&gt; {}}, :audio_segments =&gt; {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="722">
            

            

            <code class="ruby">                                    .order(&quot;sections.order, questions.order&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="723">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="724">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Found #{questions_with_audio.count} questions total&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="725">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="726">
            

            

            <code class="ruby">      # Serialize questions with their responses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="727">
            

            

            <code class="ruby">      serialized_questions = questions_with_audio.map do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="728">
            

            

            <code class="ruby">        # Get the audio segment (response) for this question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="729">
            

            

            <code class="ruby">        audio_response = question.audio_segments.first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="730">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="731">
            

            

            <code class="ruby">        question_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="732">
            

            

            <code class="ruby">          question_id: question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="733">
            

            

            <code class="ruby">          text: question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="734">
            

            

            <code class="ruby">          order: question.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="735">
            

            

            <code class="ruby">          omitted: question.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="736">
            

            

            <code class="ruby">          skipped: question.skipped,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="737">
            

            

            <code class="ruby">          parent_question_id: question.parent_question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="738">
            

            

            <code class="ruby">          is_follow_up: question.is_follow_up,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="739">
            

            

            <code class="ruby">          section_id: question.section_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="740">
            

            

            <code class="ruby">          section_title: question.section.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="741">
            

            

            <code class="ruby">          chapter_id: question.section.chapter_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="742">
            

            

            <code class="ruby">          chapter_title: question.section.chapter.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="743">
            

            

            <code class="ruby">          # Add response data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="744">
            

            

            <code class="ruby">          has_response: audio_response.present?,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="745">
            

            

            <code class="ruby">          response_status: audio_response&amp;.upload_status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="746">
            

            

            <code class="ruby">          transcribed_response: audio_response&amp;.transcription_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="747">
            

            

            <code class="ruby">          audio_file_name: audio_response&amp;.file_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="748">
            

            

            <code class="ruby">          response_duration: audio_response&amp;.duration_seconds</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="749">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="750">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="751">
            

            

            <code class="ruby">        # Include polly audio URL for speech interviews</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="752">
            

            

            <code class="ruby">        if @project.is_speech_interview &amp;&amp; question.polly_audio_clip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="753">
            

            

            <code class="ruby">          question_data[:polly_audio_url] = question.polly_audio_clip.s3_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="754">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="755">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="756">
            

            

            <code class="ruby">        question_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="757">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="758">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="759">
            

            

            <code class="ruby">      # Count questions with responses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="760">
            

            

            <code class="ruby">      questions_with_responses = serialized_questions.count { |q| q[:has_response] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="761">
            

            

            <code class="ruby">      questions_with_transcriptions = serialized_questions.count { |q| q[:transcribed_response].present? }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="762">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="763">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Questions with audio responses: #{questions_with_responses}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="764">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Questions with transcriptions: #{questions_with_transcriptions}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="765">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="766">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="767">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="768">
            

            

            <code class="ruby">        project_title: @project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="769">
            

            

            <code class="ruby">        status: @project.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="770">
            

            

            <code class="ruby">        questions: serialized_questions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="771">
            

            

            <code class="ruby">        total_questions: questions_with_audio.count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="772">
            

            

            <code class="ruby">        questions_with_responses: questions_with_responses,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="773">
            

            

            <code class="ruby">        questions_with_transcriptions: questions_with_transcriptions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="774">
            

            

            <code class="ruby">        generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="775">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="776">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="777">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="778">
            

            

            <code class="ruby">      Rails.logger.error &quot;Questions with responses request failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="779">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="780">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="781">
            

            

            <code class="ruby">        &quot;Failed to get questions with responses: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="782">
            

            

            <code class="ruby">        &quot;QUESTIONS_WITH_RESPONSES_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="783">
            

            

            <code class="ruby">        :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="784">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="785">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="786">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="787">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="788">
            

            

            <code class="ruby">  def generate_stock_image_topics</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="789">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="790">
            

            

            <code class="ruby">      selected_questions = params[:question_ids] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="791">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="792">
            

            

            <code class="ruby">      if selected_questions.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="793">
            

            

            <code class="ruby">        return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="794">
            

            

            <code class="ruby">          &quot;No questions selected for stock image topic generation&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="795">
            

            

            <code class="ruby">          &quot;NO_QUESTIONS_SELECTED&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="796">
            

            

            <code class="ruby">          :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="797">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="798">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="799">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="800">
            

            

            <code class="ruby">      # Get transcription text from selected questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="801">
            

            

            <code class="ruby">      transcription_texts = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="802">
            

            

            <code class="ruby">      selected_questions.each do |question_id|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="803">
            

            

            <code class="ruby">        audio_segment = @project.audio_segments.joins(:question).where(questions: { id: question_id }).first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="804">
            

            

            <code class="ruby">        if audio_segment&amp;.transcribed? &amp;&amp; audio_segment.transcription_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="805">
            

            

            <code class="ruby">          text = audio_segment.transcription_data[&#39;text&#39;] || audio_segment.transcription_data[:text]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="806">
            

            

            <code class="ruby">          transcription_texts &lt;&lt; text if text&amp;.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="807">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="808">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="809">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="810">
            

            

            <code class="ruby">      if transcription_texts.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="811">
            

            

            <code class="ruby">        return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="812">
            

            

            <code class="ruby">          &quot;No transcribed content found for selected questions&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="813">
            

            

            <code class="ruby">          &quot;NO_TRANSCRIPTION_DATA&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="814">
            

            

            <code class="ruby">          :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="815">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="816">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="817">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="818">
            

            

            <code class="ruby">      # Combine all transcription text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="819">
            

            

            <code class="ruby">      combined_text = transcription_texts.join(&#39; &#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="820">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="821">
            

            

            <code class="ruby">      # Use Gemini to generate 5 stock image topics</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="822">
            

            

            <code class="ruby">      gemini_service = GeminiContentAnalysisService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="823">
            

            

            <code class="ruby">      topics_result = gemini_service.generate_image_queries_for_text(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="824">
            

            

            <code class="ruby">        combined_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="825">
            

            

            <code class="ruby">        { type: &quot;audiogram background selection&quot;, style: &quot;stock photography&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="826">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="827">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="828">
            

            

            <code class="ruby">      # Extract and format topics</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="829">
            

            

            <code class="ruby">      topics = topics_result.is_a?(Array) ? topics_result : (topics_result[:image_queries] || [])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="830">
            

            

            <code class="ruby">      topics = topics.first(5) # Ensure we have exactly 5 topics</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="831">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="832">
            

            

            <code class="ruby">      # Pad with generic topics if needed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="833">
            

            

            <code class="ruby">      while topics.length &lt; 5</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="834">
            

            

            <code class="ruby">        generic_topics = [&quot;professional workspace&quot;, &quot;natural landscape&quot;, &quot;urban architecture&quot;, &quot;creative design&quot;, &quot;inspiring scenery&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="835">
            

            

            <code class="ruby">        topics &lt;&lt; generic_topics[topics.length % generic_topics.length]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="836">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="837">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="838">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="839">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="840">
            

            

            <code class="ruby">        topics: topics.uniq.first(5),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="841">
            

            

            <code class="ruby">        combined_text_preview: combined_text.truncate(200),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="842">
            

            

            <code class="ruby">        generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="843">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="844">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="845">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="846">
            

            

            <code class="ruby">      Rails.logger.error &quot;Stock image topic generation failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="847">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="848">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="849">
            

            

            <code class="ruby">        &quot;Failed to generate stock image topics: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="850">
            

            

            <code class="ruby">        &quot;TOPIC_GENERATION_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="851">
            

            

            <code class="ruby">        :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="852">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="853">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="854">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="855">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="856">
            

            

            <code class="ruby">  def fetch_stock_images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="857">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="858">
            

            

            <code class="ruby">      topics = params[:topics] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="859">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="860">
            

            

            <code class="ruby">      if topics.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="861">
            

            

            <code class="ruby">        return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="862">
            

            

            <code class="ruby">          &quot;No topics provided for stock image fetching&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="863">
            

            

            <code class="ruby">          &quot;NO_TOPICS_PROVIDED&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="864">
            

            

            <code class="ruby">          :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="865">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="866">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="867">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="868">
            

            

            <code class="ruby">      # Use ImageServiceBus to fetch images for each topic</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="869">
            

            

            <code class="ruby">      image_service = ImageServiceBus.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="870">
            

            

            <code class="ruby">      topic_images = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="871">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="872">
            

            

            <code class="ruby">      topics.each do |topic|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="873">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="874">
            

            

            <code class="ruby">          # Fetch 3 images per topic using stock_image category</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="875">
            

            

            <code class="ruby">          images_result = image_service.get_images(topic, 3, &#39;1080p&#39;, &#39;stock_image&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="876">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="877">
            

            

            <code class="ruby">          if images_result &amp;&amp; images_result.any? &amp;&amp; images_result.first[:images]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="878">
            

            

            <code class="ruby">            topic_images[topic] = images_result.first[:images].map do |img|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="879">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="880">
            

            

            <code class="ruby">                url: img[:url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="881">
            

            

            <code class="ruby">                width: img[:width],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="882">
            

            

            <code class="ruby">                height: img[:height],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="883">
            

            

            <code class="ruby">                alt_text: img[:alt_text] || topic,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="884">
            

            

            <code class="ruby">                source: img[:source] || &#39;stock&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="885">
            

            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="886">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="887">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="888">
            

            

            <code class="ruby">            topic_images[topic] = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="889">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="890">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="891">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="892">
            

            

            <code class="ruby">          Rails.logger.error &quot;Failed to fetch images for topic &#39;#{topic}&#39;: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="893">
            

            

            <code class="ruby">          topic_images[topic] = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="894">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="895">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="896">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="897">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="898">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="899">
            

            

            <code class="ruby">        topic_images: topic_images,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="900">
            

            

            <code class="ruby">        fetched_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="901">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="902">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="903">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="904">
            

            

            <code class="ruby">      Rails.logger.error &quot;Stock image fetching failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="905">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="906">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="907">
            

            

            <code class="ruby">        &quot;Failed to fetch stock images: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="908">
            

            

            <code class="ruby">        &quot;IMAGE_FETCH_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="909">
            

            

            <code class="ruby">        :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="910">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="911">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="912">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="913">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="914">
            

            

            <code class="ruby">  def generate_audiogram_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="915">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="916">
            

            

            <code class="ruby">      selected_questions = params[:question_ids] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="917">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="918">
            

            

            <code class="ruby">      if selected_questions.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="919">
            

            

            <code class="ruby">        return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="920">
            

            

            <code class="ruby">          &quot;No questions selected for audiogram&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="921">
            

            

            <code class="ruby">          &quot;NO_QUESTIONS_SELECTED&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="922">
            

            

            <code class="ruby">          :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="923">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="924">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="925">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="926">
            

            

            <code class="ruby">      # Generate audiogram data using the service</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="927">
            

            

            <code class="ruby">      audiogram_service = AudiogramGenerationService.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="928">
            

            

            <code class="ruby">        project: @project,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="929">
            

            

            <code class="ruby">        selected_questions: selected_questions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="930">
            

            

            <code class="ruby">        user: current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="931">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="932">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="933">
            

            

            <code class="ruby">      audiogram_data = audiogram_service.generate_audiogram_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="934">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="935">
            

            

            <code class="ruby">      if audiogram_data[:segments].empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="936">
            

            

            <code class="ruby">        return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="937">
            

            

            <code class="ruby">          &quot;No valid audio segments found for selected questions&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="938">
            

            

            <code class="ruby">          &quot;NO_AUDIO_SEGMENTS&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="939">
            

            

            <code class="ruby">          :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="940">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="941">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="942">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="943">
            

            

            <code class="ruby">      # Generate ASS subtitle content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="944">
            

            

            <code class="ruby">      subtitle_format = params[:subtitle_format]&amp;.to_sym || :karaoke</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="945">
            

            

            <code class="ruby">      ass_content = audiogram_service.generate_ass_subtitle_content(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="946">
            

            

            <code class="ruby">        audiogram_data, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="947">
            

            

            <code class="ruby">        output_format: subtitle_format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="948">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="949">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="950">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="951">
            

            

            <code class="ruby">        audiogram_data: audiogram_data,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="952">
            

            

            <code class="ruby">        ass_subtitle_content: ass_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="953">
            

            

            <code class="ruby">        metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="954">
            

            

            <code class="ruby">          total_segments: audiogram_data[:segments].length,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="955">
            

            

            <code class="ruby">          total_duration: audiogram_data[:total_duration],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="956">
            

            

            <code class="ruby">          subtitle_format: subtitle_format,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="957">
            

            

            <code class="ruby">          generated_at: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="958">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="959">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="960">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="961">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="962">
            

            

            <code class="ruby">      Rails.logger.error &quot;Audiogram generation failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="963">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="964">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="965">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="966">
            

            

            <code class="ruby">        &quot;Failed to generate audiogram data: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="967">
            

            

            <code class="ruby">        &quot;AUDIOGRAM_GENERATION_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="968">
            

            

            <code class="ruby">        :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="969">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="970">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="971">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="972">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="973">
            

            

            <code class="ruby">  # GET /api/projects/:id/questions/diff?since=&lt;timestamp&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="974">
            

            

            <code class="ruby">  # Returns only questions that are new or updated since the given timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="975">
            

            

            <code class="ruby">  # This is a lightweight endpoint for efficient background polling</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="976">
            

            

            <code class="ruby">  def questions_diff</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="977">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== QUESTIONS_DIFF DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="978">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project ID: #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="979">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="980">
            

            

            <code class="ruby">    # Parse the &#39;since&#39; parameter</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="981">
            

            

            <code class="ruby">    since_param = params[:since]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="982">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="983">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="984">
            

            

            <code class="ruby">      # Default to 1 minute ago if no timestamp provided</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="985">
            

            

            <code class="ruby">      since_time = since_param.present? ? Time.parse(since_param) : 1.minute.ago</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="986">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Fetching questions updated since: #{since_time.iso8601}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="987">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="988">
            

            

            <code class="ruby">      # Find questions that are new or updated since the timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="989">
            

            

            <code class="ruby">      # Include both base questions and follow-up questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="990">
            

            

            <code class="ruby">      new_questions = @project.questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="991">
            

            

            <code class="ruby">                              .where(&#39;questions.created_at &gt; ? OR questions.updated_at &gt; ?&#39;, since_time, since_time)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="992">
            

            

            <code class="ruby">                              .includes(:section =&gt; :chapter)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="993">
            

            

            <code class="ruby">                              .order(:order, :created_at)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="994">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="995">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Found #{new_questions.count} new/updated questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="996">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="997">
            

            

            <code class="ruby">      # Filter based on audio readiness for speech interviews</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="998">
            

            

            <code class="ruby">      if @project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="999">
            

            

            <code class="ruby">        initial_count = new_questions.count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1000">
            

            

            <code class="ruby">        new_questions = new_questions.select do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1001">
            

            

            <code class="ruby">          question.available_for_project_type?(true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1002">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1003">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1004">
            

            

            <code class="ruby">        if new_questions.length &lt; initial_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1005">
            

            

            <code class="ruby">          filtered_count = initial_count - new_questions.length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1006">
            

            

            <code class="ruby">          Rails.logger.debug &quot;Filtered out #{filtered_count} questions without audio&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1007">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1008">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1009">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1010">
            

            

            <code class="ruby">      # Serialize the questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1011">
            

            

            <code class="ruby">      serialized_questions = new_questions.map do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1012">
            

            

            <code class="ruby">        question_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1013">
            

            

            <code class="ruby">          question_id: question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1014">
            

            

            <code class="ruby">          text: question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1015">
            

            

            <code class="ruby">          order: question.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1016">
            

            

            <code class="ruby">          omitted: question.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1017">
            

            

            <code class="ruby">          skipped: question.skipped,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1018">
            

            

            <code class="ruby">          parent_question_id: question.parent_question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1019">
            

            

            <code class="ruby">          is_follow_up: question.is_follow_up,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1020">
            

            

            <code class="ruby">          section_id: question.section_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1021">
            

            

            <code class="ruby">          section_title: question.section&amp;.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1022">
            

            

            <code class="ruby">          chapter_id: question.section&amp;.chapter_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1023">
            

            

            <code class="ruby">          chapter_title: question.section&amp;.chapter&amp;.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1024">
            

            

            <code class="ruby">          created_at: question.created_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1025">
            

            

            <code class="ruby">          updated_at: question.updated_at.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1026">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1027">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1028">
            

            

            <code class="ruby">        # Include audio URL for speech interviews</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1029">
            

            

            <code class="ruby">        if @project.is_speech_interview &amp;&amp; question.polly_audio_clip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1030">
            

            

            <code class="ruby">          audio_clip = question.polly_audio_clip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1031">
            

            

            <code class="ruby">          if audio_clip.s3_key.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1032">
            

            

            <code class="ruby">            question_data[:polly_audio_url] = audio_clip.s3_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1033">
            

            

            <code class="ruby">            Rails.logger.debug &quot;Question #{question.id}: Added S3 audio URL&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1034">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1035">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1036">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1037">
            

            

            <code class="ruby">        question_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1038">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1039">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1040">
            

            

            <code class="ruby">      # Return the diff response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1041">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1042">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1043">
            

            

            <code class="ruby">        since: since_time.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1044">
            

            

            <code class="ruby">        current_time: Time.current.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1045">
            

            

            <code class="ruby">        new_questions_count: serialized_questions.length,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1046">
            

            

            <code class="ruby">        questions: serialized_questions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1047">
            

            

            <code class="ruby">        has_more: false # Can be used to indicate if more questions are being generated</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1048">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1049">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1050">
            

            

            <code class="ruby">    rescue ArgumentError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1051">
            

            

            <code class="ruby">      Rails.logger.error &quot;Invalid timestamp parameter: #{since_param}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1052">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1053">
            

            

            <code class="ruby">        error: &#39;Invalid timestamp format&#39;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1054">
            

            

            <code class="ruby">        message: &#39;Please provide timestamp in ISO 8601 format (e.g., 2025-01-01T12:00:00Z)&#39; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1055">
            

            

            <code class="ruby">      }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1056">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1057">
            

            

            <code class="ruby">      Rails.logger.error &quot;Questions diff failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1058">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1059">
            

            

            <code class="ruby">      render json: { error: &#39;Failed to fetch question diff&#39; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1060">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1061">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1062">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1063">
            

            

            <code class="ruby">  # Update interview mode (speech vs reading)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1064">
            

            

            <code class="ruby">  def interview_mode</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1065">
            

            

            <code class="ruby">    is_speech_interview = params[:is_speech_interview] || params[:isSpeechInterview]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1066">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1067">
            

            

            <code class="ruby">    if is_speech_interview.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1068">
            

            

            <code class="ruby">      return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1069">
            

            

            <code class="ruby">        &quot;Missing required parameter: is_speech_interview&quot;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1070">
            

            

            <code class="ruby">        &quot;MISSING_PARAMETER&quot;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1071">
            

            

            <code class="ruby">        :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1072">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1073">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1074">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1075">
            

            

            <code class="ruby">    # Convert string to boolean if needed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1076">
            

            

            <code class="ruby">    speech_enabled = case is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1077">
            

            

            <code class="ruby">                    when true, &#39;true&#39;, &#39;1&#39;, 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1078">
            

            

            <code class="ruby">                      true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1079">
            

            

            <code class="ruby">                    when false, &#39;false&#39;, &#39;0&#39;, 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1080">
            

            

            <code class="ruby">                      false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1081">
            

            

            <code class="ruby">                    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1082">
            

            

            <code class="ruby">                      return render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1083">
            

            

            <code class="ruby">                        &quot;Invalid value for is_speech_interview: must be true or false&quot;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1084">
            

            

            <code class="ruby">                        &quot;INVALID_PARAMETER&quot;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1085">
            

            

            <code class="ruby">                        :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1086">
            

            

            <code class="ruby">                      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1087">
            

            

            <code class="ruby">                    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1088">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1089">
            

            

            <code class="ruby">    @project.update!(is_speech_interview: speech_enabled)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1090">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1091">
            

            

            <code class="ruby">    Rails.logger.info &quot;Updated project #{@project.id} interview mode to #{speech_enabled ? &#39;speech&#39; : &#39;reading&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1092">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1093">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1094">
            

            

            <code class="ruby">      id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1095">
            

            

            <code class="ruby">      is_speech_interview: @project.is_speech_interview,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1096">
            

            

            <code class="ruby">      title: @project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1097">
            

            

            <code class="ruby">      topic: @project.topic,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1098">
            

            

            <code class="ruby">      status: @project.status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1099">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1100">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1101">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1102">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1103">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1104">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1105">
            

            

            <code class="ruby">  def set_project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1106">
            

            

            <code class="ruby">    @project = current_user.projects.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1107">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1108">
            

            

            <code class="ruby">    render_error(&quot;Project not found&quot;, &quot;PROJECT_NOT_FOUND&quot;, :not_found)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1109">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1110">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1111">
            

            

            <code class="ruby">  def project_json_representation(project)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1112">
            

            

            <code class="ruby">    # This logic is extracted from the `show` action for reusability.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1113">
            

            

            <code class="ruby">    # Using `project.chapters` which should already be eager-loaded.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1114">
            

            

            <code class="ruby">    # Use loaded associations to prevent additional queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1115">
            

            

            <code class="ruby">    chapters = project.chapters.to_a.sort_by(&amp;:order)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1116">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1117">
            

            

            <code class="ruby">    outline_status = case project.status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1118">
            

            

            <code class="ruby">                     when &#39;outline_generating&#39; then &#39;generating&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1119">
            

            

            <code class="ruby">                     when &#39;failed&#39; then &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1120">
            

            

            <code class="ruby">                     else chapters.size &gt; 0 ? &#39;ready&#39; : &#39;not_started&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1121">
            

            

            <code class="ruby">                     end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1122">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1123">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1124">
            

            

            <code class="ruby">      id: project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1125">
            

            

            <code class="ruby">      title: project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1126">
            

            

            <code class="ruby">      created_at: project.created_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1127">
            

            

            <code class="ruby">      last_modified_at: project.last_modified_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1128">
            

            

            <code class="ruby">      is_speech_interview: project.is_speech_interview,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1129">
            

            

            <code class="ruby">      outline: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1130">
            

            

            <code class="ruby">        status: outline_status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1131">
            

            

            <code class="ruby">        chapters: chapters.map do |chapter|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1132">
            

            

            <code class="ruby">          # Force associations to array to avoid queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1133">
            

            

            <code class="ruby">          sorted_sections = chapter.sections.to_a.sort_by(&amp;:order)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1134">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1135">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1136">
            

            

            <code class="ruby">            chapter_id: chapter.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1137">
            

            

            <code class="ruby">            title: chapter.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1138">
            

            

            <code class="ruby">            order: chapter.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1139">
            

            

            <code class="ruby">            omitted: chapter.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1140">
            

            

            <code class="ruby">            sections: sorted_sections.map do |section|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1141">
            

            

            <code class="ruby">              # Use loaded questions and filter in memory</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1142">
            

            

            <code class="ruby">              all_questions_in_section = section.questions.to_a</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1143">
            

            

            <code class="ruby">              base_questions = all_questions_in_section.select { |q| !q.is_follow_up }.sort_by(&amp;:order)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1144">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1145">
            

            

            <code class="ruby">              # Build the correctly ordered flat list, inserting follow-ups after their parents</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1146">
            

            

            <code class="ruby">              flat_ordered_questions = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1147">
            

            

            <code class="ruby">              base_questions.each do |base_q|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1148">
            

            

            <code class="ruby">                flat_ordered_questions &lt;&lt; base_q</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1149">
            

            

            <code class="ruby">                # Find and add follow-ups for this base question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1150">
            

            

            <code class="ruby">                follow_ups = all_questions_in_section.select { |q| q.parent_question_id == base_q.id }.sort_by(&amp;:order)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1151">
            

            

            <code class="ruby">                flat_ordered_questions.concat(follow_ups)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1152">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1153">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1154">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1155">
            

            

            <code class="ruby">                section_id: section.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1156">
            

            

            <code class="ruby">                title: section.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1157">
            

            

            <code class="ruby">                order: section.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1158">
            

            

            <code class="ruby">                omitted: section.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1159">
            

            

            <code class="ruby">                questions: flat_ordered_questions.map do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1160">
            

            

            <code class="ruby">                  {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1161">
            

            

            <code class="ruby">                    question_id: question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1162">
            

            

            <code class="ruby">                    text: question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1163">
            

            

            <code class="ruby">                    order: question.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1164">
            

            

            <code class="ruby">                    omitted: question.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1165">
            

            

            <code class="ruby">                    parent_question_id: question.parent_question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1166">
            

            

            <code class="ruby">                    is_follow_up: question.is_follow_up</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1167">
            

            

            <code class="ruby">                  }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1168">
            

            

            <code class="ruby">                end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1169">
            

            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1170">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1171">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1172">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1173">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1174">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1175">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1176">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1177">
            

            

            <code class="ruby">  def project_params</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1178">
            

            

            <code class="ruby">    # Handle both nested (:project key) and flat parameter formats for Swift client compatibility</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1179">
            

            

            <code class="ruby">    # When both are present, merge them with flat parameters taking precedence</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1180">
            

            

            <code class="ruby">    if params[:project].present? &amp;&amp; params[:project].is_a?(ActionController::Parameters)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1181">
            

            

            <code class="ruby">      # Nested format: { &quot;project&quot;: { &quot;initial_topic&quot;: &quot;...&quot;, ... } }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1182">
            

            

            <code class="ruby">      nested_params = params[:project].permit(:initial_topic, :is_speech_interview, :voice_id, :speech_rate, :interview_length, :question_count)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1183">
            

            

            <code class="ruby">      flat_params = params.except(:controller, :action, :project).permit(:initial_topic, :is_speech_interview, :voice_id, :speech_rate, :interview_length, :question_count)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1184">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1185">
            

            

            <code class="ruby">      # Merge both, with flat parameters taking precedence</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1186">
            

            

            <code class="ruby">      source_params = nested_params.to_h.merge(flat_params.to_h)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1187">
            

            

            <code class="ruby">      source_params = ActionController::Parameters.new(source_params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1188">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1189">
            

            

            <code class="ruby">      # Flat format only: { &quot;initial_topic&quot;: &quot;...&quot;, ... } (from Swift client)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1190">
            

            

            <code class="ruby">      source_params = params.except(:controller, :action, :project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1191">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1192">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1193">
            

            

            <code class="ruby">    permitted = source_params.permit(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1194">
            

            

            <code class="ruby">      :initial_topic, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1195">
            

            

            <code class="ruby">      :is_speech_interview, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1196">
            

            

            <code class="ruby">      :voice_id, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1197">
            

            

            <code class="ruby">      :speech_rate,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1198">
            

            

            <code class="ruby">      :interview_length,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1199">
            

            

            <code class="ruby">      :question_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1200">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1201">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1202">
            

            

            <code class="ruby">    permitted.tap do |p|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1203">
            

            

            <code class="ruby">      # Rename initial_topic to topic for our model</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1204">
            

            

            <code class="ruby">      p[:topic] = p.delete(:initial_topic) if p[:initial_topic]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1205">
            

            

            <code class="ruby">      # Preset parameters removed - using custom topics only</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1206">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1207">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1208">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1209">
            

            

            <code class="ruby">  # scaffold_project_from_preset method removed - presets disabled</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1210">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1211">
            

            

            <code class="ruby">  def generate_outline_for_project(project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1212">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== GENERATE_OUTLINE DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1213">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project ID: #{project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1214">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project topic: #{project.topic}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1215">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project status before: #{project.status}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1216">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1217">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1218">
            

            

            <code class="ruby">      # Always use LLM service to generate interview outline (presets disabled)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1219">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1220">
            

            

            <code class="ruby">      Rails.logger.debug &quot;InterviewQuestionService instantiated&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1221">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1222">
            

            

            <code class="ruby">      outline = service.generate_interview_outline(project.topic)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1223">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1224">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Outline ready: #{outline.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1225">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1226">
            

            

            <code class="ruby">      if outline[:error]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1227">
            

            

            <code class="ruby">        Rails.logger.error &quot;Outline generation failed: #{outline[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1228">
            

            

            <code class="ruby">        project.update!(status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1229">
            

            

            <code class="ruby">        return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1230">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1231">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1232">
            

            

            <code class="ruby">      # Create chapters, sections, and questions from LLM-generated outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1233">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Creating chapters from outline...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1234">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Chapters count: #{outline[:chapters]&amp;.length || 0}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1235">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1236">
            

            

            <code class="ruby">      new_question_ids = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1237">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1238">
            

            

            <code class="ruby">      ActiveRecord::Base.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1239">
            

            

            <code class="ruby">        outline[:chapters]&amp;.each do |chapter_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1240">
            

            

            <code class="ruby">          Rails.logger.debug &quot;Creating chapter: #{chapter_data[:title]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1241">
            

            

            <code class="ruby">          chapter = project.chapters.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1242">
            

            

            <code class="ruby">            title: chapter_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1243">
            

            

            <code class="ruby">            order: chapter_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1244">
            

            

            <code class="ruby">            omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1245">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1246">
            

            

            <code class="ruby">          Rails.logger.debug &quot;Chapter created with ID: #{chapter.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1247">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1248">
            

            

            <code class="ruby">          chapter_data[:sections]&amp;.each do |section_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1249">
            

            

            <code class="ruby">            Rails.logger.debug &quot;Creating section: #{section_data[:title]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1250">
            

            

            <code class="ruby">            section = chapter.sections.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1251">
            

            

            <code class="ruby">              title: section_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1252">
            

            

            <code class="ruby">              order: section_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1253">
            

            

            <code class="ruby">              omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1254">
            

            

            <code class="ruby">            )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1255">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1256">
            

            

            <code class="ruby">            section_data[:questions]&amp;.each do |question_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1257">
            

            

            <code class="ruby">              question = section.questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1258">
            

            

            <code class="ruby">                text: question_data[:text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1259">
            

            

            <code class="ruby">                order: question_data[:order]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1260">
            

            

            <code class="ruby">              )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1261">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1262">
            

            

            <code class="ruby">              # Collect question IDs for post-transaction job enqueueing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1263">
            

            

            <code class="ruby">              if project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1264">
            

            

            <code class="ruby">                new_question_ids &lt;&lt; question.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1265">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1266">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1267">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1268">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1269">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1270">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1271">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Updating project status to outline_ready&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1272">
            

            

            <code class="ruby">      project.update!(status: &#39;outline_ready&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1273">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Final project status: #{project.reload.status}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1274">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1275">
            

            

            <code class="ruby">      # Enqueue Polly jobs after transaction commits to ensure questions exist</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1276">
            

            

            <code class="ruby">      if project.is_speech_interview &amp;&amp; new_question_ids.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1277">
            

            

            <code class="ruby">        Rails.logger.debug &quot;Enqueueing Polly jobs for #{new_question_ids.length} questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1278">
            

            

            <code class="ruby">        new_question_ids.each do |question_id|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1279">
            

            

            <code class="ruby">          PollyGenerationJob.perform_later(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1280">
            

            

            <code class="ruby">            question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1281">
            

            

            <code class="ruby">            voice_id: project.voice_id || &#39;Joanna&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1282">
            

            

            <code class="ruby">            speech_rate: project.speech_rate || 100</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1283">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1284">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1285">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1286">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1287">
            

            

            <code class="ruby">      Rails.logger.error &quot;Outline generation failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1288">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1289">
            

            

            <code class="ruby">      project.update!(status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1290">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1291">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1292">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1293">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1294">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="16c56625a1e423cf964d471898d295abedd28079">
  <div class="header">
    <h3>app/controllers/api/questions_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>44</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>44</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::QuestionsController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :set_question, only: [:skip]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  before_action :set_project, only: [:skip]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  def skip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== SKIP_QUESTION DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Project ID: #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Question ID: #{@question.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Question text: #{@question.text}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      # Mark the question as skipped</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      @question.update!(skipped: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">      # Update project&#39;s last modified timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      @project.update!(last_modified_at: Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      Rails.logger.info &quot;Question #{@question.id} marked as skipped for project #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">        message: &quot;Question skipped successfully&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">        question_id: @question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">        project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        skipped: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      Rails.logger.error &quot;Failed to skip question #{@question.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">        error: &quot;Failed to skip question&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        code: &quot;SKIP_FAILED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  def set_question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    @question = Question.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      error: &quot;Question not found&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      code: &quot;QUESTION_NOT_FOUND&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">  def set_project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    @project = Project.find(params[:project_id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      error: &quot;Project not found&quot;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      code: &quot;PROJECT_NOT_FOUND&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0ea0ae91b2145fe10a51f27bad3276fe0eb9ca15">
  <div class="header">
    <h3>app/controllers/api/quote_extraction_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>42</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>42</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::QuoteExtractionController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def extract</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    Rails.logger.info &quot; QuoteExtraction: Starting extract request&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    transcript = params[:transcript]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    orientation = params[:orientation] || &#39;portrait&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    Rails.logger.info &quot; QuoteExtraction: Request params - transcript length: #{transcript&amp;.length || 0}, orientation: #{orientation}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    if transcript.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      Rails.logger.warn &quot; QuoteExtraction: Transcript parameter is blank or missing&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      render json: { error: &#39;Transcript is required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    unless [&#39;portrait&#39;, &#39;landscape&#39;].include?(orientation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      Rails.logger.warn &quot; QuoteExtraction: Invalid orientation: #{orientation}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      render json: { error: &#39;Orientation must be portrait or landscape&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    # Add API health check for debugging</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      Rails.logger.info &quot; QuoteExtraction: Calling GeminiQuoteExtractionService&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      result = GeminiQuoteExtractionService.extract_quotes(transcript, orientation)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      Rails.logger.info &quot; QuoteExtraction: Service returned #{result[:quotes]&amp;.length || 0} quotes&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      Rails.logger.info &quot; QuoteExtraction: Response structure - quotes: #{result[:quotes]&amp;.length}, searchTerms: #{result[:searchTerms]&amp;.length}, imagePrompts: #{result[:imagePrompts]&amp;.length}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      render json: result, status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    rescue =&gt; service_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      Rails.logger.error &quot; QuoteExtraction: Service error: #{service_error.class.name} - #{service_error.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      Rails.logger.error &quot; QuoteExtraction: Service backtrace: #{service_error.backtrace&amp;.first(5)&amp;.join(&#39;\n&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      raise service_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    Rails.logger.error &quot; QuoteExtraction: Controller error: #{e.class.name} - #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    Rails.logger.error &quot; QuoteExtraction: Full backtrace: #{e.backtrace&amp;.join(&#39;\n&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    error_response = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      error: &#39;Quote extraction failed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      error_type: e.class.name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      timestamp: Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">    # Add more specific error details in development</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">      error_response[:details] = e.message</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      error_response[:backtrace] = e.backtrace&amp;.first(5)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    render json: error_response, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="aadb2e0467bab888be74444a30bedfc965bb4d0e">
  <div class="header">
    <h3>app/controllers/api/runware_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>112</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>112</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">class Api::RunwareController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  before_action :require_authentication</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # POST /api/runware/create_icon</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  # Creates a square (1:1) image suitable for icons</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Parameters:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  #   - prompt (required): Text description of the image to generate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  #   - size (optional): Image size in pixels, must be divisible by 64 (default: 1024)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # Example request body:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  # {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  #   &quot;prompt&quot;: &quot;a glowing nebula shaped like a cat&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  #   &quot;size&quot;: 1024</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  # }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">  def create_icon</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    prompt = params[:prompt]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    size = params[:size]&amp;.to_i || 1024</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    if prompt.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      render json: { error: &#39;Prompt is required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    result = runware_service.create_icon(prompt: prompt, size: size)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    if result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">        image_url: result[:image_url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        task_uuid: result[:task_uuid],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">        dimensions: &quot;#{result[:width]}x#{result[:height]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      render json: { success: false, error: result[:error] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  # POST /api/runware/create_portrait</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  # Creates a portrait (9:16) image</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  # Parameters:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  #   - prompt (required): Text description of the image to generate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  #   - height (optional): Image height in pixels (default: 1344)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">  # Example request body:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">  # {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  #   &quot;prompt&quot;: &quot;astronaut meditating in a field of glowing flowers&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">  #   &quot;height&quot;: 1344</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">  # }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">  def create_portrait</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    prompt = params[:prompt]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    height = params[:height]&amp;.to_i || 1344</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    if prompt.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      render json: { error: &#39;Prompt is required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    result = runware_service.create_portrait_photo(prompt: prompt, height: height)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    if result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">        success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">        image_url: result[:image_url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">        task_uuid: result[:task_uuid],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">        dimensions: &quot;#{result[:width]}x#{result[:height]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      render json: { success: false, error: result[:error] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">  # POST /api/runware/create_tall</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">  # Creates a tall (6:19) image</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">  # Parameters:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">  #   - prompt (required): Text description of the image to generate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">  #   - height (optional): Image height in pixels (default: 1984)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">  # Example request body:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">  # {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">  #   &quot;prompt&quot;: &quot;a cascading waterfall of starlight in a cosmic forest&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">  #   &quot;height&quot;: 1984</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">  # }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">  def create_tall</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    prompt = params[:prompt]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    height = params[:height]&amp;.to_i || 1984</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    if prompt.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      render json: { error: &#39;Prompt is required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    result = runware_service.create_tall_photo(prompt: prompt, height: height)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">    if result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">        success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">        image_url: result[:image_url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">        task_uuid: result[:task_uuid],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">        dimensions: &quot;#{result[:width]}x#{result[:height]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">      render json: { success: false, error: result[:error] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">  # POST /api/runware/create_custom</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">  # Creates a custom-sized image</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">  # Parameters:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">  #   - prompt (required): Text description of the image to generate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">  #   - width (required): Image width in pixels, must be divisible by 64</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">  #   - height (required): Image height in pixels, must be divisible by 64</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">  #   - model (optional): Custom model to use (defaults to service default)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">  # Example request body:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">  # {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">  #   &quot;prompt&quot;: &quot;a mystical library floating in space&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">  #   &quot;width&quot;: 1024,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">  #   &quot;height&quot;: 768</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">  # }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">  def create_custom</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">    prompt = params[:prompt]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">    width = params[:width]&amp;.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    height = params[:height]&amp;.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">    model = params[:model]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">    if prompt.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">      render json: { error: &#39;Prompt is required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    if width.nil? || height.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      render json: { error: &#39;Both width and height are required&#39; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    create_params = { prompt: prompt, width: width, height: height }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">    create_params[:model] = model if model.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    result = runware_service.create_custom_image(**create_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    if result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">        success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">        image_url: result[:image_url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">        task_uuid: result[:task_uuid],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">        dimensions: &quot;#{result[:width]}x#{result[:height]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">      render json: { success: false, error: result[:error] }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">  # GET /api/runware/status</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">  # Returns the status of the Runware service (API key configured, etc.)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">  def status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">      # Try to create a simple test service instance to verify configuration</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">      test_service = RunwareService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">        success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">        service_available: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">        message: &#39;Runware service is configured and ready&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">    rescue ArgumentError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">        success: false,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">        service_available: false,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">        error: e.message</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">      }, status: :service_unavailable</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">  def runware_service</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">    @runware_service ||= RunwareService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">  def require_authentication</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">    unless current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">      render json: { error: &#39;Authentication required&#39; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4ec753d4986f7f7507552b352962c6092bd3cfff">
  <div class="header">
    <h3>app/controllers/api/speakers_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>38</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>38</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::SpeakersController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :set_speaker, only: [:show, :update, :destroy]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @speakers = current_user.speakers.order(created_at: :desc)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    render json: @speakers</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    render json: @speaker</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    @speaker = current_user.speakers.build(speaker_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    if @speaker.save</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      render json: @speaker, status: :created</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      render json: { errors: @speaker.errors.full_messages }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  def update</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    if @speaker.update(speaker_params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      render json: @speaker</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      render json: { errors: @speaker.errors.full_messages }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  def destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    @speaker.destroy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    head :no_content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  def set_speaker</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    @speaker = current_user.speakers.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  rescue ActiveRecord::RecordNotFound</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    render json: { error: &#39;Speaker not found&#39; }, status: :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">  def speaker_params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    params.require(:speaker).permit(:name, :email, :phone_number, :pronoun, :notes)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5022726e042598eeb917dbbb8dcb7e2303a148e7">
  <div class="header">
    <h3>app/controllers/api/transcriptions_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>50</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>50</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::TranscriptionsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  skip_before_action :verify_authenticity_token</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  before_action :authenticate_request!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">    # Handle audio file upload for topic transcription</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    unless params[:file].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      render json: { error: &quot;No audio file provided&quot; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    audio_file = params[:file]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # Validate file type - accept audio files and common formats that might not be detected properly</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    unless audio_file.content_type&amp;.start_with?(&#39;audio/&#39;) || </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">           audio_file.original_filename&amp;.match?(/\.(m4a|mp3|wav|ogg|aac|mp4|mov)$/i) ||</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">           audio_file.content_type&amp;.include?(&#39;application/octet-stream&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      render json: { error: &quot;Invalid file type. Please upload an audio file. Got: #{audio_file.content_type}&quot; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    # Validate file size (max 25MB)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    max_size = 25.megabytes</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    if audio_file.size &gt; max_size</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      render json: { error: &quot;File too large. Maximum size is 25MB.&quot; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      # Create a temporary file for transcription</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      temp_file = Tempfile.new([&#39;voice_input&#39;, File.extname(audio_file.original_filename)])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      temp_file.binmode</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      temp_file.write(audio_file.read)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      temp_file.close</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      # Use TranscriptionService to transcribe the audio with Groq</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      transcription_service = TranscriptionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      transcribed_text = transcription_service.transcribe_audio(temp_file.path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      # Clean up temp file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      temp_file.unlink</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      if transcribed_text.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">          transcription: transcribed_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">          success: true </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">        }, status: :ok</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">          error: &quot;Could not transcribe the audio. Please try again.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">          success: false </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">        }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      Rails.logger.error &quot;Voice input transcription error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">      # Clean up temp file if it exists</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      temp_file&amp;.unlink rescue nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">        error: &quot;Failed to process audio: #{e.message}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">        success: false </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b02107164c489eea8dc360bfac316449b48eecaf">
  <div class="header">
    <h3>app/controllers/api/user_lifecycle_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>165</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>165</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::UserLifecycleController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :set_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def export_user_data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    # Check if user can create a new export (weekly throttling)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    unless UserDataExport.can_create_new_export?(@user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">      last_export = @user.user_data_exports.recent.first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      days_remaining = 7 - ((Time.current - last_export.created_at) / 1.day).to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">        error: &quot;You can only request one data export per week&quot;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">        days_until_next_export: days_remaining,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">        last_export_date: last_export.created_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      }, status: :too_many_requests</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    # Check if there&#39;s already a valid export available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    current_export = @user.user_data_exports.valid_exports.recent.first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    if current_export &amp;&amp; !current_export.data_is_stale?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">        message: &quot;Current export is still valid and up to date&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">        export_id: current_export.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        status: current_export.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">        created_at: current_export.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">        expires_at: current_export.expires_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">        file_count: current_export.file_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">        file_size: current_export.formatted_file_size</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    # Create new export record</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    export_record = @user.user_data_exports.create!(status: &#39;pending&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    # Start background job</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    DataExportJob.perform_later(export_record.id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      message: &quot;Data export started. Check back here to see progress and download when ready.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      export_id: export_record.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      status: export_record.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      created_at: export_record.created_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to start data export for user #{@user.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    render json: { error: &quot;Failed to start data export&quot; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">  def delete_account</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    feedback_text = params[:experience_description]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    improvements = params[:what_would_change]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    request_export = params[:request_export] == true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    if feedback_text.blank? || feedback_text.length &lt; 10</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      render json: { error: &quot;Experience description is required (minimum 10 characters)&quot; }, status: :bad_request</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">    # Save feedback before deletion</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    feedback_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      user_id: @user.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      user_email: @user.email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      experience_description: feedback_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      what_would_change: improvements,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      requested_export: request_export,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      deletion_requested_at: Time.current,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      user_created_at: @user.created_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    # Save feedback to file for analysis</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    save_deletion_feedback(feedback_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">    # If export requested, do export first then deletion</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    if request_export</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      DataExportJob.perform_later(@user.id, @user.email)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      AccountDeletionJob.set(wait: 30.minutes).perform_later(@user.id, feedback_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">      message = &quot;Account deletion scheduled. Your data export will be sent first, then your account will be deleted in 30 minutes.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">      AccountDeletionJob.perform_later(@user.id, feedback_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">      message = &quot;Account deletion started. All your data will be permanently removed.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">    render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      message: message,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">      deletion_scheduled: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">      export_requested: request_export</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to start account deletion for user #{@user.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    render json: { error: &quot;Failed to process account deletion request&quot; }, status: :internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">  def export_status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    current_export = @user.user_data_exports.recent.first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    if current_export.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">        user_id: @user.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">        email: @user.email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">        has_export: false,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">        message: &quot;No data export found&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">        can_create_new: UserDataExport.can_create_new_export?(@user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">    response_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">      user_id: @user.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      email: @user.email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      has_export: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">      export_id: current_export.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">      status: current_export.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      created_at: current_export.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">      expires_at: current_export.expires_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">      file_count: current_export.file_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      file_size: current_export.formatted_file_size,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      days_until_expiration: current_export.days_until_expiration,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">      data_is_stale: current_export.data_is_stale?,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      can_create_new: UserDataExport.can_create_new_export?(@user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">    # Add download URL if export is ready</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">    if current_export.ready_for_download?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">      response_data[:download_url] = generate_signed_url(current_export.s3_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      response_data[:share_url] = generate_share_url(current_export.s3_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    render json: response_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">  def set_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    @user = current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">    unless @user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">      render json: { error: &quot;Authentication required&quot; }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">  def generate_signed_url(s3_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    return nil unless s3_key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">    s3_client = Aws::S3::Client.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    signer = Aws::S3::Presigner.new(client: s3_client)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">    signer.presigned_url(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">      :get_object,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">      key: s3_key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">      expires_in: 1.hour.to_i  # Short-lived URLs for security</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to generate signed URL: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">    nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">  def generate_share_url(s3_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">    return nil unless s3_key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">    # Create a mailto link with the download URL</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">    download_url = generate_signed_url(s3_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">    return nil unless download_url</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">    subject = &quot;My Inkra Data Export&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">    body = &quot;Here&#39;s my complete Inkra data export:\n\n#{download_url}\n\nThis link expires in 1 hour for security.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">    &quot;mailto:?subject=#{CGI.escape(subject)}&amp;body=#{CGI.escape(body)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">  def save_deletion_feedback(feedback_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">    feedback_dir = Rails.root.join(&#39;tmp&#39;, &#39;deletion_feedback&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">    FileUtils.mkdir_p(feedback_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    filename = &quot;user_#{feedback_data[:user_id]}_deletion_#{Time.current.strftime(&#39;%Y%m%d_%H%M%S&#39;)}.txt&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">    filepath = feedback_dir.join(filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">    File.open(filepath, &#39;w&#39;) do |f|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">      f.puts &quot;=== INKRA ACCOUNT DELETION FEEDBACK ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">      f.puts &quot;User ID: #{feedback_data[:user_id]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">      f.puts &quot;Email: #{feedback_data[:user_email]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">      f.puts &quot;Account Created: #{feedback_data[:user_created_at]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">      f.puts &quot;Deletion Requested: #{feedback_data[:deletion_requested_at]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">      f.puts &quot;Requested Data Export: #{feedback_data[:requested_export] ? &#39;Yes&#39; : &#39;No&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">      f.puts</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">      f.puts &quot;EXPERIENCE DESCRIPTION:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">      f.puts feedback_data[:experience_description]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">      f.puts</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">      if feedback_data[:what_would_change].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">        f.puts &quot;WHAT WOULD YOU CHANGE:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">        f.puts feedback_data[:what_would_change]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">        f.puts &quot;WHAT WOULD YOU CHANGE: (no response provided)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">      f.puts</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">      f.puts &quot;=== END FEEDBACK ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">    Rails.logger.info &quot;Deletion feedback saved to #{filepath}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to save deletion feedback: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby">    # Don&#39;t fail the deletion process if feedback saving fails</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="38aa29bc0c756a5af30e60b349be18431115111f">
  <div class="header">
    <h3>app/controllers/api/user_preferences_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>16</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::UserPreferencesController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    render json: { interests: current_user.interests }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  def update</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    if current_user.update(preferences_params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      render json: { interests: current_user.interests, message: &quot;Preferences updated successfully.&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      render json: { errors: current_user.errors.full_messages }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  def preferences_params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    params.require(:user_preferences).permit(interests: [])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="798126cf9012de24d7c84b3fc9fa478f8ca51a7a">
  <div class="header">
    <h3>app/controllers/api/users_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>18</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Api::UsersController &lt; Api::BaseController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def update_interests</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    interests = params[:interests] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">    # Validate that all interests are valid categories</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    invalid_interests = interests - User::INTEREST_CATEGORIES</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    if invalid_interests.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      return render json: { error: &quot;Invalid interests: #{invalid_interests.join(&#39;, &#39;)}&quot; }, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    current_user.update!(interests: interests)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      user: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">        id: current_user.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">        email: current_user.email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">        created_at: current_user.created_at.iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">        interests: current_user.interests</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a4d8afc78503228385bc85c6bc8cf23d54a807d6">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4>
      <span class="red">
  17.78%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>45</b> relevant lines.
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Base controller for Rails web application</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # No authentication by default - web controllers handle their own auth as needed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def authenticate_request!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    Rails.logger.debug &quot;=== AUTHENTICATION DEBUG ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Request path: #{request.path}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Request method: #{request.method}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Authorization header: #{request.headers[&#39;Authorization&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    Rails.logger.debug &quot;All headers: #{request.headers.to_h.select { |k,v| k.downcase.include?(&#39;auth&#39;) }}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # Skip authentication in development/test if bypass flag is set</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    if (Rails.env.development? || Rails.env.test?) &amp;&amp; ENV[&#39;DEV_SKIP_AUTH&#39;] == &#39;true&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Skipping auth due to DEV_SKIP_AUTH flag&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      # Set a default user for tests - use the first user or create one</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      @current_user = User.first || User.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">        email: &#39;test@example.com&#39;, </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">        password: &#39;password123&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">        is_premium: false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      return </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    token = extract_token_from_header</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    Rails.logger.debug &quot;Extracted token: #{token ? &#39;[PRESENT]&#39; : &#39;[MISSING]&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    unless token</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      Rails.logger.debug &quot;No token found, rendering unauthorized&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      return render_unauthorized(&#39;Missing authorization token&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      decoded_token = JwtService.decode_token(token)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Decoded token: #{decoded_token.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      unless decoded_token[&#39;type&#39;] == &#39;access&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">        Rails.logger.debug &quot;Invalid token type: #{decoded_token[&#39;type&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">        return render_unauthorized(&#39;Invalid token type&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      user_id = decoded_token[&#39;user_id&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Looking up user with ID: #{user_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      @current_user = User.find_by(id: user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      unless @current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        Rails.logger.debug &quot;User not found with ID: #{user_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        return render_unauthorized(&#39;User not found&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Authentication successful for user: #{@current_user.email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      Rails.logger.error &quot;Authentication failed: #{e.class}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      render_unauthorized(&#39;Invalid or expired token&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="60">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def current_user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    @current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="64">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def authenticate_user!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    # For web controllers, we&#39;ll use a simple session-based approach</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">    # In a real app, you&#39;d integrate with Devise or similar</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    unless session[:user_id] &amp;&amp; (@current_user = User.find_by(id: session[:user_id]))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      redirect_to &#39;/login&#39;, notice: &#39;Please log in to continue&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="72">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def render_unauthorized(message = &#39;Unauthorized&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">      message: message, </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      code: &#39;UNAUTHORIZED&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">      details: {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">    }, status: :unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="80">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="82">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def extract_token_from_header</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    authorization_header = request.headers[&#39;Authorization&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">    return nil unless authorization_header</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">    # Extract token from &quot;Bearer &lt;token&gt;&quot; format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    authorization_header.split(&#39; &#39;).last if authorization_header.start_with?(&#39;Bearer &#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d96f81800b601534e3736afbaba4451e32277ca2">
  <div class="header">
    <h3>app/controllers/concerns/admin_authentication.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>26</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>26</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">module AdminAuthentication</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  extend ActiveSupport::Concern</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  included do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    before_action :ensure_admin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  def ensure_admin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    unless admin_authenticated?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      render_admin_unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  def admin_authenticated?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # Require both authentication and admin privileges</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    current_user&amp;.admin? == true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  def render_admin_unauthorized</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    if request.format.json?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      render json: { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        message: &#39;Admin access required&#39;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">        code: &#39;ADMIN_ACCESS_REQUIRED&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">        details: { reason: &#39;insufficient_privileges&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      }, status: :forbidden</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      redirect_to root_path, alert: &#39;Admin access required&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="490d9805133c46ea3a35ee0bf98a4c4599652dae">
  <div class="header">
    <h3>app/controllers/concerns/error_responder.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>108</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>108</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">module ErrorResponder</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  extend ActiveSupport::Concern</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  included do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    rescue_from ActiveRecord::RecordNotFound, with: :handle_record_not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    rescue_from ActiveRecord::RecordInvalid, with: :handle_record_invalid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    rescue_from ActionController::ParameterMissing, with: :handle_parameter_missing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    rescue_from StandardError, with: :handle_internal_server_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    rescue_from ActionController::UnpermittedParameters, with: :handle_unpermitted_parameters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  def render_error(message, code, status, details = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    render json: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      message: message,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      code: code,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      details: details</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    }, status: status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">  def handle_record_not_found(exception)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      &quot;Resource not found&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      &quot;NOT_FOUND&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      :not_found,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      { resource: exception.model }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  def handle_record_invalid(exception)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      exception.record.errors.full_messages.join(&quot;, &quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      &quot;VALIDATION_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      :bad_request,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      { field_errors: exception.record.errors.as_json }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  def handle_parameter_missing(exception)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      &quot;Required parameter missing: #{exception.param}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      &quot;MISSING_PARAMETER&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      :bad_request,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      { parameter: exception.param }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">  def handle_internal_server_error(exception)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    Rails.logger.error &quot;Internal Server Error: #{exception.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    Rails.logger.error exception.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      &quot;An internal error occurred&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      &quot;INTERNAL_SERVER_ERROR&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      :internal_server_error,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      Rails.env.development? ? { exception: exception.message, backtrace: exception.backtrace.first(10) } : {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  def handle_unpermitted_parameters(exception)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      &quot;Unpermitted parameters provided: #{exception.params.join(&#39;, &#39;)}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      &quot;UNPERMITTED_PARAMETERS&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      :bad_request,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      { unpermitted_params: exception.params }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">  def validate_project_ownership!(project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    unless project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        &quot;Project not found&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">        &quot;PROJECT_NOT_FOUND&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">        :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      return false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">  def validate_audio_segment!(audio_segment, project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    unless audio_segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">        &quot;Audio segment not found&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">        &quot;AUDIO_SEGMENT_NOT_FOUND&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">        :not_found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">      return false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    unless audio_segment.project_id.to_s == project_id.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      render_error(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">        &quot;Audio segment does not belong to this project&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">        &quot;UNAUTHORIZED_ACCESS&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">        :forbidden</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      return false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">    true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">  # Additional helper methods for common API errors</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">  def render_unauthorized(message = &quot;Unauthorized access&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    render_error(message, &quot;UNAUTHORIZED&quot;, :unauthorized)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">  def render_forbidden(message = &quot;Access forbidden&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    render_error(message, &quot;FORBIDDEN&quot;, :forbidden)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">  def render_unprocessable_entity(message, details = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">    render_error(message, &quot;UNPROCESSABLE_ENTITY&quot;, :unprocessable_entity, details)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">  def render_bad_request(message, details = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">    render_error(message, &quot;BAD_REQUEST&quot;, :bad_request, details)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">  def render_not_found(message = &quot;Resource not found&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">    render_error(message, &quot;NOT_FOUND&quot;, :not_found)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">  def render_service_unavailable(message = &quot;Service temporarily unavailable&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">    render_error(message, &quot;SERVICE_UNAVAILABLE&quot;, :service_unavailable)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d87cc620927caa91974b5709c8f6ccd25430ac50">
  <div class="header">
    <h3>app/controllers/home_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>4</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class HomeController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b8fb142668553b6a021f6fc9850bde3db4b541ef">
  <div class="header">
    <h3>app/controllers/projects_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>82</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>82</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class ProjectsController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  before_action :set_project, only: [:show]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @projects = Project.order(created_at: :desc)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  def show</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    @chapters = @project.chapters.by_order.includes(:sections =&gt; :questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    @transcript = @project.transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  def new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    @project = Project.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  def create</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    @project = Project.new(project_params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    @project.status = &#39;outline_generating&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    if @project.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      # Generate outline (same logic as API)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      generate_outline_for_project(@project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      redirect_to @project, notice: &#39;Project was successfully created.&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      render :new, status: :unprocessable_entity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">  def set_project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    @project = Project.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  def project_params</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    params.require(:project).permit(:title, :topic)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  def generate_outline_for_project(project)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    # Same logic as in API controller</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    chapters_data = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        title: &#39;Early Days: The Idea&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">        order: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">        sections: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">            title: &#39;The Spark of Innovation&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">            order: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">            questions: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">              { text: &#39;What was the initial problem you aimed to solve?&#39;, order: 1 },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">              { text: &#39;How did you first come up with this idea?&#39;, order: 2 }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">            ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">        title: &#39;Building the Foundation&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">        order: 2,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">        sections: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">            title: &#39;First Steps&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">            order: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">            questions: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">              { text: &#39;What were your first concrete actions?&#39;, order: 1 }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">            ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    chapters_data.each do |chapter_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      chapter = project.chapters.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">        title: chapter_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">        order: chapter_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">        omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">      chapter_data[:sections].each do |section_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">        section = chapter.sections.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">          title: section_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">          order: section_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">          omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">        section_data[:questions].each do |question_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">          section.questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">            text: question_data[:text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">            order: question_data[:order]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    project.update!(status: &#39;outline_ready&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a82e1062c20702ef73b545af678e28c7710a9f14">
  <div class="header">
    <h3>app/helpers/application_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module ApplicationHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c56ceeb6623cb3382123fe535cf2b455dfb363c1">
  <div class="header">
    <h3>app/helpers/home_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module HomeHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8345edd5d7292b23889c6295df4c13ff0354c1b1">
  <div class="header">
    <h3>app/helpers/projects_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module ProjectsHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9f82b619045a78e7bbeee0182b9fff9474fe4398">
  <div class="header">
    <h3>app/jobs/account_deletion_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>75</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>75</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class AccountDeletionJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(user_id, feedback_data = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting account deletion for user #{user_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    user = User.find_by(id: user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    unless user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      Rails.logger.warn &quot;User #{user_id} not found for deletion - may have been already deleted&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      # Step 1: Clean up all S3 files first (before deleting database records)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      cleanup_user_s3_data(user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      # Step 2: Delete all database records (cascading deletes via associations)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      user_email = user.email</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      user.destroy!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      # Step 3: Send confirmation email</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      UserDataExportMailer.account_deleted(user_email, feedback_data).deliver_now</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      Rails.logger.info &quot;Account deletion completed successfully for user #{user_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      Rails.logger.error &quot;Account deletion failed for user #{user_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      # Try to send failure notification if user still exists</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      if user&amp;.persisted?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">        UserDataExportMailer.deletion_failed(user.email, e.message).deliver_now rescue nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      # Re-raise to mark job as failed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">  def cleanup_user_s3_data(user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting S3 cleanup for user #{user_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    s3_client = Aws::S3::Client.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">    # Define all S3 prefixes that contain user data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    user_prefixes = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">      &quot;audio-segments/user-#{user_id}/&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      &quot;device-logs/user-#{user_id}/&quot;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      &quot;exports/user-#{user_id}/&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">      &quot;user-exports/user_#{user_id}_&quot;,  # Data export zips</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">      # Add any other user-specific S3 prefixes here</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    total_deleted = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    user_prefixes.each do |prefix|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">        deleted_count = delete_objects_by_prefix(s3_client, bucket_name, prefix)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">        total_deleted += deleted_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">        Rails.logger.info &quot;Deleted #{deleted_count} objects with prefix &#39;#{prefix}&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">        Rails.logger.error &quot;Failed to delete objects with prefix &#39;#{prefix}&#39;: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">        # Continue with other prefixes even if one fails</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    Rails.logger.info &quot;S3 cleanup completed for user #{user_id}. Total objects deleted: #{total_deleted}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    Rails.logger.error &quot;S3 cleanup failed for user #{user_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">    # Don&#39;t fail the entire deletion process if S3 cleanup fails</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    # The database cleanup is more critical</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">  def delete_objects_by_prefix(s3_client, bucket_name, prefix)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    deleted_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    continuation_token = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    loop do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">      # List objects with the given prefix</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      list_params = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">        prefix: prefix,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">        max_keys: 1000</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">      list_params[:continuation_token] = continuation_token if continuation_token</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">      response = s3_client.list_objects_v2(list_params)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">      # Break if no objects found</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      break if response.contents.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">      # Prepare objects for batch deletion</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">      objects_to_delete = response.contents.map { |obj| { key: obj.key } }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">      # Delete objects in batch</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">      unless objects_to_delete.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">        s3_client.delete_objects(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">          bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">          delete: { objects: objects_to_delete }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">        deleted_count += objects_to_delete.size</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">      # Check if there are more objects to process</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">      continuation_token = response.is_truncated? ? response.next_continuation_token : nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      break unless continuation_token</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">    deleted_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e4652e9b218159a214fe070c5a632d37a1ab95dc">
  <div class="header">
    <h3>app/jobs/application_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class ApplicationJob &lt; ActiveJob::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Automatically retry jobs that encountered a deadlock</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # retry_on ActiveRecord::Deadlocked</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # Most jobs are safe to ignore if the underlying records are no longer available</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # discard_on ActiveJob::DeserializationError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4800f671a117151388a3c5074722729efe7fd117">
  <div class="header">
    <h3>app/jobs/data_export_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>18</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class DataExportJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(export_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    export_record = UserDataExport.find(export_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    user = export_record.user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting data export for user #{user.id}, export ID #{export_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    export_service = UserDataExportService.new(user, export_record)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      # Generate the export and update the record</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      result = export_service.create_complete_export</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      Rails.logger.info &quot;Data export completed successfully for user #{user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      Rails.logger.info &quot;Export details: #{result[:file_count]} files, #{export_record.formatted_file_size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      Rails.logger.error &quot;Data export failed for user #{user.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      # Record will be updated to &#39;failed&#39; status by the service</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="715ec0adf7f1dcb6bdcc3298eac52b0017d6876c">
  <div class="header">
    <h3>app/jobs/finalize_transcript_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>17</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>17</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class FinalizeTranscriptJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting transcript finalization for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    # Generate both structured and plaintext content in a single job</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    result = TranscriptContentAssemblerService.finalize_transcript(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    if result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      Rails.logger.info &quot;Transcript finalization completed for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      Rails.logger.error &quot;Transcript finalization failed for project #{project_id}: #{result[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    Rails.logger.error &quot;Transcript finalization job error for project #{project_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ac61f2f2aaf97948529349de13ecdc5c43352677">
  <div class="header">
    <h3>app/jobs/generate_followup_questions_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>59</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>59</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class GenerateFollowupQuestionsJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    Rails.logger.info &quot; GenerateFollowupQuestionsJob: Starting with audio_segment_id: #{audio_segment_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    # Eager load associations to prevent N+1 queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    audio_segment = AudioSegment.includes(question: { section: { chapter: :project } }).find_by(id: audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    unless audio_segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      Rails.logger.warn &quot;GenerateFollowupQuestionsJob: AudioSegment with id #{audio_segment_id} not found, skipping job&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    Rails.logger.info &quot; Found audio_segment: #{audio_segment.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    Rails.logger.info &quot; Question present: #{audio_segment.question.present?}, Transcription present: #{audio_segment.transcription_text.present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    return unless audio_segment.question.present? &amp;&amp; audio_segment.transcription_text.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    # 1. Generate questions via Gemini</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    Rails.logger.info &quot; Generating followup questions for question: #{audio_segment.question.text}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    new_questions_data = service.generate_followup_questions(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      original_question_text: audio_segment.question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      user_answer: audio_segment.transcription_text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    Rails.logger.info &quot; Generated questions data: #{new_questions_data.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    return if new_questions_data.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    # 2. Persist new questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    new_questions = persist_followup_questions(audio_segment.question, new_questions_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    Rails.logger.info &quot; Persisted #{new_questions.count} new questions: #{new_questions.map(&amp;:text).inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    # 3. Questions saved - no real-time broadcasting needed with polling approach</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    project = audio_segment.question.section.chapter.project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    Rails.logger.info &quot; Follow-up questions saved for project #{project.id}.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">  def persist_followup_questions(parent_question, questions_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    new_questions = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    new_question_ids = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    ActiveRecord::Base.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">      # Get all questions in the section to find the next available order</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      section = parent_question.section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">      max_order_in_section = section.questions.maximum(:order) || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">      # Also check existing follow-ups for the parent to ensure we don&#39;t duplicate orders</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      existing_followup_count = parent_question.follow_up_questions.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">      # Start ordering after the highest order in the section</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">      # This ensures followup questions always come after existing questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      base_order = [max_order_in_section + 1, parent_question.order + existing_followup_count + 1].max</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      new_questions = questions_data.map.with_index do |q_data, index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">        question = parent_question.follow_up_questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">          section: parent_question.section,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">          text: q_data[:text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">          order: base_order + index,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">          is_follow_up: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">        new_question_ids &lt;&lt; question.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">        question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    # Enqueue Polly jobs after transaction commits for speech interviews</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    project = parent_question.section.chapter.project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    if project.is_speech_interview &amp;&amp; new_question_ids.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      Rails.logger.info &quot;Enqueueing Polly jobs for #{new_question_ids.length} follow-up questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      new_question_ids.each do |question_id|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">        PollyGenerationJob.perform_later(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">          question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">          voice_id: project.voice_id || &#39;Joanna&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">          speech_rate: project.speech_rate || 100</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    new_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5fd907f3e81b3df467999a3067ace00b8cff71bb">
  <div class="header">
    <h3>app/jobs/outline_generation_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>107</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>107</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class OutlineGenerationJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    Rails.logger.debug &quot;\n OUTLINE GENERATION JOB STARTED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    Rails.logger.debug &quot;&quot; * 50</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Project ID: #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    project = Project.find_by(id: project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    unless project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      Rails.logger.warn &quot;OutlineGenerationJob: Project with id #{project_id} not found, skipping job&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Project Topic: \&quot;#{project.topic}\&quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Is Speech Interview: #{project.is_speech_interview}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Current Status: #{project.status}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">      # Set status to generating if not already set</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      if project.status != &#39;outline_generating&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">        project.update!(status: &#39;outline_generating&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      # Use LLM service to generate interview outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      Rails.logger.debug &quot;InterviewQuestionService instantiated&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      # Determine generation options based on interview length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      options = determine_question_options(project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Using generation options: #{options.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      outline = service.generate_interview_outline(project.topic, options)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      Rails.logger.debug &quot;LLM service returned outline with #{outline[:chapters]&amp;.length || 0} chapters&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      if outline[:error]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">        Rails.logger.error &quot;Outline generation failed: #{outline[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">        project.update!(status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">        return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      # Create chapters, sections, and questions from LLM-generated outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Creating chapters from outline...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      new_question_ids = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      ActiveRecord::Base.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">        outline[:chapters]&amp;.each do |chapter_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">          Rails.logger.debug &quot;Creating chapter: #{chapter_data[:title]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">          chapter = project.chapters.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">            title: chapter_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">            order: chapter_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">            omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">          chapter_data[:sections]&amp;.each do |section_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">            Rails.logger.debug &quot;Creating section: #{section_data[:title]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">            section = chapter.sections.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">              title: section_data[:title],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">              order: section_data[:order],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">              omitted: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">            )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">            section_data[:questions]&amp;.each do |question_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">              question = section.questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">                text: question_data[:text],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">                order: question_data[:order]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">              )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">              # Collect question IDs for post-transaction job enqueueing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">              if project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">                new_question_ids &lt;&lt; question.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      # Update project status to outline_ready</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">      Rails.logger.debug &quot;Updating project status to outline_ready&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">      project.update!(status: &#39;outline_ready&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">      # Enqueue Polly jobs after transaction commits to ensure questions exist</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      if project.is_speech_interview &amp;&amp; new_question_ids.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">        Rails.logger.debug &quot;Enqueueing Polly jobs for #{new_question_ids.length} questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">        new_question_ids.each do |question_id|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">          PollyGenerationJob.perform_later(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">            question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">            voice_id: project.voice_id || &#39;Joanna&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">            speech_rate: project.speech_rate || 100</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      Rails.logger.info &quot; Successfully generated outline for project #{project_id} with #{new_question_ids.length} questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">      Rails.logger.debug &quot;&quot; * 50</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      Rails.logger.error &quot; Failed to generate outline for project #{project_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">      Rails.logger.debug &quot;&quot; * 50</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">      project.update!(status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      raise</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">  def determine_question_options(project)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">    # Use question_count if provided, otherwise determine from interview_length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    if project.question_count.present? &amp;&amp; project.question_count &gt; 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">      # Custom question count specified</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">      total_questions = project.question_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">    elsif project.interview_length.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">      # Use predefined lengths</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">      total_questions = case project.interview_length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">                       when &#39;5_minutes&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">                         5</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">                       when &#39;10_minutes&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">                         10</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">                       when &#39;20_minutes&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">                         20</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">                       when &#39;unlimited&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">                         40 # Initial batch for unlimited</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">                       else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">                         10 # Default to 10 minutes</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">                       end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">      # Default to 10 questions if nothing specified</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">      total_questions = 10</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">    # For now, structure as 1 chapter with 1 section containing all questions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">    # This can be enhanced later to distribute questions across multiple chapters/sections</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">      num_chapters: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">      sections_per_chapter: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">      questions_per_section: total_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e22cf7e5fd9f99f556ae2fc7c1dd1b8e710b1947">
  <div class="header">
    <h3>app/jobs/podcast_export_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>171</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>171</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require &#39;open3&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">require &#39;tempfile&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">class PodcastExportJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  include Sidekiq::Status::Worker</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  sidekiq_options retry: 3</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  def perform(project_id, user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    total 100 # Set total progress steps</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    @project = Project.find(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    @user = User.find(user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting podcast export for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    store current_step: &quot;Initializing podcast export&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    # Get all audio segments ordered by question order</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    audio_segments = get_ordered_audio_segments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    if audio_segments.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      store error: &quot;No audio segments found for project&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      raise &quot;No audio segments available for export&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    at 10, &quot;Found #{audio_segments.count} audio segments&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    Rails.logger.info &quot;Found #{audio_segments.count} audio segments for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">    # Download audio files from S3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    local_files = download_audio_files(audio_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    at 40, &quot;Downloaded audio files&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    # Create podcast using FFmpeg</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    podcast_file = create_podcast(local_files)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    at 80, &quot;Created podcast file&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    # Upload to S3 and create shareable URL</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    result = upload_podcast_to_s3(podcast_file)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    at 90, &quot;Uploaded to S3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">    # Store results for retrieval</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    store download_url: result[:download_url]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    store filename: result[:filename] </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    store file_size: result[:file_size]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    store duration: result[:duration]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    at 100, &quot;Podcast export completed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    Rails.logger.info &quot;Completed podcast export for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">  ensure</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">    # Clean up temporary files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    cleanup_temp_files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">  def get_ordered_audio_segments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">    # Get audio segments ordered by question order within each section/chapter</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    @project.audio_segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      .joins(question: { section: :chapter })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      .where.not(audio_file_key: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      .order(&#39;chapters.order ASC, sections.order ASC, questions.order ASC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      .includes(question: { section: :chapter })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">  def download_audio_files(audio_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    store current_step: &quot;Downloading audio files from S3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    local_files = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    s3_service = S3Service.new(@user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    audio_segments.each_with_index do |segment, index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      Rails.logger.info &quot;Downloading segment #{index + 1}/#{audio_segments.count}: #{segment.audio_file_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      # Create temporary file for this segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      temp_file = Tempfile.new([&#39;segment&#39;, &#39;.m4a&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">        # Download from S3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">        s3_service.download_audio_segment(segment.audio_file_key, temp_file.path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">        local_files &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">          file: temp_file,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">          path: temp_file.path,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">          segment: segment,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">          question_text: segment.question.text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">        # Track temp files for cleanup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">        @temp_files ||= []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">        @temp_files &lt;&lt; temp_file</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">        Rails.logger.error &quot;Failed to download segment #{segment.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">        temp_file.close</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">        temp_file.unlink</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">        # Continue with other segments rather than failing completely</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">      # Update progress (30% of total work is downloading)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">      progress = 10 + ((index + 1).to_f / audio_segments.count * 30)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      at progress.round, &quot;Downloaded #{index + 1}/#{audio_segments.count} files&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    Rails.logger.info &quot;Downloaded #{local_files.count}/#{audio_segments.count} audio files&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    local_files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">  def create_podcast(local_files)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    store current_step: &quot;Stitching audio files together&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">    Rails.logger.info &quot;Creating podcast from #{local_files.count} audio segments&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">    # Create output temporary file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">    output_file = Tempfile.new([&#39;podcast&#39;, &#39;.m4a&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    @temp_files ||= []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">    @temp_files &lt;&lt; output_file</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">    if local_files.count == 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">      # If only one file, just copy it</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      File.copy(local_files.first[:path], output_file.path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">      # Use FFmpeg to concatenate files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">      concat_files_with_ffmpeg(local_files, output_file.path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">    Rails.logger.info &quot;Created podcast file: #{output_file.path}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">    output_file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">  def concat_files_with_ffmpeg(local_files, output_path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">    # Create a temporary file list for FFmpeg concat demuxer</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">    concat_list = Tempfile.new([&#39;concat_list&#39;, &#39;.txt&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    @temp_files ||= []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">    @temp_files &lt;&lt; concat_list</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">    # Write file list in FFmpeg concat format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    local_files.each do |file_info|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">      # Escape single quotes and backslashes for FFmpeg</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">      escaped_path = file_info[:path].gsub(&quot;&#39;&quot;, &quot;&#39;\\\\&#39;&#39;&quot;).gsub(&quot;\\&quot;, &quot;\\\\&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">      concat_list.puts &quot;file &#39;#{escaped_path}&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    concat_list.close</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">    # Build FFmpeg command for concatenation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    cmd = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">      &#39;ffmpeg&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">      &#39;-f&#39;, &#39;concat&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">      &#39;-safe&#39;, &#39;0&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">      &#39;-i&#39;, concat_list.path,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      &#39;-c&#39;, &#39;copy&#39;,  # Copy streams without re-encoding for speed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">      &#39;-y&#39;,  # Overwrite output file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">      output_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    Rails.logger.info &quot;Running FFmpeg command: #{cmd.join(&#39; &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">    # Execute FFmpeg command</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">    stdout, stderr, status = Open3.capture3(*cmd)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">    unless status.success?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">      error_msg = &quot;FFmpeg failed with status #{status.exitstatus}: #{stderr}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">      Rails.logger.error error_msg</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      Rails.logger.error &quot;FFmpeg stdout: #{stdout}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">      store error: error_msg</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">      raise error_msg</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">    Rails.logger.info &quot;FFmpeg concatenation completed successfully&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">    Rails.logger.debug &quot;FFmpeg output: #{stderr}&quot; if stderr.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">  def upload_podcast_to_s3(podcast_file)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">    store current_step: &quot;Uploading podcast to S3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">    # Generate filename</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    title_part = @project.title.parameterize.underscore[0..14]  # First 15 characters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">    date_part = Time.current.strftime(&#39;%Y%m%d&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">    filename = &quot;#{title_part}_#{date_part}.m4a&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">    # Get file info</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">    file_size = File.size(podcast_file.path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">    duration = get_audio_duration(podcast_file.path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">    Rails.logger.info &quot;Uploading podcast file: #{filename} (#{file_size} bytes, #{duration} seconds)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            

            <code class="ruby">    # Upload to S3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">    s3_service = S3Service.new(@user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">    upload_result = s3_service.store_podcast_export(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">      file_path: podcast_file.path,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">      filename: filename,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">      project_id: @project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">      content_type: &#39;audio/mp4&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">    Rails.logger.info &quot;Uploaded podcast to S3: #{upload_result[:download_url]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">      download_url: upload_result[:download_url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">      filename: filename,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">      file_size: file_size,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">      duration: format_duration(duration)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">  def get_audio_duration(file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">    cmd = [&#39;ffprobe&#39;, &#39;-v&#39;, &#39;quiet&#39;, &#39;-show_entries&#39;, &#39;format=duration&#39;, &#39;-of&#39;, &#39;csv=p=0&#39;, file_path]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">    stdout, stderr, status = Open3.capture3(*cmd)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">    if status.success? &amp;&amp; stdout.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">      stdout.strip.to_f.round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">      Rails.logger.warn &quot;Could not determine audio duration: #{stderr}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">      0.0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">  def format_duration(seconds)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">    return &quot;0 seconds&quot; if seconds.nil? || seconds == 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">    hours = seconds / 3600</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">    minutes = (seconds % 3600) / 60</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">    remaining_seconds = (seconds % 60).round</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">    parts = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">    parts &lt;&lt; &quot;#{hours.to_i} hour#{&#39;s&#39; if hours != 1}&quot; if hours &gt;= 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">    parts &lt;&lt; &quot;#{minutes.to_i} minute#{&#39;s&#39; if minutes != 1}&quot; if minutes &gt;= 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">    parts &lt;&lt; &quot;#{remaining_seconds} second#{&#39;s&#39; if remaining_seconds != 1}&quot; if remaining_seconds &gt; 0 || parts.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="230">
            

            

            <code class="ruby">    parts.join(&quot;, &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">  def cleanup_temp_files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">    return unless @temp_files</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">    @temp_files.each do |temp_file|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">        temp_file.close unless temp_file.closed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">        temp_file.unlink if File.exist?(temp_file.path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Failed to cleanup temp file: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="243">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">    Rails.logger.info &quot;Cleaned up #{@temp_files.count} temporary files&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fa1e4ee9efb68f030cd4b3f778151418ed6fdc56">
  <div class="header">
    <h3>app/jobs/polly_generation_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>55</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>55</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class PollyGenerationJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(question_id, voice_id: &#39;Joanna&#39;, speech_rate: 100)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    Rails.logger.debug &quot;\n POLLY GENERATION JOB STARTED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    Rails.logger.debug &quot;&quot; * 50</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Question ID: #{question_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Voice ID: #{voice_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Speech Rate: #{speech_rate}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    question = Question.find_by(id: question_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    unless question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      Rails.logger.warn &quot;PollyGenerationJob: Question with id #{question_id} not found, skipping job&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Question Text: \&quot;#{question.text}\&quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Section: #{question.section.title}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Chapter: #{question.section.chapter.title}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    project = question.section.chapter.project</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    # Skip if project is not a speech interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    return unless project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    # Skip if audio already exists and is completed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    if question.polly_audio_clip&amp;.completed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      Rails.logger.info &quot;Polly audio already exists for question #{question_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    # Create or find the polly audio clip record</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    audio_clip = question.polly_audio_clip || question.create_polly_audio_clip!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      speech_rate: speech_rate,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      status: &#39;pending&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">    # Update status to generating</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    audio_clip.update!(status: &#39;generating&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">      # Generate speech using Polly service</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      Rails.logger.debug &quot; Calling AWS Polly service...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      polly_service = Aws::PollyService.new(project.user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      result = polly_service.generate_speech(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">        text: question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        speech_rate: speech_rate</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      Rails.logger.debug &quot; Generated S3 Key: #{result[:s3_key]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">      # Update the audio clip with the S3 key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      audio_clip.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        s3_key: result[:s3_key],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">        status: &#39;completed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      Rails.logger.info &quot; Successfully generated Polly audio for question #{question_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      Rails.logger.debug &quot;    Final S3 Key: #{audio_clip.s3_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      Rails.logger.debug &quot;&quot; * 50</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      Rails.logger.error &quot; Failed to generate Polly audio for question #{question_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      Rails.logger.debug &quot;&quot; * 50</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      audio_clip.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">        status: &#39;failed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">        error_message: e.message</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">      raise</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b738af0cd87d5b357043abaa948fb5f768ed4c77">
  <div class="header">
    <h3>app/jobs/transcript_editing_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>128</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>128</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class TranscriptEditingJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    project = Project.find(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    transcript = project.transcript</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    unless transcript &amp;&amp; (transcript.raw_content.present? || transcript.raw_structured_content.present?)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      Rails.logger.error &quot;No raw content available for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting transcript editing for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      # Set status to editing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      transcript.update!(status: &#39;editing&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">      # Use raw plaintext if available, otherwise fall back to structured content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      raw_content = transcript.raw_content.present? ? transcript.raw_content : transcript.raw_structured_content_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      # Call Gemini to polish the transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      polished_content = GeminiTextPolishingService.polish_transcript(raw_content)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      if polished_content.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">        # Update transcript with polished content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">        transcript.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">          polished_content: polished_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">          status: &#39;ready&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">          last_updated: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">        # For backward compatibility, also update edited_content if using structured content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">        if transcript.raw_content.blank? &amp;&amp; transcript.raw_structured_content.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">          structured_polished = GeminiTextPolishingService.polish_transcript_structured(transcript.raw_structured_content_json)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">          polished_content_with_ids = map_ids_to_polished_content(structured_polished, transcript.raw_structured_content_json)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">          transcript.update!(edited_content_json: polished_content_with_ids)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">        # Mark project as completed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">        project.update!(status: &#39;completed&#39;, last_modified_at: Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">        Rails.logger.info &quot;Transcript editing completed for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">        raise &quot;Gemini polishing returned empty content&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      Rails.logger.error &quot;Transcript editing failed for project #{project_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">      transcript.update!(status: &#39;failed&#39;) if transcript.persisted?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      project.update!(status: &#39;failed&#39;) if project.persisted?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">  def map_ids_to_polished_content(polished_content, raw_content)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">    # Create lookup maps from raw content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    chapter_map = {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    section_map = {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    question_map = {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    audio_segment_map = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    raw_content.each do |item|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      case item[&#39;type&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      when &#39;chapter&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">        chapter_map[item[&#39;title&#39;]] = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">          id: item[&#39;chapterId&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">          title: item[&#39;title&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      when &#39;section&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        section_map[item[&#39;title&#39;]] = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">          id: item[&#39;sectionId&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">          title: item[&#39;title&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      when &#39;paragraph&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">        if item[&#39;questionId&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">          question_map[item[&#39;text&#39;]] = item[&#39;questionId&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">        if item[&#39;audioSegmentId&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">          audio_segment_map[item[&#39;text&#39;]] = item[&#39;audioSegmentId&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">    # Map IDs to polished content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    current_chapter_id = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    current_section_id = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    polished_content.map do |item|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">      case item[&#39;type&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      when &#39;chapter&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">        current_chapter_id = chapter_map[item[&#39;title&#39;]]&amp;.dig(:id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">        item.merge(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">          &#39;chapterId&#39; =&gt; current_chapter_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      when &#39;section&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">        current_section_id = section_map[item[&#39;title&#39;]]&amp;.dig(:id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">        item.merge(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">          &#39;sectionId&#39; =&gt; current_section_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">      when &#39;paragraph&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">        # Try to find matching question and audio segment from raw content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">        best_question_id = find_best_matching_question_id(item[&#39;text&#39;], raw_content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">        best_audio_segment_id = find_best_matching_audio_segment_id(item[&#39;text&#39;], raw_content)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">        item.merge(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">          &#39;chapterId&#39; =&gt; current_chapter_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">          &#39;sectionId&#39; =&gt; current_section_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">          &#39;questionId&#39; =&gt; best_question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">          &#39;audioSegmentId&#39; =&gt; best_audio_segment_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">        item</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">  def find_best_matching_question_id(polished_text, raw_content)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">    # Find the raw paragraph with the highest similarity to the polished text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">    best_match = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">    best_score = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">    raw_content.each do |item|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      next unless item[&#39;type&#39;] == &#39;paragraph&#39; &amp;&amp; item[&#39;questionId&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      similarity = calculate_text_similarity(polished_text, item[&#39;text&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">      if similarity &gt; best_score</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">        best_score = similarity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">        best_match = item[&#39;questionId&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    best_match</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">  def find_best_matching_audio_segment_id(polished_text, raw_content)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">    # Find the raw paragraph with the highest similarity to the polished text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">    best_match = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    best_score = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">    raw_content.each do |item|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">      next unless item[&#39;type&#39;] == &#39;paragraph&#39; &amp;&amp; item[&#39;audioSegmentId&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">      similarity = calculate_text_similarity(polished_text, item[&#39;text&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">      if similarity &gt; best_score</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">        best_score = similarity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">        best_match = item[&#39;audioSegmentId&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">    best_match</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">  def calculate_text_similarity(text1, text2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">    return 0 if text1.blank? || text2.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">    # Simple word-based similarity calculation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">    words1 = text1.downcase.split(/\W+/).reject(&amp;:empty?)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">    words2 = text2.downcase.split(/\W+/).reject(&amp;:empty?)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">    return 0 if words1.empty? || words2.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">    common_words = (words1 &amp; words2).length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">    total_words = (words1 | words2).length</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">    common_words.to_f / total_words</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8bd487ded651604d20ff74ce3c0b58357db0869f">
  <div class="header">
    <h3>app/jobs/transcription_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>33</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class TranscriptionJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting transcription job for audio segment #{audio_segment_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">    # Delegate to TranscriptionService for actual processing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    result = TranscriptionService.process_transcription(audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    if result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      Rails.logger.info &quot;Transcription job completed successfully for audio segment #{audio_segment_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      # Get the audio segment and project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      audio_segment = AudioSegment.find_by(id: audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      unless audio_segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">        Rails.logger.warn &quot;TranscriptionJob: AudioSegment with id #{audio_segment_id} not found during follow-up processing&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">        return result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      project = audio_segment.project</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      # Trigger follow-up question generation if transcription was successful</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      if audio_segment.question.present? &amp;&amp; audio_segment.transcription_text.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">        GenerateFollowupQuestionsJob.perform_later(audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        Rails.logger.info &quot;Triggered follow-up question generation for audio segment #{audio_segment_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">      # Check if all audio segments for this project are now transcribed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      # Use reliable count check instead of iterating over all segments to avoid race condition</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      total_segments = project.audio_segments.count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      transcribed_segments = project.audio_segments.where(upload_status: &#39;transcribed&#39;).count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      if total_segments == transcribed_segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        Rails.logger.info &quot;All #{total_segments} segments transcribed for project #{project.id}, enqueuing FinalizeTranscriptJob.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">        FinalizeTranscriptJob.perform_later(project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      Rails.logger.error &quot;Transcription job failed for audio segment #{audio_segment_id}: #{result[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    Rails.logger.error &quot;Transcription job error for audio segment #{audio_segment_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="31c42e5d466bf1717cff43de862f964a6926ae67">
  <div class="header">
    <h3>app/jobs/unlimited_questions_generation_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>81</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>81</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class UnlimitedQuestionsGenerationJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    Rails.logger.info &quot;UnlimitedQuestionsGenerationJob: Starting for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    project = Project.find_by(id: project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    unless project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      Rails.logger.warn &quot;UnlimitedQuestionsGenerationJob: Project #{project_id} not found&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    # Only process if this is an unlimited interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    unless project.interview_length == &#39;unlimited&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      Rails.logger.info &quot;UnlimitedQuestionsGenerationJob: Project #{project_id} is not unlimited mode, skipping&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    # Count total questions and answered questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    total_questions = project.questions.where(is_follow_up: false).count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    answered_questions = AudioSegment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      .where(project_id: project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      .where.not(question_id: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      .distinct</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      .count(:question_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    Rails.logger.info &quot;UnlimitedQuestionsGenerationJob: Project #{project_id} has #{answered_questions}/#{total_questions} questions answered&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    # Check if we&#39;ve reached the 2/3 threshold</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    threshold = (total_questions * 2.0 / 3.0).ceil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    if answered_questions &gt;= threshold</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      Rails.logger.info &quot;UnlimitedQuestionsGenerationJob: Threshold reached (#{answered_questions} &gt;= #{threshold}), generating more questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      # Generate additional questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      generate_additional_questions(project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      Rails.logger.info &quot;UnlimitedQuestionsGenerationJob: Threshold not reached yet (#{answered_questions} &lt; #{threshold})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">  def generate_additional_questions(project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">      # Get existing questions for context</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      existing_questions = project.questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        .where(is_follow_up: false)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        .order(:order)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">        .pluck(:text)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">      # Get answered questions with their responses for better context</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">      answered_segments = AudioSegment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">        .joins(:question)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        .where(project_id: project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        .where.not(question_id: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">        .select(&#39;questions.text as question_text, audio_segments.transcript&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      context = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">        topic: project.topic,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">        existing_questions: existing_questions,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">        answered_questions: answered_segments.map { |s| { question: s.question_text, answer: s.transcript } }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      Rails.logger.info &quot;UnlimitedQuestionsGenerationJob: Generating 20 additional questions with context&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      # Use the interview question service to generate more questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      new_questions_data = service.generate_additional_questions_for_unlimited(context, 20)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">      if new_questions_data.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">        # Find the last section to add questions to</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        last_section = project.sections.joins(:chapter).order(&#39;chapters.order DESC, sections.order DESC&#39;).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">        if last_section</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">          # Get the highest order number for existing questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">          max_order = project.questions.maximum(:order) || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">          ActiveRecord::Base.transaction do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">            new_questions_data.each_with_index do |question_text, index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">              question = last_section.questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">                text: question_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">                order: max_order + index + 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">                is_follow_up: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">              )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">              </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">              # If speech interview, generate audio</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">              if project.is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">                PollyGenerationJob.perform_later(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">                  question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">                  voice_id: project.voice_id || &#39;Joanna&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">                  speech_rate: project.speech_rate || 100</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">                )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">            end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">          Rails.logger.info &quot;UnlimitedQuestionsGenerationJob: Successfully added #{new_questions_data.length} new questions to project #{project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">          Rails.logger.error &quot;UnlimitedQuestionsGenerationJob: No section found to add questions to&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">        Rails.logger.error &quot;UnlimitedQuestionsGenerationJob: Failed to generate additional questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      Rails.logger.error &quot;UnlimitedQuestionsGenerationJob: Error generating questions: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="70b8d8d2c8b2a84838e3af3cb42c907f15cc5c96">
  <div class="header">
    <h3>app/mailers/application_mailer.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>4</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class ApplicationMailer &lt; ActionMailer::Base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  default from: &quot;from@example.com&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  layout &quot;mailer&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d12c787353378b943b7e269761173a69cdc72397">
  <div class="header">
    <h3>app/mailers/user_data_export_mailer.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>37</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class UserDataExportMailer &lt; ApplicationMailer</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  default from: &#39;Inkra &lt;noreply@inkra.app&gt;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def export_ready(user, email, download_url)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    @user = user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @download_url = download_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @expires_at = 7.days.from_now.strftime(&#39;%B %d, %Y&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    mail(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      to: email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      subject: &#39;Your Inkra Data Export is Ready&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  def export_failed(user, email, error_message)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    @user = user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    @error_message = error_message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    mail(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      to: email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      subject: &#39;Inkra Data Export Failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">  def account_deleted(email, feedback_data = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    @user_email = email</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    @feedback_data = feedback_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    @deletion_date = Time.current.strftime(&#39;%B %d, %Y at %I:%M %p %Z&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    mail(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      to: email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      subject: &#39;Your Inkra Account Has Been Deleted&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  def deletion_failed(email, error_message)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    @user_email = email</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    @error_message = error_message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    mail(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      to: email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      subject: &#39;Inkra Account Deletion Failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8f3ac697ee8cefb79a78091f613e006bf1450769">
  <div class="header">
    <h3>app/models/application_record.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationRecord &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  primary_abstract_class</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f543aa0d245038880df13149988fad7c4a67f5e0">
  <div class="header">
    <h3>app/models/audio_segment.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>29</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>29</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class AudioSegment &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  belongs_to :question, optional: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  validates :file_name, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  validates :mime_type, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  validates :upload_status, presence: true, inclusion: { in: %w[pending uploading success failed transcribed transcription_failed] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  validates :duration_seconds, presence: true, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  scope :successful, -&gt; { where(upload_status: &#39;success&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  scope :by_question, -&gt;(question_id) { where(question_id: question_id) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  def uploaded?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    upload_status == &#39;success&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  def transcribed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    upload_status == &#39;transcribed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  def failed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    %w[failed transcription_failed].include?(upload_status)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">  def processing?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    %w[pending uploading].include?(upload_status)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">  def has_transcription?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    transcription_text.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">  def estimated_transcription_time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    return 60 if duration_seconds.nil? # default fallback</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    (duration_seconds * 0.25).to_i # 25% of audio duration</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4e54a370a0ea54e5956ca03fd77c30381351083b">
  <div class="header">
    <h3>app/models/chapter.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>9</b> relevant lines.
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Chapter &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :project</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :sections, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :questions, through: :sections</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :title, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :order, presence: true, uniqueness: { scope: :project_id }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :omitted, inclusion: { in: [true, false] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :included, -&gt; { where(omitted: false) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :by_order, -&gt; { order(:order) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3a042261cb48d0d5c1b55dfddf96fa76cda7e072">
  <div class="header">
    <h3>app/models/device_log.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>39</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>39</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class DeviceLog &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  validates :device_id, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  validates :s3_url, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  validates :log_type, inclusion: { in: %w[crash manual automatic debug] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  scope :recent, -&gt; { order(created_at: :desc) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  scope :crashes, -&gt; { where(log_type: &#39;crash&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  scope :for_device, -&gt;(device_id) { where(device_id: device_id) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  def presigned_url(expires_in: 3600)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    return nil unless s3_url.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    s3 = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      region: ENV[&#39;AWS_REGION&#39;] || &#39;us-east-1&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      access_key_id: ENV[&#39;AWS_ACCESS_KEY_ID&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      secret_access_key: ENV[&#39;AWS_SECRET_ACCESS_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    bucket, key = parse_s3_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    return nil unless bucket &amp;&amp; key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    signer = Aws::S3::Presigner.new(client: s3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    signer.presigned_url(:get_object, bucket: bucket, key: key, expires_in: expires_in)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to generate presigned URL: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">  def parse_s3_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    return [nil, nil] unless s3_url.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    if s3_url.start_with?(&#39;s3://&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      parts = s3_url.gsub(&#39;s3://&#39;, &#39;&#39;).split(&#39;/&#39;, 2)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      [parts[0], parts[1]]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    elsif s3_url.start_with?(&#39;https://&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      uri = URI.parse(s3_url)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      bucket = uri.host.split(&#39;.&#39;).first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      key = uri.path[1..-1] # Remove leading slash</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      [bucket, key]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      [nil, nil]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3e4ac5f4ffd531b9fd6a12566d2be5fad25a8d9f">
  <div class="header">
    <h3>app/models/feedback.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>16</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Feedback &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  validates :feedback_text, presence: true, length: { minimum: 10, maximum: 2000 }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  validates :feedback_type, inclusion: { in: %w[general bug_report feature_request improvement] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  validates :email, format: { with: URI::MailTo::EMAIL_REGEXP }, allow_blank: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  scope :unresolved, -&gt; { where(resolved: false) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  scope :resolved, -&gt; { where(resolved: true) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  scope :by_type, -&gt;(type) { where(feedback_type: type) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  scope :recent, -&gt; { order(created_at: :desc) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  def mark_resolved!(admin_notes = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    update!(resolved: true, admin_notes: admin_notes)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  def mark_unresolved!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    update!(resolved: false, admin_notes: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="91a7c071cbd13538d3dc6243d5fe70e3e383b24f">
  <div class="header">
    <h3>app/models/interview_preset.rb</h3>
    <h4>
      <span class="green">
  96.15%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>26</b> relevant lines.
      <span class="green"><b>25</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class InterviewPreset &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :preset_questions, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :projects</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :user_shown_interview_presets, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="6">
            
              <span class="hits">9</span>
            

            

            <code class="ruby">  scope :active, -&gt; { where(active: true) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="7">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">  scope :featured, -&gt; { where(is_featured: true) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :by_category, -&gt;(category) { where(category: category) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="9">
            
              <span class="hits">8</span>
            

            

            <code class="ruby">  scope :ordered, -&gt; { order(:order_position, :title) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :title, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :description, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :category, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :icon_name, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :uuid, presence: true, uniqueness: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def to_param</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    uuid</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def questions_grouped_by_chapter</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="22">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    preset_questions.includes(:interview_preset)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      .order(:chapter_order, :section_order, :question_order)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      .group_by(&amp;:chapter_title)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def total_questions_count</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="28">
            
              <span class="hits">10</span>
            

            

            <code class="ruby">    preset_questions.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def shown_to_user?(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="32">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    return false unless user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="33">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    user_shown_interview_presets.exists?(user: user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="36">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def mark_as_shown_to_user(user)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="37">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    return unless user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="38">
            
              <span class="hits">6</span>
            

            

            <code class="ruby">    user_shown_interview_presets.find_or_create_by(user: user) do |record|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="39">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">      record.shown_at = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0e12cfe302f944e7f55573407476c3f564fba364">
  <div class="header">
    <h3>app/models/log_entry.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>10</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class LogEntry &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  belongs_to :tracker</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  validates :timestamp_utc, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  validates :status, presence: true, inclusion: { in: %w[pending uploading transcribing completed failed] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  scope :by_tracker, -&gt;(tracker_ids) { where(tracker_id: tracker_ids) if tracker_ids.present? }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  scope :by_date_range, -&gt;(start_date, end_date) {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    where(timestamp_utc: start_date..end_date) if start_date.present? &amp;&amp; end_date.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9d3912ed872eb1a86c3b4d6600e18d4a2b3b2f55">
  <div class="header">
    <h3>app/models/polly_audio_clip.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>57</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>57</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class PollyAudioClip &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :question</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  validates :s3_key, presence: true, uniqueness: true, if: :completed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  validates :voice_id, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  validates :status, inclusion: { in: %w[pending generating completed failed] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  validates :speech_rate, presence: true, numericality: { greater_than: 0, less_than_or_equal_to: 500 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  scope :completed, -&gt; { where(status: &#39;completed&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  scope :failed, -&gt; { where(status: &#39;failed&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  scope :pending, -&gt; { where(status: &#39;pending&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  scope :generating, -&gt; { where(status: &#39;generating&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  def completed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    status == &#39;completed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">  def failed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    status == &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">  def generating?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    status == &#39;generating&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">  def pending?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    status == &#39;pending&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">  def s3_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    return nil unless completed? &amp;&amp; s3_key.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    presigned_url = S3Service.new(question.project.user).get_presigned_url(s3_key)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    # DEBUG: Log URL generation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    Rails.logger.debug &quot;\n S3 URL GENERATION&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Question ID: #{question.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Question Text: \&quot;#{question.text[0..50]}...\&quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    Rails.logger.debug &quot; S3 Key: #{s3_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Voice: #{voice_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Rate: #{speech_rate}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    Rails.logger.debug &quot; Generated URL: #{presigned_url[0..100]}...\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    presigned_url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">  def needs_regeneration?(new_voice_id, new_speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    completed? &amp;&amp; (voice_id != new_voice_id || speech_rate != new_speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">  def mark_as_generating!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    update!(status: &#39;generating&#39;, error_message: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">  def mark_as_completed!(s3_key, content_type: nil, request_characters: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      status: &#39;completed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      s3_key: s3_key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      content_type: content_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      request_characters: request_characters,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      error_message: nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">  def mark_as_failed!(error_message)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      status: &#39;failed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      error_message: error_message.to_s.truncate(500),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      s3_key: nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d89136bc34ca3ff92d9084407437bd7014058d15">
  <div class="header">
    <h3>app/models/preset_question.rb</h3>
    <h4>
      <span class="yellow">
  86.67%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>15</b> relevant lines.
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class PresetQuestion &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :interview_preset</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :ordered, -&gt; { order(:chapter_order, :section_order, :question_order) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :by_chapter, -&gt;(chapter_title) { where(chapter_title: chapter_title) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :by_section, -&gt;(section_title) { where(section_title: section_title) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :chapter_title, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :section_title, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :question_text, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :chapter_order, presence: true, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :section_order, presence: true, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :question_order, presence: true, numericality: { greater_than: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def chapter_and_section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    &quot;#{chapter_title} - #{section_title}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def full_order_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    [chapter_order, section_order, question_order]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b3b41a590beb21599f12007ee1bd1031a10a9895">
  <div class="header">
    <h3>app/models/project.rb</h3>
    <h4>
      <span class="red">
  51.32%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>76</b> relevant lines.
      <span class="green"><b>39</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Project &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :chapters, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :sections, through: :chapters</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :questions, through: :sections</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :audio_segments, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_one :transcript, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :advisor_interactions, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :title, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :topic, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :is_speech_interview, inclusion: { in: [true, false] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  enum status: { </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    outline_generating: &#39;outline_generating&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    outline_ready: &#39;outline_ready&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    recording_in_progress: &#39;recording_in_progress&#39;, </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    transcribing: &#39;transcribing&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    completed: &#39;completed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    failed: &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="23">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_create :set_timestamps</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_update :update_last_modified</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="25">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_destroy :cleanup_sidekiq_jobs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :by_status, -&gt;(status) { where(status: status) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="28">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :active, -&gt; { where.not(status: &#39;failed&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="29">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :templates, -&gt; { where(is_template: true) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :user_projects, -&gt; { where(is_template: false) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :recently_accessed, -&gt; { where.not(last_accessed_at: nil).order(last_accessed_at: :desc) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def touch_accessed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    update_column(:last_accessed_at, Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def outline_status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    return &#39;generating&#39; if status == &#39;outline_generating&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    return &#39;not_started&#39; if chapters.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    return &#39;ready&#39; if chapters.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="44">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def completed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    status == &#39;completed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def failed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    status == &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def can_record?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">    # Always allow recording - no status-based locking</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="57">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def transcript_ready?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    transcript&amp;.status == &#39;ready&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">  # Copy this template to create a new user project</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="62">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create_instance_for_user(user, custom_title: nil, custom_topic: nil, custom_status: &#39;outline_ready&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    return nil unless is_template?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    new_project = user.projects.build(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      title: custom_title || title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      topic: custom_topic || topic,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">      status: custom_status,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">      is_speech_interview: is_speech_interview,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">      is_template: false,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">      template_name: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">      template_description: nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    if new_project.save</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">      # Copy chapters, sections, and questions structure</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      chapters.includes(sections: :questions).each do |chapter|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">        new_chapter = new_project.chapters.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">          title: chapter.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">          order: chapter.order,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">          omitted: chapter.omitted</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">        chapter.sections.each do |section|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">          new_section = new_chapter.sections.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">            title: section.title,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">            order: section.order,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">            omitted: section.omitted</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">          section.questions.each do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">            new_section.questions.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">              text: question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">              order: question.order,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">              omitted: question.omitted,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">              skipped: question.skipped,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">              parent_question_id: question.parent_question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">              is_followup: question.is_followup</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">            )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    new_project</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="108">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def template?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">    is_template?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">  # Class method to get available templates</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="113">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.available_templates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">    templates.order(:template_name, :title)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="118">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def has_audio_content?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">    audio_segments.where.not(s3_url: nil).exists?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="122">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def has_transcript_content?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">    transcript&amp;.raw_structured_content.present? || transcript&amp;.raw_content.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="127">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def has_meaningful_content?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">    has_audio_content? || has_substantial_transcript_content?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="131">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def has_substantial_transcript_content?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">    return false unless transcript&amp;.raw_content.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    transcript.raw_content.length &gt; 100</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="137">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="139">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def set_timestamps</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="140">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    self.last_modified_at = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="143">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def update_last_modified</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">    self.last_modified_at = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="147">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def cleanup_sidekiq_jobs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">    Rails.logger.info &quot;Cleaning up Sidekiq jobs for project #{id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">    # Find jobs related to this project&#39;s audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    audio_segment_ids = audio_segments.pluck(:id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">    # Clean up jobs for project and related audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">    cleanup_jobs_by_args([</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">      [id.to_s],                    # FinalizeTranscriptJob</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">      audio_segment_ids.map(&amp;:to_s) # TranscriptionJob, GenerateFollowupQuestionsJob</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">    ].flatten)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="160">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def cleanup_jobs_by_args(target_args)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">    require &#39;sidekiq/api&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">    # Clean up scheduled and retry queues</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">    [Sidekiq::ScheduledSet.new, Sidekiq::RetrySet.new, Sidekiq::Queue.new].each do |queue|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">      queue.each do |job|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">        if target_args.include?(job.args.first.to_s)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">          Rails.logger.info &quot;Removing Sidekiq job: #{job.klass} with args #{job.args}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">          job.delete</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Failed to delete Sidekiq job: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="95e543916cde9baab2ea01501520dc3ce55f1029">
  <div class="header">
    <h3>app/models/question.rb</h3>
    <h4>
      <span class="red">
  61.76%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>34</b> relevant lines.
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Question &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :section</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :audio_segments, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_one :polly_audio_clip, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # Add these new associations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :parent_question, class_name: &#39;Question&#39;, optional: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :follow_up_questions, class_name: &#39;Question&#39;, foreign_key: &#39;parent_question_id&#39;, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :text, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :order, presence: true, uniqueness: { scope: [:section_id, :parent_question_id] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :omitted, inclusion: { in: [true, false] }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :skipped, inclusion: { in: [true, false] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_destroy :cleanup_sidekiq_jobs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="17">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">  scope :by_order, -&gt; { order(:order) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :base_questions, -&gt; { where(is_follow_up: false) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :included, -&gt; { where(omitted: false) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :not_skipped, -&gt; { where(skipped: false) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def is_follow_up?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    is_follow_up</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    section.chapter.project</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  # Check if this question is ready to be shown in a speech interview</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">  # For reading interviews, questions are always ready</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  # For speech interviews, ALL questions need completed audio</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def audio_ready_for_speech_interview?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    # ALL questions in speech interviews need completed audio</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    polly_audio_clip&amp;.completed? == true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  # Check if this question should be included in the available questions API</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">  # for a given project type (speech vs reading interview)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def available_for_project_type?(is_speech_interview)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    # For reading interviews, all non-omitted, non-skipped questions are available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    return true unless is_speech_interview</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    # For speech interviews, questions must have audio ready</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    audio_ready_for_speech_interview?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def cleanup_sidekiq_jobs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    Rails.logger.info &quot;Cleaning up Sidekiq jobs for question #{id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    require &#39;sidekiq/api&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">    # Clean up PollyGenerationJob for this question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    [Sidekiq::ScheduledSet.new, Sidekiq::RetrySet.new, Sidekiq::Queue.new].each do |queue|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      queue.each do |job|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">        if job.klass == &#39;PollyGenerationJob&#39; &amp;&amp; job.args.first.to_s == id.to_s</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">          Rails.logger.info &quot;Removing PollyGenerationJob for question #{id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">          job.delete</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Failed to delete Sidekiq job for question #{id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="98d17d0be697f6832c86685d1105e1d9a5a83d4b">
  <div class="header">
    <h3>app/models/section.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>8</b> relevant lines.
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Section &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :chapter</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :questions, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :title, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :order, presence: true, uniqueness: { scope: :chapter_id }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :omitted, inclusion: { in: [true, false] }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :included, -&gt; { where(omitted: false) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :by_order, -&gt; { order(:order) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="583304283d71814ac1525e6e37af45cce5df9625">
  <div class="header">
    <h3>app/models/speaker.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>14</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Speaker &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  validates :name, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  validates :email, format: { with: URI::MailTo::EMAIL_REGEXP }, allow_blank: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  validates :phone_number, format: { with: /\A\+?[0-9\s\-\(\)]+\z/ }, allow_blank: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  validates :pronoun, inclusion: { in: %w[he she they] }, allow_blank: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  validate :has_contact_method</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  def has_contact_method</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    if email.blank? &amp;&amp; phone_number.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      errors.add(:base, &quot;Must have either email or phone number&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2cba90c5cdd93dd2019b1bb1e9d111c45d585a19">
  <div class="header">
    <h3>app/models/tracker.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>11</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Tracker &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  has_many :log_entries, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  validates :name, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  validates :sf_symbol_name, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  validates :color_hex, presence: true, format: { with: /\A#[0-9A-F]{6}\z/i }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  scope :recently_accessed, -&gt; { where.not(last_accessed_at: nil).order(last_accessed_at: :desc) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  def touch_accessed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    update_column(:last_accessed_at, Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c1a3cdc67b29de58400297074b37a1cd33892c94">
  <div class="header">
    <h3>app/models/transcript.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>32</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>32</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class Transcript &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :project</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  enum status: { processing_raw: &#39;processing_raw&#39;, raw_ready: &#39;raw_ready&#39;, editing: &#39;editing&#39;, ready: &#39;ready&#39;, failed: &#39;failed&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  validates :status, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  before_update :update_timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # Legacy JSON methods for backwards compatibility</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  def edited_content_json</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    JSON.parse(edited_content) if edited_content.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  rescue JSON::ParserError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  def edited_content_json=(value)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    self.edited_content = value.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">  def raw_structured_content_json</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    JSON.parse(raw_structured_content) if raw_structured_content.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">  rescue JSON::ParserError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">  def raw_structured_content_json=(value)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    self.raw_structured_content = value.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  # New simplified content methods</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  def raw_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    raw_content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">  def polished_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    polished_content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">  def update_timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    self.last_updated = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="58a4fe0f991a4557f7f37c575984c49a35c1e45b">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4>
      <span class="yellow">
  90.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>20</b> relevant lines.
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class User &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_secure_password</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :projects, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :trackers, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :log_entries, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :feedbacks, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :device_logs, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :speakers, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :user_shown_interview_presets, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :user_data_exports, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  INTEREST_CATEGORIES = %w[</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    fiction_writing</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    non_fiction_writing</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    personal_growth</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    mental_health</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    social_sharing</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    health_fitness</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  ].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :email, presence: true, uniqueness: true, format: { with: URI::MailTo::EMAIL_REGEXP }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="23">
            
              <span class="hits">16</span>
            

            

            <code class="ruby">  validates :password, length: { minimum: 6 }, if: -&gt; { new_record? || !password.nil? }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validate :interests_are_valid</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="27">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def admin?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    admin == true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def interests_are_valid</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="34">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">    if interests.any? { |interest| !INTEREST_CATEGORIES.include?(interest) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      errors.add(:interests, &quot;contains an invalid category&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9d532dfe99f3e60b04269ef9ddbb6557b55ab7f9">
  <div class="header">
    <h3>app/models/user_data_export.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>59</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>59</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class UserDataExport &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  validates :status, presence: true, inclusion: { in: %w[pending processing completed failed expired] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  validates :file_count, numericality: { greater_than_or_equal_to: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  validates :total_size_bytes, numericality: { greater_than_or_equal_to: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  scope :recent, -&gt; { order(created_at: :desc) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  scope :completed, -&gt; { where(status: &#39;completed&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  scope :valid_exports, -&gt; { where(status: &#39;completed&#39;).where(&#39;expires_at &gt; ?&#39;, Time.current) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  scope :expired, -&gt; { where(&#39;expires_at &lt; ?&#39;, Time.current) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  scope :for_cleanup, -&gt; { where(status: [&#39;completed&#39;, &#39;failed&#39;]).where(&#39;created_at &lt; ?&#39;, 1.month.ago) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  before_create :set_expiration_date</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  # Weekly throttling - only allow one export per week per user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  def self.can_create_new_export?(user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    last_export = where(user: user).recent.first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    return true if last_export.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    # Allow new export if last one was more than 7 days ago</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    last_export.created_at &lt; 7.days.ago</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">  def expired?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    expires_at &amp;&amp; expires_at &lt; Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">  def completed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    status == &#39;completed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">  def processing?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    status == &#39;processing&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">  def failed?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    status == &#39;failed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">  def ready_for_download?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    completed? &amp;&amp; !expired? &amp;&amp; s3_key.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  # Check if user&#39;s data has changed since this export</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">  def data_is_stale?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    return true unless completed?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    current_highest_project_id = user.projects.maximum(:id) || 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    current_highest_audio_segment_id = user.audio_segments.joins(:project).maximum(:id) || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    (current_highest_project_id &gt; (highest_project_id || 0)) ||</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    (current_highest_audio_segment_id &gt; (highest_audio_segment_id || 0))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">  def formatted_file_size</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    return &quot;Unknown&quot; if total_size_bytes.zero?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    units = %w[bytes KB MB GB TB]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    base = 1024</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    size = total_size_bytes.to_f</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    if size &lt; base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      return &quot;#{size.to_i} bytes&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    exp = (Math.log(size) / Math.log(base)).to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    exp = [exp, units.length - 1].min</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    &quot;%.1f %s&quot; % [size / (base ** exp), units[exp]]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">  def days_until_expiration</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">    return 0 if expired?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    ((expires_at - Time.current) / 1.day).ceil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">  def set_expiration_date</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">    self.expires_at = 7.days.from_now</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="97772cf93c152900e49fafcf0458e40a050846ce">
  <div class="header">
    <h3>app/models/user_shown_interview_preset.rb</h3>
    <h4>
      <span class="yellow">
  83.33%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>12</b> relevant lines.
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class UserShownInterviewPreset &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :interview_preset</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :recent, -&gt; { order(shown_at: :desc) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :for_user, -&gt;(user) { where(user: user) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :before_date, -&gt;(date) { where(&#39;shown_at &lt; ?&#39;, date) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="9">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :shown_at, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :user_id, uniqueness: { scope: :interview_preset_id }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.clear_old_records(user, days_old = 30)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    for_user(user).before_date(days_old.days.ago).delete_all</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def self.reset_for_user(user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    for_user(user).delete_all</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1fa2f6a7629760f0729ef866f95dd6eef8f37026">
  <div class="header">
    <h3>app/services/aws/polly_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>269</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>269</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">module Aws</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  class PollyService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">    # Curated list of 10 high-quality voices for the best user experience</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">    SELECTED_VOICES = [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">      # US English (5 voices)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">      { id: &#39;Matthew&#39;, name: &#39;Matthew&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">      { id: &#39;Joanna&#39;, name: &#39;Joanna&#39;, gender: &#39;Female&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      { id: &#39;Ruth&#39;, name: &#39;Ruth&#39;, gender: &#39;Female&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      { id: &#39;Stephen&#39;, name: &#39;Stephen&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      { id: &#39;Kendra&#39;, name: &#39;Kendra&#39;, gender: &#39;Female&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      # British English (3 voices)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      { id: &#39;Arthur&#39;, name: &#39;Arthur&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-GB&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      { id: &#39;Emma&#39;, name: &#39;Emma&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-GB&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      { id: &#39;Brian&#39;, name: &#39;Brian&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-GB&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      # Other English variants (2 voices)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      { id: &#39;Olivia&#39;, name: &#39;Olivia&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-AU&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      { id: &#39;Aria&#39;, name: &#39;Aria&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-NZ&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    ].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    # Full list of all available voices for speech generation (kept for backward compatibility)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    ENGLISH_VOICES = [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      # US English (en-US)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      { id: &#39;Danielle&#39;, name: &#39;Danielle (US)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      { id: &#39;Gregory&#39;, name: &#39;Gregory (US)&#39;, gender: &#39;Male&#39;, neural: false, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      { id: &#39;Ivy&#39;, name: &#39;Ivy (US Child)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      { id: &#39;Joanna&#39;, name: &#39;Joanna (US)&#39;, gender: &#39;Female&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      { id: &#39;Kendra&#39;, name: &#39;Kendra (US)&#39;, gender: &#39;Female&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      { id: &#39;Kimberly&#39;, name: &#39;Kimberly (US)&#39;, gender: &#39;Female&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      { id: &#39;Salli&#39;, name: &#39;Salli (US)&#39;, gender: &#39;Female&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      { id: &#39;Joey&#39;, name: &#39;Joey (US)&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      { id: &#39;Justin&#39;, name: &#39;Justin (US Child)&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      { id: &#39;Kevin&#39;, name: &#39;Kevin (US Child)&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      { id: &#39;Matthew&#39;, name: &#39;Matthew (US)&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      { id: &#39;Ruth&#39;, name: &#39;Ruth (US)&#39;, gender: &#39;Female&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      { id: &#39;Stephen&#39;, name: &#39;Stephen (US)&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-US&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">      # British English (en-GB)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      { id: &#39;Amy&#39;, name: &#39;Amy (British)&#39;, gender: &#39;Female&#39;, neural: true, standard: true, language_code: &#39;en-GB&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      { id: &#39;Emma&#39;, name: &#39;Emma (British)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-GB&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      { id: &#39;Brian&#39;, name: &#39;Brian (British)&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-GB&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      { id: &#39;Arthur&#39;, name: &#39;Arthur (British)&#39;, gender: &#39;Male&#39;, neural: true, standard: true, language_code: &#39;en-GB&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">      # Welsh English (en-GB-WLS)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      { id: &#39;Geraint&#39;, name: &#39;Geraint (Welsh)&#39;, gender: &#39;Male&#39;, neural: false, standard: true, language_code: &#39;en-GB-WLS&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      # Australian English (en-AU)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      { id: &#39;Nicole&#39;, name: &#39;Nicole (Australian)&#39;, gender: &#39;Female&#39;, neural: false, standard: true, language_code: &#39;en-AU&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">      { id: &#39;Olivia&#39;, name: &#39;Olivia (Australian)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-AU&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      { id: &#39;Russell&#39;, name: &#39;Russell (Australian)&#39;, gender: &#39;Male&#39;, neural: false, standard: true, language_code: &#39;en-AU&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">      # Indian English (en-IN)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      { id: &#39;Aditi&#39;, name: &#39;Aditi (Indian)&#39;, gender: &#39;Female&#39;, neural: false, standard: true, language_code: &#39;en-IN&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      { id: &#39;Raveena&#39;, name: &#39;Raveena (Indian)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-IN&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      { id: &#39;Kajal&#39;, name: &#39;Kajal (Indian)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-IN&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      # Irish English (en-IE)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      { id: &#39;Niamh&#39;, name: &#39;Niamh (Irish)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-IE&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">      # New Zealand English (en-NZ)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      { id: &#39;Aria&#39;, name: &#39;Aria (New Zealand)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-NZ&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">      # Singaporean English (en-SG)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      { id: &#39;Jasmine&#39;, name: &#39;Jasmine (Singaporean)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-SG&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      # South African English (en-ZA)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      { id: &#39;Ayanda&#39;, name: &#39;Ayanda (South African)&#39;, gender: &#39;Female&#39;, neural: true, standard: false, language_code: &#39;en-ZA&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    ].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    DEFAULT_LANGUAGE = &#39;en-US&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    DEFAULT_VOICE = &#39;Joanna&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    def initialize(user = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      @client = Aws::Polly::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">        region: ENV.fetch(&#39;AWS_REGION&#39;, &#39;us-east-1&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">        access_key_id: ENV[&#39;AWS_ACCESS_KEY_ID&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">        secret_access_key: ENV[&#39;AWS_SECRET_ACCESS_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">      @s3_service = S3Service.new(user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">    def generate_speech(text:, voice_id: DEFAULT_VOICE, speech_rate: 100, language_code: nil, engine: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      validate_voice_id!(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">      tracker = PerformanceTracker.instance</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">      # Use development audio generation in development environment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">        return generate_development_speech(text: text, voice_id: voice_id, speech_rate: speech_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">      # Get voice config to determine language if not provided</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">      voice_config = tracker.track_event(&#39;voice_config_lookup&#39;, { voice_id: voice_id }) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">        get_voice_config(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      language_code ||= voice_config[:language_code] if voice_config</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">      # Convert speech rate percentage to SSML prosody rate</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">      prosody_rate = &quot;#{speech_rate}%&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">      # Wrap text in SSML for better control</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">      ssml_text = build_ssml(text, prosody_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">      # Request speech synthesis</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">      response = tracker.track_event(&#39;aws_polly_synthesis&#39;, { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">        voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">        text_length: text.length,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">        engine: engine || (voice_neural?(voice_id) ? &#39;neural&#39; : &#39;standard&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      }) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">        @client.synthesize_speech({</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">          output_format: &#39;mp3&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">          text: ssml_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">          text_type: &#39;ssml&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">          voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">          language_code: language_code || DEFAULT_LANGUAGE,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">          engine: engine || (voice_neural?(voice_id) ? &#39;neural&#39; : &#39;standard&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">        })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">      # Generate unique S3 key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">      s3_key = generate_s3_key(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">      # Upload to S3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      tracker.track_event(&#39;s3_upload&#39;, { key: s3_key }) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">        @s3_service.upload_audio_data(s3_key, response.audio_stream)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">        s3_key: s3_key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">        content_type: response.content_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">        request_characters: response.request_characters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    rescue Aws::Polly::Errors::ServiceError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">      Rails.logger.error &quot;Polly service error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">      raise</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    def list_english_voices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">      SELECTED_VOICES</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    def list_all_voices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">      ENGLISH_VOICES</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">    def voice_available?(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      list_all_voices.any? { |voice| voice[:id] == voice_id }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">    def get_voice_config(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">      list_all_voices.find { |v| v[:id] == voice_id }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">    # Development audio generation using macOS &#39;say&#39; command</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">    def generate_development_speech(text:, voice_id: DEFAULT_VOICE, speech_rate: 100)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">      Rails.logger.info &quot; Development mode: Using macOS &#39;say&#39; command instead of AWS Polly for cost savings&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      tracker = PerformanceTracker.instance</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">      # Map Polly voices to macOS system voices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">      Rails.logger.info &quot; Input voice_id: &#39;#{voice_id}&#39; (class: #{voice_id.class})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">      macos_voice = tracker.track_event(&#39;macos_voice_mapping&#39;, { voice_id: voice_id }) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">        mapped = map_polly_to_macos_voice(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">        Rails.logger.info &quot; Voice mapping result: &#39;#{voice_id}&#39; -&gt; &#39;#{mapped}&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">        mapped</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">      # Validate that we have a valid macOS voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">      if macos_voice.nil? || macos_voice.strip.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">        Rails.logger.error &quot; ERROR: macOS voice is nil or empty after mapping. Using fallback &#39;Alex&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">        macos_voice = &#39;Alex&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">      Rails.logger.info &quot; Final macOS voice to use: &#39;#{macos_voice}&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">      # Convert speech rate (100% = normal speed for say command)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">      say_rate = (speech_rate * 2).clamp(50, 400) # say command uses words per minute, roughly 200 is normal</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">      # Generate temporary file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">      temp_file = Rails.root.join(&#39;tmp&#39;, &quot;say_#{SecureRandom.hex(8)}.aiff&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">      mp3_file = Rails.root.join(&#39;tmp&#39;, &quot;say_#{SecureRandom.hex(8)}.mp3&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby">        # Use macOS &#39;say&#39; command to generate speech</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">        say_command = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">          &#39;say&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">          &#39;-v&#39;, macos_voice,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">          &#39;-r&#39;, say_rate.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">          &#39;-o&#39;, temp_file.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">          text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">        Rails.logger.info &quot; Executing: #{say_command.join(&#39; &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby">        # Track say command execution time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">        result = tracker.track_event(&#39;macos_say_command&#39;, { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">          voice: macos_voice, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">          rate: say_rate, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">          text_length: text.length </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">        }) do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            

            <code class="ruby">          # Use backticks to capture stderr output</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">          output = `#{say_command.shelljoin} 2&gt;&amp;1`</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">          exit_status = $?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">          success = exit_status &amp;&amp; exit_status.exitstatus == 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">          Rails.logger.info &quot; Say command output: #{output}&quot; unless output.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">          Rails.logger.info &quot; Say command exit status: #{exit_status&amp;.exitstatus || &#39;nil&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">          success</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">        unless result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">          exit_status = $?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">          status_msg = exit_status ? exit_status.exitstatus : &#39;command not executed&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">          raise &quot;macOS &#39;say&#39; command failed with exit status #{status_msg}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby">        # Check if the output file was actually created</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">        unless File.exist?(temp_file)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">          Rails.logger.error &quot; ERROR: Say command succeeded but output file not created&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">          Rails.logger.error &quot; Expected file: #{temp_file}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">          Rails.logger.error &quot; Current directory: #{Dir.pwd}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">          Rails.logger.error &quot; Temp directory contents: #{Dir.entries(Rails.root.join(&#39;tmp&#39;)).join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">          raise &quot;Say command succeeded but output file not created: #{temp_file}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">        Rails.logger.info &quot; Output file created successfully: #{temp_file} (#{File.size(temp_file)} bytes)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">        # Convert AIFF to MP3 using ffmpeg (if available) or just use AIFF</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">        audio_file, content_type = tracker.track_event(&#39;audio_format_conversion&#39;) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">          if system(&#39;which ffmpeg &gt; /dev/null 2&gt;&amp;1&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">            conversion_result = system(&#39;ffmpeg&#39;, &#39;-i&#39;, temp_file.to_s, &#39;-y&#39;, mp3_file.to_s, &#39;-loglevel&#39;, &#39;error&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">            audio_file = conversion_result ? mp3_file : temp_file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">            content_type = conversion_result ? &#39;audio/mpeg&#39; : &#39;audio/aiff&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">            [audio_file, content_type]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">            Rails.logger.warn &quot; ffmpeg not found, using AIFF format (consider installing ffmpeg for MP3 conversion)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">            [temp_file, &#39;audio/aiff&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby">        # Read the generated audio file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">        audio_data = tracker.track_event(&#39;audio_file_read&#39;, { file_size: File.size(audio_file) }) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">          File.read(audio_file)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="247">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            

            <code class="ruby">        # Generate unique S3 key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">        s3_key = generate_s3_key(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="250">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="251">
            

            

            <code class="ruby">        # Upload to S3 using StringIO</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">        tracker.track_event(&#39;s3_upload&#39;, { key: s3_key, size: audio_data.bytesize }) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">          audio_stream = StringIO.new(audio_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">          @s3_service.upload_audio_data(s3_key, audio_stream)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">        Rails.logger.info &quot; Development audio generated and uploaded to S3: #{s3_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">          s3_key: s3_key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">          content_type: content_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">          request_characters: text.length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">      ensure</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="266">
            

            

            <code class="ruby">        # Clean up temporary files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">        tracker.track_event(&#39;temp_file_cleanup&#39;) do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">          [temp_file, mp3_file].each do |file|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="269">
            

            

            <code class="ruby">            File.delete(file) if File.exist?(file)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">      Rails.logger.error &quot; Development speech generation failed: #{e.class.name}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="275">
            

            

            <code class="ruby">      Rails.logger.error &quot; Backtrace: #{e.backtrace.first(5).join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">      Rails.logger.error &quot; Context: voice_id=&#39;#{voice_id}&#39;, speech_rate=#{speech_rate}, text_length=#{text&amp;.length || &#39;nil&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">      raise &quot;Development speech generation failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="278">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="279">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="280">
            

            

            <code class="ruby">    # Map Polly voice IDs to macOS system voices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">    def map_polly_to_macos_voice(polly_voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="282">
            

            

            <code class="ruby">      voice_mapping = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="283">
            

            

            <code class="ruby">        # US English voices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="284">
            

            

            <code class="ruby">        &#39;Matthew&#39; =&gt; &#39;Alex&#39;,      # Male US voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="285">
            

            

            <code class="ruby">        &#39;Joanna&#39; =&gt; &#39;Samantha&#39;,   # Female US voice  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="286">
            

            

            <code class="ruby">        &#39;Ruth&#39; =&gt; &#39;Victoria&#39;,     # Female US voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="287">
            

            

            <code class="ruby">        &#39;Stephen&#39; =&gt; &#39;Daniel&#39;,    # Male US voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="288">
            

            

            <code class="ruby">        &#39;Kendra&#39; =&gt; &#39;Kathy&#39;,      # Female US voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="289">
            

            

            <code class="ruby">        &#39;Salli&#39; =&gt; &#39;Samantha&#39;,    # Female US voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="290">
            

            

            <code class="ruby">        &#39;Joey&#39; =&gt; &#39;Alex&#39;,         # Male US voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">        &#39;Justin&#39; =&gt; &#39;Alex&#39;,       # Male US voice (child-like)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">        &#39;Kevin&#39; =&gt; &#39;Alex&#39;,        # Male US voice (child-like)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">        &#39;Kimberly&#39; =&gt; &#39;Kathy&#39;,    # Female US voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="294">
            

            

            <code class="ruby">        &#39;Ivy&#39; =&gt; &#39;Princess&#39;,      # Female US voice (child-like)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="295">
            

            

            <code class="ruby">        &#39;Danielle&#39; =&gt; &#39;Samantha&#39;, # Female US voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="296">
            

            

            <code class="ruby">        &#39;Gregory&#39; =&gt; &#39;Daniel&#39;,    # Male US voice</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="298">
            

            

            <code class="ruby">        # British English voices</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">        &#39;Arthur&#39; =&gt; &#39;Daniel&#39;,     # Male British (closest approximation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">        &#39;Emma&#39; =&gt; &#39;Kate&#39;,         # Female British</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="301">
            

            

            <code class="ruby">        &#39;Brian&#39; =&gt; &#39;Oliver&#39;,      # Male British</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="302">
            

            

            <code class="ruby">        &#39;Amy&#39; =&gt; &#39;Kate&#39;,          # Female British</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="304">
            

            

            <code class="ruby">        # Other English variants (best approximations)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="305">
            

            

            <code class="ruby">        &#39;Olivia&#39; =&gt; &#39;Karen&#39;,      # Australian Female</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="306">
            

            

            <code class="ruby">        &#39;Nicole&#39; =&gt; &#39;Karen&#39;,      # Australian Female</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="307">
            

            

            <code class="ruby">        &#39;Russell&#39; =&gt; &#39;Alex&#39;,      # Australian Male (approximation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="308">
            

            

            <code class="ruby">        &#39;Aria&#39; =&gt; &#39;Samantha&#39;,     # New Zealand Female (approximation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="309">
            

            

            <code class="ruby">        &#39;Niamh&#39; =&gt; &#39;Moira&#39;,       # Irish Female</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="310">
            

            

            <code class="ruby">        &#39;Geraint&#39; =&gt; &#39;Daniel&#39;,    # Welsh Male (approximation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="311">
            

            

            <code class="ruby">        &#39;Aditi&#39; =&gt; &#39;Veena&#39;,       # Indian Female</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">        &#39;Raveena&#39; =&gt; &#39;Veena&#39;,     # Indian Female</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="313">
            

            

            <code class="ruby">        &#39;Kajal&#39; =&gt; &#39;Veena&#39;,       # Indian Female</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="314">
            

            

            <code class="ruby">        &#39;Jasmine&#39; =&gt; &#39;Samantha&#39;,  # Singaporean Female (approximation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="315">
            

            

            <code class="ruby">        &#39;Ayanda&#39; =&gt; &#39;Samantha&#39;    # South African Female (approximation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="316">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="317">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="318">
            

            

            <code class="ruby">      mapped_voice = voice_mapping[polly_voice_id]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="319">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="320">
            

            

            <code class="ruby">      if mapped_voice.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="321">
            

            

            <code class="ruby">        Rails.logger.warn &quot; No macOS voice mapping found for &#39;#{polly_voice_id}&#39;, using default &#39;Samantha&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="322">
            

            

            <code class="ruby">        mapped_voice = &#39;Samantha&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="323">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="324">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="325">
            

            

            <code class="ruby">      Rails.logger.info &quot; Mapped Polly voice &#39;#{polly_voice_id}&#39; to macOS voice &#39;#{mapped_voice}&#39;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="326">
            

            

            <code class="ruby">      mapped_voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="327">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="328">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="329">
            

            

            <code class="ruby">    def validate_voice_id!(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="330">
            

            

            <code class="ruby">      unless voice_available?(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="331">
            

            

            <code class="ruby">        raise ArgumentError, &quot;Invalid voice_id: #{voice_id}. Available voices: #{list_all_voices.map { |v| v[:id] }.join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="332">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="333">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="335">
            

            

            <code class="ruby">    def voice_neural?(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="336">
            

            

            <code class="ruby">      voice = get_voice_config(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="337">
            

            

            <code class="ruby">      voice &amp;&amp; voice[:neural]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="338">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="340">
            

            

            <code class="ruby">    def build_ssml(text, prosody_rate)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="341">
            

            

            <code class="ruby">      &lt;&lt;~SSML</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="342">
            

            

            <code class="ruby">        &lt;speak&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="343">
            

            

            <code class="ruby">          &lt;prosody rate=&quot;#{prosody_rate}&quot;&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="344">
            

            

            <code class="ruby">            #{CGI.escapeHTML(text)}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="345">
            

            

            <code class="ruby">          &lt;/prosody&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="346">
            

            

            <code class="ruby">        &lt;/speak&gt;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="347">
            

            

            <code class="ruby">      SSML</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="348">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="349">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="350">
            

            

            <code class="ruby">    def generate_s3_key(voice_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="351">
            

            

            <code class="ruby">      prefix = case Rails.env</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="352">
            

            

            <code class="ruby">               when &#39;production&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">                 &#39;production/&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="354">
            

            

            <code class="ruby">               when &#39;staging&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="355">
            

            

            <code class="ruby">                 &#39;staging/&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="356">
            

            

            <code class="ruby">               else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="357">
            

            

            <code class="ruby">                 &#39;dev/&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="358">
            

            

            <code class="ruby">               end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="359">
            

            

            <code class="ruby">      timestamp = Time.now.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="360">
            

            

            <code class="ruby">      random_string = SecureRandom.hex(8)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">      &quot;#{prefix}polly_audio/#{voice_id.downcase}/#{timestamp}_#{random_string}.mp3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="364">
            

            

            <code class="ruby">    def get_presigned_url(s3_key, expires_in = 3600)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="365">
            

            

            <code class="ruby">      @s3_service.get_presigned_url(s3_key, expires_in)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="366">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="367">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="368">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6a46c71b198818c0b81689711792a17b778fe071">
  <div class="header">
    <h3>app/services/gemini_content_analysis_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>351</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>351</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require &#39;net/http&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">require &#39;json&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">require &#39;securerandom&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">require &#39;digest&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">class GeminiContentAnalysisService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  GEMINI_API_BASE = &#39;https://generativelanguage.googleapis.com/v1beta&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def initialize(api_key = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    @api_key = api_key || ENV[&#39;GEMINI_API_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    @model = &#39;gemini-2.5-flash-lite&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    @max_tokens = 2048</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    @temperature = 0.1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    raise &quot;GEMINI_API_KEY environment variable not set&quot; unless @api_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  # Analyze transcribed segments and generate image queries for Ken Burns videos</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  # @param segments [Array] Transcribed audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  # @param options [Hash] Analysis options</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">  # @return [Array] Segments with image queries and timing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">  def analyze_content_for_images(segments, options = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    Rails.logger.info &quot; Analyzing content for image generation using Gemini...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    # Check for cached analysis (respect force option)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    cache_file = get_cache_file_path(segments, options)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    if File.exist?(cache_file) &amp;&amp; !options[:force]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      Rails.logger.info &quot;     Using cached content analysis from: #{cache_file}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      cached_data = JSON.parse(File.read(cache_file), symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      return cached_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    elsif options[:force]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      Rails.logger.info &quot;     Force mode enabled - bypassing cache&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    # Process segments in smaller batches to avoid API limits</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    batch_size = 10  # Process 10 segments at a time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    all_results = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    Rails.logger.info &quot;   Analyzing #{segments.length} segments in batches of #{batch_size}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    segments.each_slice(batch_size).with_index do |batch, batch_index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      Rails.logger.info &quot;     Processing batch #{batch_index + 1}/#{(segments.length.to_f / batch_size).ceil} (#{batch.length} segments)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        # Build prompt for this batch</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">        prompt = build_batch_analysis_prompt(batch, options)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">        # Make API request for this batch</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        response = make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">        # Parse the response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">        batch_results = parse_batch_analysis_response(response, batch)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">        # Add to overall results</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        all_results.concat(batch_results)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">        # Add delay between batches to respect rate limits</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">        sleep(2) if batch_index &lt; (segments.length.to_f / batch_size).ceil - 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">        Rails.logger.error &quot;     Error processing batch #{batch_index + 1}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">        # Add segments with fallback queries instead of failing completely</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">        batch.each do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">          all_results &lt;&lt; segment.merge({</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">            image_queries: generate_fallback_queries(segment[:text] || segment[&#39;text&#39;] || &#39;&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">            has_images: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">          })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">    # Cache the analysis result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    Rails.logger.info &quot;     Caching content analysis to: #{cache_file}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">    File.write(cache_file, JSON.pretty_generate(all_results))</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    Rails.logger.info &quot; Content analysis completed: #{all_results.length} segments processed&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    all_results</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">  # Generate image queries for a specific text segment</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">  # @param text [String] Text to analyze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">  # @param context [Hash] Additional context</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">  # @return [Array] Image queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">  def generate_image_queries_for_text(text, context = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    prompt = build_single_text_prompt(text, context)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    response = make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    parsed = parse_analysis_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    parsed[:image_queries] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">  # Generate cache file path for content analysis</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">  # @param segments [Array] Audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">  # @param options [Hash] Analysis options</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">  # @return [String] Cache file path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">  def get_cache_file_path(segments, options)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">    # Create a hash of the segments and options to generate a unique cache key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">    content_hash = Digest::MD5.hexdigest(segments.to_json + options.to_json)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">    cache_dir = Rails.root.join(&#39;tmp&#39;, &#39;cache&#39;, &#39;gemini_analysis&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    FileUtils.mkdir_p(cache_dir) unless Dir.exist?(cache_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">    File.join(cache_dir, &quot;gemini_analysis_#{content_hash}.json&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">  # Build prompt for single text analysis</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby">  # @param text [String] Text to analyze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">  # @param context [Hash] Additional context</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">  # @return [String] Formatted prompt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">  def build_single_text_prompt(text, context = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">    context_type = context[:type] || &quot;content&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">    style = context[:style] || &quot;realistic, high-quality&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    prompt = &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">      You are an expert at analyzing text and determining what images would best illustrate the content.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      CONTEXT: This is #{context_type} that needs visual accompaniment.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      TEXT: &quot;#{text.strip}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      TASK: Generate 2-3 specific image search queries that would create compelling visual accompaniment.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">      REQUIREMENTS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">      - Generate queries that are specific and descriptive</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      - Focus on visual elements mentioned or implied in the text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">      - Each query should be 2-6 words maximum</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      - Prioritize queries that would work well for Ken Burns effects</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">        &quot;image_queries&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">          &quot;specific visual query 1&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">          &quot;specific visual query 2&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">        ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">        &quot;visual_style&quot;: &quot;#{style}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">      Generate only the JSON response, no other text.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    prompt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">  # Make request to Gemini API</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">  # @param prompt [String] The prompt to send</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">  # @return [Hash] API response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">  def make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">    uri = URI(&quot;#{GEMINI_API_BASE}/models/#{@model}:generateContent?key=#{@api_key}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    request = Net::HTTP::Post.new(uri)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">    request[&#39;Content-Type&#39;] = &#39;application/json&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">    request.body = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">      contents: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">          parts: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">              text: prompt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">          ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">      generationConfig: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">        temperature: @temperature,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">        maxOutputTokens: @max_tokens,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">        topP: 0.8,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">        topK: 40</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">    }.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">    response = make_request(request, uri)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">    if response[&#39;error&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">      raise &quot;Gemini API Error: #{response[&#39;error&#39;][&#39;message&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">    response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">  # Make HTTP request</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">  # @param request [Net::HTTP::Request] The request object</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">  # @param uri [URI] The URI object</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">  # @return [Hash] Parsed JSON response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">  def make_request(request, uri)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">    http = Net::HTTP.new(uri.host, uri.port)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">    http.use_ssl = true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">    http.read_timeout = 60</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">    http.open_timeout = 30</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">    response = http.request(request)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">    if response.code != &#39;200&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">      raise &quot;HTTP Error: #{response.code} - #{response.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">    JSON.parse(response.body)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">    raise &quot;Request failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">  # Parse analysis response from Gemini</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby">  # @param response [Hash] Gemini API response</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">  # @return [Hash] Parsed analysis result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">  def parse_analysis_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">    content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">    return { image_queries: [], primary_theme: &#39;&#39;, visual_style: &#39;&#39; } unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="211">
            

            

            <code class="ruby">      # Try to parse as JSON</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">      parsed = JSON.parse(content.strip)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="213">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby">      # Validate structure</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">        image_queries: parsed[&#39;image_queries&#39;] || [],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">        primary_theme: parsed[&#39;primary_theme&#39;] || &#39;&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">        visual_style: parsed[&#39;visual_style&#39;] || &#39;realistic, high-quality&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">        duration_suggestion: parsed[&#39;duration_suggestion&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">    rescue JSON::ParserError</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby">      # Fallback: try to extract queries from text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">        image_queries: extract_queries_from_text(content),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">        primary_theme: &#39;extracted from content&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">        visual_style: &#39;realistic, high-quality&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby">  # Extract queries from text when JSON parsing fails</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby">  # @param text [String] Response text</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">  # @return [Array] Extracted queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">  def extract_queries_from_text(text)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            

            <code class="ruby">    # Simple fallback extraction</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">    lines = text.split(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">    queries = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="238">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">    lines.each do |line|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">      line = line.strip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">      next if line.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby">      # Look for quoted strings or simple phrases</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">      if line.match(/^[&quot;&#39;](.+?)[&quot;&#39;]$/) || line.match(/^[-*]\s*(.+)$/)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">        query = $1.strip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">        queries &lt;&lt; query if query.length &gt; 2 &amp;&amp; query.length &lt; 50</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">      elsif line.match(/^(\w+(?:\s+\w+){1,5})$/)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">        queries &lt;&lt; line</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="251">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">    queries.uniq.first(4) # Limit to 4 queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="254">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            

            <code class="ruby">  # Generate fallback queries from text</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby">  # @param text [String] Text to analyze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            

            <code class="ruby">  # @return [Array] Generated queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="258">
            

            

            <code class="ruby">  def generate_fallback_queries(text)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            

            <code class="ruby">    # Create imaginative, positive, and cheerful fallback queries</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="260">
            

            

            <code class="ruby">    # These are designed to be engaging and work well for Ken Burns effects</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="261">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="262">
            

            

            <code class="ruby">    # Positive, cheerful themes that work well for video</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">    cheerful_themes = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">      &quot;sunny landscape&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">      &quot;happy people&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">      &quot;beautiful nature&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">      &quot;inspiring architecture&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">      &quot;vibrant colors&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="269">
            

            

            <code class="ruby">      &quot;peaceful scenes&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">      &quot;creative workspace&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">      &quot;adventure travel&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">      &quot;artistic expression&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">      &quot;community celebration&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">      &quot;serene landscapes&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="275">
            

            

            <code class="ruby">      &quot;dynamic city life&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">      &quot;natural beauty&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">      &quot;cultural diversity&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="278">
            

            

            <code class="ruby">      &quot;innovative technology&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">      &quot;sustainable living&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">      &quot;human connection&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">      &quot;artistic creativity&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="282">
            

            

            <code class="ruby">      &quot;urban exploration&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="283">
            

            

            <code class="ruby">      &quot;rural tranquility&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="284">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="285">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="286">
            

            

            <code class="ruby">    # Extract some context from the text to make queries more relevant</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="287">
            

            

            <code class="ruby">    words = text.downcase.split(/\W+/).reject { |w| w.length &lt; 3 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="288">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="289">
            

            

            <code class="ruby">    # Look for specific themes in the text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="290">
            

            

            <code class="ruby">    if text.match(/tech|digital|computer|phone|device/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">      queries = [&quot;modern technology&quot;, &quot;innovative design&quot;, &quot;digital lifestyle&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">    elsif text.match(/business|work|professional|career/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">      queries = [&quot;professional workspace&quot;, &quot;business collaboration&quot;, &quot;modern office&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="294">
            

            

            <code class="ruby">    elsif text.match(/nature|outdoor|environment|green/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="295">
            

            

            <code class="ruby">      queries = [&quot;natural landscape&quot;, &quot;environmental beauty&quot;, &quot;outdoor adventure&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="296">
            

            

            <code class="ruby">    elsif text.match(/city|urban|building|architecture/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="297">
            

            

            <code class="ruby">      queries = [&quot;urban architecture&quot;, &quot;city skyline&quot;, &quot;modern cityscape&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="298">
            

            

            <code class="ruby">    elsif text.match(/people|human|person|community/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">      queries = [&quot;diverse community&quot;, &quot;human connection&quot;, &quot;cultural celebration&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">    elsif text.match(/art|creative|design|artistic/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="301">
            

            

            <code class="ruby">      queries = [&quot;artistic expression&quot;, &quot;creative workspace&quot;, &quot;design inspiration&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="302">
            

            

            <code class="ruby">    elsif text.match(/travel|adventure|exploration/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="303">
            

            

            <code class="ruby">      queries = [&quot;adventure travel&quot;, &quot;exploration journey&quot;, &quot;world discovery&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="304">
            

            

            <code class="ruby">    elsif text.match(/food|cooking|culinary/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="305">
            

            

            <code class="ruby">      queries = [&quot;culinary artistry&quot;, &quot;food culture&quot;, &quot;gourmet experience&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="306">
            

            

            <code class="ruby">    elsif text.match(/music|sound|audio/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="307">
            

            

            <code class="ruby">      queries = [&quot;musical expression&quot;, &quot;sound studio&quot;, &quot;creative performance&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="308">
            

            

            <code class="ruby">    elsif text.match(/health|wellness|fitness/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="309">
            

            

            <code class="ruby">      queries = [&quot;healthy lifestyle&quot;, &quot;wellness journey&quot;, &quot;active living&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="310">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="311">
            

            

            <code class="ruby">      # Default to positive, engaging themes</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">      queries = cheerful_themes.sample(3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="313">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="314">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="315">
            

            

            <code class="ruby">    # Ensure we have exactly 3 queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="316">
            

            

            <code class="ruby">    queries = queries.first(3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="317">
            

            

            <code class="ruby">    while queries.length &lt; 3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="318">
            

            

            <code class="ruby">      queries &lt;&lt; cheerful_themes.sample</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="319">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="320">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="321">
            

            

            <code class="ruby">    queries.uniq.first(3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="322">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="323">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="324">
            

            

            <code class="ruby">  # Build a single comprehensive prompt for all segments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="325">
            

            

            <code class="ruby">  # @param segments [Array] Transcribed audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="326">
            

            

            <code class="ruby">  # @param options [Hash] Analysis options</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="327">
            

            

            <code class="ruby">  # @return [String] Formatted prompt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="328">
            

            

            <code class="ruby">  def build_batch_analysis_prompt(segments, options)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="329">
            

            

            <code class="ruby">    context = options[:context] || &quot;content analysis&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="330">
            

            

            <code class="ruby">    style = options[:style] || &quot;realistic, high-quality&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="331">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="332">
            

            

            <code class="ruby">    # Calculate total duration</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="333">
            

            

            <code class="ruby">    total_duration = segments.sum { |s| (s[:end_time] || s[&#39;end&#39;] || 0) - (s[:start_time] || s[&#39;start&#39;] || 0) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="335">
            

            

            <code class="ruby">    prompt = &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="336">
            

            

            <code class="ruby">      You are an expert at analyzing spoken content and determining what images would best illustrate the narrative.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="337">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="338">
            

            

            <code class="ruby">      CONTEXT: This is a #{context} that has been transcribed from audio.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="340">
            

            

            <code class="ruby">      AUDIO SEGMENTS (Total Duration: #{total_duration.round(1)} seconds):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="341">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="342">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="343">
            

            

            <code class="ruby">    segments.each_with_index do |segment, index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="344">
            

            

            <code class="ruby">      start_time = segment[:start_time] || segment[&#39;start&#39;] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="345">
            

            

            <code class="ruby">      end_time = segment[:end_time] || segment[&#39;end&#39;] || 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="346">
            

            

            <code class="ruby">      text = segment[:text] || segment[&#39;text&#39;] || &#39;&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="347">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="348">
            

            

            <code class="ruby">      prompt += &lt;&lt;~SEGMENT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="349">
            

            

            <code class="ruby">        Segment #{index + 1} (#{start_time.round(1)}s - #{end_time.round(1)}s): &quot;#{text.strip}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="350">
            

            

            <code class="ruby">      SEGMENT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="351">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="352">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">    prompt += &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="354">
            

            

            <code class="ruby">      TASK: Analyze each segment and generate 1-2 specific image search queries for each segment that would create compelling visual accompaniment for a Ken Burns-style video effect.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="355">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="356">
            

            

            <code class="ruby">      REQUIREMENTS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="357">
            

            

            <code class="ruby">      - Generate 2-3 queries PER SEGMENT PLUS backup options</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="358">
            

            

            <code class="ruby">      - CATEGORIZE each query as either &quot;famous_person&quot;, &quot;stock_image&quot;, or &quot;general&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="359">
            

            

            <code class="ruby">      - For FAMOUS PERSONS (politicians, celebrities, historical figures, public figures): Use category &quot;famous_person&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="360">
            

            

            <code class="ruby">      - For STOCK IMAGES (landscapes, objects, generic scenes, concepts): Use category &quot;stock_image&quot;  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">      - For GENERAL CONTENT (mixed or unclear): Use category &quot;general&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">      - Generate queries that are HIGHLY specific and descriptive</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="363">
            

            

            <code class="ruby">      - Focus on concrete visual elements mentioned or implied in each segment&#39;s text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="364">
            

            

            <code class="ruby">      - Consider the emotional tone and context of each segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="365">
            

            

            <code class="ruby">      - TIMING AWARENESS: Consider each segment&#39;s position in the narrative flow</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="366">
            

            

            <code class="ruby">      - Match images to the EXACT moment being described in each time segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="367">
            

            

            <code class="ruby">      - For segments with multiple concepts, prioritize the most visually prominent element</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="368">
            

            

            <code class="ruby">      - Avoid generic terms, be specific about objects, scenes, or concepts</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="369">
            

            

            <code class="ruby">      - Each query should be 3-8 words for better specificity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="370">
            

            

            <code class="ruby">      - Prioritize queries that would work well for Ken Burns effects (landscapes, objects, people, etc.)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="371">
            

            

            <code class="ruby">      - Always include backup/fallback queries for each segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="372">
            

            

            <code class="ruby">      - Provide alternative search terms that could work if primary queries fail</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="373">
            

            

            <code class="ruby">      - Ensure images can sustain viewer attention for 5-11 seconds without being repetitive</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="374">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="375">
            

            

            <code class="ruby">      RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="376">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="377">
            

            

            <code class="ruby">        &quot;segments&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="378">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="379">
            

            

            <code class="ruby">            &quot;segment_id&quot;: 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="380">
            

            

            <code class="ruby">            &quot;image_queries&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="381">
            

            

            <code class="ruby">              {&quot;query&quot;: &quot;primary specific query&quot;, &quot;category&quot;: &quot;famous_person&quot;},</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="382">
            

            

            <code class="ruby">              {&quot;query&quot;: &quot;secondary query&quot;, &quot;category&quot;: &quot;stock_image&quot;},</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="383">
            

            

            <code class="ruby">              {&quot;query&quot;: &quot;fallback query&quot;, &quot;category&quot;: &quot;general&quot;}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="384">
            

            

            <code class="ruby">            ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="385">
            

            

            <code class="ruby">            &quot;backup_queries&quot;: [&quot;alternative term 1&quot;, &quot;alternative term 2&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="386">
            

            

            <code class="ruby">          },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="387">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="388">
            

            

            <code class="ruby">            &quot;segment_id&quot;: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="389">
            

            

            <code class="ruby">            &quot;image_queries&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="390">
            

            

            <code class="ruby">              {&quot;query&quot;: &quot;primary specific query&quot;, &quot;category&quot;: &quot;stock_image&quot;},</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="391">
            

            

            <code class="ruby">              {&quot;query&quot;: &quot;secondary query&quot;, &quot;category&quot;: &quot;general&quot;},</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="392">
            

            

            <code class="ruby">              {&quot;query&quot;: &quot;fallback query&quot;, &quot;category&quot;: &quot;famous_person&quot;}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="393">
            

            

            <code class="ruby">            ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="394">
            

            

            <code class="ruby">            &quot;backup_queries&quot;: [&quot;alternative term 1&quot;, &quot;alternative term 2&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="395">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="396">
            

            

            <code class="ruby">        ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="397">
            

            

            <code class="ruby">        &quot;primary_theme&quot;: &quot;brief description of main theme&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="398">
            

            

            <code class="ruby">        &quot;visual_style&quot;: &quot;#{style}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="399">
            

            

            <code class="ruby">        &quot;total_duration&quot;: #{total_duration.round(1)}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="400">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="401">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="402">
            

            

            <code class="ruby">      Generate only the JSON response, no other text. Provide image_queries for each segment with proper categorization.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="403">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="404">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="405">
            

            

            <code class="ruby">    prompt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="406">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="407">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="408">
            

            

            <code class="ruby">  # Parse batch analysis response from Gemini</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="409">
            

            

            <code class="ruby">  # @param response [Hash] Gemini API response</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="410">
            

            

            <code class="ruby">  # @param segments [Array] Transcribed audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="411">
            

            

            <code class="ruby">  # @return [Array] Enriched segments with image queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="412">
            

            

            <code class="ruby">  def parse_batch_analysis_response(response, segments)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="413">
            

            

            <code class="ruby">    content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="414">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="415">
            

            

            <code class="ruby">    return segments unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="416">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="417">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="418">
            

            

            <code class="ruby">      # Clean up markdown code blocks if present</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="419">
            

            

            <code class="ruby">      cleaned_content = content.strip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="420">
            

            

            <code class="ruby">      # Remove markdown code blocks</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="421">
            

            

            <code class="ruby">      cleaned_content = cleaned_content.gsub(/^```json\s*/, &#39;&#39;).gsub(/\s*```$/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            

            

            <code class="ruby">      cleaned_content = cleaned_content.strip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="423">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="424">
            

            

            <code class="ruby">      # Try to parse as JSON</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="425">
            

            

            <code class="ruby">      parsed = JSON.parse(cleaned_content, symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="426">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="427">
            

            

            <code class="ruby">      # Check if we have the new format with segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="428">
            

            

            <code class="ruby">      if parsed[:segments] &amp;&amp; parsed[:segments].is_a?(Array)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="429">
            

            

            <code class="ruby">        # New format: each segment has its own queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="430">
            

            

            <code class="ruby">        enriched_segments = segments.map.with_index do |segment, index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="431">
            

            

            <code class="ruby">          segment_analysis = parsed[:segments].find { |s| s[:segment_id] == index }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="432">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="433">
            

            

            <code class="ruby">          if segment_analysis &amp;&amp; segment_analysis[:image_queries]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="434">
            

            

            <code class="ruby">            # Handle both old string format and new categorized format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="435">
            

            

            <code class="ruby">            processed_queries = segment_analysis[:image_queries].map do |query_item|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="436">
            

            

            <code class="ruby">              if query_item.is_a?(Hash) &amp;&amp; query_item[:query] &amp;&amp; query_item[:category]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="437">
            

            

            <code class="ruby">                # New categorized format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="438">
            

            

            <code class="ruby">                {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="439">
            

            

            <code class="ruby">                  query: query_item[:query].to_s.strip,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="440">
            

            

            <code class="ruby">                  category: query_item[:category].to_s.strip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="441">
            

            

            <code class="ruby">                }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="442">
            

            

            <code class="ruby">              elsif query_item.is_a?(String)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="443">
            

            

            <code class="ruby">                # Old string format - default to general category</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="444">
            

            

            <code class="ruby">                {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="445">
            

            

            <code class="ruby">                  query: query_item.to_s.strip,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="446">
            

            

            <code class="ruby">                  category: &#39;general&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="447">
            

            

            <code class="ruby">                }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="448">
            

            

            <code class="ruby">              else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="449">
            

            

            <code class="ruby">                # Fallback</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="450">
            

            

            <code class="ruby">                {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="451">
            

            

            <code class="ruby">                  query: query_item.to_s.strip,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="452">
            

            

            <code class="ruby">                  category: &#39;general&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="453">
            

            

            <code class="ruby">                }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="454">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="455">
            

            

            <code class="ruby">            end.reject { |q| q[:query].empty? }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="456">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="457">
            

            

            <code class="ruby">            # Extract backup queries if available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="458">
            

            

            <code class="ruby">            backup_queries = segment_analysis[:backup_queries] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="459">
            

            

            <code class="ruby">            clean_backup_queries = backup_queries.map do |query|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="460">
            

            

            <code class="ruby">              query.to_s.gsub(/^[&quot;\s]*/, &#39;&#39;).gsub(/[&quot;\s]*$/, &#39;&#39;).gsub(/^backup_queries&quot;:\s*\[?&quot;?/, &#39;&#39;).gsub(/&quot;?\s*,?\s*$/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="461">
            

            

            <code class="ruby">            end.reject(&amp;:empty?)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="462">
            

            

            <code class="ruby">            </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="463">
            

            

            <code class="ruby">            segment.merge({</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="464">
            

            

            <code class="ruby">              image_queries: processed_queries,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="465">
            

            

            <code class="ruby">              backup_queries: clean_backup_queries,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="466">
            

            

            <code class="ruby">              has_images: processed_queries.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="467">
            

            

            <code class="ruby">            })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="468">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="469">
            

            

            <code class="ruby">            # Fallback: generate queries for this segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="470">
            

            

            <code class="ruby">            fallback_queries = generate_fallback_queries(segment[:text] || segment[&#39;text&#39;] || &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="471">
            

            

            <code class="ruby">            segment.merge({</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="472">
            

            

            <code class="ruby">              image_queries: fallback_queries,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="473">
            

            

            <code class="ruby">              backup_queries: generate_fallback_queries(segment[:text] || segment[&#39;text&#39;] || &#39;&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="474">
            

            

            <code class="ruby">              has_images: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="475">
            

            

            <code class="ruby">            })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="476">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="477">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="478">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="479">
            

            

            <code class="ruby">        enriched_segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="480">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="481">
            

            

            <code class="ruby">        # Old format: distribute queries across segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="482">
            

            

            <code class="ruby">        image_queries = parsed[:image_queries] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="483">
            

            

            <code class="ruby">        distribute_image_queries(segments, image_queries)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="484">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="485">
            

            

            <code class="ruby">    rescue JSON::ParserError</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="486">
            

            

            <code class="ruby">      # Fallback: try to extract queries from text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="487">
            

            

            <code class="ruby">      fallback_queries = extract_queries_from_text(content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="488">
            

            

            <code class="ruby">      distribute_image_queries(segments, fallback_queries)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="489">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="490">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="491">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="492">
            

            

            <code class="ruby">  # Distribute image queries across segments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="493">
            

            

            <code class="ruby">  # @param segments [Array] Audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="494">
            

            

            <code class="ruby">  # @param image_queries [Array] Image queries</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="495">
            

            

            <code class="ruby">  # @return [Array] Segments with assigned queries</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="496">
            

            

            <code class="ruby">  def distribute_image_queries(segments, image_queries)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="497">
            

            

            <code class="ruby">    return segments if image_queries.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="498">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="499">
            

            

            <code class="ruby">    segments.each_with_index do |segment, index|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="500">
            

            

            <code class="ruby">      # Assign ONE query per segment based on segment position</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="501">
            

            

            <code class="ruby">      query_index = index % image_queries.length</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="502">
            

            

            <code class="ruby">      # Preserve all original segment data and add ONE image query</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="503">
            

            

            <code class="ruby">      segment.merge!({</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="504">
            

            

            <code class="ruby">        image_queries: [image_queries[query_index]], # Only ONE query per segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="505">
            

            

            <code class="ruby">        has_images: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="506">
            

            

            <code class="ruby">      })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="507">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="508">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="509">
            

            

            <code class="ruby">    segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="510">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="511">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="681d02ba100dff236efac2340176b090351645db">
  <div class="header">
    <h3>app/services/gemini_quote_extraction_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>115</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>115</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class GeminiQuoteExtractionService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def self.extract_quotes(transcript, orientation = &#39;portrait&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    Rails.logger.info &quot; GeminiQuoteService: Starting extraction with #{transcript&amp;.length || 0} chars, orientation: #{orientation}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    return { quotes: [], searchTerms: [], imagePrompts: [] } if transcript.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">      Rails.logger.info &quot; GeminiQuoteService: Building extraction prompt&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">      # Call Gemini API for quote extraction</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      prompt = build_quote_extraction_prompt(transcript, orientation)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      Rails.logger.info &quot; GeminiQuoteService: Prompt length: #{prompt.length} chars&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      Rails.logger.info &quot; GeminiQuoteService: Making Gemini API request&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      response = service.send(:make_gemini_request, prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      Rails.logger.info &quot; GeminiQuoteService: Received Gemini response&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      Rails.logger.info &quot; GeminiQuoteService: Response structure: #{response&amp;.keys&amp;.join(&#39;, &#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      # Parse the Gemini response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      unless content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">        Rails.logger.warn &quot; GeminiQuoteService: No content in Gemini response&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">        Rails.logger.warn &quot; GeminiQuoteService: Full response: #{response.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">        return { quotes: [], searchTerms: [], imagePrompts: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      Rails.logger.info &quot; GeminiQuoteService: Raw content length: #{content.length} chars&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      Rails.logger.info &quot; GeminiQuoteService: Raw content preview: #{content[0..200]}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      # Clean up and parse JSON response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      cleaned_content = content.strip.gsub(/^```json\s*/, &#39;&#39;).gsub(/\s*```$/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      Rails.logger.info &quot; GeminiQuoteService: Cleaned content length: #{cleaned_content.length} chars&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">        parsed = JSON.parse(cleaned_content, symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">        Rails.logger.info &quot; GeminiQuoteService: Successfully parsed JSON response&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      rescue JSON::ParserError =&gt; json_error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">        Rails.logger.error &quot; GeminiQuoteService: JSON parsing failed: #{json_error.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">        Rails.logger.error &quot; GeminiQuoteService: Content that failed to parse: #{cleaned_content}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        return { quotes: [], searchTerms: [], imagePrompts: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      result = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        quotes: parsed[:quotes] || [],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        orientation: parsed[:orientation] || orientation,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">        searchTerms: parsed[:searchTerms] || [],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">        imagePrompts: parsed[:imagePrompts] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      Rails.logger.info &quot; GeminiQuoteService: Extraction successful - quotes: #{result[:quotes].length}, searchTerms: #{result[:searchTerms].length}, imagePrompts: #{result[:imagePrompts].length}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">      # Log quote details for debugging</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      result[:quotes].each_with_index do |quote, index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">        Rails.logger.info &quot; GeminiQuoteService: Quote #{index + 1}: &#39;#{quote[:text]&amp;.slice(0, 50)}...&#39; (#{quote[:colorizedWords]&amp;.length || 0} colored words)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      result</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      Rails.logger.error &quot; GeminiQuoteService: Extraction failed: #{e.class.name} - #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      Rails.logger.error &quot; GeminiQuoteService: Full backtrace: #{e.backtrace&amp;.join(&#39;\n&#39;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">      # Check if this is a network/API error vs parsing error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      if e.message.include?(&#39;timeout&#39;) || e.message.include?(&#39;connection&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">        Rails.logger.error &quot; GeminiQuoteService: Network/timeout error detected&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      elsif e.is_a?(JSON::ParserError)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">        Rails.logger.error &quot; GeminiQuoteService: JSON parsing error detected&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        Rails.logger.error &quot; GeminiQuoteService: Unknown error type: #{e.class.name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      { quotes: [], searchTerms: [], imagePrompts: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">  def self.build_quote_extraction_prompt(transcript, orientation)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    max_length = orientation == &#39;portrait&#39; ? 120 : 180</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">      You are an expert at extracting powerful, shareable quotes from interview transcripts for social media quote graphics.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">      TASK: Analyze this interview transcript and extract 3-5 compelling quotes that would work well as quote shots.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      TRANSCRIPT:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">      #{transcript}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      REQUIREMENTS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      - Each quote should be #{max_length} characters or less for #{orientation} format</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">      - Focus on the most impactful, emotional, or insightful statements</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">      - Quotes should be complete thoughts that work independently</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">      - Prioritize quotes that are relatable and shareable</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      - Remove filler words like &quot;um&quot;, &quot;uh&quot;, &quot;you know&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">      - Fix minor grammar issues while preserving the speaker&#39;s voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">      - For each quote, identify 2-3 key words that should be highlighted in a different color</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">      - Generate 3-5 relevant image search terms for finding appropriate background images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      - Generate 3 detailed image generation prompts that would create suitable backgrounds for these quotes</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">      RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">        &quot;quotes&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">            &quot;text&quot;: &quot;The exact quote text here&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">            &quot;reasoning&quot;: &quot;Why this quote is compelling&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">            &quot;colorizedWords&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">                &quot;word&quot;: &quot;powerful&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">                &quot;color&quot;: &quot;#FF6B35&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">                &quot;range&quot;: {&quot;location&quot;: 15, &quot;length&quot;: 8}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">              },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">                &quot;word&quot;: &quot;moment&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">                &quot;color&quot;: &quot;#4A90E2&quot;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">                &quot;range&quot;: {&quot;location&quot;: 45, &quot;length&quot;: 6}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">            ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">            &quot;estimatedReadingTime&quot;: 3.5</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">        ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">        &quot;orientation&quot;: &quot;#{orientation}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">        &quot;searchTerms&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">          &quot;inspirational sunrise&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">          &quot;person thinking deeply&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">          &quot;calm nature scene&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">        ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">        &quot;imagePrompts&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">          &quot;A serene sunrise over mountains with warm golden light, inspirational mood, high quality photography&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">          &quot;Abstract geometric patterns with flowing gradients in purple and blue tones, modern minimal design&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">          &quot;Peaceful ocean waves at sunset with soft pastel colors, calming atmosphere, professional photography&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      COLORIZATION GUIDELINES:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">      - Highlight emotional words (love, fear, hope, dream, etc.) in warm colors (#FF6B35, #E74C3C)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">      - Highlight action words (create, build, achieve, etc.) in energetic colors (#3498DB, #9B59B6)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">      - Highlight important nouns in accent colors (#2ECC71, #F39C12)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">      - Use maximum 3 colors per quote to avoid overwhelming the design</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">      - Ensure colors contrast well with both light and dark backgrounds</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">      Generate only the JSON response, no other text.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8c640ccaa38b16c1d4a4d0c6522e4b8ef7a6292a">
  <div class="header">
    <h3>app/services/gemini_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>62</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>62</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class GeminiService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    @service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  def polish_transcript(transcript:, perspective:, speaker_name:, pronoun: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    Rails.logger.info &quot;Polishing transcript with perspective: #{perspective}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    prompt = build_polishing_prompt(transcript, perspective, speaker_name, pronoun)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    response = @service.send(:make_gemini_request, prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    return nil unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    content.strip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to polish transcript: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  def analyze_content(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    Rails.logger.info &quot;Analyzing content with Gemini&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    response = @service.send(:make_gemini_request, prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    return nil unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    content.strip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to analyze content: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">  def build_polishing_prompt(transcript, perspective, speaker_name, pronoun)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    perspective_instructions = case perspective</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    when &#39;first_person&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      &quot;Write in first person (I/me/my). Convert all references to the speaker into first person.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    when &#39;second_person&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      &quot;Write in second person (you/your). This is already the natural perspective for interviews.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    when &#39;third_person&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      possessive = case pronoun</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">                    when &#39;he&#39; then &#39;his&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">                    when &#39;she&#39; then &#39;her&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">                    else &#39;their&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">                    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      &quot;Write in third person using &#39;#{speaker_name}&#39; and &#39;#{pronoun}/#{possessive}&#39;. Convert all &#39;I/me/my&#39; references to third person.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">      You are an expert editor polishing an interview transcript. Your task is to create a polished, readable version while maintaining authenticity.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      SPEAKER: #{speaker_name}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      PERSPECTIVE: #{perspective}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      RAW TRANSCRIPT:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">      #{transcript}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      INSTRUCTIONS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">      1. #{perspective_instructions}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      2. Remove filler words (um, uh, like, you know) while preserving natural speech patterns</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      3. Fix grammar and punctuation while maintaining the speaker&#39;s voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      4. Break into logical paragraphs for readability</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      5. Preserve all important details, stories, and emotions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      6. Keep the conversational, warm tone appropriate for family memories</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      7. Ensure the text flows naturally and is engaging to read</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      IMPORTANT:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">      - Maintain the exact perspective requested (#{perspective})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      - Keep the authentic voice of the speaker</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      - Preserve all meaningful content and stories</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">      - Return only the polished text, no additional formatting or comments</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      Return the polished text directly, formatted as clean paragraphs.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="99d9dc4d25b1ed71a85ebdd8e49dfe8a6c16c1ad">
  <div class="header">
    <h3>app/services/gemini_text_polishing_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>145</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>145</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class GeminiTextPolishingService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def self.polish_transcript(raw_content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    return &quot;&quot; if raw_content.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">      Rails.logger.info &quot;Starting Gemini text polishing&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">      # Use raw plaintext directly if it&#39;s a string, otherwise extract from structured content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      raw_text = raw_content.is_a?(String) ? raw_content : extract_text_from_structured_content(raw_content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      return &quot;&quot; if raw_text.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      # Call Gemini API for polishing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      prompt = build_polishing_prompt(raw_text)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      response = service.send(:make_gemini_request, prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">      # Parse the Gemini response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      return &quot;&quot; unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">      # Return polished content as plain text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      polished_text = content.strip</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      Rails.logger.info &quot;Gemini polishing successful&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      polished_text</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      Rails.logger.error &quot;Gemini polishing failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  # Legacy method for backward compatibility</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">  def self.polish_transcript_structured(raw_structured_content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    return [] if raw_structured_content.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      Rails.logger.info &quot;Starting Gemini text polishing (structured)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      # Extract text from structured content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      raw_text = extract_text_from_structured_content(raw_structured_content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      return [] if raw_text.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      # Call Gemini API for polishing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      service = InterviewQuestionService.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      prompt = build_structured_polishing_prompt(raw_text)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      response = service.send(:make_gemini_request, prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">      # Parse the Gemini response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">      content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      return [] unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">      # Extract polished content from JSON response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      cleaned_content = content.strip.gsub(/^```json\s*/, &#39;&#39;).gsub(/\s*```$/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      parsed = JSON.parse(cleaned_content, symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      polished_content = parsed[:content] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      Rails.logger.info &quot;Gemini polishing successful: #{polished_content.length} content items&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      polished_content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      Rails.logger.error &quot;Gemini polishing failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">  def self.extract_text_from_structured_content(structured_content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    return &quot;&quot; unless structured_content.is_a?(Array)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    text_parts = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">    current_context = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    structured_content.each do |item|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      case item[&#39;type&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">      when &#39;chapter&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">        current_context[:chapter] = item[&#39;title&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">        text_parts &lt;&lt; &quot;\n\n## #{item[&#39;title&#39;]}\n&quot; if item[&#39;title&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">      when &#39;section&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">        current_context[:section] = item[&#39;title&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">        text_parts &lt;&lt; &quot;\n### #{item[&#39;title&#39;]}\n&quot; if item[&#39;title&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      when &#39;paragraph&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">        if item[&#39;text&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">          # Add context for better polishing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">          context_prefix = &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">          if current_context[:chapter] &amp;&amp; current_context[:section]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">            context_prefix = &quot;[#{current_context[:chapter]} - #{current_context[:section]}] &quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">          elsif current_context[:chapter]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">            context_prefix = &quot;[#{current_context[:chapter]}] &quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">          text_parts &lt;&lt; &quot;#{context_prefix}#{item[&#39;text&#39;]}\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">    text_parts.join</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">  def self.build_polishing_prompt(raw_text)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">      You are an expert transcript editor. Your task is to polish this raw interview transcript into professional, well-structured content while maintaining the authentic voice and all important details.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      RAW TRANSCRIPT:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">      #{raw_text}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">      INSTRUCTIONS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      1. Clean up filler words (um, uh, like, you know) but preserve natural speech patterns and the original language as much as possible</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      2. Fix grammar, punctuation, and sentence structure while maintaining the speaker&#39;s natural voice</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">      3. Improve flow and readability while maintaining conversational tone</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">      4. Break content into logical paragraphs based on topics and natural transitions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      5. Preserve all key details, examples, and specific information mentioned</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">      6. Maintain the structure indicated by chapter/section headers and interview questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">      7. Ensure each paragraph is substantial and well-formed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      8. Keep the content interview-appropriate (professional but authentic)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      9. Include interview questions in the polished output to provide context</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">      10. Preserve the original language and cultural expressions as much as possible</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">      OUTPUT FORMAT:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      Return the polished content as clean, well-formatted markdown text. Maintain the chapter/section structure and include interview questions. Do not return JSON - just return the polished markdown text directly.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">      IMPORTANT:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">      - Return only the polished markdown text, no other formatting or wrapper text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      - Maintain the logical structure from the raw content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">      - Each paragraph should be meaningful and substantial</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      - Preserve the essence and details of what was said</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">      - Include interview questions to provide context for responses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      - Keep the speaker&#39;s authentic voice and original language</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">  def self.build_structured_polishing_prompt(raw_text)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">      You are an expert transcript editor. Your task is to polish this raw interview transcript into professional, well-structured content while maintaining the authentic voice and all important details.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      RAW TRANSCRIPT:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">      &quot;#{raw_text}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">      INSTRUCTIONS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">      1. Clean up filler words (um, uh, like, you know) but preserve natural speech patterns</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">      2. Fix grammar, punctuation, and sentence structure</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">      3. Improve flow and readability while maintaining conversational tone</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">      4. Break content into logical paragraphs based on topics and natural transitions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">      5. Preserve all key details, examples, and specific information mentioned</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">      6. Maintain the structure indicated by chapter/section headers</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">      7. Ensure each paragraph is substantial and well-formed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">      8. Keep the content interview-appropriate (professional but authentic)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">      OUTPUT FORMAT:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">      Return the polished content as a JSON array where each item represents a content block. Use this exact structure:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">        &quot;content&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">            &quot;type&quot;: &quot;chapter&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">            &quot;chapterId&quot;: null,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">            &quot;title&quot;: &quot;Chapter Title Here&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">            &quot;text&quot;: null,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">            &quot;audioSegmentId&quot;: null</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">          },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">            &quot;type&quot;: &quot;section&quot;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">            &quot;sectionId&quot;: null,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">            &quot;title&quot;: &quot;Section Title Here&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">            &quot;text&quot;: null,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">            &quot;audioSegmentId&quot;: null</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">          },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">            &quot;type&quot;: &quot;paragraph&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">            &quot;chapterId&quot;: null,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">            &quot;sectionId&quot;: null,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">            &quot;questionId&quot;: null,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">            &quot;text&quot;: &quot;Polished paragraph text here. This should be well-structured, grammatically correct, and flow naturally.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">            &quot;audioSegmentId&quot;: null</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">      IMPORTANT:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">      - Only return the JSON response, no other text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">      - Maintain the logical structure from the raw content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">      - Each paragraph should be meaningful and substantial</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">      - Preserve the essence and details of what was said</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">      - IDs will be populated later by the system, keep them null</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f4b936095d50fbcf430b064ebba077696334dc61">
  <div class="header">
    <h3>app/services/image_apis/base_image_client.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>32</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>32</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require &#39;httparty&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">class BaseImageClient</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  attr_reader :api_key, :logger</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  def initialize(config = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @api_key = config[:api_key]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    @logger = Rails.logger</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  def search_images(query, target_resolution = &#39;1080p&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    raise NotImplementedError, &quot;Subclasses must implement search_images&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  def get_image_dimensions(target_resolution)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    case target_resolution.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    when &#39;1080p&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      { width: 2560, height: 1440 }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    when &#39;4k&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      { width: 5120, height: 2880 }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      { width: 2560, height: 1440 } # default to 1080p</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">  def make_request(url, headers = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    response = HTTParty.get(url, headers: headers)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    if response.success?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      response.parsed_response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      raise &quot;HTTP Error: #{response.code} - #{response.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    @logger.error(&quot;Request failed: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b37cad1ebfd987f7632d2cc77acc514bd62b55ef">
  <div class="header">
    <h3>app/services/image_apis/image_service_bus.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>186</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>186</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require_relative &#39;unsplash_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">require_relative &#39;pexels_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">require_relative &#39;pixabay_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">require_relative &#39;lorem_picsum_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">require_relative &#39;openverse_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">require_relative &#39;wikimedia_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">require &#39;set&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">class ImageServiceBus</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  attr_reader :clients, :logger, :used_clients</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  def initialize(config = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    @logger = Rails.logger</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    @used_clients = Set.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    @config = config</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    # Initialize API clients</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    @clients = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      unsplash: UnsplashClient.new(config[:unsplash] || {}),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      pexels: PexelsClient.new(config[:pexels] || {}),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      pixabay: PixabayClient.new(config[:pixabay] || {}),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      lorem_picsum: LoremPicsumClient.new(config[:lorem_picsum] || {}),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      openverse: OpenverseClient.new(config[:openverse] || {}),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      wikimedia: WikimediaClient.new(config[:wikimedia] || {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    @logger.info(&quot;ImageServiceBus initialized with #{@clients.keys.length} clients&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">  def get_images(query, count = 3, target_resolution = &#39;1080p&#39;, category = &#39;general&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    Rails.logger.info &quot; ImageServiceBus: Getting #{count} images for query &#39;#{query}&#39; (category: #{category})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    results = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    # Determine client priority based on category</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    if category == &#39;famous_person&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      # For famous persons, prioritize Wikimedia first, then regular sources</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      primary_clients = [:wikimedia]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      fallback_clients = [:unsplash, :pexels, :pixabay, :openverse, :lorem_picsum]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      Rails.logger.info &quot; Famous person detected - prioritizing Wikimedia&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">      # For stock images and general content, use traditional priority</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      primary_clients = [:unsplash, :pexels, :pixabay]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      fallback_clients = [:openverse, :wikimedia, :lorem_picsum]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">    # For speed optimization: limit attempts and reduce delays</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    all_clients = primary_clients + fallback_clients</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    attempts = 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    max_attempts = [all_clients.length, 6].min # Limit max attempts for speed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    while results.empty? &amp;&amp; attempts &lt; max_attempts</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      client_name = all_clients[attempts % all_clients.length]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">      client = @clients[client_name]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      attempts += 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      next unless client</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      Rails.logger.info &quot; ImageServiceBus: Attempting #{client_name} (attempt #{attempts}/#{max_attempts})&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">        # Reduced delay for faster processing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">        sleep(0.1) if attempts &gt; 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">        result = client.search_images(query, target_resolution)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">        if result &amp;&amp; result[:images] &amp;&amp; !result[:images].empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">          # Filter out placeholder/low quality images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">          quality_images = result[:images].select { |img| is_quality_image?(img) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">          if quality_images.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">            filtered_result = result.merge(images: quality_images)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">            results &lt;&lt; filtered_result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">            Rails.logger.info &quot; ImageServiceBus: Got #{quality_images.length} quality images from #{client_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">            break # Success! Stop trying other clients</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">          else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">            Rails.logger.warn &quot;  ImageServiceBus: #{client_name} returned only placeholder images&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">        else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">          Rails.logger.warn &quot;  ImageServiceBus: No results from #{client_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">        Rails.logger.error &quot; ImageServiceBus: Error with #{client_name}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">        # Continue to next client</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">    # If still no results, try with relaxed quality requirements</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    if results.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      Rails.logger.info &quot; ImageServiceBus: Retrying with relaxed quality requirements&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">      results = get_images_relaxed(query, target_resolution)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">    Rails.logger.info &quot; ImageServiceBus: Returning #{results.length} results&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    results</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">  def get_single_image(query, target_resolution = &#39;1080p&#39;, category = &#39;general&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">    result = get_images(query, 1, target_resolution, category)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">    result.first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">  def client_status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">    status = {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    @clients.each do |name, client|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      status[name] = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">        available: client.respond_to?(:available?) ? client.available? : true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">        rate_limit_info: client.respond_to?(:rate_limit_info) ? client.rate_limit_info : nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">    status</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">  # Check if image meets quality requirements</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">  # @param image [Hash] Image data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">  # @return [Boolean] True if image is good quality</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">  def is_quality_image?(image)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">    return false unless image &amp;&amp; image[:url]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">    url = image[:url]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">    # Skip placeholder patterns and low-quality indicators</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">    low_quality_patterns = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      /placeholder/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">      /default/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      /notfound/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">      /404/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      /missing/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">      /unavailable/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">      /lorem/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">      /picsum\.photos.*\?blur/i, # Skip blurred Lorem Picsum images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">      /thumb/i,                   # Skip thumbnail versions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">      /small/i,                   # Skip small versions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">      /compressed/i,              # Skip heavily compressed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">      /preview/i,                 # Skip preview versions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      /low.*res/i,               # Skip low resolution indicators</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">      /grainy/i,                 # Skip explicitly grainy images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">      /pixelated/i,              # Skip pixelated images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">      /\?w=\d{1,3}[&amp;$]/,         # Skip URLs with small width parameters (&lt; 1000px)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">      /\?h=\d{1,3}[&amp;$]/,         # Skip URLs with small height parameters (&lt; 1000px)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">      /size=small/i,             # Skip small size parameters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">      /quality=low/i             # Skip low quality parameters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    return false if low_quality_patterns.any? { |pattern| url.match?(pattern) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">    # STRICT minimum dimensions for high-quality Ken Burns effects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">    if image[:width] &amp;&amp; image[:height]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">      # Require MUCH higher resolution - Ken Burns needs room to zoom and pan</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">      min_width = 2560   # Minimum 2560px width for smooth 1080p output</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">      min_height = 1440  # Minimum 1440px height for smooth 1080p output</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">      return false if image[:width] &lt; min_width || image[:height] &lt; min_height</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">      # Reject images with poor aspect ratios that might be low quality</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">      aspect_ratio = image[:width].to_f / image[:height].to_f</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">      return false if aspect_ratio &lt; 0.5 || aspect_ratio &gt; 3.0  # Reject extreme ratios</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">      # Prefer larger images - they usually have better quality</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">      total_pixels = image[:width] * image[:height]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      return false if total_pixels &lt; 3_686_400  # Minimum ~3.7MP (2560x1440)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">    # Additional URL-based quality checks</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">    # Prefer images from URLs that indicate high quality</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">    quality_indicators = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">      /\d{4,}x\d{4,}/,           # URLs containing large dimensions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">      /hd/i,                     # HD indicator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">      /high.*res/i,              # High resolution indicator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">      /full.*res/i,              # Full resolution indicator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">      /original/i,               # Original size indicator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">      /large/i,                  # Large size indicator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">      /4k/i,                     # 4K indicator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">      /uhd/i,                    # Ultra HD indicator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">      /raw/i,                    # Raw/uncompressed indicator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">      /uncompressed/i            # Uncompressed indicator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            

            <code class="ruby">    # Boost score for quality indicators but don&#39;t require them</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">    has_quality_indicator = quality_indicators.any? { |pattern| url.match?(pattern) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby">    # For Ken Burns, we need the highest possible quality</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby">    # If dimensions aren&#39;t available, be more strict about URL quality indicators</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">    if !image[:width] || !image[:height]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">      return has_quality_indicator  # Require quality indicators if no dimensions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">    true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="192">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">  # Get images with relaxed quality requirements</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby">  # @param query [String] Search query</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            

            <code class="ruby">  # @param target_resolution [String] Target resolution</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            

            <code class="ruby">  # @return [Array] Results with relaxed requirements</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">  def get_images_relaxed(query, target_resolution)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">    results = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby">    # Try each client once more with relaxed but still reasonable minimums</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">    @clients.each do |client_name, client|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">        result = client.search_images(query, target_resolution)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">        if result &amp;&amp; result[:images] &amp;&amp; !result[:images].empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby">          # Apply relaxed quality filter - still require decent resolution</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">          relaxed_quality_images = result[:images].select { |img| is_relaxed_quality_image?(img) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="208">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">          if relaxed_quality_images.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">            filtered_result = result.merge(images: relaxed_quality_images)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">            results &lt;&lt; filtered_result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">            Rails.logger.info &quot; ImageServiceBus: Accepted relaxed quality from #{client_name} (#{relaxed_quality_images.length} images)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">            break # Take first available result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">        Rails.logger.error &quot; ImageServiceBus: Relaxed attempt failed for #{client_name}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">    results</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="225">
            

            

            <code class="ruby">  # Check if image meets relaxed quality requirements</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">  def is_relaxed_quality_image?(image)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">    return false unless image &amp;&amp; image[:url]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">    url = image[:url]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby">    # Skip obvious low-quality patterns (more permissive than strict)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">    low_quality_patterns = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">      /placeholder/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">      /default/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">      /notfound/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">      /404/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">      /missing/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">      /unavailable/i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">      /grainy/i,                 # Still reject explicitly grainy images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">      /pixelated/i,              # Still reject pixelated images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">      /\?w=\d{1,2}[&amp;$]/,         # Reject very small width parameters (&lt; 100px)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">      /\?h=\d{1,2}[&amp;$]/,         # Reject very small height parameters (&lt; 100px)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="243">
            

            

            <code class="ruby">      /quality=low/i             # Still reject explicitly low quality</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">    ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="245">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">    return false if low_quality_patterns.any? { |pattern| url.match?(pattern) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="247">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            

            <code class="ruby">    # Relaxed but still decent minimum dimensions for Ken Burns</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">    if image[:width] &amp;&amp; image[:height]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">      min_width = 1920   # Still require Full HD minimum for relaxed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">      min_height = 1080  # Still require Full HD minimum for relaxed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="252">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">      return false if image[:width] &lt; min_width || image[:height] &lt; min_height</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="254">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            

            <code class="ruby">      # Still reject extreme aspect ratios</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="256">
            

            

            <code class="ruby">      aspect_ratio = image[:width].to_f / image[:height].to_f</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">      return false if aspect_ratio &lt; 0.3 || aspect_ratio &gt; 4.0  # More permissive but still reasonable</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="259">
            

            

            <code class="ruby">      # Minimum pixel count for relaxed quality</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">      total_pixels = image[:width] * image[:height]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">      return false if total_pixels &lt; 2_073_600  # Minimum ~2MP (1920x1080)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="263">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">    true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="98638beb2d8023e188703138b45e1afc72d52ea3">
  <div class="header">
    <h3>app/services/image_apis/lorem_picsum_client.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>32</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>32</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require_relative &#39;base_image_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">class LoremPicsumClient &lt; BaseImageClient</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def initialize(config = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    super(config)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @base_url = &#39;https://picsum.photos&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def search_images(query, target_resolution = &#39;1080p&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    dimensions = get_image_dimensions(target_resolution)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    images = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    5.times do |i|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      random_id = rand(1..1000)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      images &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">        url: &quot;#{@base_url}/#{dimensions[:width]}/#{dimensions[:height]}?random=#{random_id}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">        download_url: &quot;#{@base_url}/#{dimensions[:width]}/#{dimensions[:height]}?random=#{random_id}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">        width: dimensions[:width],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">        height: dimensions[:height],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">        description: &quot;Random placeholder image #{i + 1}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">        photographer: &quot;Lorem Picsum&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">        photographer_url: &quot;https://picsum.photos&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">        metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">          id: random_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">          seed: random_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      provider: &#39;lorem_picsum&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      query: query,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      images: images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="47e70a90b34a8cb4f111c1d6740f069605fc5a3d">
  <div class="header">
    <h3>app/services/image_apis/openverse_client.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>37</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require_relative &#39;base_image_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">class OpenverseClient &lt; BaseImageClient</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def initialize(config = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    super(config)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @base_url = &#39;https://api.openverse.engineering/v1&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def search_images(query, target_resolution = &#39;1080p&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    dimensions = get_image_dimensions(target_resolution)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    url = &quot;#{@base_url}/images/?q=#{URI.encode_www_form_component(query)}&amp;page_size=10&amp;filter=license_type:commercial&amp;filter=license_type:modification&amp;filter=aspect_ratio:wide&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    headers = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      &#39;Accept&#39; =&gt; &#39;application/json&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    data = make_request(url, headers)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    return nil unless data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      provider: &#39;openverse&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      query: query,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      images: data[&#39;results&#39;].map do |image|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">          url: image[&#39;url&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">          download_url: image[&#39;url&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">          width: image[&#39;width&#39;] || dimensions[:width],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">          height: image[&#39;height&#39;] || dimensions[:height],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">          description: image[&#39;title&#39;] || image[&#39;alt_text&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">          photographer: image[&#39;creator&#39;] || &#39;Unknown&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">          photographer_url: image[&#39;creator_url&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">          metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">            id: image[&#39;id&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">            license: image[&#39;license&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">            license_version: image[&#39;license_version&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">            tags: image[&#39;tags&#39;]&amp;.map { |tag| tag[&#39;name&#39;] } || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a5bef94f5c17b4a8f5fe6a6510bedf5a12a680fa">
  <div class="header">
    <h3>app/services/image_apis/pexels_client.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>42</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>42</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require_relative &#39;base_image_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">class PexelsClient &lt; BaseImageClient</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def initialize(config = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    super(config)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @base_url = &#39;https://api.pexels.com/v1&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def search_images(query, target_resolution = &#39;1080p&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    return nil unless @api_key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    # Request larger images and higher quality for Ken Burns effects</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    # Add minimum size filter to get better quality images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    enhanced_query = &quot;#{query} high quality&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    url = &quot;#{@base_url}/search?query=#{URI.encode_www_form_component(enhanced_query)}&amp;per_page=15&amp;orientation=landscape&amp;size=large&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    headers = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      &#39;Authorization&#39; =&gt; @api_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    data = make_request(url, headers)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    return nil unless data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      provider: &#39;pexels&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      query: query,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      images: data[&#39;photos&#39;].map do |photo|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">        # Use the highest quality version available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">        image_url = photo[&#39;src&#39;][&#39;original&#39;] || photo[&#39;src&#39;][&#39;large2x&#39;] || photo[&#39;src&#39;][&#39;large&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">          url: image_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">          download_url: photo[&#39;src&#39;][&#39;original&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">          width: photo[&#39;width&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">          height: photo[&#39;height&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">          description: photo[&#39;alt&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">          photographer: photo[&#39;photographer&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">          photographer_url: photo[&#39;photographer_url&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">          metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">            id: photo[&#39;id&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">            avg_color: photo[&#39;avg_color&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">            liked: photo[&#39;liked&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">            original_size: photo[&#39;src&#39;][&#39;original&#39;] ? true : false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      end.select { |img| </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        # Additional filtering for high-quality images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">        img[:width] &amp;&amp; img[:height] &amp;&amp; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        img[:width] &gt;= 2000 &amp;&amp; img[:height] &gt;= 1000  # Pre-filter for higher resolution</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2a430e8ab6e04f5ac1f649d79327d1cdda571446">
  <div class="header">
    <h3>app/services/image_apis/pixabay_client.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>62</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>62</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require_relative &#39;base_image_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">class PixabayClient &lt; BaseImageClient</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def initialize(config = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    super(config)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @base_url = &#39;https://pixabay.com/api&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def search_images(query, target_resolution = &#39;1080p&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    return nil unless @api_key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    # Enhanced query for high quality and request larger images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    enhanced_query = &quot;#{query} high quality professional&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    # Request high resolution images with quality filters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    url = &quot;#{@base_url}/?key=#{@api_key}&amp;q=#{URI.encode_www_form_component(enhanced_query)}&amp;image_type=photo&amp;orientation=horizontal&amp;per_page=20&amp;min_width=2000&amp;min_height=1000&amp;order=popular&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    data = make_request(url)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    return nil unless data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      provider: &#39;pixabay&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      query: query,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      images: data[&#39;hits&#39;].map do |photo|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">        # Use the highest quality version available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">        image_url = photo[&#39;fullHDURL&#39;] || photo[&#39;largeImageURL&#39;] || photo[&#39;webformatURL&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">          url: image_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">          download_url: photo[&#39;largeImageURL&#39;] || image_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">          width: photo[&#39;imageWidth&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">          height: photo[&#39;imageHeight&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">          description: photo[&#39;tags&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">          photographer: photo[&#39;user&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">          photographer_url: &quot;https://pixabay.com/users/#{photo[&#39;user&#39;]}-#{photo[&#39;user_id&#39;]}/&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">          metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">            id: photo[&#39;id&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">            likes: photo[&#39;likes&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">            downloads: photo[&#39;downloads&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">            comments: photo[&#39;comments&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">            tags: photo[&#39;tags&#39;].split(&#39;, &#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">            quality_score: calculate_quality_score(photo)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      end.select { |img| </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        # Additional quality filtering</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">        img[:width] &amp;&amp; img[:height] &amp;&amp; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        img[:width] &gt;= 2400 &amp;&amp; img[:height] &gt;= 1200 &amp;&amp;  # Higher resolution requirement</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">        img[:metadata][:likes] &gt;= 10 &amp;&amp;  # Require some popularity</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">        img[:metadata][:downloads] &gt;= 50  # Require some usage validation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      }.sort_by { |img| </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">        # Sort by quality score</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">        -img[:metadata][:quality_score]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">  def calculate_quality_score(photo)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">    # Calculate quality score based on Pixabay metrics</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    score = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">    # Dimension score</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    if photo[&#39;imageWidth&#39;] &amp;&amp; photo[&#39;imageHeight&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      pixel_count = photo[&#39;imageWidth&#39;] * photo[&#39;imageHeight&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      score += (pixel_count / 1_000_000.0) * 8  # 8 points per megapixel</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">    # Social metrics</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    score += (photo[&#39;likes&#39;] || 0) * 0.2</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    score += (photo[&#39;downloads&#39;] || 0) * 0.01</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    score += (photo[&#39;comments&#39;] || 0) * 0.5</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    # Quality indicators in tags</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    quality_tags = [&#39;hd&#39;, &#39;high resolution&#39;, &#39;4k&#39;, &#39;professional&#39;, &#39;studio&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    tag_string = (photo[&#39;tags&#39;] || &#39;&#39;).downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">    quality_tags.each do |tag|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">      score += 10 if tag_string.include?(tag)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    score</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="777f3b0e8dc11a0f5c3864f57300766e6530a78a">
  <div class="header">
    <h3>app/services/image_apis/unsplash_client.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>61</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>61</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require_relative &#39;base_image_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">class UnsplashClient &lt; BaseImageClient</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def initialize(config = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    super(config)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @base_url = &#39;https://api.unsplash.com&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @secret_key = config[:secret_key] || ENV[&#39;UNSPLASH_SECRET_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  def search_images(query, target_resolution = &#39;1080p&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    return nil unless @api_key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">    # Enhanced query for better quality results</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    enhanced_query = &quot;#{query} high resolution professional&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">    # Request more results to filter for quality</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    url = &quot;#{@base_url}/search/photos?query=#{URI.encode_www_form_component(enhanced_query)}&amp;per_page=15&amp;orientation=landscape&amp;order_by=relevant&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    headers = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      &#39;Authorization&#39; =&gt; &quot;Client-ID #{@api_key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      &#39;Accept-Version&#39; =&gt; &#39;v1&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    data = make_request(url, headers)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    return nil unless data</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      provider: &#39;unsplash&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      query: query,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      images: data[&#39;results&#39;].map do |photo|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">        # Use the highest quality version available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        image_url = photo[&#39;urls&#39;][&#39;full&#39;] || photo[&#39;urls&#39;][&#39;raw&#39;] || photo[&#39;urls&#39;][&#39;regular&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">          url: image_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">          download_url: photo[&#39;links&#39;][&#39;download&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">          width: photo[&#39;width&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">          height: photo[&#39;height&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">          description: photo[&#39;description&#39;] || photo[&#39;alt_description&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">          photographer: photo[&#39;user&#39;][&#39;name&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">          photographer_url: photo[&#39;user&#39;][&#39;links&#39;][&#39;html&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">          metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">            id: photo[&#39;id&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">            created_at: photo[&#39;created_at&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">            likes: photo[&#39;likes&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">            color: photo[&#39;color&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">            quality_score: calculate_quality_score(photo)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      end.select { |img| </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        # Pre-filter for high-quality images based on dimensions and metadata</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">        img[:width] &amp;&amp; img[:height] &amp;&amp; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">        img[:width] &gt;= 2400 &amp;&amp; img[:height] &gt;= 1600 &amp;&amp;  # Higher minimum for Unsplash</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">        img[:metadata][:likes] &gt;= 5  # Prefer images with some social validation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      }.sort_by { |img| </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">        # Sort by quality score (likes, dimensions, etc.)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        -img[:metadata][:quality_score]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">  def calculate_quality_score(photo)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">    # Calculate a quality score based on various factors</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    score = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    # Dimension score (higher resolution = better)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    if photo[&#39;width&#39;] &amp;&amp; photo[&#39;height&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      pixel_count = photo[&#39;width&#39;] * photo[&#39;height&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      score += (pixel_count / 1_000_000.0) * 10  # 10 points per megapixel</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">    # Social validation score (likes)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">    score += (photo[&#39;likes&#39;] || 0) * 0.1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">    # Premium/Plus status bonus</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    score += 20 if photo[&#39;user&#39;][&#39;for_hire&#39;] == true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    # Description quality bonus (longer descriptions often indicate curated content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    description_length = (photo[&#39;description&#39;] || photo[&#39;alt_description&#39;] || &#39;&#39;).length</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">    score += [description_length / 10.0, 10].min</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    score</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2cf847907eba6cf8250176fe73a059a51b67dd6a">
  <div class="header">
    <h3>app/services/image_apis/wikimedia_client.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>155</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>155</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require_relative &#39;base_image_client&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">class WikimediaClient &lt; BaseImageClient</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def initialize(config = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    super(config)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    @base_url = &#39;https://commons.wikimedia.org/w/api.php&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  def search_images(query, target_resolution = &#39;1080p&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    dimensions = get_image_dimensions(target_resolution)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    # WikiMedia Commons API parameters</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    params = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">      action: &#39;query&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">      format: &#39;json&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      list: &#39;search&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      srsearch: query,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">      srnamespace: 6, # File namespace</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      srlimit: 10,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      srqiprofile: &#39;classic&#39;, # Better quality results</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      srqisize: &#39;large&#39; # Prefer larger images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    url = build_url(@base_url, params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    headers = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      &#39;Accept&#39; =&gt; &#39;application/json&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      &#39;User-Agent&#39; =&gt; &#39;VibeWriter-Rails/1.0&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    data = make_request(url, headers)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    return nil unless data &amp;&amp; data[&#39;query&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    # Get detailed info for each image</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    image_titles = data[&#39;query&#39;][&#39;search&#39;].map { |item| item[&#39;title&#39;] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    detailed_images = get_image_details(image_titles)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      provider: &#39;wikimedia&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      query: query,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      images: detailed_images.compact.map do |image|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">          url: image[:url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">          download_url: image[:url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">          width: image[:width] || dimensions[:width],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">          height: image[:height] || dimensions[:height],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">          description: image[:description] || query,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">          photographer: image[:author] || &#39;Wikimedia Commons&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">          photographer_url: image[:author_url],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">          metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">            id: image[:pageid],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">            license: image[:license],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">            categories: image[:categories],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">            usage_restrictions: image[:usage_restrictions],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">            file_size: image[:file_size]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">  def build_url(base_url, params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    query_string = params.map { |k, v| &quot;#{k}=#{URI.encode_www_form_component(v.to_s)}&quot; }.join(&#39;&amp;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    &quot;#{base_url}?#{query_string}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">  def get_image_details(titles)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    return [] if titles.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">    # Get detailed information for each image</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    params = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">      action: &#39;query&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">      format: &#39;json&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">      titles: titles.join(&#39;|&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      prop: &#39;imageinfo|categories&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      iiprop: &#39;url|size|mime|extmetadata&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">      cllimit: 10,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">      clshow: &#39;!hidden&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    url = build_url(@base_url, params)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    headers = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      &#39;Accept&#39; =&gt; &#39;application/json&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      &#39;User-Agent&#39; =&gt; &#39;VibeWriter-Rails/1.0&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    data = make_request(url, headers)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    return [] unless data &amp;&amp; data[&#39;query&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    pages = data[&#39;query&#39;][&#39;pages&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    images = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">    pages.each do |pageid, page|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">      next unless page[&#39;imageinfo&#39;] &amp;&amp; page[&#39;imageinfo&#39;].any?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">      imageinfo = page[&#39;imageinfo&#39;].first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      extmetadata = imageinfo[&#39;extmetadata&#39;] || {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">      # Extract license and author information</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">      license = extract_license(extmetadata)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      author = extract_author(extmetadata)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">      author_url = extract_author_url(extmetadata)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">      # Skip video files - we only want static images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      file_url = imageinfo[&#39;url&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">      if file_url&amp;.match(/\.(webm|mp4|avi|mov|wmv|flv|mkv|ogv)$/i)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">        Rails.logger.info &quot;Skipping video file: #{File.basename(file_url)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">        next</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">      # Skip very large files (&gt;50MB) - likely videos or high-res archives</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">      file_size = imageinfo[&#39;size&#39;].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      if file_size &gt; 50_000_000  # 50MB limit</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">        Rails.logger.info &quot;Skipping large file (#{(file_size/1024/1024).round}MB): #{File.basename(file_url)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">        next</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">      # Check if image meets size requirements</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      width = imageinfo[&#39;width&#39;].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">      height = imageinfo[&#39;height&#39;].to_i</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">      # Only include images that meet minimum size requirements</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">      if width &gt;= 1920 &amp;&amp; height &gt;= 1080</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">        images &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">          url: imageinfo[&#39;url&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">          width: width,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">          height: height,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">          description: extract_description(extmetadata),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">          author: author,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">          author_url: author_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">          license: license,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">          pageid: pageid,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">          file_size: imageinfo[&#39;size&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">          categories: page[&#39;categories&#39;]&amp;.map { |cat| cat[&#39;title&#39;] } || [],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">          usage_restrictions: extract_usage_restrictions(extmetadata)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    images</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">  def extract_license(extmetadata)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    license_field = extmetadata[&#39;License&#39;] || extmetadata[&#39;license&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">    if license_field &amp;&amp; license_field[&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">      license_field[&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">      &#39;Unknown&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">  def extract_author(extmetadata)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">    author_field = extmetadata[&#39;Author&#39;] || extmetadata[&#39;author&#39;] || extmetadata[&#39;Artist&#39;] || extmetadata[&#39;artist&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    if author_field &amp;&amp; author_field[&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">      author_field[&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">      &#39;Wikimedia Commons&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">  def extract_author_url(extmetadata)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">    author_url_field = extmetadata[&#39;AuthorURL&#39;] || extmetadata[&#39;authorurl&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">    if author_url_field &amp;&amp; author_url_field[&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">      author_url_field[&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">      nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">  def extract_description(extmetadata)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">    desc_field = extmetadata[&#39;ImageDescription&#39;] || extmetadata[&#39;imagedescription&#39;] || extmetadata[&#39;Description&#39;] || extmetadata[&#39;description&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">    if desc_field &amp;&amp; desc_field[&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">      desc_field[&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">      nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">  def extract_usage_restrictions(extmetadata)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">    restrictions = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">    # Check for various restriction indicators</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">    restriction_fields = [&#39;Restrictions&#39;, &#39;restrictions&#39;, &#39;UsageRestrictions&#39;, &#39;usagerestrictions&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">    restriction_fields.each do |field|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">      if extmetadata[field] &amp;&amp; extmetadata[field][&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">        restrictions &lt;&lt; extmetadata[field][&#39;value&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">    restrictions.empty? ? nil : restrictions.join(&#39;, &#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="40b254911a3e28d5457e88a551f95d7c22cfcdab">
  <div class="header">
    <h3>app/services/interview_flow_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>123</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>123</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class InterviewFlowService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def initialize(project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    @project = project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Initialized with project id: #{@project.id}, title: #{@project.title}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Project is_speech_interview: #{@project.is_speech_interview}, status: #{@project.status}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  def generate_question_queue</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Starting generate_question_queue for project #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    answered_question_ids = get_answered_question_ids</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Answered question IDs: #{answered_question_ids.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: Array of integers, ACTUAL: #{answered_question_ids.class.name} with #{answered_question_ids.size} items&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    # Get all non-omitted, non-skipped questions for the project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Fetching all non-omitted questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    all_questions = @project.questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">                             .joins(section: :chapter)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">                             .includes(section: { chapter: :project }, polly_audio_clip: [])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">                             .where(omitted: false, skipped: false, sections: { omitted: false }, chapters: { omitted: false })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">                             .order(&quot;chapters.order ASC, sections.order ASC, questions.order ASC&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] All questions count: #{all_questions.size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: ActiveRecord::Relation with questions, ACTUAL: #{all_questions.class.name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] First 3 questions: #{all_questions.first(3).map { |q| { id: q.id, text: q.text[0..50], is_follow_up: q.is_follow_up } }}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    # Filter out the questions that have already been answered</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Filtering out answered questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    unanswered_questions = all_questions.reject { |q| answered_question_ids.include?(q.id) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Unanswered questions count: #{unanswered_questions.size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: Fewer questions than all_questions, ACTUAL: #{all_questions.size} - #{answered_question_ids.size} = #{unanswered_questions.size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    # Sort to place follow-ups immediately after their answered parents.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    # And prioritize any unanswered follow-ups whose parents ARE answered.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    # Separate into three groups:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    # 1. Urgent follow-ups (parent answered, follow-up is not)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    # 2. Standard main questions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">    # 3. Follow-ups whose parents haven&#39;t been answered yet</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    urgent_follow_ups = unanswered_questions.select do |q|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      is_urgent = q.is_follow_up? &amp;&amp; q.parent_question_id.in?(answered_question_ids)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      if is_urgent</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Found urgent follow-up: question_id=#{q.id}, parent_id=#{q.parent_question_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      is_urgent</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Urgent follow-ups found: #{urgent_follow_ups.size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: Follow-ups with answered parents, ACTUAL: #{urgent_follow_ups.map { |q| { id: q.id, parent: q.parent_question_id } }}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    standard_queue = unanswered_questions.reject do |q|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      q.is_follow_up?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Standard questions (non-follow-ups): #{standard_queue.size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: Main questions only, ACTUAL: #{standard_queue.first(3).map { |q| { id: q.id, is_follow_up: q.is_follow_up } }}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    # The final queue is urgent follow-ups first, then the rest of the standard questions.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">    # This ensures that as soon as a question is answered, its follow-ups jump to the front of the line.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    final_queue = (urgent_follow_ups + standard_queue).uniq(&amp;:id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Final queue composition:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG]   - Total questions: #{final_queue.length}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG]   - Urgent follow-ups: #{urgent_follow_ups.count}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG]   - Standard questions: #{standard_queue.count}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: urgent_follow_ups + standard_queue, ACTUAL: #{final_queue.length} total&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] First 5 in queue: #{final_queue.first(5).map { |q| { id: q.id, is_follow_up: q.is_follow_up, parent: q.parent_question_id } }}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    return final_queue</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">  # Insert new follow-up questions into an existing queue at the optimal position</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">  def insert_followup_questions(current_queue, parent_question_id, new_followups)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] insert_followup_questions called&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG]   - Current queue size: #{current_queue.size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG]   - Parent question ID: #{parent_question_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG]   - New follow-ups count: #{new_followups.size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">    return current_queue if new_followups.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">    # Find the parent question index in the current queue</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">    parent_index = current_queue.find_index { |q| q.id == parent_question_id }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Parent question index: #{parent_index}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: Integer index &gt;= 0, ACTUAL: #{parent_index.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    unless parent_index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">      Rails.logger.warn &quot;[INTERVIEW_FLOW_DEBUG] Parent question #{parent_question_id} not found in queue!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">      return current_queue</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">    # Find the insertion point (after parent and existing follow-ups)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    insertion_index = find_insertion_point(current_queue, parent_index, parent_question_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Insertion index: #{insertion_index}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: Index after parent and existing follow-ups, ACTUAL: #{insertion_index}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">    # Insert new follow-ups at the calculated position</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Inserting #{new_followups.size} follow-ups at position #{insertion_index}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    current_queue.insert(insertion_index, *new_followups)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Queue size after insertion: #{current_queue.size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: Original size + new follow-ups, ACTUAL: #{current_queue.size}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">    current_queue</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">  # Get the next priority question that should be asked</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">  def get_next_priority_question(current_queue, current_index)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] get_next_priority_question called&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG]   - Queue size: #{current_queue.length}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG]   - Current index: #{current_index}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: Valid index &lt; queue.length - 1, ACTUAL: #{current_index} &lt; #{current_queue.length - 1}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">    # Check if there are any new high-priority follow-ups that should be inserted</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">    # before continuing with the regular flow</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">    # For now, just return the next question in sequence</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">    if current_index &gt;= current_queue.length - 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] No more questions available (at end of queue)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      return nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">    next_question = current_queue[current_index + 1]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Next question: id=#{next_question.id}, is_follow_up=#{next_question.is_follow_up}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">    next_question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">  def get_base_questions_ordered</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    @project.questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">            .joins(:section)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">            .where(is_follow_up: false)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">            .where(sections: { omitted: false }, omitted: false)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">            .includes(:section, follow_up_questions: [])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">            .order(&#39;sections.order ASC, questions.order ASC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">  def get_all_existing_followups</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">    @project.questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">            .joins(:section)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">            .where(is_follow_up: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">            .where(sections: { omitted: false }, omitted: false)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">            .includes(:section)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">            .order(&#39;questions.parent_question_id ASC, questions.order ASC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">  def get_followup_questions_for(parent_question)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">    # Follow-up questions are now preloaded, so filter in memory</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">    parent_question.follow_up_questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">                   .select { |q| !q.omitted }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">                   .sort_by(&amp;:order)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">  def find_insertion_point(queue, parent_index, parent_question_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">    # Start looking after the parent question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    index = parent_index + 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">    # Skip over existing follow-ups for the same parent</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">    while index &lt; queue.length &amp;&amp; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">          queue[index].is_follow_up &amp;&amp; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">          queue[index].parent_question_id == parent_question_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">      index += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">    index</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">  def get_answered_question_ids</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Getting answered question IDs for project #{@project.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="169">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">    # Get all question IDs that have associated audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">    segments = @project.audio_segments.where.not(question_id: nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Found #{segments.count} audio segments with question_ids&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="173">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">    question_ids = segments.distinct.pluck(:question_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] Distinct question IDs: #{question_ids.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    Rails.logger.info &quot;[INTERVIEW_FLOW_DEBUG] EXPECTED: Array of non-nil integers, ACTUAL: #{question_ids.select(&amp;:nil?).any? ? &#39;Contains nil!&#39; : &#39;All valid&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">    question_ids</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8567ce1cc767c0a0d3242b757144b6a1006f2697">
  <div class="header">
    <h3>app/services/interview_question_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>410</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>410</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require &#39;net/http&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">require &#39;json&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">class InterviewQuestionService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  GEMINI_API_BASE = &#39;https://generativelanguage.googleapis.com/v1beta&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  def initialize(api_key = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    @api_key = api_key || ENV[&#39;GEMINI_API_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    @model = &#39;gemini-2.5-flash-lite&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    @max_tokens = 2048</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    @temperature = 0.7</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    raise &quot;GEMINI_API_KEY environment variable not set&quot; unless @api_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">  # Generate interview questions for a given topic</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  # @param topic [String] The topic for interview questions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">  # @param options [Hash] Generation options</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  # @return [Hash] Structured interview outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">  def generate_interview_outline(topic, options = {})</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    # Use options if provided, otherwise use defaults</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    num_chapters = options[:num_chapters] || 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    sections_per_chapter = options[:sections_per_chapter] || 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    questions_per_section = options[:questions_per_section] || 10</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">    prompt = build_interview_outline_prompt(topic, num_chapters, sections_per_chapter, questions_per_section)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    response = make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    parse_interview_outline_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  # Generate additional questions for a specific section</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  # @param section_context [Hash] Context about the section</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  # @param num_questions [Integer] Number of questions to generate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  # @return [Array] Additional questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  def generate_section_questions(section_context, num_questions = 3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    prompt = build_section_questions_prompt(section_context, num_questions)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    response = make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    parse_section_questions_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">  # Refine existing questions based on feedback</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  # @param questions [Array] Existing questions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  # @param feedback [String] Feedback for improvement</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  # @return [Array] Refined questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">  def refine_questions(questions, feedback)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    prompt = build_question_refinement_prompt(questions, feedback)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    response = make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    parse_refined_questions_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">  # Generate follow-up questions based on user&#39;s answer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">  # @param original_question_text [String] The original question</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">  # @param user_answer [String] The user&#39;s answer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">  # @return [Array] Follow-up questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">  def generate_followup_questions(original_question_text:, user_answer:)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    prompt = build_followup_prompt(original_question_text, user_answer)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    response = make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    parse_followup_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">  # Generate additional chapters for an existing project</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby">  # @param project [Project] The project to expand</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">  # @return [Hash] Additional chapters structure</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">  def generate_additional_chapters(project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    prompt = build_additional_chapters_prompt(project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    response = make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    parse_interview_outline_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">  # Generate interview questions based on tracker context</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">  # @param tracker_name [String] The name of the tracker</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">  # @param tracker_context [String] The context from tracker entries</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">  # @return [Hash] Structured interview outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">  def generate_interview_from_tracker(tracker_name, tracker_context)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">    prompt = build_tracker_interview_prompt(tracker_name, tracker_context)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    response = make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    parse_interview_outline_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">  # Generate additional questions for unlimited interview mode</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">  # @param context [Hash] Context including existing questions and answers</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">  # @param num_questions [Integer] Number of questions to generate</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">  # @return [Array] Additional question texts</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">  def generate_additional_questions_for_unlimited(context, num_questions = 20)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    prompt = build_unlimited_questions_prompt(context, num_questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    response = make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    parse_unlimited_questions_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">  def build_interview_outline_prompt(topic, num_chapters, sections_per_chapter, questions_per_section)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">      You are an expert interview designer creating a comprehensive interview outline.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">      TOPIC: #{topic}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">      TASK: Create a structured interview outline with:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      - #{num_chapters} chapters (main themes/areas)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">      - #{sections_per_chapter} sections per chapter (sub-topics)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">      - #{questions_per_section} questions per section (specific interview questions)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      REQUIREMENTS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">      - Questions should be open-ended and thought-provoking</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">      - Progress from general to specific within each section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">      - Ensure logical flow between chapters and sections</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      - Questions should encourage detailed, personal responses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      - Avoid yes/no questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">      - Include follow-up question suggestions where appropriate</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">      - Make questions conversational and engaging</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">      RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">        &quot;title&quot;: &quot;Interview about [topic]&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">        &quot;chapters&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">            &quot;title&quot;: &quot;Chapter title&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">            &quot;order&quot;: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">            &quot;sections&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">                &quot;title&quot;: &quot;Section title&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">                &quot;order&quot;: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">                &quot;questions&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">                  {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">                    &quot;text&quot;: &quot;Question text here?&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">                    &quot;order&quot;: 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">                  }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">                ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">            ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      Generate only the JSON response, no other text.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">  def build_section_questions_prompt(section_context, num_questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">    chapter_title = section_context[:chapter_title]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">    section_title = section_context[:section_title]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    existing_questions = section_context[:existing_questions] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">      You are an expert interview designer adding questions to an existing section.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      CONTEXT:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">      Chapter: #{chapter_title}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">      Section: #{section_title}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">      EXISTING QUESTIONS:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby">      #{existing_questions.map.with_index { |q, i| &quot;#{i + 1}. #{q}&quot; }.join(&quot;\n&quot;)}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">      TASK: Generate #{num_questions} additional interview questions for this section that:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">      - Complement the existing questions without being repetitive</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">      - Maintain the same theme and depth level</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">      - Are open-ended and encourage detailed responses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">      - Flow naturally with the existing questions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">        &quot;questions&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">            &quot;text&quot;: &quot;Question text here?&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">            &quot;order&quot;: #{existing_questions.length + 1}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">      Generate only the JSON response, no other text.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">  def build_question_refinement_prompt(questions, feedback)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">      You are an expert interview designer refining questions based on feedback.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">      CURRENT QUESTIONS:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="182">
            

            

            <code class="ruby">      #{questions.map.with_index { |q, i| &quot;#{i + 1}. #{q[:text] || q[&#39;text&#39;]}&quot; }.join(&quot;\n&quot;)}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">      FEEDBACK: #{feedback}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">      TASK: Refine the questions based on the feedback while maintaining:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">      - The overall intent and structure</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">      - Open-ended nature that encourages detailed responses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">      - Logical flow and progression</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">      - Conversational tone</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">      RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">        &quot;questions&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">            &quot;text&quot;: &quot;Refined question text here?&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">            &quot;order&quot;: 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">      Generate only the JSON response, no other text.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">  def build_followup_prompt(original_question, answer)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">    You are an expert interviewer. Based on the user&#39;s answer to an original question, generate 1 to 3 insightful, open-ended follow-up questions. The goal is to dig deeper into the user&#39;s response, clarify points, or explore related tangents.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">    ORIGINAL QUESTION:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">    &quot;#{original_question}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="212">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">    USER&#39;S ANSWER:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">    &quot;#{answer}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="215">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">    TASK:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">    Generate 1 to 3 follow-up questions.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">    RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">      &quot;questions&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">        { &quot;text&quot;: &quot;First follow-up question?&quot; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">        { &quot;text&quot;: &quot;Second follow-up question?&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="226">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">    Generate only the JSON response, no other text.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">  def build_additional_chapters_prompt(project)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">    existing_chapters = project.chapters.includes(sections: :questions).map do |chapter|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">        title: chapter.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">        sections: chapter.sections.map do |section|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">            title: section.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">            questions: section.questions.base_questions.map(&amp;:text)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            

            <code class="ruby">    # Get interview context from transcripts/audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">    interview_context = &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">    if project.audio_segments.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">      recent_transcripts = project.audio_segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">                                 .where.not(transcription_text: [nil, &quot;&quot;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">                                 .limit(10)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">                                 .pluck(:transcription_text)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">      interview_context = recent_transcripts.join(&quot;\n\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="253">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">      You are an expert interview designer creating additional chapters for an existing interview project.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">      ORIGINAL TOPIC: #{project.topic}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">      EXISTING CHAPTERS AND STRUCTURE:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="260">
            

            

            <code class="ruby">      #{existing_chapters.map.with_index do |chapter, i|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">        sections_text = chapter[:sections].map.with_index do |section, j|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">          questions_text = section[:questions].map.with_index { |q, k| &quot;        #{k + 1}. #{q}&quot; }.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">          &quot;    Section #{j + 1}: #{section[:title]}\n#{questions_text}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">        end.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">        &quot;Chapter #{i + 1}: #{chapter[:title]}\n#{sections_text}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">      end.join(&quot;\n\n&quot;)}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="267">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="268">
            

            

            <code class="ruby">      #{&quot;INTERVIEW CONTEXT (from recent recordings):\n#{interview_context}\n\n&quot; if interview_context.present?}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">      TASK: Generate 2-3 additional chapters that:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">      - Expand on the original topic without repeating existing content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">      - Complement the existing chapters by exploring new angles or deeper aspects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">      - Follow the same structure (2 sections per chapter, 3 questions per section)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">      - Take into account any themes or insights from the interview context</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="275">
            

            

            <code class="ruby">      - Are logically ordered as a continuation of the existing outline</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">      - Maintain the same depth and interview style as existing questions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="277">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="278">
            

            

            <code class="ruby">      REQUIREMENTS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">      - Questions should be open-ended and thought-provoking</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">      - Avoid any overlap with existing chapters/sections/questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">      - Build upon themes that may have emerged from the interview context</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="282">
            

            

            <code class="ruby">      - Ensure smooth progression from the existing content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="283">
            

            

            <code class="ruby">      - Use the next available order numbers for chapters</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="284">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="285">
            

            

            <code class="ruby">      RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="286">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="287">
            

            

            <code class="ruby">        &quot;chapters&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="288">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="289">
            

            

            <code class="ruby">            &quot;title&quot;: &quot;New chapter title&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="290">
            

            

            <code class="ruby">            &quot;order&quot;: #{existing_chapters.length + 1},</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">            &quot;sections&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">                &quot;title&quot;: &quot;Section title&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="294">
            

            

            <code class="ruby">                &quot;order&quot;: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="295">
            

            

            <code class="ruby">                &quot;questions&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="296">
            

            

            <code class="ruby">                  {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="297">
            

            

            <code class="ruby">                    &quot;text&quot;: &quot;Question text here?&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="298">
            

            

            <code class="ruby">                    &quot;order&quot;: 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">                  }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">                ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="301">
            

            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="302">
            

            

            <code class="ruby">            ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="303">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="304">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="305">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="306">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="307">
            

            

            <code class="ruby">      Generate only the JSON response, no other text.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="308">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="309">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="310">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="311">
            

            

            <code class="ruby">  def build_tracker_interview_prompt(tracker_name, tracker_context)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="313">
            

            

            <code class="ruby">      You are an expert interview designer creating a personalized interview based on tracker data.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="314">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="315">
            

            

            <code class="ruby">      TRACKER NAME: #{tracker_name}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="316">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="317">
            

            

            <code class="ruby">      TRACKER CONTEXT (recent entries):</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="318">
            

            

            <code class="ruby">      #{tracker_context}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="319">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="320">
            

            

            <code class="ruby">      TASK: Create a structured interview outline with:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="321">
            

            

            <code class="ruby">      - 3 chapters (main themes/areas) that explore the user&#39;s experience with this tracker</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="322">
            

            

            <code class="ruby">      - 2 sections per chapter (sub-topics)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="323">
            

            

            <code class="ruby">      - 3 questions per section (specific interview questions)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="324">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="325">
            

            

            <code class="ruby">      REQUIREMENTS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="326">
            

            

            <code class="ruby">      - Questions should be deeply personalized based on the tracker context provided</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="327">
            

            

            <code class="ruby">      - Explore patterns, insights, and reflections related to the tracking data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="328">
            

            

            <code class="ruby">      - Questions should be open-ended and encourage detailed, personal responses</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="329">
            

            

            <code class="ruby">      - Progress from general reflection to specific insights within each section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="330">
            

            

            <code class="ruby">      - Reference specific patterns or themes from the tracker entries when relevant</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="331">
            

            

            <code class="ruby">      - Avoid yes/no questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="332">
            

            

            <code class="ruby">      - Make questions conversational and engaging</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="333">
            

            

            <code class="ruby">      - Help the user reflect on their journey and growth in this area</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="335">
            

            

            <code class="ruby">      CHAPTER THEMES TO CONSIDER:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="336">
            

            

            <code class="ruby">      - Patterns and trends in the tracking data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="337">
            

            

            <code class="ruby">      - Personal insights and realizations</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="338">
            

            

            <code class="ruby">      - Challenges and breakthroughs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="339">
            

            

            <code class="ruby">      - Future goals and aspirations related to this area</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="340">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="341">
            

            

            <code class="ruby">      RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="342">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="343">
            

            

            <code class="ruby">        &quot;title&quot;: &quot;Reflection on Your #{tracker_name} Journey&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="344">
            

            

            <code class="ruby">        &quot;chapters&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="345">
            

            

            <code class="ruby">          {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="346">
            

            

            <code class="ruby">            &quot;title&quot;: &quot;Chapter title&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="347">
            

            

            <code class="ruby">            &quot;order&quot;: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="348">
            

            

            <code class="ruby">            &quot;sections&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="349">
            

            

            <code class="ruby">              {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="350">
            

            

            <code class="ruby">                &quot;title&quot;: &quot;Section title&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="351">
            

            

            <code class="ruby">                &quot;order&quot;: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="352">
            

            

            <code class="ruby">                &quot;questions&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">                  {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="354">
            

            

            <code class="ruby">                    &quot;text&quot;: &quot;Question text here?&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="355">
            

            

            <code class="ruby">                    &quot;order&quot;: 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="356">
            

            

            <code class="ruby">                  }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="357">
            

            

            <code class="ruby">                ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="358">
            

            

            <code class="ruby">              }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="359">
            

            

            <code class="ruby">            ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="360">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="364">
            

            

            <code class="ruby">      Generate only the JSON response, no other text.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="365">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="366">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="367">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="368">
            

            

            <code class="ruby">  def make_gemini_request(prompt)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="369">
            

            

            <code class="ruby">    uri = URI(&quot;#{GEMINI_API_BASE}/models/#{@model}:generateContent?key=#{@api_key}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="370">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="371">
            

            

            <code class="ruby">    request = Net::HTTP::Post.new(uri)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="372">
            

            

            <code class="ruby">    request[&#39;Content-Type&#39;] = &#39;application/json&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="373">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="374">
            

            

            <code class="ruby">    request.body = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="375">
            

            

            <code class="ruby">      contents: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="376">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="377">
            

            

            <code class="ruby">          parts: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="378">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="379">
            

            

            <code class="ruby">              text: prompt</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="380">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="381">
            

            

            <code class="ruby">          ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="382">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="383">
            

            

            <code class="ruby">      ],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="384">
            

            

            <code class="ruby">      generationConfig: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="385">
            

            

            <code class="ruby">        temperature: @temperature,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="386">
            

            

            <code class="ruby">        maxOutputTokens: @max_tokens,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="387">
            

            

            <code class="ruby">        topP: 0.8,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="388">
            

            

            <code class="ruby">        topK: 40</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="389">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="390">
            

            

            <code class="ruby">    }.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="391">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="392">
            

            

            <code class="ruby">    response = make_request(request, uri)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="393">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="394">
            

            

            <code class="ruby">    if response[&#39;error&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="395">
            

            

            <code class="ruby">      raise &quot;Gemini API Error: #{response[&#39;error&#39;][&#39;message&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="396">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="397">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="398">
            

            

            <code class="ruby">    response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="399">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="400">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="401">
            

            

            <code class="ruby">  def make_request(request, uri)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="402">
            

            

            <code class="ruby">    http = Net::HTTP.new(uri.host, uri.port)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="403">
            

            

            <code class="ruby">    http.use_ssl = true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="404">
            

            

            <code class="ruby">    http.read_timeout = 60</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="405">
            

            

            <code class="ruby">    http.open_timeout = 30</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="406">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="407">
            

            

            <code class="ruby">    response = http.request(request)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="408">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="409">
            

            

            <code class="ruby">    if response.code != &#39;200&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="410">
            

            

            <code class="ruby">      raise &quot;HTTP Error: #{response.code} - #{response.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="411">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="412">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="413">
            

            

            <code class="ruby">    JSON.parse(response.body)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="414">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="415">
            

            

            <code class="ruby">    raise &quot;Request failed: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="416">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="417">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="418">
            

            

            <code class="ruby">  def parse_interview_outline_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="419">
            

            

            <code class="ruby">    content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="420">
            

            

            <code class="ruby">    return { error: &#39;No content in response&#39; } unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="421">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="423">
            

            

            <code class="ruby">      cleaned_content = content.strip.gsub(/^```json\s*/, &#39;&#39;).gsub(/\s*```$/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="424">
            

            

            <code class="ruby">      JSON.parse(cleaned_content, symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="425">
            

            

            <code class="ruby">    rescue JSON::ParserError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="426">
            

            

            <code class="ruby">      { error: &quot;Failed to parse response: #{e.message}&quot;, raw_content: content }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="427">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="428">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="429">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="430">
            

            

            <code class="ruby">  def parse_section_questions_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="431">
            

            

            <code class="ruby">    content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="432">
            

            

            <code class="ruby">    return [] unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="433">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="434">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="435">
            

            

            <code class="ruby">      cleaned_content = content.strip.gsub(/^```json\s*/, &#39;&#39;).gsub(/\s*```$/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="436">
            

            

            <code class="ruby">      parsed = JSON.parse(cleaned_content, symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="437">
            

            

            <code class="ruby">      parsed[:questions] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="438">
            

            

            <code class="ruby">    rescue JSON::ParserError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="439">
            

            

            <code class="ruby">      []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="440">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="441">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="442">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="443">
            

            

            <code class="ruby">  def parse_refined_questions_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="444">
            

            

            <code class="ruby">    content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="445">
            

            

            <code class="ruby">    return [] unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="446">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="447">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="448">
            

            

            <code class="ruby">      cleaned_content = content.strip.gsub(/^```json\s*/, &#39;&#39;).gsub(/\s*```$/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="449">
            

            

            <code class="ruby">      parsed = JSON.parse(cleaned_content, symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="450">
            

            

            <code class="ruby">      parsed[:questions] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="451">
            

            

            <code class="ruby">    rescue JSON::ParserError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="452">
            

            

            <code class="ruby">      []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="453">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="454">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="455">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="456">
            

            

            <code class="ruby">  def parse_followup_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="457">
            

            

            <code class="ruby">    content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="458">
            

            

            <code class="ruby">    return [] unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="459">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="460">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="461">
            

            

            <code class="ruby">      cleaned_content = content.strip.gsub(/^```json\s*/, &#39;&#39;).gsub(/\s*```$/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="462">
            

            

            <code class="ruby">      parsed = JSON.parse(cleaned_content, symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="463">
            

            

            <code class="ruby">      parsed[:questions] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="464">
            

            

            <code class="ruby">    rescue JSON::ParserError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="465">
            

            

            <code class="ruby">      []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="466">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="467">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="468">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="469">
            

            

            <code class="ruby">  def build_unlimited_questions_prompt(context, num_questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="470">
            

            

            <code class="ruby">    existing_questions_text = context[:existing_questions].join(&quot;\n- &quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="471">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="472">
            

            

            <code class="ruby">    answered_context = if context[:answered_questions].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="473">
            

            

            <code class="ruby">      context[:answered_questions].map do |qa|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="474">
            

            

            <code class="ruby">        &quot;Q: #{qa[:question]}\nA: #{qa[:answer]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="475">
            

            

            <code class="ruby">      end.join(&quot;\n\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="476">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="477">
            

            

            <code class="ruby">      &quot;No questions answered yet&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="478">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="479">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="480">
            

            

            <code class="ruby">    &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="481">
            

            

            <code class="ruby">      You are an expert interviewer continuing an in-depth interview session.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="482">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="483">
            

            

            <code class="ruby">      INTERVIEW TOPIC: #{context[:topic]}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="484">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="485">
            

            

            <code class="ruby">      EXISTING QUESTIONS ALREADY ASKED:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="486">
            

            

            <code class="ruby">      - #{existing_questions_text}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="487">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="488">
            

            

            <code class="ruby">      CONTEXT FROM ANSWERED QUESTIONS:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="489">
            

            

            <code class="ruby">      #{answered_context}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="490">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="491">
            

            

            <code class="ruby">      TASK: Generate #{num_questions} NEW interview questions that:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="492">
            

            

            <code class="ruby">      - Continue exploring the topic in greater depth</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="493">
            

            

            <code class="ruby">      - Build on themes that emerged from the answers given</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="494">
            

            

            <code class="ruby">      - DO NOT repeat or rephrase any existing questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="495">
            

            

            <code class="ruby">      - Maintain the conversational and engaging tone</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="496">
            

            

            <code class="ruby">      - Progress naturally from what has been discussed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="497">
            

            

            <code class="ruby">      - Explore new angles and perspectives</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="498">
            

            

            <code class="ruby">      - Remain relevant to the original topic</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="499">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="500">
            

            

            <code class="ruby">      REQUIREMENTS:</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="501">
            

            

            <code class="ruby">      - All questions must be unique and not covered before</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="502">
            

            

            <code class="ruby">      - Questions should be open-ended and thought-provoking</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="503">
            

            

            <code class="ruby">      - Consider the flow and context of the conversation so far</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="504">
            

            

            <code class="ruby">      - Mix both follow-up themes and entirely new aspects</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="505">
            

            

            <code class="ruby">      - Maintain interview quality and depth</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="506">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="507">
            

            

            <code class="ruby">      RESPONSE FORMAT (JSON only):</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="508">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="509">
            

            

            <code class="ruby">        &quot;questions&quot;: [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="510">
            

            

            <code class="ruby">          &quot;First new question text here?&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="511">
            

            

            <code class="ruby">          &quot;Second new question text here?&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="512">
            

            

            <code class="ruby">          ...</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="513">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="514">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="515">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="516">
            

            

            <code class="ruby">      Generate only the JSON response with exactly #{num_questions} new questions.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="517">
            

            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="518">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="519">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="520">
            

            

            <code class="ruby">  def parse_unlimited_questions_response(response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="521">
            

            

            <code class="ruby">    content = response.dig(&#39;candidates&#39;, 0, &#39;content&#39;, &#39;parts&#39;, 0, &#39;text&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="522">
            

            

            <code class="ruby">    return [] unless content</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="523">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="524">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="525">
            

            

            <code class="ruby">      cleaned_content = content.strip.gsub(/^```json\s*/, &#39;&#39;).gsub(/\s*```$/, &#39;&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="526">
            

            

            <code class="ruby">      parsed = JSON.parse(cleaned_content, symbolize_names: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="527">
            

            

            <code class="ruby">      parsed[:questions] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="528">
            

            

            <code class="ruby">    rescue JSON::ParserError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="529">
            

            

            <code class="ruby">      Rails.logger.error &quot;Failed to parse unlimited questions response: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="530">
            

            

            <code class="ruby">      []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="531">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="532">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="533">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6aaf8bb6e19fb8ec450f6da2e5e60435f8bd476e">
  <div class="header">
    <h3>app/services/jwt_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>38</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>38</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class JwtService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Access token expires in 1 hour</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  ACCESS_TOKEN_EXPIRATION = 1.hour</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">  # Refresh token expires in 30 days</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  REFRESH_TOKEN_EXPIRATION = 30.days</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  class &lt;&lt; self</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    def encode_access_token(user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">      payload = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">        user_id: user_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">        type: &#39;access&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      JWT.encode(payload, secret_key, &#39;HS256&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    def encode_refresh_token(user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">      payload = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">        user_id: user_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">        type: &#39;refresh&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      JWT.encode(payload, secret_key, &#39;HS256&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    def decode_token(token)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      decoded = JWT.decode(token, secret_key, true, { algorithm: &#39;HS256&#39; })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      decoded[0]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    rescue JWT::ExpiredSignature</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      raise StandardError, &#39;Token has expired&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">    rescue JWT::DecodeError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      raise StandardError, &#39;Invalid token&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    def generate_token_pair(user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">        access_token: encode_access_token(user_id),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">        refresh_token: encode_refresh_token(user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    def secret_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      Rails.application.credentials.secret_key_base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ef02a77a6146c164c330122481c2e1ae738baf18">
  <div class="header">
    <h3>app/services/performance_tracker.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>221</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>221</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require &#39;csv&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">class PerformanceTracker</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  include Singleton</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  attr_reader :timings</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  TRACKING_FILE = Rails.root.join(&#39;log&#39;, &#39;performance_metrics.csv&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  SUMMARY_FILE = Rails.root.join(&#39;log&#39;, &#39;performance_summary.md&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    @timings = {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    @session_id = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    @mutex = Mutex.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    ensure_csv_exists</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">  def start_session(session_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    @mutex.synchronize do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      @session_id = session_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      @timings[session_id] = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">        start_time: Time.current,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">        events: [],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        total_duration: 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      Rails.logger.info &quot; Performance tracking started for session: #{session_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">  def track_event(event_name, metadata = {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    start_time = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    result = nil</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    if block_given?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      result = yield</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      end_time = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      end_time = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    # Only track performance data if we have an active session</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    if @session_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      duration_ms = ((end_time - start_time) * 1000).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      @mutex.synchronize do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">        event_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">          name: event_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">          start_time: start_time,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">          end_time: end_time,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">          duration_ms: duration_ms,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">          metadata: metadata</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">        @timings[@session_id][:events] &lt;&lt; event_data if @timings[@session_id]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">        # Log to Rails logger</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">        Rails.logger.info &quot; [#{@session_id}] #{event_name}: #{duration_ms}ms #{metadata.to_json}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby">        # Append to CSV</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">        append_to_csv(event_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">  def end_session</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    return unless @session_id</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    @mutex.synchronize do</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">      if session_data = @timings[@session_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">        end_time = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        session_data[:end_time] = end_time</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">        session_data[:total_duration] = ((end_time - session_data[:start_time]) * 1000).round(2)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">        # Generate summary</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">        generate_summary(session_data)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">        # Log final summary</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">        Rails.logger.info &quot; Session #{@session_id} completed in #{session_data[:total_duration]}ms&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      @session_id = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">  def get_session_summary(session_id = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    session_id ||= @session_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    return nil unless session_id &amp;&amp; @timings[session_id]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    session_data = @timings[session_id]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    events = session_data[:events]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">      session_id: session_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">      total_duration_ms: session_data[:total_duration] || 0,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">      event_count: events.size,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      events_by_duration: events.sort_by { |e| -e[:duration_ms] },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">      events_by_category: categorize_events(events),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">      bottlenecks: identify_bottlenecks(events)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">  def ensure_csv_exists</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">    unless File.exist?(TRACKING_FILE)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">      CSV.open(TRACKING_FILE, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">        csv &lt;&lt; [&#39;timestamp&#39;, &#39;session_id&#39;, &#39;event_name&#39;, &#39;duration_ms&#39;, &#39;metadata&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">  def append_to_csv(event_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    CSV.open(TRACKING_FILE, &#39;a&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">        event_data[:start_time].iso8601,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">        @session_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">        event_data[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">        event_data[:duration_ms],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">        event_data[:metadata].to_json</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to write to performance CSV: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">  def generate_summary(session_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    events = session_data[:events]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">    summary = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;# Performance Summary - Session #{@session_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;**Generated at:** #{Time.current.iso8601}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;**Total Duration:** #{session_data[:total_duration]}ms&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;## Event Timeline&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;| Event | Duration (ms) | Percentage | Details |&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;|-------|--------------|------------|---------|&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    total_duration = session_data[:total_duration] || 1</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">    events.sort_by { |e| e[:start_time] }.each do |event|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">      percentage = ((event[:duration_ms] / total_duration) * 100).round(1)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">      details = event[:metadata].empty? ? &quot;-&quot; : event[:metadata].to_json</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">      summary &lt;&lt; &quot;| #{event[:name]} | #{event[:duration_ms]} | #{percentage}% | #{details} |&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;## Performance Analysis&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">    # Identify bottlenecks</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">    bottlenecks = identify_bottlenecks(events)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    if bottlenecks.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">      summary &lt;&lt; &quot;###  Bottlenecks Detected&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">      summary &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">      bottlenecks.each do |bottleneck|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">        summary &lt;&lt; &quot;- **#{bottleneck[:name]}**: #{bottleneck[:duration_ms]}ms (#{bottleneck[:percentage]}% of total time)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">        if bottleneck[:name].include?(&#39;say_command&#39;) || bottleneck[:name].include?(&#39;polly&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;  -  Audio generation is a major bottleneck. Consider:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;    - Pre-generating audio for common questions&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;    - Using faster TTS voices&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;    - Implementing audio caching&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">        elsif bottleneck[:name].include?(&#39;api&#39;) || bottleneck[:name].include?(&#39;network&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;  -  Network latency detected. Consider:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;    - Batch API requests&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;    - Implement request caching&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;    - Use connection pooling&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">        elsif bottleneck[:name].include?(&#39;database&#39;) || bottleneck[:name].include?(&#39;query&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;  -  Database performance issue. Consider:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;    - Adding database indexes&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;    - Optimizing queries&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">          summary &lt;&lt; &quot;    - Implementing query caching&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">      summary &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="180">
            

            

            <code class="ruby">    # Categorize events</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">    categories = categorize_events(events)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;###  Time by Category&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;| Category | Total Time (ms) | Event Count |&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;|----------|----------------|-------------|&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">    categories.each do |category, data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">      summary &lt;&lt; &quot;| #{category} | #{data[:total_ms]} | #{data[:count]} |&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;## Recommendations&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">    summary &lt;&lt; &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="195">
            

            

            <code class="ruby">    # Generate recommendations based on data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">    if session_data[:total_duration] &gt; 5000</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">      summary &lt;&lt; &quot;-  **Total load time exceeds 5 seconds** - Users may experience frustration&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">    audio_events = events.select { |e| e[:name].downcase.include?(&#39;audio&#39;) || e[:name].downcase.include?(&#39;polly&#39;) || e[:name].downcase.include?(&#39;say&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">    if audio_events.any?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">      audio_total = audio_events.sum { |e| e[:duration_ms] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">      audio_percentage = ((audio_total / total_duration) * 100).round(1)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">      if audio_percentage &gt; 40</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">        summary &lt;&lt; &quot;-  **Audio generation takes #{audio_percentage}% of total time**&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">        summary &lt;&lt; &quot;  - Consider pre-generating audio during project creation&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">        summary &lt;&lt; &quot;  - Implement progressive loading (start interview while audio generates)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">    api_events = events.select { |e| e[:name].downcase.include?(&#39;api&#39;) || e[:name].downcase.include?(&#39;request&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">    if api_events.size &gt; 5</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">      summary &lt;&lt; &quot;-  **Multiple API calls detected (#{api_events.size} calls)**&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">      summary &lt;&lt; &quot;  - Consider batching API requests&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">      summary &lt;&lt; &quot;  - Implement request parallelization&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="217">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            

            <code class="ruby">    # Write to file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">    File.write(SUMMARY_FILE, summary.join(&quot;\n&quot;))</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="220">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            

            <code class="ruby">    # Also append to a historical summary file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">    historical_file = Rails.root.join(&#39;log&#39;, &quot;performance_history_#{Date.current.strftime(&#39;%Y%m%d&#39;)}.md&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">    File.open(historical_file, &#39;a&#39;) do |f|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">      f.puts &quot;\n---\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">      f.puts summary.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="227">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">    Rails.logger.info &quot; Performance summary written to #{SUMMARY_FILE}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="230">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to generate performance summary: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">  def categorize_events(events)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">    categories = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">    events.each do |event|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">      category = determine_category(event[:name])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">      categories[category] ||= { total_ms: 0, count: 0, events: [] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">      categories[category][:total_ms] += event[:duration_ms]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">      categories[category][:count] += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">      categories[category][:events] &lt;&lt; event</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">    categories</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="246">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">  def determine_category(event_name)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">    name = event_name.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="249">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">    return &#39;Audio Generation&#39; if name.include?(&#39;audio&#39;) || name.include?(&#39;polly&#39;) || name.include?(&#39;say&#39;) || name.include?(&#39;speech&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">    return &#39;Database&#39; if name.include?(&#39;database&#39;) || name.include?(&#39;query&#39;) || name.include?(&#39;activerecord&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">    return &#39;API/Network&#39; if name.include?(&#39;api&#39;) || name.include?(&#39;request&#39;) || name.include?(&#39;http&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">    return &#39;File I/O&#39; if name.include?(&#39;file&#39;) || name.include?(&#39;s3&#39;) || name.include?(&#39;upload&#39;) || name.include?(&#39;download&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">    return &#39;Processing&#39; if name.include?(&#39;process&#39;) || name.include?(&#39;generate&#39;) || name.include?(&#39;compute&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="255">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="256">
            

            

            <code class="ruby">    &#39;Other&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">  def identify_bottlenecks(events, threshold_percentage = 20)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">    return [] if events.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="261">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">    total_duration = events.sum { |e| e[:duration_ms] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">    return [] if total_duration == 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">    bottlenecks = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="266">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">    events.each do |event|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">      percentage = ((event[:duration_ms] / total_duration) * 100).round(1)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="269">
            

            

            <code class="ruby">      if percentage &gt;= threshold_percentage</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">        bottlenecks &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">          name: event[:name],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">          duration_ms: event[:duration_ms],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">          percentage: percentage,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">          metadata: event[:metadata]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="275">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="278">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">    bottlenecks.sort_by { |b| -b[:duration_ms] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ef3b4db87c402afe406f59555207dc469386fc2e">
  <div class="header">
    <h3>app/services/preset_questions_importer.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>133</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>133</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require &#39;yaml&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">require &#39;securerandom&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">class PresetQuestionsImporter</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  PRESET_QUESTIONS_DIR = Rails.root.join(&#39;db&#39;, &#39;preset_questions&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">  def self.import_all</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    new.import_all</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    @errors = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    @imported_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    @updated_count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  def import_all</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    Rails.logger.info &quot;Starting preset questions import from #{PRESET_QUESTIONS_DIR}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    yaml_files.each do |file_path|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">        import_file(file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        @errors &lt;&lt; &quot;Error importing #{File.basename(file_path)}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">        Rails.logger.error &quot;Error importing #{file_path}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">        Rails.logger.error e.backtrace.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    log_summary</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">    { imported: @imported_count, updated: @updated_count, errors: @errors }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">  def yaml_files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    Dir.glob(File.join(PRESET_QUESTIONS_DIR, &#39;*.yaml&#39;))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  def import_file(file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    filename = File.basename(file_path, &#39;.yaml&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    yaml_content = YAML.load_file(file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    # Add UUID if not present</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    if yaml_content[&#39;uuid&#39;].blank?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      yaml_content[&#39;uuid&#39;] = SecureRandom.uuid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      save_yaml_with_uuid(file_path, yaml_content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">      Rails.logger.info &quot;Added UUID to #{filename}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    import_interview_preset(yaml_content, filename)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">  def save_yaml_with_uuid(file_path, yaml_content)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">    # Reorder content to have uuid at the top</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    ordered_content = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      &#39;uuid&#39; =&gt; yaml_content[&#39;uuid&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      &#39;title&#39; =&gt; yaml_content[&#39;title&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      &#39;description&#39; =&gt; yaml_content[&#39;description&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      &#39;llm_prompt&#39; =&gt; yaml_content[&#39;llm_prompt&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      &#39;questions&#39; =&gt; yaml_content[&#39;questions&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    File.write(file_path, ordered_content.to_yaml)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">  def import_interview_preset(yaml_content, filename)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    preset = InterviewPreset.find_or_initialize_by(uuid: yaml_content[&#39;uuid&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    if preset.persisted?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">      @updated_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      Rails.logger.info &quot;Updating existing preset: #{yaml_content[&#39;title&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">      @imported_count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">      Rails.logger.info &quot;Creating new preset: #{yaml_content[&#39;title&#39;]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">    preset.assign_attributes(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">      title: yaml_content[&#39;title&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">      description: yaml_content[&#39;description&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">      category: determine_category(yaml_content[&#39;title&#39;], filename),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">      icon_name: determine_icon(yaml_content[&#39;title&#39;], filename),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      order_position: determine_order_position(filename),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      active: true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    preset.save!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">    # Import questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    import_questions_for_preset(preset, yaml_content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">  def import_questions_for_preset(preset, yaml_content)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">    # Clear existing questions to avoid duplicates</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    preset.preset_questions.destroy_all</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    questions = yaml_content[&#39;questions&#39;] || []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">    questions.each_with_index do |question_text, index|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">      PresetQuestion.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">        interview_preset: preset,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">        chapter_title: &#39;Main Questions&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">        section_title: &#39;Core Questions&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">        question_text: question_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">        chapter_order: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">        section_order: 1,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">        question_order: index + 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    Rails.logger.info &quot;Imported #{questions.size} questions for #{preset.title}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">  def determine_category(title, filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">    # Simple categorization based on keywords in title/filename</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">    title_lower = title.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">    filename_lower = filename.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">    case</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">    when title_lower.include?(&#39;creative&#39;) || title_lower.include?(&#39;innovation&#39;) || filename_lower.include?(&#39;creative&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      &#39;creativity&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">    when title_lower.include?(&#39;question&#39;) || title_lower.include?(&#39;inquiry&#39;) || filename_lower.include?(&#39;question&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      &#39;self_inquiry&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">    when title_lower.include?(&#39;leadership&#39;) || title_lower.include?(&#39;influence&#39;) || filename_lower.include?(&#39;leadership&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">      &#39;leadership&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">    when title_lower.include?(&#39;relationship&#39;) || title_lower.include?(&#39;connection&#39;) || filename_lower.include?(&#39;relationship&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      &#39;relationships&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">    when title_lower.include?(&#39;mindset&#39;) || title_lower.include?(&#39;mindful&#39;) || title_lower.include?(&#39;mental&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      &#39;mindset&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    when title_lower.include?(&#39;growth&#39;) || title_lower.include?(&#39;transformation&#39;) || title_lower.include?(&#39;development&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      &#39;personal_growth&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">      &#39;general&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">  def determine_icon(title, filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby">    # Simple icon assignment based on category</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">    category = determine_category(title, filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">    case category</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    when &#39;creativity&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">      &#39;lightbulb.fill&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">    when &#39;self_inquiry&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">      &#39;questionmark.circle.fill&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    when &#39;leadership&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">      &#39;person.3.fill&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    when &#39;relationships&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">      &#39;heart.fill&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">    when &#39;mindset&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      &#39;brain.head.profile&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    when &#39;personal_growth&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">      &#39;arrow.up.circle.fill&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">      &#39;star.fill&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">  def determine_order_position(filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby">    # Use a hash of the filename to create consistent ordering</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">    filename.bytes.sum % 1000</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">  def log_summary</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">    Rails.logger.info &quot;Preset questions import completed: #{@imported_count} imported, #{@updated_count} updated&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">    @errors.each { |error| Rails.logger.error error }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cb0b6816d0350dd2cc7ed699bb2e62b87391b3f9">
  <div class="header">
    <h3>app/services/runware_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>130</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>130</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="never" data-hits="" data-linenumber="1">
            

            

            <code class="ruby"># frozen_string_literal: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"># ==============================================================================</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"># RunwareService Class</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"># @description</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">#   A Ruby service for the Runware Text-to-Image REST API integrated into Rails.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">#   This service handles authentication, API request construction, and response</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">#   parsing for generating images based on textual prompts.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"># @usage</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">#   # Generate a square icon (1:1)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">#   runware = RunwareService.new</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">#   icon_url = runware.create_icon(prompt: &quot;a glowing nebula shaped like a cat&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">#   </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">#   # Generate a portrait photo (9:16)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">#   portrait_url = runware.create_portrait_photo(prompt: &quot;astronaut meditating in a field of glowing flowers&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">#   </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">#   # Generate a tall photo (6:19)  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">#   tall_url = runware.create_tall_photo(prompt: &quot;a lone monolith on a distant planet, two moons in the sky&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">#</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"># ==============================================================================</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">class RunwareService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">  include HTTParty</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">  # The base URI for the Runware v1 REST API.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">  base_uri &#39;https://api.runware.ai/v1&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  # The overall aesthetic prompt to be appended to every request.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  # This defines the &quot;Cosmic Lofi&quot; look and feel.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  COSMIC_LOFI_AESTHETIC = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    &#39;Cosmic Lofi aesthetic&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">    &#39;calm, introspective, and magical digital space&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    &#39;a quiet corner of the universe at midnight&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    &#39;sophisticated and modern with depth and softness&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">    &#39;deep near-black blues and purples&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    &#39;muted, luminous pastel highlights like distant nebulae or soft aurora lights&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">    &#39;serene, cinematic&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">    &#39;4k, high detail&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">  ].join(&#39;, &#39;).freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  # The negative prompt to steer the AI away from undesired elements.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">  NEGATIVE_AESTHETIC = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">    &#39;pure black&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    &#39;harsh lighting&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    &#39;oversaturated colors&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    &#39;bright jarring colors&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    &#39;chaotic composition&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    &#39;blurry, low quality, pixelated&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    &#39;text, watermark, signature, username&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">  ].join(&#39;, &#39;).freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">  # A capable default model that works well for a variety of styles.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">  # HiDream-I1 Full is the highest quality HiDream model with sharp detail,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">  # accurate prompts, full LoRA compatibility, and is fully uncensored.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">  DEFAULT_MODEL = &#39;hidream:i1-full&#39;.freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">  def initialize(api_key: ENV[&#39;RUNWARE_API_KEY&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    raise ArgumentError, &#39;RUNWARE_API_KEY environment variable not set.&#39; if api_key.nil? || api_key.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    @api_key = api_key</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">    # Set default headers for all requests made by this class instance.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">    self.class.headers(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">      &#39;Authorization&#39; =&gt; &quot;Bearer #{@api_key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      &#39;Content-Type&#39; =&gt; &#39;application/json&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">  # ============================================================================</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby">  # Public Methods</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">  # ============================================================================</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">  # Generates a square image (1:1 aspect ratio), ideal for icons.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">  # @param prompt [String] The main subject of the image.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">  # @param size [Integer] The width and height of the image in pixels. Must be divisible by 64.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">  # @return [Hash] Response containing image URL or error details</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">  def create_icon(prompt:, size: 1024)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    Rails.logger.info(&quot;Starting icon generation for prompt: &#39;#{prompt}&#39;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    unless size % 64 == 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      Rails.logger.error(&quot;Image size must be divisible by 64. Received: #{size}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      return { success: false, error: &quot;Image size must be divisible by 64&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    create_image_with_polling(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">      prompt: prompt,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">      width: size,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      height: size</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">  # Generates a portrait image (9:16 aspect ratio).</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">  # @param prompt [String] The main subject of the image.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">  # @param height [Integer] The height of the image. Width will be calculated to match the 9:16 aspect ratio and rounded to the nearest multiple of 64.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">  # @return [Hash] Response containing image URL or error details</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">  def create_portrait_photo(prompt:, height: 1344)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">    Rails.logger.info(&quot;Starting 9:16 portrait generation for prompt: &#39;#{prompt}&#39;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">    # Calculate width for a 9:16 aspect ratio and ensure it&#39;s divisible by 64.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    width = calculate_dimension(height * 9.0 / 16.0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    create_image_with_polling(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      prompt: prompt,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">      width: width,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">      height: height</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">  # Generates a very tall image (6:19 aspect ratio).</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">  # Note: 6:19 is an unconventional ratio. This method creates an image that approximates it.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">  # @param prompt [String] The main subject of the image.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">  # @param height [Integer] The height of the image. Width will be calculated to match the 6:19 aspect ratio and rounded to the nearest multiple of 64.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">  # @return [Hash] Response containing image URL or error details</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">  def create_tall_photo(prompt:, height: 1984)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">    Rails.logger.info(&quot;Starting 6:19 tall photo generation for prompt: &#39;#{prompt}&#39;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">    # Calculate width for a 6:19 aspect ratio and ensure it&#39;s divisible by 64.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">    width = calculate_dimension(height * 6.0 / 19.0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">    create_image_with_polling(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">      prompt: prompt,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      width: width,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">      height: height</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">  # Generic method for creating images with custom dimensions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">  # @param prompt [String] The main subject of the image.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">  # @param width [Integer] Image width (must be divisible by 64).</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">  # @param height [Integer] Image height (must be divisible by 64).</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">  # @param model [String] Optional model override.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby">  # @return [Hash] Response containing image URL or error details</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">  def create_custom_image(prompt:, width:, height:, model: DEFAULT_MODEL)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">    Rails.logger.info(&quot;Starting custom image generation: #{width}x#{height} for prompt: &#39;#{prompt}&#39;&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    unless width % 64 == 0 &amp;&amp; height % 64 == 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">      Rails.logger.error(&quot;Image dimensions must be divisible by 64. Received: #{width}x#{height}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">      return { success: false, error: &quot;Image dimensions must be divisible by 64&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">    create_image_with_polling(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">      prompt: prompt,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">      width: width,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">      height: height,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      model: model</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">  # ============================================================================</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">  # Private Helper Methods</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            

            <code class="ruby">  # ============================================================================</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">  # Core method to submit an image generation task and poll for the result.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="161">
            

            

            <code class="ruby">  # The Runware REST API is synchronous and returns the result directly.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="163">
            

            

            <code class="ruby">  # @param prompt [String] The user&#39;s prompt.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">  # @param width [Integer] Image width.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby">  # @param height [Integer] Image height.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">  # @param model [String] The model to use.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">  # @return [Hash] Response with success status and either image_url or error</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">  def create_image_with_polling(prompt:, width:, height:, model: DEFAULT_MODEL)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">    task_uuid = SecureRandom.uuid</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">    full_prompt = &quot;#{prompt}, #{COSMIC_LOFI_AESTHETIC}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">    payload = [{</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">      taskType: &#39;imageInference&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">      taskUUID: task_uuid,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">      positivePrompt: full_prompt,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">      negativePrompt: NEGATIVE_AESTHETIC,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">      width: width,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">      height: height,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">      model: model,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">      steps: 30, # A good balance of quality and speed.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">      numberResults: 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">    }]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">    Rails.logger.debug(&quot;Submitting task #{task_uuid} with payload: #{payload.to_json}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">      response = self.class.post(&#39;/&#39;, body: payload.to_json)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="188">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">      unless response.success?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">        Rails.logger.error(&quot;HTTP Error: #{response.code} - #{response.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">        Rails.logger.error(&quot;Response Body: #{response.body}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">        return { success: false, error: &quot;HTTP Error: #{response.code} - #{response.message}&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="194">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">      parsed_response = response.parsed_response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">      Rails.logger.debug(&quot;Received response: #{parsed_response.to_json}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">      # Check for API-level errors</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">      if parsed_response[&#39;error&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">        Rails.logger.error(&quot;API Error: #{parsed_response[&#39;error&#39;]}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">        return { success: false, error: parsed_response[&#39;error&#39;] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            

            <code class="ruby">      # Find the result corresponding to our task UUID</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">      task_result = parsed_response[&#39;data&#39;]&amp;.find { |item| item[&#39;taskUUID&#39;] == task_uuid }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">      if task_result &amp;&amp; task_result[&#39;imageURL&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">        Rails.logger.info(&quot;Successfully generated image for task #{task_uuid}.&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">        return { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">          success: true, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">          image_url: task_result[&#39;imageURL&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">          task_uuid: task_uuid,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">          width: width,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">          height: height</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">        Rails.logger.error(&quot;API response did not contain a valid image URL for task #{task_uuid}.&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">        Rails.logger.debug(&quot;Full response data: #{parsed_response[&#39;data&#39;]}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">        return { success: false, error: &quot;API response did not contain a valid image URL&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">    rescue HTTParty::Error, SocketError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">      Rails.logger.error(&quot;Network or HTTParty error: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">      return { success: false, error: &quot;Network error: #{e.message}&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">      Rails.logger.error(&quot;Unexpected error in Runware service: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">      return { success: false, error: &quot;Unexpected error: #{e.message}&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby">  # Helper to round a dimension to the nearest multiple of 64, as required by the API.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            

            <code class="ruby">  #</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">  # @param value [Float] The calculated dimension.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            

            <code class="ruby">  # @return [Integer] The dimension rounded to the nearest multiple of 64.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">  def calculate_dimension(value)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">    (value / 64.0).round * 64</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="dcdbafec3c5b1946fff32e7431827c0194d0ecb4">
  <div class="header">
    <h3>app/services/s3_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>406</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>406</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class S3Service</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def initialize(user)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    @user = user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  def generate_upload_url(record_id:, record_type:, filename:, content_type: &#39;audio/mp4&#39;, expires_in: 3600)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;] || &#39;vibewrite-audio-dev&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    key = generate_s3_key(record_id: record_id, record_type: record_type, filename: filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    Rails.logger.info &quot;========== S3 UPLOAD URL GENERATION ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    Rails.logger.info &quot;Bucket: #{bucket_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    Rails.logger.info &quot;Key: #{key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    Rails.logger.info &quot;Content Type: #{content_type}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    Rails.logger.info &quot;User ID: #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    Rails.logger.info &quot;Record Type: #{record_type}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    Rails.logger.info &quot;Record ID: #{record_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    Rails.logger.info &quot;AWS Region: #{aws_region}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    Rails.logger.info &quot;AWS Access Key ID present: #{aws_access_key_id.present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    Rails.logger.info &quot;AWS Secret Key present: #{aws_secret_access_key.present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">      s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">        region: aws_region,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">        access_key_id: aws_access_key_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">        secret_access_key: aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      # Test bucket access</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">        s3_client.head_bucket(bucket: bucket_name)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">        Rails.logger.info &quot; Bucket access verified&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        Rails.logger.error &quot; Bucket access error: #{e.class} - #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      presigner = Aws::S3::Presigner.new(client: s3_client)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      url = presigner.presigned_url(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">        :put_object, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">        bucket: bucket_name, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">        key: key, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">        expires_in: expires_in,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">        content_type: content_type</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">      Rails.logger.info &quot; Generated presigned upload URL successfully&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">      Rails.logger.info &quot;URL (first 150 chars): #{url[0..150]}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">      Rails.logger.info &quot;========== END S3 UPLOAD URL GENERATION ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">        url: url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">        s3_url: &quot;https://#{bucket_name}.s3.amazonaws.com/#{key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">        key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">        bucket: bucket_name</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      Rails.logger.error &quot; S3 UPLOAD URL GENERATION FAILED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Class: #{e.class}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Message: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      Rails.logger.error &quot;Backtrace:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.first(5).join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      Rails.logger.error &quot;========== END S3 UPLOAD URL GENERATION ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">      # Return mock URL in development if S3 fails</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">        Rails.logger.warn &quot; Returning mock URL for development&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">          url: &quot;https://mock-s3-upload-url.com/#{key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">          s3_url: &quot;https://#{bucket_name}.s3.amazonaws.com/#{key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">          key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">          bucket: bucket_name</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">        raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">  def generate_playback_url(record_id:, record_type:, filename:, content_type: &#39;audio/mp4&#39;, expires_in: 3600)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;] || &#39;vibewrite-audio-dev&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    key = generate_s3_key(record_id: record_id, record_type: record_type, filename: filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">    s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      region: aws_region,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">      access_key_id: aws_access_key_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      secret_access_key: aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">    presigner = Aws::S3::Presigner.new(client: s3_client)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    url = presigner.presigned_url(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      :get_object, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">      bucket: bucket_name, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">      key: key, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      expires_in: expires_in,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      response_content_type: content_type</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    Rails.logger.info &quot;Generated playback URL: #{url}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">    url</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">  def download_audio_data(record_id:, record_type:, filename:)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;] || &#39;vibewrite-audio-dev&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">    key = generate_s3_key(record_id: record_id, record_type: record_type, filename: filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    Rails.logger.info &quot;========== S3 AUDIO DOWNLOAD ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    Rails.logger.info &quot;Bucket: #{bucket_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">    Rails.logger.info &quot;Key: #{key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">    Rails.logger.info &quot;User ID: #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">        region: aws_region,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">        access_key_id: aws_access_key_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">        secret_access_key: aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      response = s3_client.get_object(bucket: bucket_name, key: key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      audio_data = response.body.read</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      Rails.logger.info &quot; Successfully downloaded audio data (#{audio_data.bytesize} bytes)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">      Rails.logger.info &quot;========== END S3 AUDIO DOWNLOAD ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">      audio_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">      Rails.logger.error &quot; S3 AUDIO DOWNLOAD FAILED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Class: #{e.class}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Message: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      Rails.logger.error &quot;========== END S3 AUDIO DOWNLOAD ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">      # Return nil so the calling code can handle the fallback</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">      nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">  def download_audio_to_file(record_id:, record_type:, filename:, target_path:)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;] || &#39;vibewrite-audio-dev&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    key = generate_s3_key(record_id: record_id, record_type: record_type, filename: filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">    Rails.logger.info &quot;========== S3 AUDIO DOWNLOAD TO FILE ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">    Rails.logger.info &quot;Bucket: #{bucket_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">    Rails.logger.info &quot;Key: #{key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">    Rails.logger.info &quot;Target Path: #{target_path}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">    Rails.logger.info &quot;User ID: #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">      s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">        region: aws_region,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">        access_key_id: aws_access_key_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">        secret_access_key: aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">      s3_client.get_object(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">        response_target: target_path,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">        key: key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">      Rails.logger.info &quot; Successfully downloaded audio to file&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">      Rails.logger.info &quot;========== END S3 AUDIO DOWNLOAD TO FILE ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">      true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      Rails.logger.error &quot; S3 AUDIO DOWNLOAD TO FILE FAILED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Class: #{e.class}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Message: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">      Rails.logger.error &quot;========== END S3 AUDIO DOWNLOAD TO FILE ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">      false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">  # Store export file in S3 and return shareable URL</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">  def store_export_file(content:, filename:, project_id: nil, format:, expires_in: 7.days)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;] || &#39;vibewrite-audio-dev&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">    key = generate_export_s3_key(filename: filename, project_id: project_id, format: format)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">    Rails.logger.info &quot;========== S3 EXPORT FILE STORAGE ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">    Rails.logger.info &quot;Bucket: #{bucket_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">    Rails.logger.info &quot;Key: #{key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">    Rails.logger.info &quot;Content Size: #{content.bytesize} bytes&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">    Rails.logger.info &quot;User ID: #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">    Rails.logger.info &quot;Format: #{format}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">      s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">        region: aws_region,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">        access_key_id: aws_access_key_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">        secret_access_key: aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            

            <code class="ruby">      # Upload the content to S3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">      s3_client.put_object(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">        key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">        body: content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">        content_type: content_type_for_format(format),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">        content_disposition: &quot;attachment; filename=\&quot;#{filename}\&quot;&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="198">
            

            

            <code class="ruby">        # Set expiration using object tagging or lifecycle policy</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">        expires: Time.current + expires_in</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            

            <code class="ruby">      # Generate a presigned URL for sharing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">      presigner = Aws::S3::Presigner.new(client: s3_client)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">      share_url = presigner.presigned_url(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">        :get_object,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">        key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">        expires_in: expires_in.to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">        response_content_disposition: &quot;attachment; filename=\&quot;#{filename}\&quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="211">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">      Rails.logger.info &quot; Successfully stored export file and generated share URL&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">      Rails.logger.info &quot;Share URL (first 150 chars): #{share_url[0..150]}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">      Rails.logger.info &quot;========== END S3 EXPORT FILE STORAGE ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="215">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">        share_url: share_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">        s3_key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">        expires_at: Time.current + expires_in</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">      Rails.logger.error &quot; S3 EXPORT FILE STORAGE FAILED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Class: #{e.class}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Message: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">      Rails.logger.error &quot;Backtrace:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.first(5).join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">      Rails.logger.error &quot;========== END S3 EXPORT FILE STORAGE ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">      # Return mock URL in development if S3 fails</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">      if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">        Rails.logger.warn &quot; Returning mock share URL for development&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">          share_url: &quot;https://mock-s3-share-url.com/#{key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">          s3_key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">          bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">          expires_at: Time.current + expires_in</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">        raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="243">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="245">
            

            

            <code class="ruby">  # Extract S3 key from full S3 URL</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">  def extract_s3_key_from_url(s3_url)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">    uri = URI.parse(s3_url)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="248">
            

            

            <code class="ruby">    uri.path.delete_prefix(&#39;/&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="250">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="251">
            

            

            <code class="ruby">  # Upload audio data directly to S3 (used by Polly service)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">  def upload_audio_data(key, audio_stream)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;] || &#39;vibewrite-audio-dev&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="254">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">    Rails.logger.info &quot;========== S3 AUDIO DATA UPLOAD ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="256">
            

            

            <code class="ruby">    Rails.logger.info &quot;Bucket: #{bucket_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">    Rails.logger.info &quot;Key: #{key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="258">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">      s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">        region: aws_region,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">        access_key_id: aws_access_key_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">        secret_access_key: aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="265">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">      s3_client.put_object(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">        key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="269">
            

            

            <code class="ruby">        body: audio_stream,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">        content_type: &#39;audio/mp3&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="272">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">      Rails.logger.info &quot; Successfully uploaded audio data to S3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">      Rails.logger.info &quot;========== END S3 AUDIO DATA UPLOAD ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">      true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="278">
            

            

            <code class="ruby">      Rails.logger.error &quot; S3 AUDIO DATA UPLOAD FAILED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Class: #{e.class}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Message: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">      Rails.logger.error &quot;========== END S3 AUDIO DATA UPLOAD ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="282">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="283">
            

            

            <code class="ruby">      raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="284">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="285">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="286">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="287">
            

            

            <code class="ruby">  # Get presigned URL for a given S3 key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="288">
            

            

            <code class="ruby">  def get_presigned_url(key, expires_in: 3600)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="289">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;] || &#39;vibewrite-audio-dev&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="290">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">    s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">      region: aws_region,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">      access_key_id: aws_access_key_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="294">
            

            

            <code class="ruby">      secret_access_key: aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="295">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="296">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="297">
            

            

            <code class="ruby">    presigner = Aws::S3::Presigner.new(client: s3_client)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="298">
            

            

            <code class="ruby">    presigner.presigned_url(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">      :get_object,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">      bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="301">
            

            

            <code class="ruby">      key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="302">
            

            

            <code class="ruby">      expires_in: expires_in</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="303">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="304">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="305">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="306">
            

            

            <code class="ruby">  # Download audio segment using its S3 key to local file path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="307">
            

            

            <code class="ruby">  def download_audio_segment(s3_key, local_file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="308">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;] || &#39;vibewrite-audio-dev&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="309">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="310">
            

            

            <code class="ruby">    Rails.logger.info &quot;========== S3 AUDIO SEGMENT DOWNLOAD ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="311">
            

            

            <code class="ruby">    Rails.logger.info &quot;Bucket: #{bucket_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">    Rails.logger.info &quot;Key: #{s3_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="313">
            

            

            <code class="ruby">    Rails.logger.info &quot;Target Path: #{local_file_path}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="314">
            

            

            <code class="ruby">    Rails.logger.info &quot;User ID: #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="315">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="316">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="317">
            

            

            <code class="ruby">      s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="318">
            

            

            <code class="ruby">        region: aws_region,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="319">
            

            

            <code class="ruby">        access_key_id: aws_access_key_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="320">
            

            

            <code class="ruby">        secret_access_key: aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="321">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="322">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="323">
            

            

            <code class="ruby">      s3_client.get_object(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="324">
            

            

            <code class="ruby">        response_target: local_file_path,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="325">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="326">
            

            

            <code class="ruby">        key: s3_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="327">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="328">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="329">
            

            

            <code class="ruby">      Rails.logger.info &quot; Successfully downloaded audio segment to file&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="330">
            

            

            <code class="ruby">      Rails.logger.info &quot;File size: #{File.size(local_file_path)} bytes&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="331">
            

            

            <code class="ruby">      Rails.logger.info &quot;========== END S3 AUDIO SEGMENT DOWNLOAD ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="332">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="333">
            

            

            <code class="ruby">      true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="334">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="335">
            

            

            <code class="ruby">      Rails.logger.error &quot; S3 AUDIO SEGMENT DOWNLOAD FAILED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="336">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Class: #{e.class}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="337">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Message: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="338">
            

            

            <code class="ruby">      Rails.logger.error &quot;========== END S3 AUDIO SEGMENT DOWNLOAD ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="340">
            

            

            <code class="ruby">      raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="341">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="342">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="344">
            

            

            <code class="ruby">  # Store podcast export file in S3 and return download URL</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="345">
            

            

            <code class="ruby">  def store_podcast_export(file_path:, filename:, project_id:, content_type: &#39;audio/mp4&#39;, expires_in: 7.days)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="346">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;] || &#39;vibewrite-audio-dev&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="347">
            

            

            <code class="ruby">    key = generate_podcast_s3_key(filename: filename, project_id: project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="348">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="349">
            

            

            <code class="ruby">    Rails.logger.info &quot;========== S3 PODCAST EXPORT STORAGE ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="350">
            

            

            <code class="ruby">    Rails.logger.info &quot;Bucket: #{bucket_name}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="351">
            

            

            <code class="ruby">    Rails.logger.info &quot;Key: #{key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="352">
            

            

            <code class="ruby">    Rails.logger.info &quot;File Path: #{file_path}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">    Rails.logger.info &quot;File Size: #{File.size(file_path)} bytes&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="354">
            

            

            <code class="ruby">    Rails.logger.info &quot;User ID: #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="355">
            

            

            <code class="ruby">    Rails.logger.info &quot;Content Type: #{content_type}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="356">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="357">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="358">
            

            

            <code class="ruby">      s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="359">
            

            

            <code class="ruby">        region: aws_region,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="360">
            

            

            <code class="ruby">        access_key_id: aws_access_key_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">        secret_access_key: aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="364">
            

            

            <code class="ruby">      # Upload the file to S3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="365">
            

            

            <code class="ruby">      File.open(file_path, &#39;rb&#39;) do |file|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="366">
            

            

            <code class="ruby">        s3_client.put_object(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="367">
            

            

            <code class="ruby">          bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="368">
            

            

            <code class="ruby">          key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="369">
            

            

            <code class="ruby">          body: file,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="370">
            

            

            <code class="ruby">          content_type: content_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="371">
            

            

            <code class="ruby">          content_disposition: &quot;attachment; filename=\&quot;#{filename}\&quot;&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="372">
            

            

            <code class="ruby">          # Set expiration</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="373">
            

            

            <code class="ruby">          expires: Time.current + expires_in,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="374">
            

            

            <code class="ruby">          metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="375">
            

            

            <code class="ruby">            &#39;user-id&#39; =&gt; @user.id.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="376">
            

            

            <code class="ruby">            &#39;project-id&#39; =&gt; project_id.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="377">
            

            

            <code class="ruby">            &#39;export-type&#39; =&gt; &#39;podcast&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="378">
            

            

            <code class="ruby">            &#39;created-at&#39; =&gt; Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="379">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="380">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="381">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="382">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="383">
            

            

            <code class="ruby">      # Generate a presigned URL for downloading</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="384">
            

            

            <code class="ruby">      presigner = Aws::S3::Presigner.new(client: s3_client)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="385">
            

            

            <code class="ruby">      download_url = presigner.presigned_url(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="386">
            

            

            <code class="ruby">        :get_object,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="387">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="388">
            

            

            <code class="ruby">        key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="389">
            

            

            <code class="ruby">        expires_in: expires_in.to_i,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="390">
            

            

            <code class="ruby">        response_content_disposition: &quot;attachment; filename=\&quot;#{filename}\&quot;&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="391">
            

            

            <code class="ruby">        response_content_type: content_type</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="392">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="393">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="394">
            

            

            <code class="ruby">      Rails.logger.info &quot; Successfully stored podcast export and generated download URL&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="395">
            

            

            <code class="ruby">      Rails.logger.info &quot;Download URL (first 150 chars): #{download_url[0..150]}...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="396">
            

            

            <code class="ruby">      Rails.logger.info &quot;========== END S3 PODCAST EXPORT STORAGE ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="397">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="398">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="399">
            

            

            <code class="ruby">        download_url: download_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="400">
            

            

            <code class="ruby">        s3_key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="401">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="402">
            

            

            <code class="ruby">        expires_at: Time.current + expires_in</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="403">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="404">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="405">
            

            

            <code class="ruby">      Rails.logger.error &quot; S3 PODCAST EXPORT STORAGE FAILED&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="406">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Class: #{e.class}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="407">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error Message: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="408">
            

            

            <code class="ruby">      Rails.logger.error &quot;Backtrace:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="409">
            

            

            <code class="ruby">      Rails.logger.error e.backtrace.first(5).join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="410">
            

            

            <code class="ruby">      Rails.logger.error &quot;========== END S3 PODCAST EXPORT STORAGE ==========&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="411">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="412">
            

            

            <code class="ruby">      # Return mock URL in development if S3 fails</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="413">
            

            

            <code class="ruby">      if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="414">
            

            

            <code class="ruby">        Rails.logger.warn &quot; Returning mock podcast URL for development&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="415">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="416">
            

            

            <code class="ruby">          download_url: &quot;https://mock-s3-podcast-url.com/#{key}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="417">
            

            

            <code class="ruby">          s3_key: key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="418">
            

            

            <code class="ruby">          bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="419">
            

            

            <code class="ruby">          expires_at: Time.current + expires_in</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="420">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="421">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            

            

            <code class="ruby">        raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="423">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="424">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="425">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="426">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="427">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="428">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="429">
            

            

            <code class="ruby">  def environment_prefix</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="430">
            

            

            <code class="ruby">    case Rails.env</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="431">
            

            

            <code class="ruby">    when &#39;production&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="432">
            

            

            <code class="ruby">      &#39;production/&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="433">
            

            

            <code class="ruby">    when &#39;staging&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="434">
            

            

            <code class="ruby">      &#39;staging/&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="435">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="436">
            

            

            <code class="ruby">      &#39;dev/&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="437">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="438">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="439">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="440">
            

            

            <code class="ruby">  def generate_s3_key(record_id:, record_type:, filename:)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="441">
            

            

            <code class="ruby">    prefix = environment_prefix</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="442">
            

            

            <code class="ruby">    case record_type.to_s.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="443">
            

            

            <code class="ruby">    when &#39;audiosegment&#39;, &#39;audio_segment&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="444">
            

            

            <code class="ruby">      &quot;#{prefix}audio_segments/#{record_id}/#{filename}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="445">
            

            

            <code class="ruby">    when &#39;logentry&#39;, &#39;log_entry&#39;, &#39;vibelog&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="446">
            

            

            <code class="ruby">      &quot;#{prefix}vibelog/#{@user.id}/#{record_id}_#{Time.current.to_i}.m4a&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="447">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="448">
            

            

            <code class="ruby">      &quot;#{prefix}#{record_type.to_s.downcase}/#{@user.id}/#{record_id}/#{filename}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="449">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="450">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="451">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="452">
            

            

            <code class="ruby">  def generate_export_s3_key(filename:, project_id: nil, format:)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="453">
            

            

            <code class="ruby">    prefix = environment_prefix</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="454">
            

            

            <code class="ruby">    timestamp = Time.current.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="455">
            

            

            <code class="ruby">    if project_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="456">
            

            

            <code class="ruby">      &quot;#{prefix}exports/projects/#{@user.id}/#{project_id}/#{timestamp}_#{filename}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="457">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="458">
            

            

            <code class="ruby">      &quot;#{prefix}exports/vibelog/#{@user.id}/#{timestamp}_#{filename}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="459">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="460">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="461">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="462">
            

            

            <code class="ruby">  def generate_podcast_s3_key(filename:, project_id:)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="463">
            

            

            <code class="ruby">    prefix = environment_prefix</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="464">
            

            

            <code class="ruby">    timestamp = Time.current.to_i</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="465">
            

            

            <code class="ruby">    &quot;#{prefix}exports/podcasts/#{@user.id}/#{project_id}/#{timestamp}_#{filename}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="466">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="467">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="468">
            

            

            <code class="ruby">  def content_type_for_format(format)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="469">
            

            

            <code class="ruby">    case format.to_s.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="470">
            

            

            <code class="ruby">    when &#39;csv&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="471">
            

            

            <code class="ruby">      &#39;text/csv&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="472">
            

            

            <code class="ruby">    when &#39;pdf&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="473">
            

            

            <code class="ruby">      &#39;application/pdf&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="474">
            

            

            <code class="ruby">    when &#39;docx&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="475">
            

            

            <code class="ruby">      &#39;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="476">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="477">
            

            

            <code class="ruby">      &#39;text/plain&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="478">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="479">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="480">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="481">
            

            

            <code class="ruby">  def aws_region</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="482">
            

            

            <code class="ruby">    Rails.application.credentials.dig(:aws, :region) || ENV[&#39;AWS_REGION&#39;] || &#39;us-east-1&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="483">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="484">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="485">
            

            

            <code class="ruby">  def aws_access_key_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="486">
            

            

            <code class="ruby">    Rails.application.credentials.dig(:aws, :access_key_id) || ENV[&#39;AWS_ACCESS_KEY_ID&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="487">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="488">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="489">
            

            

            <code class="ruby">  def aws_secret_access_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="490">
            

            

            <code class="ruby">    Rails.application.credentials.dig(:aws, :secret_access_key) || ENV[&#39;AWS_SECRET_ACCESS_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="491">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="492">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="490a4684f17592695cbfe8e1e732d57f3a2c4a10">
  <div class="header">
    <h3>app/services/transcript_content_assembler_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>195</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>195</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class TranscriptContentAssemblerService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def self.process_transcript(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">    project = Project.find_by(id: project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">    unless project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">      Rails.logger.warn &quot;TranscriptContentAssemblerService: Project with id #{project_id} not found&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">      return { success: false, error: &quot;Project not found&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">      Rails.logger.info &quot;Starting transcript processing for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">      # Simulate LLM processing delay</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">      simulate_processing_delay</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">      # Get all transcribed audio segments for this project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">      transcribed_segments = project.audio_segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">                                   .where(upload_status: &#39;transcribed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">                                   .includes(:question =&gt; { :section =&gt; :chapter })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">                                   .order(&#39;questions.order ASC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">      if transcribed_segments.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            

            <code class="ruby">        Rails.logger.warn &quot;No transcribed segments found for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">        return { success: false, error: &#39;No transcribed content available&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      # Generate structured content (for backward compatibility)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      structured_content = generate_structured_content(project, transcribed_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      # Create or update transcript record with structured content only</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      transcript = project.transcript || project.build_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      transcript.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">        status: &#39;processing_raw&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">        raw_structured_content_json: structured_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">        last_updated: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">      Rails.logger.info &quot;Transcript processing completed for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      { success: true, transcript_id: transcript.id }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">      Rails.logger.error &quot;Transcript processing error for project #{project_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      project.update!(status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">      { success: false, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">  def self.finalize_transcript(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">    project = Project.find_by(id: project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">    unless project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      Rails.logger.warn &quot;TranscriptContentAssemblerService: Project with id #{project_id} not found for finalization&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      return { success: false, error: &quot;Project not found&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      Rails.logger.info &quot;Finalizing transcript for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">      # Get all transcribed audio segments for this project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      transcribed_segments = project.audio_segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">                                   .where(upload_status: &#39;transcribed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">                                   .includes(:question =&gt; { :section =&gt; :chapter })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">                                   .order(&#39;questions.order ASC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      if transcribed_segments.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">        Rails.logger.warn &quot;No transcribed segments found for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">        return { success: false, error: &#39;No transcribed content available&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">      # Generate both structured content and raw plaintext content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">      structured_content = generate_structured_content(project, transcribed_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">      raw_transcript = generate_raw_transcript(project, transcribed_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">      # Create or update transcript record with both formats</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">      transcript = project.transcript || project.build_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">      transcript.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">        status: &#39;raw_ready&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">        raw_structured_content_json: structured_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">        raw_content: raw_transcript,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">        last_updated: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">      # Enqueue editing job to polish the complete transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">      TranscriptEditingJob.perform_later(project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      Rails.logger.info &quot;Transcript finalization completed for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">      { success: true, transcript_id: transcript.id }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      Rails.logger.error &quot;Transcript finalization error for project #{project_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">      project.update!(status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">      { success: false, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">  def self.generate_complete_transcript(project_id, enqueue_editing_job: true)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    project = Project.find(project_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">      Rails.logger.info &quot;Generating complete transcript for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">      # Get all transcribed audio segments for this project</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">      transcribed_segments = project.audio_segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">                                   .where(upload_status: &#39;transcribed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">                                   .includes(:question =&gt; { :section =&gt; :chapter })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">                                   .order(&#39;questions.order ASC&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">      if transcribed_segments.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">        Rails.logger.warn &quot;No transcribed segments found for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">        return { success: false, error: &#39;No transcribed content available&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">      # Generate raw plaintext transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      raw_transcript = generate_raw_transcript(project, transcribed_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">      # Update transcript record with complete raw content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">      transcript = project.transcript || project.build_transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      transcript.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">        status: &#39;raw_ready&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">        raw_content: raw_transcript,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">        last_updated: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby">      # Enqueue editing job to polish the complete transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">      if enqueue_editing_job</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">        TranscriptEditingJob.perform_later(project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">      Rails.logger.info &quot;Complete transcript generation completed for project #{project_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">      { success: true, transcript_id: transcript.id }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">      Rails.logger.error &quot;Complete transcript generation error for project #{project_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">      project.update!(status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">      { success: false, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">  def self.simulate_processing_delay</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            

            <code class="ruby">    # Simulate realistic LLM processing time (3-10 seconds)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">    delay = rand(3..10)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    Rails.logger.info &quot;Simulating transcript processing delay: #{delay} seconds&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">    sleep(delay) if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">  def self.generate_structured_content(project, transcribed_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">    content = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">    # Group segments by chapter and section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">    chapters_data = group_segments_by_structure(transcribed_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    chapters_data.each do |chapter_info|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            

            <code class="ruby">      # Add chapter header</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">      content &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">        type: &#39;chapter&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">        chapterId: chapter_info[:chapter].id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">        title: chapter_info[:chapter].title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">        text: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">        audioSegmentId: nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="164">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">      chapter_info[:sections].each do |section_info|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            

            <code class="ruby">        # Add section header if section exists</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">        if section_info[:section]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">          content &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">            type: &#39;section&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">            sectionId: section_info[:section].id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">            title: section_info[:section].title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">            text: nil,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">            audioSegmentId: nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">          }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="176">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby">        # Process each question&#39;s transcription into structured paragraphs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">        section_info[:segments].each do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">          structured_paragraphs = structure_transcription_text(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">            segment.transcription_text, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">            segment.question&amp;.text</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">          )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">          structured_paragraphs.each do |paragraph_text|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">            content &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">              type: &#39;paragraph&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">              chapterId: chapter_info[:chapter].id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">              sectionId: section_info[:section]&amp;.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">              questionId: segment.question&amp;.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">              text: paragraph_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">              audioSegmentId: segment.id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="197">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">    content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="200">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">  def self.group_segments_by_structure(segments)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">    chapters = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">    segments.each do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">      question = segment.question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">      next unless question</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">      section = question.section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">      chapter = section.chapter</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">      chapters[chapter.id] ||= {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">        chapter: chapter,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">        sections: {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="215">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">      section_id = section&amp;.id || &#39;no_section&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">      chapters[chapter.id][:sections][section_id] ||= {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">        section: section,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">        segments: []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="222">
            

            

            <code class="ruby">      chapters[chapter.id][:sections][section_id][:segments] &lt;&lt; segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="224">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="225">
            

            

            <code class="ruby">    # Convert to sorted array</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">    chapters.values.sort_by { |c| c[:chapter].order }.map do |chapter_data|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">        chapter: chapter_data[:chapter],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">        sections: chapter_data[:sections].values.sort_by { |s| s[:section]&amp;.order || 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="230">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">  def self.structure_transcription_text(transcription_text, question_text = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">    return [transcription_text] if transcription_text.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="236">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            

            <code class="ruby">    # Just return raw text for raw structured content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">    [transcription_text]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">  def self.generate_raw_transcript(project, transcribed_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">    transcript_parts = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="244">
            

            

            <code class="ruby">    # Group segments by chapter and section</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">    chapters_data = group_segments_by_structure(transcribed_segments)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="246">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">    chapters_data.each do |chapter_info|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            

            <code class="ruby">      # Add chapter header</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">      transcript_parts &lt;&lt; &quot;# #{chapter_info[:chapter].title}\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="250">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">      chapter_info[:sections].each do |section_info|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="252">
            

            

            <code class="ruby">        # Add section header if section exists</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">        if section_info[:section]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">          transcript_parts &lt;&lt; &quot;## #{section_info[:section].title}\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="256">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="257">
            

            

            <code class="ruby">        # Add each question and its response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="258">
            

            

            <code class="ruby">        section_info[:segments].each do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">          if segment.question&amp;.text.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">            transcript_parts &lt;&lt; &quot;**Question:** #{segment.question.text}\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="262">
            

            

            <code class="ruby">          </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">          if segment.transcription_text.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="264">
            

            

            <code class="ruby">            transcript_parts &lt;&lt; &quot;#{segment.transcription_text}\n\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="269">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">    transcript_parts.join.strip</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="272">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a15d656496ad5c44b661239217ce5ead18a9ecdb">
  <div class="header">
    <h3>app/services/transcription_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>354</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>354</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require &#39;net/http&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">require &#39;uri&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">require &#39;tempfile&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">require &#39;open-uri&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">require &#39;ostruct&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">class TranscriptionService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">  WHISPER_API_URL = &#39;https://api.openai.com/v1/audio/transcriptions&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">  GROQ_API_URL = &#39;https://api.groq.com/openai/v1/audio/transcriptions&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">  def self.trigger_transcription_job(audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">    # Trigger async processing with a background job</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    TranscriptionJob.perform_later(audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  def self.process_transcription(audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    audio_segment = AudioSegment.find_by(id: audio_segment_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    unless audio_segment</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      Rails.logger.warn &quot;TranscriptionService: AudioSegment with id #{audio_segment_id} not found&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">      return { success: false, error: &quot;AudioSegment not found&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    project = audio_segment.project</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      # Update project status to transcribing if not already</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      unless project.status == &#39;transcribing&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">        project.update!(status: &#39;transcribing&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      # Transcribe the audio using Whisper API</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      transcription_result = transcribe_audio_segment(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      if transcription_result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">        # Store transcription result including word-level timestamps</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">        update_attrs = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">          upload_status: &#39;transcribed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">          transcription_text: transcription_result[:text]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">        # Add transcription_data if available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">        if transcription_result[:transcription_data]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">          update_attrs[:transcription_data] = transcription_result[:transcription_data]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">        audio_segment.update!(update_attrs)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">        Rails.logger.info &quot;Transcription successful for audio segment #{audio_segment_id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">        # Trigger unlimited questions generation if needed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">        if project.interview_length == &#39;unlimited&#39; &amp;&amp; audio_segment.question_id.present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">          UnlimitedQuestionsGenerationJob.perform_later(project.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">        { success: true, text: transcription_result[:text] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">        # Handle transcription failure</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">        audio_segment.update!(upload_status: &#39;transcription_failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">        project.update!(status: &#39;failed&#39;) unless project.audio_segments.where.not(upload_status: &#39;transcription_failed&#39;).exists?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">        Rails.logger.error &quot;Transcription failed for audio segment #{audio_segment_id}: #{transcription_result[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">        { success: false, error: transcription_result[:error] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">      Rails.logger.error &quot;Transcription processing error for audio segment #{audio_segment_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">      audio_segment.update!(upload_status: &#39;transcription_failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      project.update!(status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">      { success: false, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">  # Instance method for transcribing audio (used by VibeLogTranscriptionJob)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">  def transcribe_audio(file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    # Determine which transcription service to use</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">    transcription_provider = ENV[&#39;TRANSCRIPTION_PROVIDER&#39;] || &#39;whisper&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">    # Check API credentials based on provider</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    case transcription_provider.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="80">
            

            

            <code class="ruby">    when &#39;groq&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">      api_key = Rails.application.credentials.dig(:groq, :api_key) || ENV[&#39;GROQ_API_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">      unless api_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Groq API key not configured, falling back to mock transcription&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">        return &quot;Mock transcription: This is a test transcription for VibeLog entry.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            

            <code class="ruby">    when &#39;gemini&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">      api_key = Rails.application.credentials.dig(:gemini, :api_key) || ENV[&#39;GEMINI_API_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">      unless api_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Gemini API key not configured, falling back to mock transcription&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">        return &quot;Mock transcription: This is a test transcription for VibeLog entry.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">    else # whisper (default)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">      api_key = Rails.application.credentials.dig(:openai, :api_key) || ENV[&#39;OPENAI_API_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">      unless api_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">        Rails.logger.warn &quot;OpenAI API key not configured, falling back to mock transcription&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">        return &quot;Mock transcription: This is a test transcription for VibeLog entry.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">      # Read audio data from file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">      audio_data = File.read(file_path, mode: &#39;rb&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            

            <code class="ruby">      file_name = File.basename(file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">      # Create a mock audio segment for method compatibility</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">      mock_segment = OpenStruct.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">        id: &quot;vibelog_temp&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">        file_name: file_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">        mime_type: &quot;audio/m4a&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">      # Send to appropriate transcription API</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">      result = case transcription_provider.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">      when &#39;groq&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">        self.class.transcribe_with_groq(audio_data, mock_segment, api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">      when &#39;gemini&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">        self.class.transcribe_with_gemini(audio_data, mock_segment, api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">      else # whisper (default)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">        self.class.transcribe_with_whisper(audio_data, mock_segment, api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">      if result[:success]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">        result[:text]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">        Rails.logger.error &quot;Transcription failed: #{result[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">        raise &quot;Transcription failed: #{result[:error]}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error in transcription process: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">      # Fall back to mock transcription in development</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">      if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">        Rails.logger.info &quot;Falling back to mock transcription for development&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">        &quot;Mock transcription: This is a test transcription for VibeLog entry.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">        raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">  def self.transcribe_audio_segment(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            

            <code class="ruby">    # Determine which transcription service to use</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">    transcription_provider = ENV[&#39;TRANSCRIPTION_PROVIDER&#39;] || &#39;whisper&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">    # Check API credentials based on provider</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">    case transcription_provider.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">    when &#39;groq&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">      api_key = Rails.application.credentials.dig(:groq, :api_key) || ENV[&#39;GROQ_API_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">      unless api_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Groq API key not configured, falling back to mock transcription&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">        return generate_mock_transcription(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    when &#39;gemini&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">      api_key = Rails.application.credentials.dig(:gemini, :api_key) || ENV[&#39;GEMINI_API_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">      unless api_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Gemini API key not configured, falling back to mock transcription&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">        return generate_mock_transcription(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">    else # whisper (default)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="162">
            

            

            <code class="ruby">      api_key = Rails.application.credentials.dig(:openai, :api_key) || ENV[&#39;OPENAI_API_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      unless api_key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">        Rails.logger.warn &quot;OpenAI API key not configured, falling back to mock transcription&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">        return generate_mock_transcription(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="170">
            

            

            <code class="ruby">      # Download audio from S3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">      audio_data = download_audio_from_s3(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">      if audio_data.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Could not download audio from S3, falling back to mock transcription&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">        return generate_mock_transcription(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            

            <code class="ruby">      # Send to appropriate transcription API</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">      case transcription_provider.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">      when &#39;groq&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">        transcribe_with_groq(audio_data, audio_segment, api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">      when &#39;gemini&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">        transcribe_with_gemini(audio_data, audio_segment, api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="184">
            

            

            <code class="ruby">      else # whisper (default)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">        transcribe_with_whisper(audio_data, audio_segment, api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">      Rails.logger.error &quot;Error in transcription process: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            

            <code class="ruby">      # Fall back to mock transcription in development</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">      if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">        Rails.logger.info &quot;Falling back to mock transcription for development&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="193">
            

            

            <code class="ruby">        generate_mock_transcription(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">        { success: false, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="199">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">  def self.download_audio_from_s3(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            

            <code class="ruby">    # Use centralized S3Service for downloading audio</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">    s3_service = S3Service.new(audio_segment.project.user)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">    audio_data = s3_service.download_audio_data(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">      record_id: audio_segment.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">      record_type: &#39;audio_segment&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">      filename: audio_segment.file_name</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="210">
            

            

            <code class="ruby">    # Fallback to sample file if S3 fails</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">    if audio_data.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">      Rails.logger.error &quot;Failed to download audio from S3 via S3Service&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">      sample_file_path = Rails.root.join(&#39;..&#39;, &#39;sample_audio.m4a&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="214">
            

            

            <code class="ruby">      if File.exist?(sample_file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">        Rails.logger.info &quot;S3 failed, falling back to sample audio file&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">        return File.read(sample_file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">    audio_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">  def self.transcribe_with_whisper(audio_data, audio_segment, api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="225">
            

            

            <code class="ruby">      # Create a temporary file for the audio data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">      temp_file = Tempfile.new([&#39;audio_segment&#39;, File.extname(audio_segment.file_name)])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">      temp_file.binmode</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">      temp_file.write(audio_data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">      temp_file.close</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            

            <code class="ruby">      # Use HTTParty for direct API call</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">      url = &#39;https://api.openai.com/v1/audio/transcriptions&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">      response = HTTParty.post(url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">        headers: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">          &#39;Authorization&#39; =&gt; &quot;Bearer #{api_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">        },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">        body: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">          file: File.open(temp_file.path),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="240">
            

            

            <code class="ruby">          model: &#39;whisper-1&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">          language: &#39;en&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">          response_format: &#39;verbose_json&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="243">
            

            

            <code class="ruby">          timestamp_granularities: [&#39;word&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="246">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">      temp_file.unlink</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">      if response.success?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">        result = response.parsed_response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">        Rails.logger.info &quot;Whisper transcription successful for audio segment #{audio_segment.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="252">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="253">
            

            

            <code class="ruby">        # Extract word-level timestamps if available</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">        transcription_data = {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">        if result[&#39;words&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="256">
            

            

            <code class="ruby">          transcription_data[&#39;words&#39;] = result[&#39;words&#39;].map do |word|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">            {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="258">
            

            

            <code class="ruby">              &#39;word&#39; =&gt; word[&#39;word&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">              &#39;start&#39; =&gt; word[&#39;start&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">              &#39;end&#39; =&gt; word[&#39;end&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">            }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">        { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">          success: true, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">          text: result[&#39;text&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">          transcription_data: transcription_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="269">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">        error_message = response.parsed_response&amp;.dig(&#39;error&#39;, &#39;message&#39;) || &quot;HTTP #{response.code}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="272">
            

            

            <code class="ruby">        Rails.logger.error &quot;Whisper API error: #{error_message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">        { success: false, error: error_message }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="275">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">      Rails.logger.error &quot;Whisper API error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="278">
            

            

            <code class="ruby">      { success: false, error: e.message }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">    ensure</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="280">
            

            

            <code class="ruby">      # Clean up temp file if it exists</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">      temp_file&amp;.unlink rescue nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="282">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="283">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="284">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="285">
            

            

            <code class="ruby">  def self.transcribe_with_groq(audio_data, audio_segment, api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="286">
            

            

            <code class="ruby">    uri = URI(GROQ_API_URL)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="287">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="288">
            

            

            <code class="ruby">    boundary = &quot;----WebKitFormBoundary#{SecureRandom.hex(16)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="289">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="290">
            

            

            <code class="ruby">    # Create multipart form data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">    body = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">    body &lt;&lt; &quot;--#{boundary}\r\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">    body &lt;&lt; &quot;Content-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;#{audio_segment.file_name}\&quot;\r\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="294">
            

            

            <code class="ruby">    body &lt;&lt; &quot;Content-Type: #{audio_segment.mime_type}\r\n\r\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="295">
            

            

            <code class="ruby">    body &lt;&lt; audio_data</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="296">
            

            

            <code class="ruby">    body &lt;&lt; &quot;\r\n--#{boundary}\r\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="297">
            

            

            <code class="ruby">    body &lt;&lt; &quot;Content-Disposition: form-data; name=\&quot;model\&quot;\r\n\r\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="298">
            

            

            <code class="ruby">    body &lt;&lt; &quot;whisper-large-v3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">    body &lt;&lt; &quot;\r\n--#{boundary}\r\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">    body &lt;&lt; &quot;Content-Disposition: form-data; name=\&quot;language\&quot;\r\n\r\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="301">
            

            

            <code class="ruby">    body &lt;&lt; &quot;en&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="302">
            

            

            <code class="ruby">    body &lt;&lt; &quot;\r\n--#{boundary}--\r\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="303">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="304">
            

            

            <code class="ruby">    request = Net::HTTP::Post.new(uri)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="305">
            

            

            <code class="ruby">    request[&#39;Authorization&#39;] = &quot;Bearer #{api_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="306">
            

            

            <code class="ruby">    request[&#39;Content-Type&#39;] = &quot;multipart/form-data; boundary=#{boundary}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="307">
            

            

            <code class="ruby">    request.body = body.join</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="308">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="309">
            

            

            <code class="ruby">    http = Net::HTTP.new(uri.host, uri.port)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="310">
            

            

            <code class="ruby">    http.use_ssl = true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="311">
            

            

            <code class="ruby">    http.read_timeout = 60</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="312">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="313">
            

            

            <code class="ruby">    response = http.request(request)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="314">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="315">
            

            

            <code class="ruby">    if response.code == &#39;200&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="316">
            

            

            <code class="ruby">      result = JSON.parse(response.body)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="317">
            

            

            <code class="ruby">      { success: true, text: result[&#39;text&#39;] }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="318">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="319">
            

            

            <code class="ruby">      error_message = begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="320">
            

            

            <code class="ruby">        JSON.parse(response.body)[&#39;error&#39;][&#39;message&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="321">
            

            

            <code class="ruby">      rescue</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="322">
            

            

            <code class="ruby">        &quot;HTTP #{response.code}: #{response.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="323">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="324">
            

            

            <code class="ruby">      { success: false, error: error_message }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="325">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="326">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="327">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="328">
            

            

            <code class="ruby">  def self.transcribe_with_gemini(audio_data, audio_segment, api_key)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="329">
            

            

            <code class="ruby">    # Gemini doesn&#39;t have direct audio transcription API like Whisper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="330">
            

            

            <code class="ruby">    # For now, we&#39;ll use a workaround or return a note about this limitation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="331">
            

            

            <code class="ruby">    Rails.logger.warn &quot;Gemini audio transcription not directly supported - this is a placeholder implementation&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="332">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="333">
            

            

            <code class="ruby">    # In a real implementation, you might:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="334">
            

            

            <code class="ruby">    # 1. Use Google Speech-to-Text API instead</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="335">
            

            

            <code class="ruby">    # 2. Convert audio to a supported format for Gemini</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="336">
            

            

            <code class="ruby">    # 3. Use a different approach altogether</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="337">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="338">
            

            

            <code class="ruby">    { </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="339">
            

            

            <code class="ruby">      success: false, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="340">
            

            

            <code class="ruby">      error: &quot;Gemini direct audio transcription not implemented. Use Google Speech-to-Text API instead.&quot; </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="341">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="342">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="344">
            

            

            <code class="ruby">  def self.simulate_processing_delay</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="345">
            

            

            <code class="ruby">    # Simulate realistic processing time (2-8 seconds)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="346">
            

            

            <code class="ruby">    delay = rand(2..8)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="347">
            

            

            <code class="ruby">    Rails.logger.info &quot;Simulating transcription processing delay: #{delay} seconds&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="348">
            

            

            <code class="ruby">    sleep(delay) if Rails.env.development?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="349">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="350">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="351">
            

            

            <code class="ruby">  def self.should_transcription_succeed?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="352">
            

            

            <code class="ruby">    # 90% success rate for realistic testing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">    rand(100) &lt; 90</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="354">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="355">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="356">
            

            

            <code class="ruby">  def self.generate_mock_transcription(audio_segment)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="357">
            

            

            <code class="ruby">    question = audio_segment.question</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="358">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="359">
            

            

            <code class="ruby">    if question</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="360">
            

            

            <code class="ruby">      # Generate contextual mock transcription based on question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">      mock_text = generate_contextual_response(question.text)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            

            <code class="ruby">      # Generic mock transcription</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="364">
            

            

            <code class="ruby">      mock_text = generate_generic_response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="365">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="366">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="367">
            

            

            <code class="ruby">    # Generate mock word-level timestamps</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="368">
            

            

            <code class="ruby">    words = mock_text.split(&#39; &#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="369">
            

            

            <code class="ruby">    mock_words = []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="370">
            

            

            <code class="ruby">    current_time = 0.0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="371">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="372">
            

            

            <code class="ruby">    words.each do |word|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="373">
            

            

            <code class="ruby">      word_duration = rand(0.2..0.8) # Random word duration between 0.2-0.8 seconds</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="374">
            

            

            <code class="ruby">      mock_words &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="375">
            

            

            <code class="ruby">        &#39;word&#39; =&gt; word,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="376">
            

            

            <code class="ruby">        &#39;start&#39; =&gt; current_time.round(3),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="377">
            

            

            <code class="ruby">        &#39;end&#39; =&gt; (current_time + word_duration).round(3)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="378">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="379">
            

            

            <code class="ruby">      current_time += word_duration + rand(0.1..0.3) # Add pause between words</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="380">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="381">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="382">
            

            

            <code class="ruby">    transcription_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="383">
            

            

            <code class="ruby">      &#39;words&#39; =&gt; mock_words</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="384">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="385">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="386">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="387">
            

            

            <code class="ruby">      success: true,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="388">
            

            

            <code class="ruby">      text: mock_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="389">
            

            

            <code class="ruby">      transcription_data: transcription_data,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="390">
            

            

            <code class="ruby">      confidence: rand(0.85..0.98).round(3),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="391">
            

            

            <code class="ruby">      duration: audio_segment.duration_seconds || rand(30..180),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="392">
            

            

            <code class="ruby">      language: &#39;en-US&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="393">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="394">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="395">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="396">
            

            

            <code class="ruby">  def self.generate_contextual_response(question_text)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="397">
            

            

            <code class="ruby">    # Generate realistic responses based on question patterns</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="398">
            

            

            <code class="ruby">    case question_text.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="399">
            

            

            <code class="ruby">    when /name|who are you|introduce/</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="400">
            

            

            <code class="ruby">      [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="401">
            

            

            <code class="ruby">        &quot;My name is Sarah Johnson and I&#39;m a software engineer based in San Francisco.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="402">
            

            

            <code class="ruby">        &quot;I&#39;m Alex Thompson, a freelance writer and photographer from Portland.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="403">
            

            

            <code class="ruby">        &quot;Hi, I&#39;m Maria Rodriguez. I work as a marketing director for a tech startup.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="404">
            

            

            <code class="ruby">      ].sample</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="405">
            

            

            <code class="ruby">    when /background|experience|career/</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="406">
            

            

            <code class="ruby">      [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="407">
            

            

            <code class="ruby">        &quot;I have about eight years of experience in software development, primarily working with web technologies and mobile applications.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="408">
            

            

            <code class="ruby">        &quot;I started my career in journalism but transitioned to content marketing about five years ago.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="409">
            

            

            <code class="ruby">        &quot;My background is in graphic design, but I&#39;ve recently been focusing more on user experience research.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="410">
            

            

            <code class="ruby">      ].sample</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="411">
            

            

            <code class="ruby">    when /challenge|difficult|problem/</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="412">
            

            

            <code class="ruby">      [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="413">
            

            

            <code class="ruby">        &quot;One of the biggest challenges I faced was when our entire database crashed during a product launch. We had to rebuild everything from backups while maintaining service.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="414">
            

            

            <code class="ruby">        &quot;The most difficult situation was probably when I had to manage a team through a major company restructuring.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="415">
            

            

            <code class="ruby">        &quot;I struggled with imposter syndrome early in my career, especially when transitioning from design to development.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="416">
            

            

            <code class="ruby">      ].sample</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="417">
            

            

            <code class="ruby">    when /goal|future|plan/</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="418">
            

            

            <code class="ruby">      [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="419">
            

            

            <code class="ruby">        &quot;My main goal is to eventually lead a product team and help build solutions that really make a difference in people&#39;s lives.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="420">
            

            

            <code class="ruby">        &quot;I&#39;m planning to start my own consultancy focused on helping small businesses with their digital marketing strategies.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="421">
            

            

            <code class="ruby">        &quot;In the future, I&#39;d love to combine my technical skills with teaching and maybe develop educational technology.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            

            

            <code class="ruby">      ].sample</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="423">
            

            

            <code class="ruby">    when /learn|advice|tip/</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="424">
            

            

            <code class="ruby">      [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="425">
            

            

            <code class="ruby">        &quot;The most important thing I&#39;ve learned is that clear communication is just as important as technical skills in this field.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="426">
            

            

            <code class="ruby">        &quot;My advice would be to never stop learning and to always be open to feedback, even when it&#39;s hard to hear.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="427">
            

            

            <code class="ruby">        &quot;I think the key is to focus on solving real problems rather than just using the latest technology because it&#39;s trendy.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="428">
            

            

            <code class="ruby">      ].sample</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="429">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="430">
            

            

            <code class="ruby">      # Generic thoughtful response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="431">
            

            

            <code class="ruby">      [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="432">
            

            

            <code class="ruby">        &quot;That&#39;s a really interesting question. I think it depends on the specific context and what you&#39;re trying to achieve.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="433">
            

            

            <code class="ruby">        &quot;Well, from my experience, I&#39;ve found that the most important factor is usually understanding your audience and their needs.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="434">
            

            

            <code class="ruby">        &quot;I believe the key is finding the right balance between innovation and practicality in whatever approach you take.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="435">
            

            

            <code class="ruby">        &quot;That&#39;s something I&#39;ve been thinking about a lot lately, and I think there are several different ways to approach it.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="436">
            

            

            <code class="ruby">      ].sample</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="437">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="438">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="439">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="440">
            

            

            <code class="ruby">  def self.generate_generic_response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="441">
            

            

            <code class="ruby">    [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="442">
            

            

            <code class="ruby">      &quot;Thank you for that question. I think this is something that many people in our industry are grappling with right now.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="443">
            

            

            <code class="ruby">      &quot;That&#39;s a great point. In my experience, the most effective approach is usually to start small and iterate based on feedback.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="444">
            

            

            <code class="ruby">      &quot;I appreciate you asking about that. It&#39;s definitely been a learning experience for me over the past few years.&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="445">
            

            

            <code class="ruby">      &quot;That&#39;s something I&#39;m passionate about. I believe we need to focus more on sustainable practices and long-term thinking.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="446">
            

            

            <code class="ruby">    ].sample</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="447">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="448">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="449">
            

            

            <code class="ruby">  def self.all_segments_transcribed?(project)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="450">
            

            

            <code class="ruby">    # Check if all successfully uploaded segments have been transcribed</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="451">
            

            

            <code class="ruby">    successful_segments = project.audio_segments.where(upload_status: [&#39;success&#39;, &#39;transcribed&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="452">
            

            

            <code class="ruby">    return true if successful_segments.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="453">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="454">
            

            

            <code class="ruby">    successful_segments.all? { |segment| segment.upload_status == &#39;transcribed&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="455">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="456">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="52882c73ad5556576f9ed7b831d0c6e8e0c9e69a">
  <div class="header">
    <h3>app/services/user_data_export_service.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>418</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>418</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">require &#39;csv&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">require &#39;zip&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">require &#39;fileutils&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">class UserDataExportService</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">  def initialize(user, export_record = nil)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    @user = user</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    @export_record = export_record</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    @export_timestamp = Time.current.strftime(&#39;%Y%m%d_%H%M%S&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">  def create_complete_export</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    Rails.logger.info &quot;Creating complete data export for user #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">    # Update status to processing</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">    @export_record&amp;.update!(status: &#39;processing&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">    # Create temporary directory for export</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    export_dir = create_export_directory</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      # Capture current data IDs for freshness tracking</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">      current_project_id = @user.projects.maximum(:id) || 0</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      current_audio_segment_id = @user.projects.joins(:audio_segments).maximum(&#39;audio_segments.id&#39;) || 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      # Generate CSV files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      csv_files = generate_csv_files(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">      # Download and organize S3 files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">      s3_files = collect_s3_files(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">      # Create README file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      create_readme_file(export_dir, csv_files.keys, s3_files.keys)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      # Create zip file</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="36">
            

            

            <code class="ruby">      zip_path = create_zip_file(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">      # Upload to S3 and get file info</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      s3_key, file_size = upload_to_s3(zip_path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      file_count = csv_files.size + s3_files.values.sum { |desc| desc.to_s.scan(/\d+/).first.to_i }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      # Update export record with completion info</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">      if @export_record</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="44">
            

            

            <code class="ruby">        @export_record.update!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">          status: &#39;completed&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">          s3_key: s3_key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">          file_count: file_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">          total_size_bytes: file_size,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">          highest_project_id: current_project_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">          highest_audio_segment_id: current_audio_segment_id</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">        )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="54">
            

            

            <code class="ruby">      Rails.logger.info &quot;Export completed successfully for user #{@user.id}: #{s3_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">      { s3_key: s3_key, file_size: file_size, file_count: file_count }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">      Rails.logger.error &quot;Export failed for user #{@user.id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">      @export_record&amp;.update!(status: &#39;failed&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">      cleanup_directory(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">      raise e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">  def create_export_directory</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">    export_dir = Rails.root.join(&#39;tmp&#39;, &quot;user_export_#{@user.id}_#{@export_timestamp}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    FileUtils.mkdir_p(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    FileUtils.mkdir_p(export_dir.join(&#39;data&#39;))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    FileUtils.mkdir_p(export_dir.join(&#39;audio_files&#39;))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="72">
            

            

            <code class="ruby">    FileUtils.mkdir_p(export_dir.join(&#39;logs&#39;))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    export_dir</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">  def generate_csv_files(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">    data_dir = export_dir.join(&#39;data&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">    csv_files = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">    # Users CSV</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">    csv_files[&#39;users.csv&#39;] = generate_users_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">    # Projects CSV</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">    csv_files[&#39;projects.csv&#39;] = generate_projects_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">    # Questions CSV (includes answers)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    csv_files[&#39;questions.csv&#39;] = generate_questions_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">    # Audio Segments CSV</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">    csv_files[&#39;audio_segments.csv&#39;] = generate_audio_segments_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">    # Transcripts CSV</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            

            <code class="ruby">    csv_files[&#39;transcripts.csv&#39;] = generate_transcripts_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="94">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">    # Feedbacks CSV</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">    csv_files[&#39;feedbacks.csv&#39;] = generate_feedbacks_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="97">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="98">
            

            

            <code class="ruby">    # Device Logs CSV</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">    csv_files[&#39;device_logs.csv&#39;] = generate_device_logs_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">    # Advisor Interactions CSV</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">    csv_files[&#39;advisor_interactions.csv&#39;] = generate_advisor_interactions_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">    Rails.logger.info &quot;Generated #{csv_files.size} CSV files for user #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            

            <code class="ruby">    csv_files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            

            <code class="ruby">  def generate_users_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">    file_path = data_dir.join(&#39;users.csv&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="110">
            

            

            <code class="ruby">    CSV.open(file_path, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">      csv &lt;&lt; [&#39;id&#39;, &#39;email&#39;, &#39;interests&#39;, &#39;admin&#39;, &#39;created_at&#39;, &#39;updated_at&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            

            <code class="ruby">        @user.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">        @user.email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            

            <code class="ruby">        @user.interests&amp;.join(&#39;;&#39;),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">        @user.admin?,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            

            <code class="ruby">        @user.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">        @user.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="121">
            

            

            <code class="ruby">    file_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            

            <code class="ruby">  def generate_projects_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">    file_path = data_dir.join(&#39;projects.csv&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">    CSV.open(file_path, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">        &#39;id&#39;, &#39;title&#39;, &#39;status&#39;, &#39;topic&#39;, &#39;is_speech_interview&#39;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">        &#39;voice_id&#39;, &#39;speech_rate&#39;, &#39;interview_length&#39;, &#39;question_count&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">        &#39;created_at&#39;, &#39;updated_at&#39;, &#39;last_modified_at&#39;, &#39;last_accessed_at&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">      @user.projects.find_each do |project|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">        csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            

            <code class="ruby">          project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">          project.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">          project.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">          project.topic,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">          project.is_speech_interview,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="140">
            

            

            <code class="ruby">          project.voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">          project.speech_rate,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="142">
            

            

            <code class="ruby">          project.interview_length,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">          project.question_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">          project.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="145">
            

            

            <code class="ruby">          project.updated_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">          project.last_modified_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">          project.last_accessed_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">    file_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">  def generate_questions_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">    file_path = data_dir.join(&#39;questions.csv&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">    CSV.open(file_path, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">        &#39;id&#39;, &#39;project_id&#39;, &#39;chapter_title&#39;, &#39;section_title&#39;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">        &#39;question_text&#39;, &#39;question_order&#39;, &#39;is_follow_up&#39;, &#39;parent_question_id&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">        &#39;has_response&#39;, &#39;transcribed_response&#39;, &#39;created_at&#39;, &#39;updated_at&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">      @user.projects.includes(:questions).find_each do |project|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">        project.questions.find_each do |question|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="165">
            

            

            <code class="ruby">          csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">            question.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">            project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">            question.section&amp;.chapter&amp;.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">            question.section&amp;.title,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">            question.text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">            question.order,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">            question.parent_question_id.present?,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">            question.parent_question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="174">
            

            

            <code class="ruby">            question.has_response?,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">            question.transcribed_response,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">            question.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="177">
            

            

            <code class="ruby">            question.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">          ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="182">
            

            

            <code class="ruby">    file_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="183">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="185">
            

            

            <code class="ruby">  def generate_audio_segments_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="186">
            

            

            <code class="ruby">    file_path = data_dir.join(&#39;audio_segments.csv&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="187">
            

            

            <code class="ruby">    CSV.open(file_path, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="188">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="189">
            

            

            <code class="ruby">        &#39;id&#39;, &#39;project_id&#39;, &#39;question_id&#39;, &#39;file_name&#39;, &#39;mime_type&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="190">
            

            

            <code class="ruby">        &#39;duration_seconds&#39;, &#39;s3_url&#39;, &#39;upload_status&#39;, &#39;transcription_text&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="191">
            

            

            <code class="ruby">        &#39;created_at&#39;, &#39;updated_at&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="192">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="194">
            

            

            <code class="ruby">      @user.projects.includes(:audio_segments).find_each do |project|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="195">
            

            

            <code class="ruby">        project.audio_segments.find_each do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="196">
            

            

            <code class="ruby">          csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="197">
            

            

            <code class="ruby">            segment.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="198">
            

            

            <code class="ruby">            project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="199">
            

            

            <code class="ruby">            segment.question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="200">
            

            

            <code class="ruby">            segment.file_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="201">
            

            

            <code class="ruby">            segment.mime_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="202">
            

            

            <code class="ruby">            segment.duration_seconds,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="203">
            

            

            <code class="ruby">            segment.s3_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="204">
            

            

            <code class="ruby">            segment.upload_status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="205">
            

            

            <code class="ruby">            segment.transcription_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="206">
            

            

            <code class="ruby">            segment.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="207">
            

            

            <code class="ruby">            segment.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="208">
            

            

            <code class="ruby">          ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="209">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="210">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="211">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="212">
            

            

            <code class="ruby">    file_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="213">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="214">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="215">
            

            

            <code class="ruby">  def generate_transcripts_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="216">
            

            

            <code class="ruby">    file_path = data_dir.join(&#39;transcripts.csv&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="217">
            

            

            <code class="ruby">    CSV.open(file_path, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="218">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="219">
            

            

            <code class="ruby">        &#39;id&#39;, &#39;project_id&#39;, &#39;status&#39;, &#39;raw_content&#39;, &#39;edited_content&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="220">
            

            

            <code class="ruby">        &#39;created_at&#39;, &#39;updated_at&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="221">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="223">
            

            

            <code class="ruby">      @user.projects.includes(:transcript).find_each do |project|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="224">
            

            

            <code class="ruby">        if project.transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="225">
            

            

            <code class="ruby">          transcript = project.transcript</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="226">
            

            

            <code class="ruby">          csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="227">
            

            

            <code class="ruby">            transcript.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="228">
            

            

            <code class="ruby">            project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="229">
            

            

            <code class="ruby">            transcript.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="230">
            

            

            <code class="ruby">            transcript.raw_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="231">
            

            

            <code class="ruby">            transcript.edited_content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="232">
            

            

            <code class="ruby">            transcript.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="233">
            

            

            <code class="ruby">            transcript.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="234">
            

            

            <code class="ruby">          ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="235">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="236">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="237">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="238">
            

            

            <code class="ruby">    file_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="239">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="241">
            

            

            <code class="ruby">  def generate_feedbacks_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="242">
            

            

            <code class="ruby">    file_path = data_dir.join(&#39;feedbacks.csv&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="243">
            

            

            <code class="ruby">    CSV.open(file_path, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="244">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="245">
            

            

            <code class="ruby">        &#39;id&#39;, &#39;feedback_text&#39;, &#39;feedback_type&#39;, &#39;email&#39;, &#39;resolved&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="246">
            

            

            <code class="ruby">        &#39;admin_notes&#39;, &#39;created_at&#39;, &#39;updated_at&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="247">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="248">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="249">
            

            

            <code class="ruby">      @user.feedbacks.find_each do |feedback|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="250">
            

            

            <code class="ruby">        csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="251">
            

            

            <code class="ruby">          feedback.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="252">
            

            

            <code class="ruby">          feedback.feedback_text,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="253">
            

            

            <code class="ruby">          feedback.feedback_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="254">
            

            

            <code class="ruby">          feedback.email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="255">
            

            

            <code class="ruby">          feedback.resolved,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="256">
            

            

            <code class="ruby">          feedback.admin_notes,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="257">
            

            

            <code class="ruby">          feedback.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="258">
            

            

            <code class="ruby">          feedback.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="259">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="260">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="261">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="262">
            

            

            <code class="ruby">    file_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="263">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="264">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="265">
            

            

            <code class="ruby">  def generate_device_logs_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="266">
            

            

            <code class="ruby">    file_path = data_dir.join(&#39;device_logs.csv&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="267">
            

            

            <code class="ruby">    CSV.open(file_path, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="268">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="269">
            

            

            <code class="ruby">        &#39;id&#39;, &#39;device_id&#39;, &#39;build_version&#39;, &#39;os_version&#39;, &#39;log_type&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="270">
            

            

            <code class="ruby">        &#39;s3_url&#39;, &#39;uploaded_at&#39;, &#39;created_at&#39;, &#39;updated_at&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="271">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="272">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="273">
            

            

            <code class="ruby">      @user.device_logs.find_each do |log|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="274">
            

            

            <code class="ruby">        csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="275">
            

            

            <code class="ruby">          log.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="276">
            

            

            <code class="ruby">          log.device_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="277">
            

            

            <code class="ruby">          log.build_version,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="278">
            

            

            <code class="ruby">          log.os_version,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="279">
            

            

            <code class="ruby">          log.log_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="280">
            

            

            <code class="ruby">          log.s3_url,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="281">
            

            

            <code class="ruby">          log.uploaded_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="282">
            

            

            <code class="ruby">          log.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="283">
            

            

            <code class="ruby">          log.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="284">
            

            

            <code class="ruby">        ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="285">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="286">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="287">
            

            

            <code class="ruby">    file_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="288">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="289">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="290">
            

            

            <code class="ruby">  def generate_advisor_interactions_csv(data_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="291">
            

            

            <code class="ruby">    file_path = data_dir.join(&#39;advisor_interactions.csv&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="292">
            

            

            <code class="ruby">    CSV.open(file_path, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="293">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="294">
            

            

            <code class="ruby">        &#39;id&#39;, &#39;project_id&#39;, &#39;advisor_id&#39;, &#39;question&#39;, &#39;response&#39;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="295">
            

            

            <code class="ruby">        &#39;status&#39;, &#39;created_at&#39;, &#39;updated_at&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="296">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="297">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="298">
            

            

            <code class="ruby">      # Check if advisor_interactions association exists</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="299">
            

            

            <code class="ruby">      if @user.projects.first&amp;.respond_to?(:advisor_interactions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="300">
            

            

            <code class="ruby">        @user.projects.includes(:advisor_interactions).find_each do |project|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="301">
            

            

            <code class="ruby">          project.advisor_interactions.find_each do |interaction|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="302">
            

            

            <code class="ruby">            csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="303">
            

            

            <code class="ruby">              interaction.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="304">
            

            

            <code class="ruby">              project.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="305">
            

            

            <code class="ruby">              interaction.advisor_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="306">
            

            

            <code class="ruby">              interaction.question,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="307">
            

            

            <code class="ruby">              interaction.response,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="308">
            

            

            <code class="ruby">              interaction.status,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="309">
            

            

            <code class="ruby">              interaction.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="310">
            

            

            <code class="ruby">              interaction.updated_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="311">
            

            

            <code class="ruby">            ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="312">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="313">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="314">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="315">
            

            

            <code class="ruby">        # Association doesn&#39;t exist, just write headers</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="316">
            

            

            <code class="ruby">        Rails.logger.info &quot;AdvisorInteraction model not found, skipping advisor interactions export&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="317">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="318">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="319">
            

            

            <code class="ruby">    file_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="320">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="321">
            

            

            <code class="ruby">    Rails.logger.warn &quot;Failed to generate advisor interactions CSV: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="322">
            

            

            <code class="ruby">    # Create empty file with headers</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="323">
            

            

            <code class="ruby">    CSV.open(file_path, &#39;w&#39;) do |csv|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="324">
            

            

            <code class="ruby">      csv &lt;&lt; [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="325">
            

            

            <code class="ruby">        &#39;id&#39;, &#39;project_id&#39;, &#39;advisor_id&#39;, &#39;question&#39;, &#39;response&#39;, </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="326">
            

            

            <code class="ruby">        &#39;status&#39;, &#39;created_at&#39;, &#39;updated_at&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="327">
            

            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="328">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="329">
            

            

            <code class="ruby">    file_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="330">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="331">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="332">
            

            

            <code class="ruby">  def collect_s3_files(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="333">
            

            

            <code class="ruby">    Rails.logger.info &quot;Collecting S3 files for user #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="334">
            

            

            <code class="ruby">    s3_files = {}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="335">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="336">
            

            

            <code class="ruby">    # Get all audio segments</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="337">
            

            

            <code class="ruby">    audio_count = collect_audio_files(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="338">
            

            

            <code class="ruby">    s3_files[&#39;audio_files&#39;] = &quot;#{audio_count} audio files&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="339">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="340">
            

            

            <code class="ruby">    # Get device logs if any</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="341">
            

            

            <code class="ruby">    log_count = collect_device_log_files(export_dir)  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="342">
            

            

            <code class="ruby">    s3_files[&#39;device_logs&#39;] = &quot;#{log_count} log files&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="343">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="344">
            

            

            <code class="ruby">    Rails.logger.info &quot;Collected #{audio_count} audio files and #{log_count} log files&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="345">
            

            

            <code class="ruby">    s3_files</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="346">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="347">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="348">
            

            

            <code class="ruby">  def collect_audio_files(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="349">
            

            

            <code class="ruby">    audio_dir = export_dir.join(&#39;audio_files&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="350">
            

            

            <code class="ruby">    count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="351">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="352">
            

            

            <code class="ruby">    @user.projects.includes(:audio_segments).find_each do |project|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="353">
            

            

            <code class="ruby">      project.audio_segments.where.not(s3_url: nil).find_each do |segment|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="354">
            

            

            <code class="ruby">        begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="355">
            

            

            <code class="ruby">          if download_s3_file(segment.s3_url, audio_dir, &quot;project_#{project.id}_#{segment.file_name}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="356">
            

            

            <code class="ruby">            count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="357">
            

            

            <code class="ruby">          end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="358">
            

            

            <code class="ruby">        rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="359">
            

            

            <code class="ruby">          Rails.logger.warn &quot;Failed to download audio file #{segment.s3_url}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="360">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="361">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="362">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="363">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="364">
            

            

            <code class="ruby">    count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="365">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="366">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="367">
            

            

            <code class="ruby">  def collect_device_log_files(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="368">
            

            

            <code class="ruby">    logs_dir = export_dir.join(&#39;logs&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="369">
            

            

            <code class="ruby">    count = 0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="370">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="371">
            

            

            <code class="ruby">    @user.device_logs.where.not(s3_url: nil).find_each do |log|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="372">
            

            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="373">
            

            

            <code class="ruby">        filename = &quot;device_log_#{log.id}_#{log.device_id}.txt&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="374">
            

            

            <code class="ruby">        if download_s3_file(log.s3_url, logs_dir, filename)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="375">
            

            

            <code class="ruby">          count += 1</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="376">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="377">
            

            

            <code class="ruby">      rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="378">
            

            

            <code class="ruby">        Rails.logger.warn &quot;Failed to download device log #{log.s3_url}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="379">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="380">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="381">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="382">
            

            

            <code class="ruby">    count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="383">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="384">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="385">
            

            

            <code class="ruby">  def download_s3_file(s3_url, target_dir, filename)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="386">
            

            

            <code class="ruby">    return false if s3_url.blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="387">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="388">
            

            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="389">
            

            

            <code class="ruby">      # Parse S3 URL to get bucket and key</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="390">
            

            

            <code class="ruby">      uri = URI.parse(s3_url)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="391">
            

            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="392">
            

            

            <code class="ruby">      if uri.host&amp;.include?(&#39;amazonaws.com&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="393">
            

            

            <code class="ruby">        # Extract bucket and key from S3 URL</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="394">
            

            

            <code class="ruby">        path_parts = uri.path[1..-1].split(&#39;/&#39;, 2)  # Remove leading slash</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="395">
            

            

            <code class="ruby">        bucket = path_parts[0] || uri.host.split(&#39;.&#39;).first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="396">
            

            

            <code class="ruby">        key = path_parts[1] || uri.path[1..-1]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="397">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="398">
            

            

            <code class="ruby">        s3_client = Aws::S3::Client.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="399">
            

            

            <code class="ruby">        target_path = target_dir.join(filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="400">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="401">
            

            

            <code class="ruby">        s3_client.get_object(bucket: bucket, key: key, response_target: target_path.to_s)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="402">
            

            

            <code class="ruby">        true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="403">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="404">
            

            

            <code class="ruby">        # For non-S3 URLs, try direct HTTP download</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="405">
            

            

            <code class="ruby">        require &#39;open-uri&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="406">
            

            

            <code class="ruby">        target_path = target_dir.join(filename)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="407">
            

            

            <code class="ruby">        File.open(target_path, &#39;wb&#39;) do |file|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="408">
            

            

            <code class="ruby">          URI.open(s3_url) { |data| file.write(data.read) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="409">
            

            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="410">
            

            

            <code class="ruby">        true</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="411">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="412">
            

            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="413">
            

            

            <code class="ruby">      Rails.logger.error &quot;Failed to download file #{s3_url}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="414">
            

            

            <code class="ruby">      false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="415">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="416">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="417">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="418">
            

            

            <code class="ruby">  def create_readme_file(export_dir, csv_files, s3_categories)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="419">
            

            

            <code class="ruby">    readme_path = export_dir.join(&#39;README.txt&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="420">
            

            

            <code class="ruby">    File.open(readme_path, &#39;w&#39;) do |f|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="421">
            

            

            <code class="ruby">      f.puts &quot;=== INKRA DATA EXPORT ===&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="422">
            

            

            <code class="ruby">      f.puts &quot;Export created: #{Time.current}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="423">
            

            

            <code class="ruby">      f.puts &quot;User ID: #{@user.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="424">
            

            

            <code class="ruby">      f.puts &quot;User Email: #{@user.email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="425">
            

            

            <code class="ruby">      f.puts &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="426">
            

            

            <code class="ruby">      f.puts &quot;This export contains all your data from Inkra:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="427">
            

            

            <code class="ruby">      f.puts &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="428">
            

            

            <code class="ruby">      f.puts &quot;DATA FILES (CSV format):&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="429">
            

            

            <code class="ruby">      csv_files.each { |filename| f.puts &quot;  - #{filename}&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="430">
            

            

            <code class="ruby">      f.puts &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="431">
            

            

            <code class="ruby">      f.puts &quot;AUDIO FILES:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="432">
            

            

            <code class="ruby">      f.puts &quot;  - All your interview recordings organized by project&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="433">
            

            

            <code class="ruby">      f.puts &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="434">
            

            

            <code class="ruby">      f.puts &quot;LOG FILES:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="435">
            

            

            <code class="ruby">      f.puts &quot;  - Device logs and crash reports (if any)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="436">
            

            

            <code class="ruby">      f.puts &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="437">
            

            

            <code class="ruby">      f.puts &quot;CSV FILE DESCRIPTIONS:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="438">
            

            

            <code class="ruby">      f.puts &quot;  - users.csv: Your account information and preferences&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="439">
            

            

            <code class="ruby">      f.puts &quot;  - projects.csv: All your interview projects and metadata&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="440">
            

            

            <code class="ruby">      f.puts &quot;  - questions.csv: All interview questions and your answers&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="441">
            

            

            <code class="ruby">      f.puts &quot;  - audio_segments.csv: Metadata about your audio recordings&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="442">
            

            

            <code class="ruby">      f.puts &quot;  - transcripts.csv: Text transcriptions of your interviews&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="443">
            

            

            <code class="ruby">      f.puts &quot;  - feedbacks.csv: Any feedback you&#39;ve provided to Inkra&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="444">
            

            

            <code class="ruby">      f.puts &quot;  - device_logs.csv: Technical logs from your device&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="445">
            

            

            <code class="ruby">      f.puts &quot;  - advisor_interactions.csv: Your interactions with AI advisors&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="446">
            

            

            <code class="ruby">      f.puts &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="447">
            

            

            <code class="ruby">      f.puts &quot;IMPORT INSTRUCTIONS:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="448">
            

            

            <code class="ruby">      f.puts &quot;  - CSV files can be opened in Excel, Google Sheets, or any spreadsheet app&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="449">
            

            

            <code class="ruby">      f.puts &quot;  - Audio files are in their original format (usually M4A or MP3)&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="450">
            

            

            <code class="ruby">      f.puts &quot;  - All timestamps are in UTC format&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="451">
            

            

            <code class="ruby">      f.puts &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="452">
            

            

            <code class="ruby">      f.puts &quot;If you have questions about this export, contact support@inkra.app&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="453">
            

            

            <code class="ruby">      f.puts &quot;&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="454">
            

            

            <code class="ruby">      f.puts &quot;Thank you for using Inkra to capture your stories!&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="455">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="456">
            

            

            <code class="ruby">    readme_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="457">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="458">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="459">
            

            

            <code class="ruby">  def create_zip_file(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="460">
            

            

            <code class="ruby">    zip_filename = &quot;user_#{@user.id}_export_#{@export_timestamp}.zip&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="461">
            

            

            <code class="ruby">    zip_path = Rails.root.join(&#39;tmp&#39;, zip_filename)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="462">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="463">
            

            

            <code class="ruby">    Zip::File.open(zip_path, Zip::File::CREATE) do |zipfile|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="464">
            

            

            <code class="ruby">      Dir.glob(File.join(export_dir, &#39;**&#39;, &#39;*&#39;)).each do |file|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="465">
            

            

            <code class="ruby">        next if File.directory?(file)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="466">
            

            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="467">
            

            

            <code class="ruby">        # Get relative path from export directory</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="468">
            

            

            <code class="ruby">        relative_path = Pathname.new(file).relative_path_from(Pathname.new(export_dir.to_s))</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="469">
            

            

            <code class="ruby">        zipfile.add(relative_path.to_s, file)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="470">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="471">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="472">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="473">
            

            

            <code class="ruby">    zip_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="474">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="475">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="476">
            

            

            <code class="ruby">  def upload_to_s3(zip_file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="477">
            

            

            <code class="ruby">    return nil, 0 unless zip_file_path &amp;&amp; File.exist?(zip_file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="478">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="479">
            

            

            <code class="ruby">    timestamp = Time.current.strftime(&#39;%Y%m%d_%H%M%S&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="480">
            

            

            <code class="ruby">    s3_key = &quot;user-exports/user_#{@user.id}_export_#{timestamp}.zip&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="481">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="482">
            

            

            <code class="ruby">    # Get S3 client</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="483">
            

            

            <code class="ruby">    s3_client = Aws::S3::Client.new</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="484">
            

            

            <code class="ruby">    bucket_name = Rails.application.credentials.dig(:aws, :s3_bucket) || ENV[&#39;AWS_S3_BUCKET&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="485">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="486">
            

            

            <code class="ruby">    file_size = File.size(zip_file_path)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="487">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="488">
            

            

            <code class="ruby">    File.open(zip_file_path, &#39;rb&#39;) do |file|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="489">
            

            

            <code class="ruby">      s3_client.put_object(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="490">
            

            

            <code class="ruby">        bucket: bucket_name,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="491">
            

            

            <code class="ruby">        key: s3_key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="492">
            

            

            <code class="ruby">        body: file,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="493">
            

            

            <code class="ruby">        content_type: &#39;application/zip&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="494">
            

            

            <code class="ruby">        metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="495">
            

            

            <code class="ruby">          &#39;user-id&#39; =&gt; @user.id.to_s,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="496">
            

            

            <code class="ruby">          &#39;export-created-at&#39; =&gt; Time.current.iso8601</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="497">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="498">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="499">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="500">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="501">
            

            

            <code class="ruby">    [s3_key, file_size]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="502">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="503">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to upload export to S3: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="504">
            

            

            <code class="ruby">    raise &quot;Failed to upload export file to cloud storage&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="505">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="506">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="507">
            

            

            <code class="ruby">  def cleanup_directory(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="508">
            

            

            <code class="ruby">    FileUtils.rm_rf(export_dir) if export_dir &amp;&amp; Dir.exist?(export_dir)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="509">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="510">
            

            

            <code class="ruby">    Rails.logger.warn &quot;Failed to cleanup export directory #{export_dir}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="511">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="512">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cf583b717d2b7683b80f90ce524ba73524a5eb72">
  <div class="header">
    <h3>app/services/voice_demo_generator.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>59</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>59</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class VoiceDemoGenerator</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  DEMO_TEXT = &quot;Hi there! This is a sample of my voice. I can help bring your story to life with natural, expressive narration.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  CURATED_VOICES = [</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    { id: &#39;Matthew&#39;, engine: &#39;neural&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    { id: &#39;Joanna&#39;, engine: &#39;neural&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            

            <code class="ruby">    { id: &#39;Amy&#39;, engine: &#39;neural&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    { id: &#39;Brian&#39;, engine: &#39;neural&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    { id: &#39;Emma&#39;, engine: &#39;neural&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    { id: &#39;Olivia&#39;, engine: &#39;neural&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    { id: &#39;Arthur&#39;, engine: &#39;neural&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    { id: &#39;Daniel&#39;, engine: &#39;neural&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    { id: &#39;Aria&#39;, engine: &#39;neural&#39; },</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">    { id: &#39;Gregory&#39;, engine: &#39;neural&#39; }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">  ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">  def self.generate_all_demos</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    CURATED_VOICES.map do |voice_config|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">      generate_demo(voice_config[:id], voice_config[:engine])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">  def self.generate_demo(voice_id, engine = &#39;neural&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">    polly_client = Aws::Polly::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      region: ENV[&#39;AWS_REGION&#39;] || &#39;us-east-1&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      access_key_id: ENV[&#39;AWS_ACCESS_KEY_ID&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      secret_access_key: ENV[&#39;AWS_SECRET_ACCESS_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    s3_client = Aws::S3::Client.new(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">      region: ENV[&#39;AWS_REGION&#39;] || &#39;us-east-1&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">      access_key_id: ENV[&#39;AWS_ACCESS_KEY_ID&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">      secret_access_key: ENV[&#39;AWS_SECRET_ACCESS_KEY&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">    # Generate audio with Polly</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    response = polly_client.synthesize_speech({</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      text: DEMO_TEXT,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      voice_id: voice_id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">      output_format: &#39;mp3&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">      engine: engine</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    # Upload to S3</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    s3_key = &quot;voice_demos/#{voice_id.downcase}_demo.mp3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    bucket = ENV[&#39;AWS_S3_BUCKET&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    s3_client.put_object({</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      bucket: bucket,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            

            <code class="ruby">      key: s3_key,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">      body: response.audio_stream,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">      content_type: &#39;audio/mpeg&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">    })</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">    # Return the public URL</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    &quot;https://#{bucket}.s3.amazonaws.com/#{s3_key}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            

            <code class="ruby">    Rails.logger.error &quot;Failed to generate demo for voice #{voice_id}: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            

            <code class="ruby">  def self.get_all_voice_urls</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    CURATED_VOICES.map do |voice|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="64">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">        voice_id: voice[:id],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">        engine: voice[:engine],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">        demo_url: &quot;https://#{ENV[&#39;AWS_S3_BUCKET&#39;]}.s3.amazonaws.com/voice_demos/#{voice[:id].downcase}_demo.mp3&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
